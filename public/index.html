<!doctype html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ูุธุงู ุนููุฏ ุงููุธุงูุฉ - ูุงุฌูุฉ ูุชุตูุฉ</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- <link rel="stylesheet" href="styles.css"> -->
  <!-- <link rel="stylesheet" href="styles/theme-modern.css"> -->

  <link rel="stylesheet" href="styles/theme-kucoin.css">

  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <!-- Quill.js Rich Text Editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script src="/socket.io/socket.io.js"></script>








  <!-- <script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script> -->
  <style>
    /* Sortable table headers */
    th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-left: 20px;
    }

    th.sortable:hover {
      background-color: #f0f4f8;
    }

    .sort-arrow {
      position: absolute;
      left: 5px;
      opacity: 0.3;
      font-size: 10px;
    }

    .sort-arrow::before {
      content: 'โผ';
    }

    th.sortable.asc .sort-arrow {
      opacity: 1;
    }

    th.sortable.asc .sort-arrow::before {
      content: 'โฒ';
    }

    th.sortable.desc .sort-arrow {
      opacity: 1;
    }

    th.sortable.desc .sort-arrow::before {
      content: 'โผ';
    }

    /* Flower Theme Switcher - Improved */
    .theme-flower {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 9999;
      width: 40px;
      height: 40px;
    }

    /* Keep petals visible for 2 seconds after hover ends */
    .theme-flower:hover,
    .theme-flower:focus-within {
      width: 180px;
      height: 180px;
    }

    .flower-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #24ae8f 0%, #14b8a6 100%);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(36, 174, 143, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      transition: all 0.3s ease;
      z-index: 10;
    }

    .flower-center:hover {
      transform: translate(-50%, -50%) scale(1.15) rotate(180deg);
      box-shadow: 0 6px 20px rgba(36, 174, 143, 0.7);
    }

    .flower-petal {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      color: white;
      text-align: center;
      padding: 3px;
      line-height: 1.1;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
      transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      opacity: 0;
      transform: translate(-50%, -50%) scale(0);
      pointer-events: none;
    }

    .theme-flower:hover .flower-petal,
    .theme-flower:focus-within .flower-petal {
      opacity: 1;
      pointer-events: all;
      transition-delay: 0s;
    }

    /* Petal positions - closer circle */
    .theme-flower:hover .petal-1,
    .theme-flower:focus-within .petal-1 {
      transform: translate(calc(-50% + 0px), calc(-50% - 65px)) scale(1);
      transition-delay: 0.05s;
    }

    .theme-flower:hover .petal-2,
    .theme-flower:focus-within .petal-2 {
      transform: translate(calc(-50% + 56px), calc(-50% - 33px)) scale(1);
      transition-delay: 0.1s;
    }

    .theme-flower:hover .petal-3,
    .theme-flower:focus-within .petal-3 {
      transform: translate(calc(-50% + 56px), calc(-50% + 33px)) scale(1);
      transition-delay: 0.15s;
    }

    .theme-flower:hover .petal-4,
    .theme-flower:focus-within .petal-4 {
      transform: translate(calc(-50% + 0px), calc(-50% + 65px)) scale(1);
      transition-delay: 0.2s;
    }

    .theme-flower:hover .petal-5,
    .theme-flower:focus-within .petal-5 {
      transform: translate(calc(-50% - 56px), calc(-50% + 33px)) scale(1);
      transition-delay: 0.25s;
    }

    .theme-flower:hover .petal-6,
    .theme-flower:focus-within .petal-6 {
      transform: translate(calc(-50% - 56px), calc(-50% - 33px)) scale(1);
      transition-delay: 0.3s;
    }

    /* Individual petal colors */
    .petal-1 {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .petal-2 {
      background: linear-gradient(135deg, #f0b90b 0%, #d9a809 100%);
    }

    .petal-3 {
      background: linear-gradient(135deg, #24ae8f 0%, #14b8a6 100%);
    }

    .petal-4 {
      background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);
    }

    .petal-5 {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    }

    .petal-6 {
      background: linear-gradient(135deg, #e5e7eb 0%, #f3f4f6 100%);
      color: #1e293b;
    }

    .flower-petal:hover {
      transform: translate(-50%, -50%) scale(1.2) !important;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
      z-index: 20;
    }

    /* Tooltip on hover */
    .flower-petal::before {
      content: attr(title);
      position: absolute;
      bottom: 110%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .flower-petal:hover::before {
      opacity: 1;
    }

    /* ===== GRID LAYOUT FOR MAIN + SIDEBAR ===== */
    main {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 1.5rem;
      align-items: start;
    }

    .content {
      min-width: 0;
      /* Prevents overflow */
    }

    .panel {
      background: var(--bg-secondary, #f8fafc);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--border-color, #e2e8f0);
      width: 100%;
      box-sizing: border-box;
    }

    .panel h3 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--text-primary, #1e293b);
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--primary-color, #2563eb);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0;
    }

    .panel h3::before {
      content: '๐';
      font-size: 1.5rem;
    }

    /* Stat Cards */
    .stat {
      background: linear-gradient(135deg, var(--primary-color, #3b82f6) 0%, var(--primary-dark, #2563eb) 100%);
      color: white;
      padding: 1.25rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      transition: all 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      text-align: right;
    }

    .stat:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    #statPending {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    #statPending:hover {
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }

    .stat .muted {
      font-size: 0.75rem;
      opacity: 0.9;
      margin-bottom: 0.375rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat strong {
      font-size: 2.25rem;
      font-weight: 800;
      display: block;
      line-height: 1;
    }

    .stat .chip {
      background: rgba(255, 255, 255, 0.25);
      color: white;
      padding: 0.375rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      border: 1px solid rgba(255, 255, 255, 0.4);
      white-space: nowrap;
    }

    /* Navigation Buttons */
    .nav {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }

    .nav button {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid transparent;
      border-radius: 10px;
      background: var(--bg-tertiary, #f1f5f9);
      color: var(--text-primary, #1e293b);
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: right;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      position: relative;
      overflow: hidden;
    }

    .nav button::before {
      font-size: 1.25rem;
      display: inline-block;
      margin-left: 8px;
    }

    .nav button[data-view="contracts"]::before {
      content: '๐';
    }

    .nav button[data-view="notifications"]::before {
      content: '๐';
    }

    .nav button[data-view="reports"]::before {
      content: '๐';
    }

    .nav button::after {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--primary-color, #3b82f6);
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }

    .nav button:hover {
      background: var(--bg-secondary, #e2e8f0);
      border-color: var(--primary-color, #3b82f6);
      transform: translateX(-4px);
    }

    .nav button.active {
      background: linear-gradient(135deg, var(--primary-color, #3b82f6) 0%, var(--primary-dark, #2563eb) 100%);
      color: white;
      border-color: var(--primary-color, #3b82f6);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .nav button.active::after {
      transform: scaleY(1);
    }

    /* Custom scrollbar for sidebar */
    #dashboardSidebar::-webkit-scrollbar {
      width: 4px;
    }

    #dashboardSidebar::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }

    /* ===== CONTROLS BAR STYLING ===== */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      margin-bottom: 0.75rem;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      width: 100%;
      box-sizing: border-box;
    }

    .controls .btn {
      white-space: nowrap;
      flex-shrink: 0;
    }

    .controls input#search {
      flex: 1;
      min-width: 200px;
      max-width: 350px;
      padding: 0.625rem 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .controls input#search:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(36, 174, 143, 0.2);
      outline: none;
    }

    .controls select#filter {
      min-width: 140px;
      padding: 0.625rem 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 0.875rem;
      cursor: pointer;
    }

    .controls select#filter:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(36, 174, 143, 0.2);
      outline: none;
    }

    /* ===== TABLE WRAPPER STYLING ===== */
    .table-wrap {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      padding: 1rem;
      width: 100%;
      box-sizing: border-box;
      overflow: visible;
      /* Show everything without internal scroll */
    }

    .table-wrap table {
      width: 100%;
      border-collapse: collapse;
    }

    /* ===== RESPONSIVE SIDEBAR ===== */
    @media (max-width: 1024px) {
      #mainDashboardContainer {
        flex-direction: column;
        padding: 1rem;
      }

      #dashboardSidebar {
        flex: 1;
        width: 100%;
        min-width: 0;
        position: relative;
        top: 0;
        margin-bottom: 2rem;
      }

      .nav {
        flex-direction: row;
        flex-wrap: wrap;
      }

      .nav button {
        flex: 1;
        min-width: 140px;
      }
    }

    /* Quill Toolbar Custom Font Size Labels */
    .ql-snow .ql-picker.ql-size .ql-picker-label::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item::before {
      content: attr(data-value) !important;
    }

    /* Handle default (empty value) case if any */
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value=""]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value=""]::before {
      content: 'Normal';
    }

    /* Responsive Grid Layout */
    @media (max-width: 1024px) {
      main {
        grid-template-columns: 1fr;
      }

      .panel {
        position: relative;
        top: 0;
      }

      .nav {
        flex-direction: row;
        flex-wrap: wrap;
      }

      .nav button {
        flex: 1;
        min-width: 150px;
      }
    }

    /* Fullscreen A4 Document Editor Modal */
    .a4-editor-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      overflow: auto;
      padding: 20px;
    }

    .a4-editor-modal.active {
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    .a4-editor-content {
      background: #e0e0e0;
      border-radius: 12px;
      padding: 30px;
      width: 100%;
      max-width: 240mm;
      min-height: 100vh;
      position: relative;
    }

    .a4-editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    @media print {
      #contractAttachmentsSection {
        display: none !important;
      }
    }

    .a4-editor-header h3 {
      margin: 0;
      color: #1e293b;
      font-size: 18px;
    }

    .a4-editor-close {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .a4-editor-close:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    /* A4 Paper-Style Editor */
    .a4-paper-container {
      max-width: 210mm;
      margin: 0 auto;
      background: #e0e0e0;
      padding: 20px 0;
    }

    .a4-paper {
      background: white;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(0, 0, 0, 0.1);
      margin: 0 auto;
      width: 210mm;
      min-height: 297mm;
      position: relative;
    }

    /* Quill Editor Styling for A4 */
    .a4-paper .ql-container {
      border: none !important;
      font-family: 'Cairo', 'Arial', sans-serif;
      font-size: 14px;
      line-height: 1.6;
    }

    /* Quill Alignment Classes for View Mode */
    .ql-align-center {
      text-align: center;
    }

    .ql-align-right {
      text-align: right;
    }

    .ql-align-justify {
      text-align: justify;
    }

    /* Quill Font Size Classes for View Mode */
    .ql-size-small {
      font-size: 0.75em;
    }

    .ql-size-large {
      font-size: 1.5em;
    }

    .ql-size-huge {
      font-size: 2.5em;
    }

    /* Custom Pixel Sizes */
    .ql-size-8px {
      font-size: 8px;
    }

    .ql-size-10px {
      font-size: 10px;
    }

    .ql-size-12px {
      font-size: 12px;
    }

    .ql-size-14px {
      font-size: 14px;
    }

    .ql-size-16px {
      font-size: 16px;
    }

    .ql-size-18px {
      font-size: 18px;
    }

    .ql-size-20px {
      font-size: 20px;
    }

    .ql-size-24px {
      font-size: 24px;
    }

    .ql-size-30px {
      font-size: 30px;
    }

    .ql-size-36px {
      font-size: 36px;
    }

    .ql-size-48px {
      font-size: 48px;
    }

    .ql-size-60px {
      font-size: 60px;
    }

    .ql-size-72px {
      font-size: 72px;
    }

    /* Ensure inline font-size styles are respected */
    span[style*="font-size"] {
      display: inline;
    }

    /* Calendar/Date Picker */
    .a4-paper .ql-editor {
      padding: 2.5cm 2cm !important;
      min-height: 297mm;
      direction: rtl;
      text-align: right;
    }

    .a4-paper .ql-toolbar {
      border: none !important;
      border-bottom: 2px solid #e5e7eb !important;
      background: #f9fafb;
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* Quill Toolbar Custom Font Size Labels */
    .ql-snow .ql-picker.ql-size .ql-picker-label::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item::before {
      content: attr(data-value) !important;
    }

    /* Handle default (empty value) case if any */
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value=""]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value=""]::before {
      content: 'Normal';
    }

    /* Drag-and-drop styles for terms */
    .term-item {
      transition: opacity 0.2s, transform 0.2s, background 0.2s;
      cursor: move;
      user-select: none;
      position: relative;
    }

    .term-item.dragging {
      opacity: 0.4;
      transform: scale(0.98);
    }

    .term-item.drag-over {
      border-top: 3px solid var(--primary-color, #3b82f6) !important;
      background: rgba(59, 130, 246, 0.05);
    }

    .term-item:hover {
      background: rgba(59, 130, 246, 0.03);
    }

    .term-item::before {
      content: 'โฎโฎ';
      position: absolute;
      left: -8px;
      color: #94a3b8;
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .term-item:hover::before {
      opacity: 0.5;
    }

    /* Fix for manually numbered text items - preserve line breaks */
    #v-terms,
    .terms-box,
    .ql-editor {
      white-space: pre-wrap !important;
      word-wrap: break-word !important;
    }

    /* Ensure proper display of Quill content */
    .ql-editor p,
    #v-terms p {
      margin: 10px 0;
      white-space: pre-wrap;
    }

    /* Print styles - aggressive spacing reduction to fit on one page */
    @media print {
      /* 
        IMPORTANT: For pre-stamped paper with header/footer, adjust the padding below!
        
        Example: If your stamped header is 20mm and footer is 15mm:
        Change padding from: padding: 15mm 18mm !important;
        To: padding: 35mm 18mm 30mm 18mm !important;
        
        Format: padding: TOP RIGHT BOTTOM LEFT;
      */
      /* 
        NOTE: To adjust top/bottom margins for pre-stamped paper,
        edit Lines 2905-2906 in the printViewContract iframe function.
      */

      /* Compact document for print */
      #doc-content {
        padding: 15mm !important;
        min-height: auto !important;
        font-size: 14px !important;
        line-height: 1.4 !important;
      }

      /* Reduce header spacing */
      .contract-header {
        margin-bottom: 12px !important;
      }

      .top-info-row {
        margin-bottom: 15px !important;
      }

      /* Compact contract sections */
      .contract-section {
        margin-bottom: 10px !important;
      }

      /* Reduce terms box spacing */
      .terms-box,
      #v-terms {
        margin-bottom: 15px !important;
        padding: 0 !important;
        line-height: 1.4 !important;
        white-space: pre-wrap !important;
        word-wrap: break-word !important;
      }

      /* FIX: Restore proper list formatting - don't override paragraph margins in lists */
      #v-terms ol,
      #v-terms ul,
      .ql-editor ol,
      .ql-editor ul {
        margin: 10px 0 !important;
        padding-right: 20px !important;
        display: block !important;
      }

      #v-terms li,
      .ql-editor li {
        margin: 6px 0 !important;
        line-height: 1.5 !important;
        display: list-item !important;
        text-align: right !important;
        direction: rtl !important;
      }

      /* Ensure list items are block level */
      #v-terms ol li,
      #v-terms ul li,
      .ql-editor ol li,
      .ql-editor ul li {
        display: list-item !important;
        margin-bottom: 8px !important;
      }

      /* Only compact non-list paragraphs */
      #v-terms>p {
        margin: 8px 0 !important;
        line-height: 1.4 !important;
      }

      /* Signature section - keep together and reduce spacing */
      #contract-signatures,
      .signature-section {
        margin-top: 0px !important;
        padding-top: 0 !important;
        page-break-before: avoid !important;
        page-break-inside: avoid !important;
        break-before: avoid !important;
        break-inside: avoid !important;
      }

      /* Keep terms and signatures together */
      #v-terms {
        page-break-after: avoid !important;
        break-after: avoid !important;
      }

      /* Reduce signature text spacing */
      #contract-signatures p {
        margin: 5px 0 !important;
      }

      /* Remove extra breaks in signatures ONLY, not in terms */
      #contract-signatures br {
        display: none !important;
      }

      /* Ensure br tags work in terms content */
      #v-terms br,
      .ql-editor br,
      .terms-box br {
        display: block !important;
        content: "" !important;
      }

      /* Preserve white-space in ALL term content - use wildcard to catch everything */
      #v-terms,
      #v-terms *,
      #v-terms p,
      #v-terms div,
      .ql-editor,
      .ql-editor *,
      .ql-editor p,
      .ql-editor div,
      .terms-box,
      .terms-box * {
        white-space: pre-wrap !important;
        word-wrap: break-word !important;
      }

      /* Prevent widows/orphans */
      p,
      div {
        orphans: 3;
        widows: 3;
      }
    }

    /* --- MOBILE-ONLY STYLES (Smart Identification) --- */
    @media (max-width: 768px) {

      /* Force single column layout for the main container */
      main {
        grid-template-columns: 1fr !important;
        display: flex !important;
        flex-direction: column !important;
      }

      /* Stack header elements */
      header {
        flex-direction: column !important;
        text-align: center !important;
        gap: 15px !important;
      }

      .brand {
        flex-direction: column !important;
        align-items: center !important;
      }

      .top-actions {
        width: 100% !important;
        justify-content: center !important;
        flex-wrap: wrap !important;
        gap: 8px !important;
      }

      .top-actions .btn {
        flex: 1 1 calc(50% - 10px) !important;
        min-width: 120px !important;
      }

      /* Stack Controls bar */
      .controls {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 10px !important;
      }

      .controls input#search,
      .controls select#filter,
      .controls .btn {
        width: 100% !important;
        max-width: none !important;
        margin: 0 !important;
      }

      /* Stack form rows - CRITICAL for "row row row" look */
      .row {
        display: flex !important;
        flex-direction: column !important;
        gap: 10px !important;
        margin-bottom: 15px !important;
      }

      .field {
        width: 100% !important;
      }

      .field input,
      .field select,
      .field textarea {
        width: 100% !important;
      }

      /* Sidebar (now stacked) styling */
      .panel {
        width: 100% !important;
      }

      .nav {
        flex-direction: column !important;
      }

      .nav button {
        width: 100% !important;
        justify-content: center !important;
      }

      /* Contract Table to Card View */
      .table-wrap {
        border: none !important;
        background: transparent !important;
        box-shadow: none !important;
        padding: 0 !important;
      }

      table,
      thead,
      tbody,
      th,
      td,
      tr {
        display: block !important;
      }

      thead tr {
        position: absolute !important;
        top: -9999px !important;
        left: -9999px !important;
      }

      tr {
        margin-bottom: 15px !important;
        background: var(--bg-secondary, #ffffff) !important;
        border: 1px solid var(--border-color, #e2e8f0) !important;
        border-radius: 12px !important;
        padding: 12px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05) !important;
      }

      td {
        border: none !important;
        position: relative !important;
        padding-right: 45% !important;
        text-align: left !important;
        min-height: 40px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        border-bottom: 1px solid #f1f5f9 !important;
      }

      td:last-child {
        border-bottom: none !important;
        margin-top: 10px !important;
        padding-right: 0 !important;
        flex-direction: column !important;
        align-items: stretch !important;
      }

      td::before {
        content: attr(data-label) !important;
        position: absolute !important;
        right: 12px !important;
        width: 40% !important;
        text-align: right !important;
        font-weight: 700 !important;
        color: var(--text-muted, #64748b) !important;
        font-size: 0.85rem !important;
      }

      td div {
        width: 100% !important;
        justify-content: center !important;
        gap: 5px !important;
      }

      /* Auth Box stacking */
      .auth>div {
        flex-direction: column !important;
        width: 100% !important;
      }

      .auth input {
        width: 100% !important;
        max-width: none !important;
      }

      .auth button {
        width: 100% !important;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">
          <img src="logo.jpg" alt="ูุธุงู ุนููุฏ ุงููุธุงูุฉ" width="56" height="56" id="siteLogo">
        </div>
        <div class="title">
          <h1>ูุธุงู ุนููุฏ ุงููุธุงูุฉ </h1>
          <p>ุนุฑุถุ ุฅูุดุงุกุ ุชูููุน ูุฃุฑุดูุฉ ุงูุนููุฏ โ ูุชุตู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช</p>
        </div>
      </div>

      <div class="top-actions">
        <div class="size-controls" style="display:flex; gap:2px; margin-left:10px;">
          <button class="btn small" onclick="setPageSize('small')" title="ุชุตุบูุฑ">A-</button>
          <button class="btn small" onclick="setPageSize('default')" title="ุนุงุฏู">A</button>
          <button class="btn small" onclick="setPageSize('large')" title="ุชูุจูุฑ">A+</button>
        </div>
        <!-- <button class="btn" id="exportCsvBtn" title="ุชุตุฏูุฑ ุชูุงุฑูุฑ ุงูุนููุฏ">ุชุตุฏูุฑ CSV</button> -->
        <!-- <button class="btn" id="uploadPdfBtn" title="ุฑูุน PDF">ุฑูุน PDF</button> -->
        <button class="btn primary" id="renewContractBtn">ุชุฌุฏูุฏ ุนูุฏ</button>
        <button class="btn primary" id="newContractBtn">ุฅูุดุงุก ุนูุฏ ุฌุฏูุฏ</button>
        <div id="userInfoDisplay"
          style="display:none; align-items:center; gap:8px; padding:5px 12px; background:#f1f5f9; border-radius:8px; border:1px solid #e2e8f0; margin-left:10px;">
          <span style="font-size:0.85rem; color:#64748b;">ุงููุณุชุฎุฏู:</span>
          <strong id="currentUserNameLabel" style="font-size:0.9rem; color:#0f172a;">-</strong>
        </div>
        <button class="btn" id="logoutBtn" style="background:#ef4444;color:white;display:none; border-radius:8px;">ุชุณุฌูู
          ุงูุฎุฑูุฌ</button>
      </div>
    </header>

    <div class="auth" id="authBox"
      style="margin: 0 1rem 1rem 1rem; backdrop-filter: blur(8px); background: rgba(30, 32, 44, 0.6); border: 1px solid rgba(36, 174, 143, 0.3); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); border-radius: 16px; padding: 1rem; z-index: 100;">
      <div style="display:flex; gap:1.5rem; align-items:center; justify-content:center; flex-wrap:wrap; width:100%;">
        <div style="display:flex; align-items:center; gap:0.5rem;">
          <div style="width:10px; height:10px; border-radius:50%; background:#24ae8f; box-shadow: 0 0 10px #24ae8f;">
          </div>
          <label style="color:var(--text-secondary); font-size:0.9rem; font-weight:700;">ุงุณู ุงููุณุชุฎุฏู</label>
          <input id="username" placeholder=""
            style="background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 10px 15px; color: white; width: 200px; font-family: inherit;">
        </div>
        <div style="display:flex; align-items:center; gap:0.5rem;">
          <div style="width:10px; height:10px; border-radius:50%; background:#24ae8f; box-shadow: 0 0 10px #24ae8f;">
          </div>
          <label style="color:var(--text-secondary); font-size:0.9rem; font-weight:700;">ูููุฉ ุงูุณุฑ</label>
          <input id="password" type="password" placeholder=""
            style="background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 10px 15px; color: white; width: 200px; font-family: inherit;">
        </div>
        <button class="btn primary" id="loginBtn"
          style="padding: 10px 35px; border-radius: 12px; font-weight: 700; background: linear-gradient(135deg, #24ae8f 0%, #1d9176 100%); border: none; box-shadow: 0 5px 15px rgba(36, 174, 143, 0.4); cursor: pointer; transition: transform 0.2s;">ุฏุฎูู
          ุงููุธุงู</button>
        <span id="authMsg" class="muted" style="color: #64748b; font-size: 0.85rem; font-weight:600;"></span>
      </div>
    </div>

    <div id="dashboardControls" class="controls">
      <button class="btn" id="refreshBtn">ุชุญุฏูุซ ุงููุงุฆูุฉ</button>
      <button class="btn" id="createUserBtn">ุฅุถุงูุฉ ูุณุชุฎุฏููู</button>
      <button class="btn" id="manageUsersBtn" style="display:none;">ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</button>
      <input id="search" placeholder="ุจุญุซ ุจุงุณู ุงูุนููู ุฃู ุฑูู ุงูุนูุฏ..." />
      <select id="filter">
        <option value="">ูู ุงูุญุงูุงุช</option>
        <option value="active">ูุดุท</option>
        <option value="pending">ููุฏ ุงูุชูููุน</option>
        <option value="expired">ููุชูู</option>
      </select>
      <button class="btn" id="exportExcelBtn">๐ ุชุตุฏูุฑ Excel</button>
    </div>

    <main id="mainContainer">
      <!-- Dashboard Sidebar Panel -->
      <aside class="panel">
        <h3>ููุญุฉ ุงูุชุญูู</h3>

        <!-- Statistics Cards -->
        <div class="stat" id="statActive">
          <div>
            <div class="muted">ุงูุนููุฏ ุงููุดุทุฉ</div>
            <strong id="countActive">0</strong>
          </div>
          <div class="chip">ูุดุท</div>
        </div>

        <div class="stat" id="statPending">
          <div>
            <div class="muted">ููุฏ ุงูุชูููุน</div>
            <strong id="countPending">0</strong>
          </div>
          <div class="chip">ูุนูู</div>
        </div>

        <!-- Navigation Buttons -->
        <nav class="nav">
          <button data-view="contracts" class="active">ุงูุนููุฏ</button>
          <button data-view="reports">ุงูุชูุงุฑูุฑ</button>
          <button data-view="notifications">ุงูุฅุดุนุงุฑุงุช</button>
        </nav>
      </aside>

      <section class="content">
        <div id="formWrap" class="form" aria-hidden="true" style="display:none;">
          <h3>ูููุฐุฌ ุฅูุดุงุก/ุชุนุฏูู ุนูุฏ</h3>

          <div class="row">
            <div class="field small">
              <label>ููุน ุงูุนููู</label>
              <select id="clientType">
                <option>ูุฑุฏ</option>
                <option>ููุดุฃุฉ</option>
              </select>
            </div>

            <div class="field">
              <label>ุงุณู ุงูุนููู</label>
              <input type="text" id="clientName" />
            </div>

            <div class="field"
              style="margin-top: 10px; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <label style="margin:0; font-weight:600; color:#475569; display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" id="hasRepresentative" onchange="toggleRepresentativeInput()"
                    style="width:16px; height:16px;">
                  ูููุซูู ูู ุงูุชูููุน (ุงุฎุชูุงุฑู)
                </label>
              </div>
              <div id="representativeFields" style="display:none; gap:10px; margin-top:5px;">
                <input type="text" id="representativeName" placeholder="ุงูุงุณู (ูุซุงู: ุญุณู ุจู ูุญูุฏ ุงูุดูุฑุงูู)"
                  style="flex:2;" oninput="if(typeof refreshContractLiveUI === 'function') refreshContractLiveUI()">
                <input type="text" id="representativeTitle" placeholder="ุงููุณูู (ูุซุงู: ุงูุฑุฆูุณ ุงูุชูููุฐู)" style="flex:1;"
                  oninput="if(typeof refreshContractLiveUI === 'function') refreshContractLiveUI()">
              </div>
              <script>
                function toggleRepresentativeInput() {
                  const checked = document.getElementById('hasRepresentative').checked;
                  const fields = document.getElementById('representativeFields');
                  if (fields) fields.style.display = checked ? 'flex' : 'none';
                  // Trigger update if live
                  if (typeof refreshContractLiveUI === 'function') refreshContractLiveUI();
                }
              </script>
            </div>

            <div class="field small">
              <label>ููุน ุงูุฎุฏูุฉ</label>
              <select id="serviceType">
                <option>ูุธุงูุฉ ููููุฉ</option>
                <option>ูุธุงูุฉ ุฃุณุจูุนูุฉ</option>
                <option>ุทูุงุฑุฆ</option>
                <option>ููู ููุงูุงุช</option>
                <option>ููู ููุฑุงุช</option>
                <option>ููู ุฃุฎุดุงุจ</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field small"><label>ุงููุฏููุฉ</label><input id="city" /></div>
            <div class="field small"><label>ุงูุญู</label><input id="district" /></div>
            <div class="field small"><label>ููุน ุงูุญุงููุฉ</label><select id="containerType">
                <option>ุจุฑููู</option>
                <option>2 ูุงุฑุฏุฉ</option>
                <option>4 ูุงุฑุฏุฉ</option>
                <option>6 ูุงุฑุฏุฉ</option>
                <option>240 Liter</option>
                <option>360 Liter</option>
                <option>1100 Liter</option>
                <option>1300 Liter</option>
                <option>ุจุฏูู</option>
              </select></div>
            <!-- <div class="field small"><label>ุงููููุน (ุนุงู)</label><input id="location" /></div> -->
          </div>

          <div class="row">
            <div class="field small"><label>ูู ุชุงุฑูุฎ</label><input type="date" id="dateFrom" /></div>
            <div class="field small"><label>ุฅูู ุชุงุฑูุฎ</label><input type="date" id="dateTo" /></div>
            <div class="field small"><label>ูุฏุฉ ุงูุนูุฏ</label><select id="duration">
                <option>ุณููู</option>
                <option>6 ุฃุดูุฑ</option>
                <option>3 ุฃุดูุฑ</option>
                <option>ุฏูุนุฉ ูุงุญุฏุฉ</option>
              </select></div>
            <div class="field small"><label>ูููุฉ ุงูุฏูุนุฉ ุงูุดูุฑูุฉ</label><input id="monthlyFee" /></div>
            <div class="field small"><label>ุงูุถุฑูุจุฉ</label><input id="tax" value="15%" placeholder="ูุซุงู: 15%" />
            </div>
            <div class="field small"><label>ุงูุณุนุฑ ุงูุฅุฌูุงูู</label><input id="totalPrice" /></div>
          </div>

          <div class="row">
            <div class="field">
              <label>ุดุฑูุท ู ุจููุฏ</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <input id="termsSummary" readonly placeholder="ุงุถุบุท 'ุฅุฏุงุฑุฉ ุงูุดุฑูุท' ููุชุญ ูุงูุฐุฉ ุงูุดุฑูุท"
                  style="flex:1;padding:8px;border-radius:8px;border:1px solid #e0e6ef" />
                <button class="btn" id="manageTermsBtn">ุฅุฏุงุฑุฉ ุงูุดุฑูุท</button>
                <button class="btn" id="exportTermsBtn" title="ุชุตุฏูุฑ ุงูุดุฑูุท ุงููุญุฏุฏุฉ ูููู Word">ุชุตุฏูุฑ Word</button>
              </div>
              <input type="hidden" id="terms" />
              <div class="muted" style="font-size:12px">ุงูุชุญ ุฅุฏุงุฑุฉ ุงูุดุฑูุท ูุฅุถุงูุฉ/ุชุนุฏูู/ุงุฎุชูุงุฑ ุงูุจููุฏ. ุนูุฏ ุงูุฅุฏุฑุงุฌ ุณุชูุญูุธ
                ุงููุชูุฌุฉ ุฏุงุฎู ุงูุญูู.</div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>ูููุน ุงูุญุงููุฉ (ุฅุญุฏุงุซูุงุช)</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <input id="containerLocation" placeholder="lat,lng" />
                <button class="btn" id="btnMapPicker_V2" type="button"
                  onclick="window.openMapModalFor('container')">ุงุฎุชุฑ ูู
                  ุฎุฑุงุฆุท Google</button>
                <a id="containerGoogleLink" class="muted" href="#" target="_blank" style="display:none">ุนุฑุถ ูู ุฎุฑุงุฆุท
                  Google</a>
              </div>
              <div class="muted" style="font-size:12px">ุงุถุบุท ููุชุญ ุฎุฑุงุฆุท Google ูู ูุงูุฐุฉ ุฌุฏูุฏุฉุ ุซู ุงูุณุฎ ุฑุงุจุท ุงููููุน
                ูุงุถุบุท
                "ูุตู ูู ุงูุญุงูุธุฉ".</div>
            </div>

            <!-- <div class="field">
              <label>ูููุน ุงูุชุญุตูู (ุฅุญุฏุงุซูุงุช)</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <input id="pickupLocation" placeholder="lat,lng" />
                <button class="btn" id="pickPickupBtn">ุงุฎุชุฑ ูู ุฎุฑุงุฆุท Google</button>
                <a id="pickupGoogleLink" class="muted" href="#" target="_blank" style="display:none">ุนุฑุถ ูู ุฎุฑุงุฆุท
                  Google</a>
              </div>
              <div class="muted" style="font-size:12px">ุจุนุฏ ุงุฎุชูุงุฑ ุงููููุน ูู ุฎุฑุงุฆุท Google ุงูุณุฎ ุงูุฑุงุจุท ุซู ุงุถุบุท "ูุตู ูู
                ุงูุญุงูุธุฉ".</div>
            </div> -->
          </div>

          <div class="row">
            <div class="field small">
              <label>ูุณูู ุงูุนูุฏ <button class="btn small text-only" id="manageManagersBtn"
                  style="padding:0 4px;font-size:0.8em;">(ุฅุฏุงุฑุฉ)</button></label>
              <select id="manager">
                <option value="">-- ุงุฎุชุฑ --</option>
              </select>
            </div>
            <div class="field small">
              <label>ูุญุตู ุงูุนูุฏ <button class="btn small text-only" id="manageCollectorsBtn"
                  style="padding:0 4px;font-size:0.8em;">(ุฅุฏุงุฑุฉ)</button></label>
              <select id="collector">
                <option value="">-- ุงุฎุชุฑ --</option>
              </select>
            </div>
            <div class="field small"><label>ุดุฑูุท ุงูุฏูุน</label><select id="paymentType">
                <option>ุณูููุฉ</option>
                <option>ูู 6 ุฃุดูุฑ</option>
                <option>ูู 3 ุฃุดูุฑ</option>
                <option>ุฏูุนุฉ ูุงุญุฏุฉ</option>
                <option>ุฏูุนุชูู 50% ู 50%</option>
              </select></div>
            <div class="field small"><label>ุญุงูุฉ ุงูุนูุฏ</label><select id="status">
                <option value="active">ูุดุท</option>
                <option value="pending">ููุฏ ุงูุชูููุน</option>
                <option value="expired">ููุชูู</option>
              </select></div>
          </div>

          <div class="row">
            <div class="field">
              <label>ุงูุทุฑู ุงูุฃูู (ุซุงุจุช)</label>
              <input type="text" id="firstParty" value="ุดุฑูุฉ ุจูุช ููููุงููุงุช" readonly
                style="background:#f8f9fc;border-color:#e6ecf8;color:#4a5568;" />
              <div class="muted" style="font-size:12px">ุงูุทุฑู ุงูุฃูู ุซุงุจุช ุฏุงุฆูุงู: ุดุฑูุฉ ุจูุช ููููุงููุงุช</div>
            </div>
            <div class="field">
              <label>ุงูุทุฑู ุงูุซุงูู (ุงูุนููู)</label>
              <input type="text" id="secondParty" readonly
                style="background:#f8f9fc;border-color:#e6ecf8;color:#4a5568;" />
              <div class="muted" style="font-size:12px">ุณูุชู ุชุนุจุฆุชู ุชููุงุฆูุงู ูู ุงุณู ุงูุนููู</div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุนููู (ููุฅุฑุณุงู ูุงูุชูููุน)</label>
              <input type="email" id="clientEmail" placeholder="client@example.com" />
              <div class="muted" style="font-size:12px">ุณูุชู ุฅุฑุณุงู ุฑุงุจุท ุงูุชูููุน ุงูุขูู ุฅูู ูุฐุง ุงูุจุฑูุฏ</div>
            </div>
            <div class="field">
              <label>ุฑูู ุฌูุงู ุงูุนููู</label>
              <input type="tel" id="clientPhone" placeholder="05xxxxxxxx" />
              <div class="muted" style="font-size:12px">ูุฅุฑุณุงู ุฑุงุจุท ุงูุชูููุน ุนุจุฑ ุงููุงุชุณุงุจ (ุงุฎุชูุงุฑู)</div>
            </div>
          </div>

          <!-- Contract Attachments Section (Only shown for NEW contracts, not renewals) -->
          <div id="contractAttachmentsSection"
            style="display:none; margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f8fafc 0%, #e3f2fd 100%); border-radius: 12px; border: 2px solid #3b82f6;">
            <h4 style="margin: 0 0 16px 0; color: #1e40af; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 1.5rem;">๐</span>
              ูุฑููุงุช ุงูุนูุฏ
            </h4>
            <div class="muted" style="font-size:12px; margin-bottom: 16px; color: #475569;">
              ูุฐู ุงููุฑููุงุช ุชุธูุฑ ููุท ุนูุฏ ุฅูุดุงุก ุนูุฏ ุฌุฏูุฏ. ุนูุฏ ุงูุชุฌุฏูุฏ ูุง ุชุญุชุงุฌ ุฅูู ุฅุนุงุฏุฉ ุฑูุน ุงููุฑููุงุช.
            </div>

            <div class="row">
              <div class="field">
                <label>1- ุตูุฑุฉ ุงูุฑุฎุตุฉ</label>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                  <button type="button" class="btn" onclick="document.getElementById('licenseImage').click()"
                    style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    ๐ ุฑูุน ููู
                  </button>
                  <button type="button" class="btn" onclick="document.getElementById('licenseImageCamera').click()"
                    style="flex: 1; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    ๐ธ ุงูุชูุงุท ุตูุฑุฉ
                  </button>
                </div>
                <input type="file" id="licenseImage" accept="image/*,application/pdf" style="display: none;" />
                <input type="file" id="licenseImageCamera" accept="image/*" capture="environment"
                  style="display: none;" />
                <div class="muted" style="font-size:12px">ูููู ุฑูุน ุตูุฑุฉ (JPG, PNG, GIF) ุฃู ููู PDF</div>
                <div id="licenseImagePreview" style="margin-top: 8px;"></div>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label>2- ุงูุณุฌู ุงูุชุฌุงุฑู</label>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                  <button type="button" class="btn" onclick="document.getElementById('commercialRegistry').click()"
                    style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    ๐ ุฑูุน ููู
                  </button>
                  <button type="button" class="btn"
                    onclick="document.getElementById('commercialRegistryCamera').click()"
                    style="flex: 1; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    ๐ธ ุงูุชูุงุท ุตูุฑุฉ
                  </button>
                </div>
                <input type="file" id="commercialRegistry" accept="image/*,application/pdf" style="display: none;" />
                <input type="file" id="commercialRegistryCamera" accept="image/*" capture="environment"
                  style="display: none;" />
                <div class="muted" style="font-size:12px">ูููู ุฑูุน ุตูุฑุฉ ุฃู PDF ููุณุฌู ุงูุชุฌุงุฑู</div>
                <div id="commercialRegistryPreview" style="margin-top: 8px;"></div>
              </div>
              <div class="field">
                <label>3- ุฑุฎุตุฉ ุงููุดุงุท</label>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                  <button type="button" class="btn" onclick="document.getElementById('activityLicense').click()"
                    style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    ๐ ุฑูุน ููู
                  </button>
                  <button type="button" class="btn" onclick="document.getElementById('activityLicenseCamera').click()"
                    style="flex: 1; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    ๐ธ ุงูุชูุงุท ุตูุฑุฉ
                  </button>
                </div>
                <input type="file" id="activityLicense" accept="image/*,application/pdf" style="display: none;" />
                <input type="file" id="activityLicenseCamera" accept="image/*" capture="environment"
                  style="display: none;" />
                <div class="muted" style="font-size:12px">ูููู ุฑูุน ุตูุฑุฉ ุฃู PDF ูุฑุฎุตุฉ ุงููุดุงุท</div>
                <div id="activityLicensePreview" style="margin-top: 8px;"></div>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label>4- ุงูุฑูู ุงูุถุฑูุจู</label>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                  <button type="button" class="btn" onclick="document.getElementById('taxNumber').click()"
                    style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    ๐ ุฑูุน ููู
                  </button>
                  <button type="button" class="btn" onclick="document.getElementById('taxNumberCamera').click()"
                    style="flex: 1; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    ๐ธ ุงูุชูุงุท ุตูุฑุฉ
                  </button>
                </div>
                <input type="file" id="taxNumber" accept="image/*,application/pdf" style="display: none;" />
                <input type="file" id="taxNumberCamera" accept="image/*" capture="environment" style="display: none;" />
                <div class="muted" style="font-size:12px">ูููู ุฑูุน ุตูุฑุฉ ุฃู PDF ููุฑูู ุงูุถุฑูุจู</div>
                <div id="taxNumberPreview" style="margin-top: 8px;"></div>
              </div>
            </div>
          </div>

          <!-- Contract Attachments Display -->
          <div id="attachmentsDisplay"
            style="display:none; margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
            <h4 style="margin: 0 0 12px 0; color: #1e293b;">ูุฑููุงุช ุงูุนูุฏ</h4>
            <div id="attachmentsList"></div>
          </div>

          <div class="actions">
            <button class="btn primary" id="saveContractBtn">ุญูุธ ุงูุนูุฏ</button>
            <button class="btn" id="previewContractBtn" title="ูุนุงููุฉ ุงูุนูุฏ ูุจู ุงูุญูุธ"
              style="background: #6366f1; color: white; border: none;">๐๏ธ ูุนุงููุฉ</button>
            <button class="btn" id="sendForSigningBtn" title="ุฅุฑุณุงู ุงูุนูุฏ ููุนููู ููุชูููุน">ุฅุฑุณุงู ููุชูููุน</button>
            <!-- <button class="btn" id="generateContractFileBtn" title="ุฅูุดุงุก ููู ุงูุนูุฏ (Word/PDF)">ุฅูุดุงุก ููู ุงูุนูุฏ</button> -->
            <button class="btn" id="cancelFormBtn">ุฅูุบุงุก</button>
          </div>
        </div>



        <div class="table-wrap" id="contractsArea">
          <table>
            <thead>
              <tr>
                <th class="sortable" data-sort="id" onclick="sortTable('id')">ุฑูู <span class="sort-arrow"></span>
                </th>
                <th class="sortable" data-sort="second_party" onclick="sortTable('second_party')">ุงูุนููู <span
                    class="sort-arrow"></span></th>
                <th class="sortable" data-sort="service_name" onclick="sortTable('service_name')">ุงูุฎุฏูุฉ <span
                    class="sort-arrow"></span></th>
                <th class="sortable" data-sort="from_date" onclick="sortTable('from_date')">ุงููุชุฑุฉ <span
                    class="sort-arrow"></span></th>
                <th class="sortable" data-sort="total_price" onclick="sortTable('total_price')">ุงูุณุนุฑ <span
                    class="sort-arrow"></span></th>
                <th class="sortable" data-sort="manager" onclick="sortTable('manager')">ูุณูู <span
                    class="sort-arrow"></span></th>
                <th class="sortable" data-sort="collector" onclick="sortTable('collector')">ูุญุตู <span
                    class="sort-arrow"></span></th>
                <th class="sortable" data-sort="status" onclick="sortTable('status')">ุงูุญุงูุฉ <span
                    class="sort-arrow"></span></th>
                <!-- <th>ุฅุฌุฑุงุกุงุช</th> -->
              </tr>
            </thead>
            <tbody id="contractsTbody"></tbody>
          </table>
        </div>

        <!-- Reports Section - Enhanced with Entity-Level Drill-Down -->
        <div class="table-wrap" id="reportsArea" style="display:none;">
          <h3 style="margin-bottom: 1.5rem;">ุงูุชูุงุฑูุฑ ูุงูุฅุญุตุงุฆูุงุช</h3>

          <!-- Entity Type Selector -->
          <div
            style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;">
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
              <button class="btn" id="showCollectorsBtn" style="flex: 1; min-width: 200px; padding: 1rem;">
                ๐ฐ ุงููุญุตููู
              </button>
              <button class="btn" id="showMarketersBtn" style="flex: 1; min-width: 200px; padding: 1rem;">
                ๐ ุงููุณูููู
              </button>
              <button class="btn" id="showClientsBtn" style="flex: 1; min-width: 200px; padding: 1rem;">
                ๐ข ุงูุนููุงุก / ุงูุทุฑู ุงูุซุงูู
              </button>
              <button class="btn primary" id="showOverviewBtn" style="flex: 1; min-width: 200px; padding: 1rem;">
                ๐ ูุธุฑุฉ ุนุงูุฉ
              </button>
            </div>
          </div>

          <!-- Overview Section (Default) -->
          <div id="overviewSection">
            <!-- Key Metrics -->
            <div
              style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
              <div
                style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">ุฅุฌูุงูู ุงูุนููุฏ</div>
                <div style="font-size: 2.5rem; font-weight: 700;" id="reportTotalContracts">0</div>
              </div>

              <div
                style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช</div>
                <div style="font-size: 2.5rem; font-weight: 700;" id="reportTotalRevenue">0</div>
                <div style="font-size: 0.75rem; opacity: 0.8;">ุฑูุงู ุณุนูุฏู</div>
              </div>

              <div
                style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">ุฅุฌูุงูู ุงูุนููุงุก</div>
                <div style="font-size: 2.5rem; font-weight: 700;" id="reportTotalClients">0</div>
              </div>

              <div
                style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">ูุชูุณุท ูููุฉ ุงูุนูุฏ</div>
                <div style="font-size: 2.5rem; font-weight: 700;" id="reportAvgContract">0</div>
                <div style="font-size: 0.75rem; opacity: 0.8;">ุฑูุงู ุณุนูุฏู</div>
              </div>
            </div>

            <!-- Status Distribution -->
            <div
              style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;">
              <h4 style="margin-bottom: 1rem;">ุชูุฒูุน ุงูุนููุฏ ุญุณุจ ุงูุญุงูุฉ</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div style="padding: 1rem; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
                  <div style="color: #059669; font-size: 0.875rem; margin-bottom: 0.25rem;">ูุดุทุฉ</div>
                  <div style="font-size: 1.75rem; font-weight: 700; color: #047857;" id="reportActiveCount">0</div>
                </div>
                <div style="padding: 1rem; background: #fffbeb; border-radius: 8px; border-left: 4px solid #f59e0b;">
                  <div style="color: #d97706; font-size: 0.875rem; margin-bottom: 0.25rem;">ููุฏ ุงูุชูููุน</div>
                  <div style="font-size: 1.75rem; font-weight: 700; color: #b45309;" id="reportPendingCount">0</div>
                </div>
                <div style="padding: 1rem; background: #fef2f2; border-radius: 8px; border-left: 4px solid #ef4444;">
                  <div style="color: #dc2626; font-size: 0.875rem; margin-bottom: 0.25rem;">ููุชููุฉ</div>
                  <div style="font-size: 1.75rem; font-weight: 700; color: #b91c1c;" id="reportExpiredCount">0</div>
                </div>
              </div>
            </div>

            <!-- Manager Performance -->
            <div
              style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;">
              <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.5rem;">๐</span>
                ุฃุฏุงุก ุงููุณูููู
              </h4>
              <div style="overflow-x: auto;">
                <table>
                  <thead>
                    <tr>
                      <th>ุงููุณูู</th>
                      <th>ุนุฏุฏ ุงูุนููุฏ</th>
                      <th>ุฅุฌูุงูู ุงููููุฉ</th>
                      <th>ุงูุฅูุฑุงุฏุงุช ุงูุดูุฑูุฉ</th>
                      <!-- <th>ุฅุฌุฑุงุกุงุช</th> -->
                    </tr>
                  </thead>
                  <tbody id="managerStatsTbody"></tbody>
                </table>
              </div>
            </div>

            <!-- Collector Performance -->
            <div
              style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;">
              <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.5rem;">๐ฐ</span>
                ุฃุฏุงุก ุงููุญุตููู
              </h4>
              <div style="overflow-x: auto;">
                <table>
                  <thead>
                    <tr>
                      <th>ุงููุญุตู</th>
                      <th>ุนุฏุฏ ุงูุนููุฏ</th>
                      <th>ุฅุฌูุงูู ุงููููุฉ</th>
                      <th>ุงูุฅูุฑุงุฏุงุช ุงูุดูุฑูุฉ</th>
                      <!-- <th>ุฅุฌุฑุงุกุงุช</th> -->
                    </tr>
                  </thead>
                  <tbody id="collectorStatsTbody"></tbody>
                </table>
              </div>
            </div>

            <!-- Top Clients -->
            <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e5e7eb;">
              <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.5rem;">๐</span>
                ุฃูุถู 5 ุนููุงุก (ุญุณุจ ูููุฉ ุงูุนููุฏ)
              </h4>
              <div style="overflow-x: auto;">
                <table>
                  <thead>
                    <tr>
                      <th>ุงูุนููู</th>
                      <th>ุนุฏุฏ ุงูุนููุฏ</th>
                      <th>ุฅุฌูุงูู ุงููููุฉ</th>
                      <!-- <th>ุฅุฌุฑุงุกุงุช</th> -->
                    </tr>
                  </thead>
                  <tbody id="topClientsTbody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Entity Selection Section -->
          <div id="entitySelectionSection" style="display:none;">
            <div
              style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;">
              <h4 id="entitySectionTitle" style="margin-bottom: 1rem;">ุงุฎุชุฑ ุงููุญุตู</h4>

              <!-- Search/Filter -->
              <div style="margin-bottom: 1rem;">
                <input type="text" id="entitySearchInput" placeholder="ุงุจุญุซ..."
                  style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #e0e6ef; font-size: 1rem;">
              </div>

              <!-- Entity Cards Grid -->
              <div id="entityCardsGrid"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                <!-- Cards will be populated by JavaScript -->
              </div>
            </div>
          </div>

          <!-- Entity Detail Report Section -->
          <div id="entityDetailSection" style="display:none;">
            <!-- Back Button -->
            <div style="margin-bottom: 1rem;">
              <button class="btn" id="backToEntitiesBtn">
                โ ุงูุนูุฏุฉ ูููุงุฆูุฉ
              </button>
            </div>

            <!-- Entity Header -->
            <div
              style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);">
              <h3 id="entityDetailName" style="margin: 0 0 1rem 0; font-size: 2rem;">ูุญูุฏ ุฃุญูุฏ</h3>
              <div id="entityDetailType" style="font-size: 1rem; opacity: 0.9; margin-bottom: 1.5rem;">ูุญุตู</div>

              <!-- Statistics Grid -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <div
                  style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
                  <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.25rem;">ุฅุฌูุงูู ุงูุนููุฏ</div>
                  <div id="entityStatTotalContracts" style="font-size: 1.75rem; font-weight: 700;">0</div>
                </div>
                <div
                  style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
                  <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.25rem;">ูุดุทุฉ</div>
                  <div id="entityStatActiveContracts" style="font-size: 1.75rem; font-weight: 700;">0</div>
                </div>
                <div
                  style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
                  <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.25rem;">ุฅุฌูุงูู ุงููููุฉ</div>
                  <div id="entityStatTotalValue" style="font-size: 1.75rem; font-weight: 700;">0 ุฑ.ุณ</div>
                </div>
                <div
                  style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
                  <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.25rem;">ุงูุฅูุฑุงุฏุงุช ุงูุดูุฑูุฉ</div>
                  <div id="entityStatMonthlyRevenue" style="font-size: 1.75rem; font-weight: 700;">0 ุฑ.ุณ</div>
                </div>
              </div>
            </div>

            <!-- Contracts Table -->
            <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e5e7eb;">
              <h4 style="margin-bottom: 1rem;">ุฌููุน ุงูุนููุฏ</h4>
              <div style="overflow-x: auto;">
                <table>
                  <thead>
                    <tr>
                      <th>ุฑูู ุงูุนูุฏ</th>
                      <th>ุงูุนููู / ุงูุทุฑู ุงูุซุงูู</th>
                      <th>ุงูุฎุฏูุฉ</th>
                      <th>ูู ุชุงุฑูุฎ</th>
                      <th>ุฅูู ุชุงุฑูุฎ</th>
                      <th>ุงูุฏูุนุฉ ุงูุดูุฑูุฉ</th>
                      <th>ุงููููุฉ ุงูุฅุฌูุงููุฉ</th>
                      <th>ุงูุญุงูุฉ</th>
                      <!-- <th>ุฅุฌุฑุงุกุงุช</th> -->
                    </tr>
                  </thead>
                  <tbody id="entityContractsTbody"></tbody>
                </table>
              </div>

              <!-- Export Button -->
              <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                <button class="btn primary" id="exportEntityReportBtn">
                  ๐ ุชุตุฏูุฑ ุงูุชูุฑูุฑ ุฅูู Excel
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Notifications Section -->
        <div id="notificationsArea"
          style="display:none; padding: 20px; background: white; border-radius: 12px; border: 1px solid #e5e7eb;">
          <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <span>๐</span> ุชูุจููุงุช ุงูููุธููู ุงููุญุธูุฉ
          </h3>
          <p class="muted" style="margin-bottom: 20px;">ูู ุจุงุฎุชูุงุฑ ุงูููุธูุ ุฏุฑุฌุฉ ุงูุฃูููุฉุ ููุฏุฉ ุงูุชูุจูู ุซู ุงุถุบุท "ุฅุฑุณุงู
            ุงูุชูุจูู".</p>

          <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
            <!-- Column 1: Users List -->
            <div style="background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0;">
              <h5 style="margin-bottom: 15px;">ุงูููุธููู ุงููุชุตููู ุญุงููุงู</h5>
              <div id="onlineUsersList"
                style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;">
                <div class="muted" style="text-align: center; padding: 20px;">ุฌุงุฑู ุชุญููู ุงููุชุตููู...</div>
              </div>
            </div>

            <!-- Column 2: Controls -->
            <div style="padding: 15px; border: 1px solid #e2e8f0; border-radius: 10px;">
              <h5 style="margin-bottom: 20px;">ุฎูุงุฑุงุช ุงูุชูุจูู</h5>

              <div class="field" style="margin-bottom: 20px;">
                <label>ุฏุฑุฌุฉ ุงูุฃูููุฉ (ูุงูุตูุช)</label>
                <div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
                  <button class="btn notif-priority-btn" data-priority="low"
                    style="flex: 1; border: 2px solid #e2e8f0; min-width: 80px;">
                    <div style="font-size: 1.1em;">๐</div>
                    <span>ููุฎูุถ</span>
                  </button>
                  <button class="btn notif-priority-btn active" data-priority="normal"
                    style="flex: 1; border: 2px solid #3b82f6; background: #eff6ff; min-width: 80px;">
                    <div style="font-size: 1.1em;">๐</div>
                    <span>ุนุงุฏู</span>
                  </button>
                  <button class="btn notif-priority-btn" data-priority="important"
                    style="flex: 1; border: 2px solid #e2e8f0; min-width: 80px;">
                    <div style="font-size: 1.1em;">๐</div>
                    <span>ูุงู</span>
                  </button>
                  <button class="btn notif-priority-btn" data-priority="critical"
                    style="flex: 1; border: 2px solid #e2e8f0; min-width: 80px;">
                    <div style="font-size: 1.1em;">๐จ</div>
                    <span>ุนุงุฌู ุฌุฏุงู</span>
                  </button>
                </div>
              </div>

              <div class="field" style="margin-bottom: 25px;">
                <label>ูุฏุฉ ุงูุชูุจูู (ุจุงูุซูุงูู): <span id="notifDurationVal">5</span> ุซุงููุฉ</label>
                <input type="range" id="notifDuration" min="1" max="30" value="5"
                  style="width: 100%; margin-top: 10px;">
              </div>

              <div class="field" style="margin-bottom: 25px;">
                <label>ุฑุณุงูุฉ ุงูุชูุจูู (ุงุฎุชูุงุฑู)</label>
                <input type="text" id="notifMessage" placeholder="ุงูุชุจ ุฑุณุงูุฉ ูุตูุฑุฉ ููุง..."
                  style="width: 100%; margin-top: 5px;">
              </div>

              <button class="btn primary" id="sendNotifBtn"
                style="width: 100%; padding: 15px; font-size: 1.1em; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                ๐ ุฅุฑุณุงู ุงูุชูุจูู ุงูุขู
              </button>
            </div>
          </div>
        </div>

        <!-- Notification Overlay (Hidden by default) -->
        <div id="notifOverlay"
          style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 99999; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center;">
          <div id="notifVisual" style="font-size: 80px; margin-bottom: 20px; animation: pulse 1s infinite;">๐</div>
          <h2 id="notifTitle" style="font-size: 2.5rem; margin-bottom: 10px;">ุชูุจูู ุฌุฏูุฏ</h2>
          <p id="notifSender" style="font-size: 1.5rem; opacity: 0.9; margin-bottom: 20px;">ูู: ูุฏูุฑ ุงููุธุงู</p>
          <div id="notifContent"
            style="background: rgba(255,255,255,0.1); padding: 20px 40px; border-radius: 15px; max-width: 80%; font-size: 1.8rem;">
            ูุฑุฌู ุงูุงูุชุจุงู ููุฑุงู!
          </div>
          <div style="margin-top: 40px;">
            <button class="btn" onclick="stopCurrentNotif()"
              style="background: white; color: black; padding: 10px 30px; font-size: 1.2rem; border-radius: 50px;">ุฅุบูุงู
              ุงูุชูุจูู</button>
          </div>
          <style>
            @keyframes pulse {
              0% {
                transform: scale(1);
              }

              50% {
                transform: scale(1.1);
              }

              100% {
                transform: scale(1);
              }
            }
          </style>
        </div>



      </section>


    </main>
  </div>

  <footer style="text-align:center;margin-top:18px" class="muted">ูุณุฎุฉ ุชุฌุฑูุจูุฉ - ุชุฃูุฏ ูู ุชุดููุฑ ุงูุฃุณุฑุงุฑ ูุจู ุงูุชุณููู
  </footer>

  <!-- Theme Flower Switcher -->
  <div class="theme-flower">
    <div class="flower-center" title="ุงุฎุชุฑ ุงูุชุตููู">๐ธ</div>
    <div class="flower-petal petal-1" onmouseover="switchTheme('theme-modern.css')" title="Modern">Modern</div>
    <div class="flower-petal petal-2" onmouseover="switchTheme('theme-binance.css')" title="Binance">Binance</div>
    <div class="flower-petal petal-3" onmouseover="switchTheme('theme-kucoin.css')" title="KuCoin">KuCoin</div>
    <div class="flower-petal petal-4" onmouseover="switchTheme('theme-ocean.css')" title="Ocean">Ocean</div>
    <div class="flower-petal petal-5" onmouseover="switchTheme('theme-dark-gold.css')" title="Dark Gold">Dark</div>
    <div class="flower-petal petal-6" onmouseover="switchTheme('theme-minimal.css')" title="Minimal">Minimal</div>
  </div>
  </div>

  <!-- Terms manager modal -->
  <div id="termsModal" class="map-modal" role="dialog" aria-hidden="true" style="display:none;">
    <div class="map-modal-content" style="max-width:900px;">
      <h4>ุฅุฏุงุฑุฉ ุงูุดุฑูุท ู ุงูุจููุฏ</h4>

      <div style="display:flex;gap:12px;margin-bottom:8px;align-items:center;">
        <button class="btn" id="termsRefreshBtn">ุชุญุฏูุซ ุงููุงุฆูุฉ</button>
        <button class="btn" id="termsSelectAllBtn">ุชุญุฏูุฏ ุงููู</button>
        <button class="btn" id="termsDeselectAllBtn">ุฅูุบุงุก ุงูุชุญุฏูุฏ</button>
        <button class="btn primary" id="termsInsertBtn">ุฅุฏุฑุงุฌ ุงููุญุฏุฏ ูู ุงูุนูุฏ</button>
        <button class="btn" id="termsExportBtn">ุชุตุฏูุฑ ุงููุญุฏุฏ ุฅูู Word</button>
        <div style="flex:1"></div>
        <button class="btn" id="termsCloseBtn">ุฅุบูุงู</button>
      </div>

      <div style="display:flex;gap:12px;">
        <div
          style="flex:1;min-width:300px;max-height:480px;overflow:auto;border:1px solid #e6ecf8;padding:8px;border-radius:8px;background:#fff;">
          <div id="termsList"></div>
        </div>

        <aside style="width:380px;min-width:240px;">
          <h5>ูุนุงููุฉ / ุฅุถุงูุฉ / ุชุนุฏูู ุจูุฏ</h5>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <input id="termId" type="hidden" />
            <label>ุงุณู ุงูุจูุฏ</label>
            <input id="termName" />
            <label>ููุน ุงูุจูุฏ</label>
            <select id="termType">
              <option value="text">ูุต</option>
              <option value="selection">ุงุฎุชูุงุฑ (ูุงุฆูุฉ)</option>
            </select>
            <label id="termContentLabel">ูุต ุงูุจูุฏ</label>
            <!-- Quill Editor Container with A4 Paper Style -->
            <div style="margin-bottom: 12px;">
              <button class="btn primary" id="openFullscreenEditorBtn" type="button">
                ๐ ูุชุญ ูู ูุญุฑุฑ ููุก ุงูุดุงุดุฉ
              </button>
            </div>
            <div class="a4-paper-container" style="max-height: 400px; overflow-y: auto;">
              <div class="a4-paper" style="min-height: 200px;">
                <div id="termContent"></div>
              </div>
            </div>
            <div class="muted" style="font-size:12px">ูููุน "ุงุฎุชูุงุฑ" ุถุน ูู ุฎูุงุฑ ูู ุณุทุฑ ุฌุฏูุฏ. ุงููุฑ "ูุชุญ ูู ูุญุฑุฑ ููุก
              ุงูุดุงุดุฉ" ููุญุตูู ุนูู ุชุฌุฑุจุฉ ุชุญุฑูุฑ ุฃูุถู.</div>

            <div style="display:flex;gap:8px;">
              <button class="btn primary" id="saveTermBtn">ุญูุธ ุงูุจูุฏ</button>
              <button class="btn" id="newTermBtn">ุฌุฏูุฏ</button>
              <button class="btn" id="deleteTermBtn"
                style="background:#f8d7da;border-color:#f5c6cb;color:#721c24">ุญุฐู</button>
            </div>
          </div>
        </aside>
      </div>

    </div>
    </section>

    </section>
    </main>

    <div class="container">

      <!-- Google Maps picker modal - Beautiful redesigned version -->
      <!-- Map Modal Moved to End of Body -->

      <!-- Contract Signing Modal -->
      <div id="signingModal" class="map-modal" role="dialog" aria-hidden="true" style="display:none;">
        <div class="map-modal-content" style="max-width:600px;">
          <h4>ุฅุฑุณุงู ุงูุนูุฏ ููุนููู ููุชูููุน</h4>

          <div class="row" style="margin-bottom:16px;">
            <div class="field">
              <label>ุทุฑููุฉ ุงูุฅุฑุณุงู</label>
              <select id="sendMethod" style="width:100%;">
                <option value="link">ุฅูุดุงุก ุฑุงุจุท ุชูููุน ุขูู</option>
                <!-- <option value="email">ุฅุฑุณุงู ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</option> -->
                <option value="whatsapp">ุฅุฑุณุงู ุนุจุฑ ุงููุงุชุณุงุจ</option>
                <!-- <option value="file">ุชุญููู ููู Word/PDF</option> -->
              </select>
            </div>
          </div>

          <div id="linkSection" class="send-section">
            <div class="field">
              <label>ุฑุงุจุท ุงูุชูููุน ุงูุขูู</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <input id="signingLink" readonly style="flex:1;font-family:monospace;font-size:12px;" />
                <button class="btn" id="copyLinkBtn">ูุณุฎ</button>
              </div>
              <div class="muted" style="font-size:12px">ูุฐุง ุงูุฑุงุจุท ูุฑูุฏ ููุนููู ูุขูู ููุชูููุน</div>
            </div>
          </div>

          <div id="emailSection" class="send-section" style="display:none;">
            <div class="field">
              <label>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุนููู</label>
              <input type="email" id="signingEmail" placeholder="client@example.com" />
            </div>
            <div class="field">
              <label>ุฑุณุงูุฉ ูุฎุตุตุฉ (ุงุฎุชูุงุฑู)</label>
              <textarea id="emailMessage" style="height:80px;"
                placeholder="ูุฑุฌู ุชูููุน ุงูุนูุฏ ุงููุฑูู ุนุจุฑ ุงูุฑุงุจุท ุงูุชุงูู..."></textarea>
            </div>
          </div>

          <div id="whatsappSection" class="send-section" style="display:none;">
            <div class="field">
              <label>ุฑูู ุฌูุงู ุงูุนููู</label>
              <input type="tel" id="whatsappNumber" placeholder="05xxxxxxxx" />
            </div>
            <div class="field">
              <label>ุฑุณุงูุฉ ุงููุงุชุณุงุจ</label>
              <textarea id="whatsappMessage" style="height:80px;" readonly></textarea>
            </div>
          </div>

          <!-- <div id="fileSection" class="send-section" style="display:none;"> -->
          <!-- <div class="field">
          <label>ุชูุณูู ุงูููู</label>
          <select id="fileFormat">
            <option value="word">ููู Word (.docx)</option>
            <option value="pdf">ููู PDF</option>
          </select>
        </div> -->
          <!-- <div class="field">
          <label>ุฎูุงุฑุงุช ุงูุฅุถุงูุฉ</label>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <label style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" id="includeTerms" checked />
              <span>ุฅุฏุฑุงุฌ ุงูุดุฑูุท ูุงูุจููุฏ ุงููุญุฏุฏุฉ</span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" id="includeSignatures" checked />
              <span>ุฅุฏุฑุงุฌ ูุณุงุญุงุช ุงูุชูููุน</span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" id="includeQrCode" checked />
              <span>ุฅุฏุฑุงุฌ ููุฏ QR ููุชุญูู ูู ุงูุนูุฏ</span>
            </label>
          </div>
        </div> -->
          <!-- </div> -->

          <div class="row">
            <!-- <div class="field">
          <label>ุชูุนูู ุงููุตุงุฏูุฉ ุงูุซูุงุฆูุฉ</label>
          <select id="authMethod" style="width:100%;">
            <option value="email_only">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุท</option>
            <option value="email_code">ุงูุจุฑูุฏ + ุฑูุฒ ุงูุชุญูู</option>
            <option value="phone_code">ุงูุฌูุงู + ุฑูุฒ ุงูุชุญูู</option>
            <option value="id_verification">ุงูุจุฑูุฏ + ุชุญูู ุงููููุฉ</option>
          </select>
          <div class="muted" style="font-size:12px">ูุฒูุงุฏุฉ ุฃูุงู ุงูุชูููุน ูููุน ุงูุชูุงุนุจ</div>
        </div> -->
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px;">
            <button class="btn" id="cancelSigningBtn">ุฅูุบุงุก</button>
            <button class="btn primary" id="confirmSendBtn">ุชุฃููุฏ ุงูุฅุฑุณุงู</button>
          </div>
        </div>
      </div>

      <!-- Fullscreen A4 Document Editor Modal -->
      <div id="a4EditorModal" class="a4-editor-modal" role="dialog" aria-hidden="true">
        <div class="a4-editor-content">
          <div class="a4-editor-header">
            <h3 id="a4EditorTitle">๐ ูุญุฑุฑ ุงููุณุชูุฏ - ูุต ุงูุจูุฏ</h3>
            <div style="display:flex;gap:8px;">
              <button class="btn primary" id="saveTermFullscreenBtn">ุญูุธ ุงูุจูุฏ</button>
              <button class="btn" id="newTermFullscreenBtn">ุฌุฏูุฏ</button>
              <button class="a4-editor-close" id="closeA4EditorBtn">โ ุฅุบูุงู</button>
            </div>
          </div>

          <div class="a4-paper-container">
            <div class="a4-paper">
              <div id="termContentFullscreen"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Management Modal -->
      <div id="usersModal" class="map-modal" role="dialog" aria-hidden="true" style="display:none;">
        <div class="map-modal-content" style="max-width:700px;">
          <h4>ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</h4>
          <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;">
              <thead>
                <tr style="background:#f8f9fa;text-align:right;">
                  <th style="padding:10px;">ID</th>
                  <th style="padding:10px;">ุงุณู ุงููุณุชุฎุฏู</th>
                  <th style="padding:10px;">ุงูุงุณู ุงูุธุงูุฑ</th>
                  <th style="padding:10px;">ุงูุฏูุฑ</th>
                  <th style="padding:10px;">ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                  <!-- <th style="padding:10px;">ุฅุฌุฑุงุกุงุช</th> -->
                </tr>
              </thead>
              <tbody id="usersListTbody"></tbody>
            </table>
          </div>
          <div style="margin-top:20px;display:flex;justify-content:flex-end;">
            <button class="btn" id="closeUsersModalBtn">ุฅุบูุงู</button>
          </div>
        </div>
      </div>

    </div>

    <!-- Manager/Collector Management Modal -->
    <div id="listManagementModal" class="map-modal" role="dialog" aria-hidden="true" style="display:none;">
      <div class="map-modal-content" style="max-width:600px;">
        <h4 id="listManagementTitle">ุฅุฏุงุฑุฉ ุงููุงุฆูุฉ</h4>

        <div style="margin-bottom:20px;">
          <h5 style="margin-bottom:12px;">ุงููุงุฆูุฉ ุงูุญุงููุฉ</h5>
          <div id="currentListItems"
            style="max-height:300px;overflow-y:auto;border:1px solid #e6ecf8;padding:12px;border-radius:8px;background:#fff;">
          </div>
        </div>

        <div style="margin-bottom:20px;">
          <h5 style="margin-bottom:12px;">ุฅุถุงูุฉ ุฌุฏูุฏ</h5>
          <div style="display:flex;gap:8px;">
            <input id="newListItemInput" placeholder="ุฃุฏุฎู ุงูุงุณู..."
              style="flex:1;padding:10px;border-radius:8px;border:1px solid #e0e6ef" />
            <button class="btn primary" id="addListItemBtn">ุฅุถุงูุฉ</button>
          </div>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;">
          <button class="btn" id="closeListManagementBtn">ุฅุบูุงู</button>
        </div>
      </div>
    </div>

    <script>

      // Global closeModal function
      window.closeModal = function (modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'none';
      };

      // Final integrated index.html: Google Maps paste-based picker (no API key required).
      console.log('โ INDEX.HTML LOADED - VERSION: 2025-12-06-02:30 - PRICING TERM FEATURE ACTIVE');
      document.addEventListener('DOMContentLoaded', () => {
        const API_BASE = '/api';
        let token = null; // Local reference
        window.authToken = null; // Global reference for other script blocks
        let currentPickerTarget = null; // 'container' or 'pickup'

        // Initialize Socket.io
        window.socket = io();

        const $ = id => document.getElementById(id);
        const showElem = el => {
          if (!el) return;
          // Fix: All Modals should use flex for proper centering and layout
          const isModal = el.classList.contains('modal') || el.classList.contains('map-modal') || el.id.toLowerCase().includes('modal');
          el.style.display = isModal ? 'flex' : 'block';
          el.setAttribute('aria-hidden', 'false');
        };
        const hideElem = el => { if (!el) return; el.style.display = 'none'; el.setAttribute('aria-hidden', 'true'); };

        // --- GLOBAL EXPOSURE (Early) ---
        // Expose critical functions early to prevent "onclick" failures during slow initialization
        window.openView = async function (id) { await openView(id); };
        window.openEdit = async function (id) { await openEdit(id); };
        window.openRenew = async function (id) { await openRenew(id); };
        window.updateStatus = async function (id, s) { await updateStatus(id, s); };
        window.loadContracts = async function () { await loadContracts(); };
        window.closeModal = function (id) {
          const el = document.getElementById(id);
          if (el) {
            el.style.display = 'none';
            el.setAttribute('aria-hidden', 'true');
          }
        };
        console.log('โ Critical handlers exposed globally');

        // double-guard hide
        hideElem($('formWrap'));
        hideElem($('mapModal'));

        // Click outside to close all modals
        document.addEventListener('click', function (e) {
          // Check if click target has class 'modal' (the backdrop)
          if (e.target.classList && e.target.classList.contains('modal')) {
            hideElem(e.target);
          }
        });

        // Escape key to close all modals and trigger cancel buttons
        document.addEventListener('keydown', function (e) {
          // High priority: Close notification overlay if visible
          if ($('notifOverlay') && $('notifOverlay').style.display === 'flex') {
            if (e.key === 'Escape' || e.key === 'Enter') {
              e.preventDefault();
              stopCurrentNotif();
              return;
            }
          }

          if (e.key === 'Escape') {
            // First try to close visible modals
            const modals = document.querySelectorAll('.modal');
            let closedAny = false;
            modals.forEach(modal => {
              if (modal.style.display !== 'none' && modal.style.display !== '') {
                hideElem(modal);
                closedAny = true;
              }
            });

            // If no modal was closed, try clicking cancel/close buttons
            if (!closedAny) {
              // Find all visible cancel buttons (ุฅูุบุงุก)
              const cancelButtons = document.querySelectorAll('button');
              for (const btn of cancelButtons) {
                if (btn.textContent.includes('ุฅูุบุงุก') && btn.offsetParent !== null) {
                  btn.click();
                  break;
                }
              }
            }
          }
        });

        // Theme Switcher Function
        window.switchTheme = function (themeName) {
          const themeLink = document.querySelector('link[href*="theme-"]');
          if (themeLink) {
            themeLink.href = 'styles/' + themeName;
            // Save preference to localStorage
            localStorage.setItem('selectedTheme', themeName);
            console.log('Theme switched to:', themeName);
          }
        };

        // Load saved theme on page load
        const savedTheme = localStorage.getItem('selectedTheme');
        if (savedTheme) {
          const themeLink = document.querySelector('link[href*="theme-"]');
          if (themeLink) {
            themeLink.href = 'styles/' + savedTheme;
          }
        }

        // --- Initialize Quill Editor ---
        // Register custom font sizes
        var Size = Quill.import('attributors/style/size');
        var customSizes = ['8px', '10px', '12px', '14px', '16px', '18px', '20px', '24px', '30px', '36px', '48px', '60px', '72px'];
        Size.whitelist = customSizes;
        Quill.register(Size, true);

        var quill = new Quill('#termContent', {
          theme: 'snow',
          modules: {
            toolbar: [
              [{ 'header': [1, 2, 3, false] }],
              [{ 'size': customSizes }],
              ['bold', 'italic', 'underline'],
              [{ 'list': 'ordered' }, { 'list': 'bullet' }],
              [{ 'align': '' }, { 'align': 'center' }, { 'align': 'right' }, { 'align': 'justify' }],
              [{ 'direction': 'rtl' }],
              [{ 'color': [] }, { 'background': [] }],
              ['clean']
            ]
          }
        });
        // Expose quill globally for live updates
        window.quill = quill;

        // Initialize fullscreen Quill editor
        var quillFullscreen = new Quill('#termContentFullscreen', {
          theme: 'snow',
          modules: {
            toolbar: [
              [{ 'header': [1, 2, 3, false] }],
              [{ 'size': customSizes }],
              ['bold', 'italic', 'underline'],
              [{ 'list': 'ordered' }, { 'list': 'bullet' }],
              [{ 'align': '' }, { 'align': 'center' }, { 'align': 'right' }, { 'align': 'justify' }],
              [{ 'direction': 'rtl' }],
              [{ 'color': [] }, { 'background': [] }],
              ['clean']
            ]
          }
        });

        // Fullscreen Editor Modal Handlers
        const a4EditorModal = document.getElementById('a4EditorModal');
        const openFullscreenBtn = document.getElementById('openFullscreenEditorBtn');
        const closeFullscreenBtn = document.getElementById('closeA4EditorBtn');

        openFullscreenBtn.addEventListener('click', function () {
          // Sync content from main editor to fullscreen editor
          quillFullscreen.root.innerHTML = quill.root.innerHTML;

          // Show fullscreen modal
          a4EditorModal.classList.add('active');
          document.body.style.overflow = 'hidden'; // Prevent background scrolling
        });

        closeFullscreenBtn.addEventListener('click', function () {
          // Sync content from fullscreen editor back to main editor
          quill.root.innerHTML = quillFullscreen.root.innerHTML;

          // Hide fullscreen modal
          a4EditorModal.classList.remove('active');
          document.body.style.overflow = ''; // Restore scrolling
        });

        // Close on ESC key
        document.addEventListener('keydown', function (e) {
          if (e.key === 'Escape' && a4EditorModal.classList.contains('active')) {
            closeFullscreenBtn.click();
          }
        });

        // Close on backdrop click
        a4EditorModal.addEventListener('click', function (e) {
          if (e.target === a4EditorModal) {
            closeFullscreenBtn.click();
          }
        });

        // Fullscreen Save/New Buttons
        const saveFullscreenBtn = document.getElementById('saveTermFullscreenBtn');
        const newFullscreenBtn = document.getElementById('newTermFullscreenBtn');

        saveFullscreenBtn.addEventListener('click', function () {
          // Sync content back to main editor
          quill.root.innerHTML = quillFullscreen.root.innerHTML;
          // Trigger main save button
          document.getElementById('saveTermBtn').click();
        });

        newFullscreenBtn.addEventListener('click', function () {
          // Trigger main new button
          document.getElementById('newTermBtn').click();
          // Sync cleared content to fullscreen editor
          quillFullscreen.root.innerHTML = quill.root.innerHTML;
          // Also clear inputs in fullscreen if we want to reflect that (though inputs are not in fullscreen)
          // The main newTermBtn clears the form, so syncing quill is enough for the editor part.
        });

        // --- LocalStorage Helpers ---
        const STORAGE_KEY_CONTRACTS = 'clean_service_contracts_v1';
        const STORAGE_KEY_CLIENTS = 'clean_service_clients_v1';
        const STORAGE_KEY_USERS = 'clean_service_users_v1';

        function getStoredData(key) {
          try {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
          } catch (e) {
            console.error('Error reading from localStorage', e);
            return [];
          }
        }

        function setStoredData(key, data) {
          try {
            localStorage.setItem(key, JSON.stringify(data));
          } catch (e) {
            console.error('Error writing to localStorage', e);
            alert('ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู (ุงููุณุงุญุฉ ููุชูุฆุฉุ)');
          }
        }

        // Mock apiFetch for compatibility with existing Terms logic if needed, 
        // but we will try to rely on local storage helpers for main logic.
        // --- API helper ---
        // CRITICAL: Make apiFetch global so it can be accessed from other script blocks
        window.apiFetch = async function apiFetch(path, opts = {}) {
          console.log(`[API] Request: ${path}`, opts.method || 'GET');
          opts.headers = opts.headers || {};
          if (!opts.headers['Content-Type'] && !(opts.body instanceof FormData)) opts.headers['Content-Type'] = 'application/json';
          // Check both local and global token for cross-script compatibility
          const authToken = token || window.authToken;
          if (authToken) opts.headers['Authorization'] = 'Bearer ' + authToken;
          try {
            const res = await fetch(API_BASE + path, opts);
            console.log(`[API] Response: ${path} Status: ${res.status}`);
            if (res.status === 401) { alert('ูุทููุจ ุชุณุฌูู ุงูุฏุฎูู ุฃู ุงูุฑูุฒ ููุชูู'); throw new Error('unauth'); }
            const data = await res.json().catch(() => null);
            if (!res.ok) throw new Error((data && data.message) || res.statusText);
            return data;
          } catch (err) {
            console.error(`[API] Error: ${path}`, err);
            throw err;
          }
        }

        // --- Number to Arabic Text Converter ---
        function numberToArabicText(num) {
          if (!num || isNaN(num)) return '';

          num = Math.round(num);
          if (num === 0) return 'ุตูุฑ';
          if (num < 0) return 'ุณุงูุจ ' + numberToArabicText(Math.abs(num));

          const ones = ['', 'ูุงุญุฏ', 'ุงุซูุงู', 'ุซูุงุซุฉ', 'ุฃุฑุจุนุฉ', 'ุฎูุณุฉ', 'ุณุชุฉ', 'ุณุจุนุฉ', 'ุซูุงููุฉ', 'ุชุณุนุฉ'];
          const tens = ['', '', 'ุนุดุฑูู', 'ุซูุงุซูู', 'ุฃุฑุจุนูู', 'ุฎูุณูู', 'ุณุชูู', 'ุณุจุนูู', 'ุซูุงููู', 'ุชุณุนูู'];
          const teens = ['ุนุดุฑุฉ', 'ุฃุญุฏ ุนุดุฑ', 'ุงุซูุง ุนุดุฑ', 'ุซูุงุซุฉ ุนุดุฑ', 'ุฃุฑุจุนุฉ ุนุดุฑ', 'ุฎูุณุฉ ุนุดุฑ', 'ุณุชุฉ ุนุดุฑ', 'ุณุจุนุฉ ุนุดุฑ', 'ุซูุงููุฉ ุนุดุฑ', 'ุชุณุนุฉ ุนุดุฑ'];
          const hundreds = ['', 'ูุงุฆุฉ', 'ูุฆุชุงู', 'ุซูุงุซูุงุฆุฉ', 'ุฃุฑุจุนูุงุฆุฉ', 'ุฎูุณูุงุฆุฉ', 'ุณุชูุงุฆุฉ', 'ุณุจุนูุงุฆุฉ', 'ุซูุงููุงุฆุฉ', 'ุชุณุนูุงุฆุฉ'];

          function convertLessThanThousand(n) {
            if (n === 0) return '';

            let result = '';

            // Hundreds
            const h = Math.floor(n / 100);
            if (h > 0) {
              result += hundreds[h];
              n %= 100;
              if (n > 0) result += ' ู';
            }

            // Tens and ones
            if (n >= 10 && n <= 19) {
              result += teens[n - 10];
            } else {
              const t = Math.floor(n / 10);
              const o = n % 10;

              if (t > 0) {
                result += tens[t];
                if (o > 0) result += ' ู';
              }

              if (o > 0) {
                result += ones[o];
              }
            }

            return result;
          }

          if (num < 1000) {
            return convertLessThanThousand(num);
          }

          // Thousands
          if (num < 1000000) {
            const thousands = Math.floor(num / 1000);
            const remainder = num % 1000;

            let result = '';
            if (thousands === 1) {
              result = 'ุฃูู';
            } else if (thousands === 2) {
              result = 'ุฃููุงู';
            } else if (thousands >= 3 && thousands <= 10) {
              result = convertLessThanThousand(thousands) + ' ุขูุงู';
            } else {
              result = convertLessThanThousand(thousands) + ' ุฃูู';
            }

            if (remainder > 0) {
              result += ' ู' + convertLessThanThousand(remainder);
            }

            return result;
          }

          // Millions
          const millions = Math.floor(num / 1000000);
          const remainder = num % 1000000;

          let result = '';
          if (millions === 1) {
            result = 'ููููู';
          } else if (millions === 2) {
            result = 'ูููููุงู';
          } else {
            result = convertLessThanThousand(millions) + ' ููููู';
          }

          if (remainder > 0) {
            result += ' ู' + numberToArabicText(remainder);
          }

          return result;
        }

        // --- Pricing Term Management ---
        const PRICING_TERM_ID = 'pricing_term_auto';

        async function ensurePricingTerm() {
          try {
            console.log('๐ [DEBUG] ensurePricingTerm: Starting...');

            // Check localStorage first (more reliable)
            const localTerms = loadLocalTerms();
            const existingLocalTerm = localTerms.find(t => (t.id || t._id) === PRICING_TERM_ID);

            if (!existingLocalTerm) {
              console.log('๐ [DEBUG] ensurePricingTerm: Term not in localStorage, creating it');
              // Create the pricing term
              const newTerm = {
                id: PRICING_TERM_ID,
                name: 'ูููุฉ ุงูุนูุฏ',
                type: 'text',
                content: 'ุณูุชู ุชุญุฏูุซ ูุฐุง ุงูุจูุฏ ุชููุงุฆูุงู ูู ููู ุงูุนูุฏ',
                isDefault: true
              };

              // Save to localStorage first
              localTerms.push(newTerm);
              saveLocalTerms(localTerms);
              console.log('โ [DEBUG] ensurePricingTerm: Term saved to localStorage');

              // Try API as well (but don't fail if it doesn't work)
              try {
                await saveTerm(newTerm);
                console.log('โ [DEBUG] ensurePricingTerm: Term also saved to API');
              } catch (err) {
                console.log('โ๏ธ [DEBUG] ensurePricingTerm: API save failed (this is OK, using localStorage):', err.message);
              }
            } else {
              console.log('โ [DEBUG] ensurePricingTerm: Term already exists in localStorage');
            }
          } catch (err) {
            console.error('โ [DEBUG] ensurePricingTerm: Error:', err);
          }
        }

        async function updatePricingTermContent() {
          try {
            console.log('๐ [DEBUG] updatePricingTermContent: Starting...');
            // Get values from form
            const monthlyFeeInput = $('monthlyFee')?.value || '0';
            const taxInput = $('tax')?.value || '15%';
            const totalPriceInput = $('totalPrice')?.value || '0';
            const duration = $('duration')?.value || 'ุณููู';
            const paymentType = $('paymentType')?.value || 'ุณูููุฉ';
            const dateFrom = $('dateFrom')?.value;
            const dateTo = $('dateTo')?.value;

            console.log('๐ [DEBUG] updatePricingTermContent: Form values:', { monthlyFeeInput, taxInput, totalPriceInput, duration, paymentType });

            // Parse values
            const monthlyFee = parseFloat(monthlyFeeInput) || 0;
            const taxRateStr = (taxInput || '').toString().replace('%', '').trim();
            const taxRate = taxRateStr === '' ? 15 : (parseFloat(taxRateStr) || 0);
            const totalPrice = parseFloat(totalPriceInput) || 0;

            // Calculate Monthly Total (Fee + Tax)
            const monthlyTax = (monthlyFee * taxRate) / 100;
            const monthlyTotal = Math.round(monthlyFee + monthlyTax);

            // Calculate Contract Total (already total price from form, which includes duration)
            const contractTotal = Math.round(totalPrice);

            // Convert to Arabic text
            const monthlyTotalText = numberToArabicText(monthlyTotal);
            const contractTotalText = numberToArabicText(contractTotal);

            // 1. Monthly Clause
            // "1- ูููุฉ ูุฐุง ุงูุนูุฏ ุดูุฑูุง ูุจูุบ ููุฏุฑู (MonthlyTotal) ArabicTotal ุฑูุงู ููุท ุดุงูู ุงูุถุฑูุจุฉ ุงููุถุงูุฉ (15%)"
            const clause1 = `1- ูููุฉ ูุฐุง ุงูุนูุฏ ุดูุฑูุง ูุจูุบ ููุฏุฑู (${monthlyTotal} ุฑูุงู) ${monthlyTotalText} ุฑูุงู ููุท ุดุงูู ุงูุถุฑูุจุฉ ุงููุถุงูุฉ (${taxRate}%)`;

            // 2. Annual/Duration Clause
            // Determine duration text
            let durationText = 'ุณูููุง';
            if (duration === '6 ุฃุดูุฑ') durationText = 'ููุฏุฉ ุณุชุฉ ุฃุดูุฑ';
            else if (duration === '3 ุฃุดูุฑ') durationText = 'ููุฏุฉ ุซูุงุซุฉ ุฃุดูุฑ';
            else if (duration === 'ุฏูุนุฉ ูุงุญุฏุฉ') durationText = 'ุฅุฌูุงูุงู';

            const clause2 = `2- ูููุฉ ูุฐุง ุงูุนูุฏ ${durationText} ูุจูุบ ููุฏุฑู (${contractTotal} ุฑูุงู) ${contractTotalText} ุฑูุงู ููุท ุดุงูู ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ (${taxRate}%)`;

            // 3. Payment Terms Clause
            // Determine payment text based on selection
            let paymentTermsText = '';
            if (paymentType === 'ุฏูุนุชูู 50% ู 50%') {
              paymentTermsText = 'ุนูู ุฏูุนุชูู 50% ุนูุฏ ุชูููุน ุงูุนูุฏ ู 50% ุจุนุฏ ุณุชุฉ ุฃุดูุฑ';
            } else if (paymentType === 'ุณูููุฉ') {
              paymentTermsText = 'ุนูู ุฏูุนุฉ ูุงุญุฏุฉ ุณูููุงู';
            } else if (paymentType === 'ูู 6 ุฃุดูุฑ') {
              paymentTermsText = 'ุนูู ุฏูุนุงุช ูุตู ุณูููุฉ';
            } else if (paymentType === 'ูู 3 ุฃุดูุฑ') {
              paymentTermsText = 'ุนูู ุฏูุนุงุช ุฑุจุน ุณูููุฉ';
            } else if (paymentType === 'ุฏูุนุฉ ูุงุญุฏุฉ') {
              paymentTermsText = 'ุฏูุนุฉ ูุงุญุฏุฉ';
            } else {
              paymentTermsText = paymentType;
            }

            const clause3 = `3- ุงุชูู ุงูุทุฑูุงู ุนูู ุฃู ูุชู ุณุฏุงุฏ ูููุฉ ูุฐุง ุงูุนูุฏ ${paymentTermsText}ุ ููุชู ุชุญููู ุฏูุนุงุช ุงูุนูุฏ ุนูู ุญุณุงุจ ูุคุณุณุฉ ุจูุช ููููุงููุงุชุ ูุตุฑู ุงูุฑุงุฌุญู ุฑูู ุงูุงูุจุงู (SA8680000193608010458724)`;

            // The new "Calculated Block"
            const newCalcBlock = `${clause1}\n${clause2}\n${clause3}`;

            // Preserve existing Content if it was manually edited
            const existingTerm = loadLocalTerms().find(t => (t.id || t._id) === PRICING_TERM_ID);
            const termName = existingTerm ? existingTerm.name : 'ูููุฉ ุงูุนูุฏ';

            let finalContent = newCalcBlock;

            if (existingTerm && existingTerm.content) {
              const oldContent = existingTerm.content;

              // Check if content has HTML formatting (starts with < tag)
              const hasFormatting = oldContent.trim().startsWith('<');

              if (hasFormatting) {
                // PRESERVE FORMATTING: Update only the numbers in the HTML
                console.log('โ Preserving HTML formatting, updating only numbers.');

                let updatedContent = oldContent;

                // Update Monthly Total (First occurrence of price in parentheses)
                // Pattern: (number ุฑูุงู) in clause 1
                updatedContent = updatedContent.replace(
                  /(\(\s*)\d+(\s*ุฑูุงู\))/,
                  `$1${monthlyTotal}$2`
                );

                // Update Monthly Total Arabic Text
                // Pattern: Arabic text before "ุฑูุงู ููุท ุดุงูู"
                updatedContent = updatedContent.replace(
                  /(ููุฏุฑู \(\d+ ุฑูุงู\)\s+)[\u0600-\u06FF\s]+(\s+ุฑูุงู ููุท ุดุงูู ุงูุถุฑูุจุฉ)/,
                  `$1${monthlyTotalText}$2`
                );

                // Update Tax Rate in clause 1 (first occurrence)
                updatedContent = updatedContent.replace(
                  /(ุงูุถุฑูุจุฉ ุงููุถุงูุฉ \()\d+(%\))/,
                  `$1${taxRate}$2`
                );

                // Update Annual/Contract Total (Second occurrence of price in parentheses)
                // We need to target specifically the second clause
                const clause2Regex = /2-.*?ููุฏุฑู \(\s*\d+\s*ุฑูุงู\)/;
                updatedContent = updatedContent.replace(
                  clause2Regex,
                  (match) => match.replace(/\d+(?=\s*ุฑูุงู\))/, contractTotal)
                );

                // Update Annual Total Arabic Text
                updatedContent = updatedContent.replace(
                  /(2-.*?ููุฏุฑู \(\d+ ุฑูุงู\)\s+)[\u0600-\u06FF\s]+(\s+ุฑูุงู ููุท ุดุงูู)/,
                  `$1${contractTotalText}$2`
                );

                // Update Tax Rate in clause 2
                updatedContent = updatedContent.replace(
                  /(ุงููููุฉ ุงููุถุงูุฉ \()\d+(%\))/,
                  `$1${taxRate}$2`
                );

                finalContent = updatedContent;

              } else {
                // SURGICAL REPLACEMENT: Update each clause separately to preserve surrounding text
                let updatedContent = oldContent;

                // Patterns for individual clauses
                const r1 = /1-\s*ูููุฉ ูุฐุง ุงูุนูุฏ ุดูุฑูุง[\s\S]*?(?=\n\s*2-|$)/;
                const r2 = /2-\s*ูููุฉ ูุฐุง ุงูุนูุฏ (ุณูููุง|ููุฏุฉ|ุฅุฌูุงูุง)[\s\S]*?(?=\n\s*3-|$)/;
                const r3 = /3-\s*ุงุชูู ุงูุทุฑูุงู ุนูู[\s\S]*?(?=ูุตุฑู ุงูุฑุงุฌุญู ุฑูู ุงูุงูุจุงู|$)/;
                const rIban = /ูุตุฑู ุงูุฑุงุฌุญู ุฑูู ุงูุงูุจุงู\s*\(SA8680000193608010458724\)/;

                let foundSomething = false;

                if (r1.test(updatedContent)) {
                  updatedContent = updatedContent.replace(r1, clause1 + (updatedContent.match(r1)[0].endsWith('\n') ? '' : '\n'));
                  foundSomething = true;
                }
                if (r2.test(updatedContent)) {
                  updatedContent = updatedContent.replace(r2, clause2 + (updatedContent.match(r2)[0].endsWith('\n') ? '' : '\n'));
                  foundSomething = true;
                }
                if (r3.test(updatedContent)) {
                  // For clause 3, we try to preserve the IBAN part separately if possible
                  if (rIban.test(updatedContent)) {
                    updatedContent = updatedContent.replace(r3, clause3.replace(rIban, '')); // We'll let the IBAN match handle its part if we wanted, but clause 3 has it too.
                  } else {
                    updatedContent = updatedContent.replace(r3, clause3);
                  }
                  foundSomething = true;
                }

                if (foundSomething) {
                  finalContent = updatedContent;
                  console.log('โ Surgically updated pricing clauses. Manual text preserved.');
                } else {
                  // Fallback to the broad regex if individual ones fail
                  const pricingBlockRegex = /1- ูููุฉ ูุฐุง ุงูุนูุฏ ุดูุฑูุง ูุจูุบ ููุฏุฑู[\s\S]*?ูุตุฑู ุงูุฑุงุฌุญู ุฑูู ุงูุงูุจุงู \(SA8680000193608010458724\)/;
                  if (pricingBlockRegex.test(oldContent)) {
                    console.log('โ Found broad pricing block. Replacing.');
                    finalContent = oldContent.replace(pricingBlockRegex, newCalcBlock);
                  } else {
                    console.warn('โ๏ธ Could not find pricing clauses in content. Appending calculations.');
                    finalContent = oldContent.trim() + '\n\n' + newCalcBlock;
                  }
                }
              }
            }
            // Update the term
            const updatedTerm = {
              id: PRICING_TERM_ID,
              name: termName,
              type: 'text',
              content: finalContent,
              isDefault: true
            };

            console.log('๐ [DEBUG] updatePricingTermContent: Content generated:', finalContent.substring(0, 100) + '...');

            // Always update localStorage first (more reliable)
            const localTerms = loadLocalTerms();
            const idx = localTerms.findIndex(t => (t.id || t._id) === PRICING_TERM_ID);
            if (idx >= 0) {
              localTerms[idx] = updatedTerm;
              console.log('โ [DEBUG] updatePricingTermContent: Updated term in localStorage at index', idx);
            } else {
              console.log('โ๏ธ [DEBUG] updatePricingTermContent: Term not found in localStorage, adding it');
              localTerms.push(updatedTerm);
            }
            saveLocalTerms(localTerms);
            console.log('โ [DEBUG] updatePricingTermContent: Term saved to localStorage');

            // Try API as well (but don't fail if it doesn't work)
            try {
              await updateTerm(PRICING_TERM_ID, updatedTerm);
              console.log('โ [DEBUG] updatePricingTermContent: Term also updated via API');
            } catch (err) {
              console.log('โ๏ธ [DEBUG] updatePricingTermContent: API update failed (this is OK, using localStorage):', err.message);
            }

            return finalContent;
          } catch (err) {
            console.error('โ [DEBUG] updatePricingTermContent: Error:', err);
            return null;
          }
        }

        // --- Manager/Collector Management ---
        const STORAGE_MANAGERS = 'managers_list';
        const STORAGE_COLLECTORS = 'collectors_list';
        let currentManagementType = null; // 'managers' or 'collectors'

        // Global variables for table sorting
        let contractsData = [];
        let currentSortColumn = '';
        let currentSortDirection = 'asc';

        // Load managers/collectors from localStorage
        function loadList(type) {
          const storageKey = type === 'managers' ? STORAGE_MANAGERS : STORAGE_COLLECTORS;
          const stored = localStorage.getItem(storageKey);
          return stored ? JSON.parse(stored) : [];
        }

        // Save list to localStorage
        function saveList(type, list) {
          const storageKey = type === 'managers' ? STORAGE_MANAGERS : STORAGE_COLLECTORS;
          localStorage.setItem(storageKey, JSON.stringify(list));
        }

        // Initialize lists from DB if empty
        async function initializeDropdownLists() {
          // Check if lists exist
          const managers = loadList('managers');
          const collectors = loadList('collectors');

          if (managers.length === 0 || collectors.length === 0) {
            try {
              // Fetch all contracts to extract unique values
              const contracts = await apiFetch('/contracts');
              if (contracts && Array.isArray(contracts)) {
                if (managers.length === 0) {
                  const uniqueManagers = [...new Set(contracts.map(c => c.manager).filter(Boolean))];
                  saveList('managers', uniqueManagers);
                }
                if (collectors.length === 0) {
                  const uniqueCollectors = [...new Set(contracts.map(c => c.collector).filter(Boolean))];
                  saveList('collectors', uniqueCollectors);
                }
              }
            } catch (err) {
              console.warn('Failed to initialize lists from DB:', err);
            }
          }
          populateDropdown('managers');
          populateDropdown('collectors');
        }

        // Populate dropdown
        function populateDropdown(type) {
          const list = loadList(type);
          const selectEl = $(type === 'managers' ? 'manager' : 'collector');
          if (!selectEl) return;

          const currentValue = selectEl.value;
          selectEl.innerHTML = '<option value="">-- ุงุฎุชุฑ --</option>';
          list.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            opt.textContent = item;
            selectEl.appendChild(opt);
          });

          // Restore selection if it still exists
          if (currentValue && list.includes(currentValue)) {
            selectEl.value = currentValue;
          }
        }

        // Open management modal
        function openManagementModal(type) {
          console.log('๐ [DEBUG] Opening management modal for:', type);
          currentManagementType = type;
          const title = type === 'managers' ? 'ุฅุฏุงุฑุฉ ุงููุณูููู' : 'ุฅุฏุงุฑุฉ ุงููุญุตููู';
          if ($('listManagementTitle')) $('listManagementTitle').textContent = title;
          renderListItems();
          const modal = $('listManagementModal');
          if (modal) {
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden', 'false');
            console.log('โ [DEBUG] Modal displayed');
          } else {
            console.error('โ [DEBUG] Modal listManagementModal not found!');
          }
        }

        // Render list items
        function renderListItems() {
          if (!currentManagementType) return;
          const list = loadList(currentManagementType);
          const container = $('currentListItems');
          if (!container) return;

          if (list.length === 0) {
            container.innerHTML = '<div class="muted">ูุง ุชูุฌุฏ ุนูุงุตุฑ</div>';
            return;
          }

          container.innerHTML = '';
          list.forEach((item, index) => {
            const div = document.createElement('div');
            div.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eef4ff;';
            div.innerHTML = `
            <span>${item}</span>
            <button class="btn small" style="background:#f8d7da;border-color:#f5c6cb;color:#721c24;" data-index="${index}">ุญุฐู</button>
          `;
            container.appendChild(div);
          });

          // Attach delete handlers
          container.querySelectorAll('button[data-index]').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const index = parseInt(e.target.getAttribute('data-index'));
              deleteListItem(index);
            });
          });
        }

        // Add new item
        function addListItem() {
          if (!currentManagementType) return;
          const input = $('newListItemInput');
          if (!input) return;

          const newItem = input.value.trim();
          if (!newItem) {
            alert('ูุฑุฌู ุฅุฏุฎุงู ุงูุงุณู');
            return;
          }

          const list = loadList(currentManagementType);
          if (list.includes(newItem)) {
            alert('ูุฐุง ุงูุงุณู ููุฌูุฏ ูุณุจูุงู');
            return;
          }

          list.push(newItem);
          saveList(currentManagementType, list);
          populateDropdown(currentManagementType);
          renderListItems();
          input.value = '';
        }

        // Delete item
        function deleteListItem(index) {
          if (!currentManagementType) return;
          if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุญุฐู ูู ุงููุงุฆูุฉุ (ูู ูุชู ุญุฐู ุงูุจูุงูุงุช ูู ุงูุนููุฏ ุงููุฏููุฉ)')) return;

          const list = loadList(currentManagementType);
          list.splice(index, 1);
          saveList(currentManagementType, list);
          populateDropdown(currentManagementType);
          renderListItems();
        }

        // Event Listeners for Management
        // NOTE: manageManagersBtn and manageCollectorsBtn handlers are defined at end of file
        // in the employees management section using the API-based openEmployeesModal function.
        // Do NOT add duplicate handlers here.

        const addListItemBtn = $('addListItemBtn');
        if (addListItemBtn) {
          addListItemBtn.addEventListener('click', addListItem);
        }

        const newListItemInput = $('newListItemInput');
        if (newListItemInput) {
          newListItemInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              addListItem();
            }
          });
        }

        const closeListManagementBtn = $('closeListManagementBtn');
        if (closeListManagementBtn) {
          closeListManagementBtn.addEventListener('click', () => {
            const modal = $('listManagementModal');
            if (modal) {
              modal.style.display = 'none';
              modal.setAttribute('aria-hidden', 'true');
            }
            currentManagementType = null;
          });
        }

        $('loginBtn').addEventListener('click', async () => {
          try {
            const username = $('username').value;
            const password = $('password').value;
            const res = await fetch(API_BASE + '/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
            const json = await res.json();
            if (!res.ok) { $('authMsg').textContent = json.message || 'ุฎุทุฃ'; return; }
            token = json.token;
            window.authToken = json.token; // Make globally accessible
            const user = json.user;
            // Store visible user info globally for permission checks
            window.currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(user));
            localStorage.setItem('token', token);
            $('authMsg').textContent = 'ูุฑุญุจุงู ' + (user.display_name || user.username);

            // Register with Socket.io
            if (window.socket) {
              window.socket.emit('register', user.username);
            }
            if ($('logoutBtn')) $('logoutBtn').style.display = 'inline-block';
            if ($('userInfoDisplay')) {
              $('userInfoDisplay').style.display = 'flex';
              $('currentUserNameLabel').textContent = user.display_name || user.username;
            }
            if ($('mainDashboardContainer')) $('mainDashboardContainer').style.display = 'block';
            if ($('dashboardSidebar')) $('dashboardSidebar').style.display = 'block';
            if ($('authBox')) $('authBox').style.display = 'none';

            await loadServices();
            await initializeDropdownLists();
            await loadContracts();

            // Permission Check: Hide Management Buttons for non-admins
            const isAdmin = user.role && user.role.trim().toLowerCase() === 'admin';
            console.log('Checking permissions for user:', user.username, 'isAdmin:', isAdmin);

            if (!isAdmin) {
              if ($('manageManagersBtn')) $('manageManagersBtn').style.display = 'none';
              if ($('manageCollectorsBtn')) $('manageCollectorsBtn').style.display = 'none';
            } else {
              if ($('manageManagersBtn')) $('manageManagersBtn').style.display = 'inline-block';
              if ($('manageCollectorsBtn')) $('manageCollectorsBtn').style.display = 'inline-block';
            }

            // Show/Hide Manage Users Button
            if (user.role && user.role.trim().toLowerCase() === 'admin') {
              console.log('User is admin. Showing admin buttons.');
              $('manageUsersBtn').style.display = 'inline-block';
              $('createUserBtn').style.display = 'inline-block';
              $('reportsNavBtn').style.display = 'inline-block';
            } else {
              console.warn('User is NOT admin. Hiding admin buttons. Role seen:', user.role);
              $('manageUsersBtn').style.display = 'none';
              $('createUserBtn').style.display = 'none';
              $('reportsNavBtn').style.display = 'none';
            }

          } catch (err) {
            console.error(err);
            if (!window.currentUser) {
              alert('ุฎุทุฃ ูู ุชุณุฌูู ุงูุฏุฎูู: ' + err.message);
            }
          }
        });

        window.logout = function () {
          if (!confirm('ูู ุชุฑูุฏ ุชุณุฌูู ุงูุฎุฑูุฌุ')) return;

          // Clear all session data
          localStorage.removeItem('currentUser');
          localStorage.removeItem('token');
          token = null;
          window.currentUser = null;

          // Notify socket server if possible
          if (window.socket) {
            window.socket.emit('logout'); // Custom event or just disconnect
            window.socket.disconnect();
            // Reconnect for next user
            setTimeout(() => {
              window.socket = io();
            }, 500);
          }

          // Update UI
          if ($('authBox')) $('authBox').style.display = 'block';
          if ($('notifNavBtn')) $('notifNavBtn').style.display = 'none';
          if ($('reportsNavBtn')) $('reportsNavBtn').style.display = 'none';
          if ($('logoutBtn')) $('logoutBtn').style.display = 'none';
          if ($('formWrap')) $('formWrap').style.display = 'none';

          $('contractsArea').style.display = 'none';
          $('notificationsArea').style.display = 'none';
          $('reportsArea').style.display = 'none';

          // Hide dashboard panels and sidebar
          if ($('mainDashboardContainer')) $('mainDashboardContainer').style.display = 'block'; // Keep it block for authBox
          if ($('dashboardSidebar')) $('dashboardSidebar').style.display = 'none';
          if ($('userInfoDisplay')) $('userInfoDisplay').style.display = 'none';

          $('username').value = '';
          $('password').value = '';
          $('authMsg').textContent = 'ุชู ุชุณุฌูู ุงูุฎุฑูุฌ ุจูุฌุงุญ. ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ููุจุฏุก.';

          console.log('User logged out, session cleared.');
        };

        if ($('logoutBtn')) {
          $('logoutBtn').addEventListener('click', logout);
        }

        // Initialize on load
        loadServices();
        initializeDropdownLists();
        loadContracts();

        $('createUserBtn').addEventListener('click', async () => {
          const username = prompt('ุงุณู ุงููุณุชุฎุฏู ุงูุฌุฏูุฏ:', '');
          if (!username) return;
          const password = prompt('ูููุฉ ุงููุฑูุฑ:', '');
          let roleInput = prompt('ุงูุฏูุฑ - ุงุฎุชุฑ:\nadmin (ูุฏูุฑ - ูุงูู ุงูุตูุงุญูุงุช)\nstaff (ููุธู - ุฅุถุงูุฉ ูุชุนุฏูู ููุท ุจุฏูู ุญุฐู)', 'staff');

          // Sanitize role input to prevent truncation or invalid values
          let role = 'staff';
          if (roleInput && roleInput.toLowerCase().includes('admin')) {
            role = 'admin';
          }

          try {
            await apiFetch('/users', { method: 'POST', body: JSON.stringify({ username, password, role, display_name: username }) });
            alert('ุชู ุฅูุดุงุก ุงููุณุชุฎุฏู');
          } catch (err) { alert('ุฎุทุฃ: ' + err.message); }
        });



        // Manage Users
        $('manageUsersBtn').addEventListener('click', async () => {
          showElem($('usersModal'));
          loadUsersList();
        });

        $('closeUsersModalBtn').addEventListener('click', () => {
          hideElem($('usersModal'));
        });

        async function loadUsersList() {
          const tbody = $('usersListTbody');
          tbody.innerHTML = '<tr><td colspan="6">ุฌุงุฑู ุงูุชุญููู...</td></tr>';
          try {
            const users = await apiFetch('/users', { method: 'GET' });
            tbody.innerHTML = '';
            users.forEach(u => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                      <td style="padding:10px;border-bottom:1px solid #eee;">${u.id}</td>
                      <td style="padding:10px;border-bottom:1px solid #eee;font-weight:bold;">${u.username}</td>
                      <td style="padding:10px;border-bottom:1px solid #eee;">${u.display_name || '-'}</td>
                      <td style="padding:10px;border-bottom:1px solid #eee;"><span class="chip">${u.role}</span></td>
                      <td style="padding:10px;border-bottom:1px solid #eee;">${new Date(u.created_at).toLocaleDateString('en-GB')}</td>
                      <td style="padding:10px;border-bottom:1px solid #eee;">
                        ${u.username !== 'admin' ? `<button class="btn small" onclick="deleteUser(${u.id})" style="background:#ef4444;color:white;">ุญุฐู</button>` : ''}
                      </td>
                  `;
              tbody.appendChild(tr);
            });
          } catch (err) {
            tbody.innerHTML = `<tr><td colspan="6" style="color:red;">ุฎุทุฃ: ${err.message}</td></tr>`;
          }
        }

        window.deleteUser = async function (id) {
          if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุณุชุฎุฏูุ')) return;
          try {
            await apiFetch('/users/' + id, { method: 'DELETE' });
            loadUsersList();
          } catch (err) {
            alert('ูุดู ุงูุญุฐู: ' + err.message);
          }
        };

        async function loadServices() {
          const defaultServices = ['ูุธุงูุฉ ููููุฉ', 'ูุธุงูุฉ ุฃุณุจูุนูุฉ', 'ุทูุงุฑุฆ', 'ููู ููุงูุงุช', 'ููู ููุฑุงุช', 'ููู ุฃุฎุดุงุจ'];
          try {
            const srv = await apiFetch('/services', { method: 'GET' });
            const serverNames = Array.isArray(srv) ? srv.map(s => s.name).filter(Boolean) : [];
            const merged = [...defaultServices];
            serverNames.forEach(n => { if (!merged.includes(n)) merged.push(n); });
            const sel = $('serviceType'); sel.innerHTML = '';
            merged.forEach(name => { const opt = document.createElement('option'); opt.value = name; opt.textContent = name; sel.appendChild(opt); });
          } catch (err) {
            const sel = $('serviceType'); sel.innerHTML = '';
            ['ูุธุงูุฉ ููููุฉ', 'ูุธุงูุฉ ุฃุณุจูุนูุฉ', 'ุทูุงุฑุฆ', 'ููู ููุงูุงุช', 'ููู ููุฑุงุช', 'ููู ุฃุฎุดุงุจ'].forEach(name => {
              const opt = document.createElement('option'); opt.value = name; opt.textContent = name; sel.appendChild(opt);
            });
          }
        }

        // Helper function to check if contract is expired
        function isContractExpired(toDateStr) {
          if (!toDateStr) return false;
          const toDate = new Date(toDateStr);
          const today = new Date();
          // Set time to midnight for accurate date comparison
          today.setHours(0, 0, 0, 0);
          toDate.setHours(0, 0, 0, 0);
          return toDate < today; // Expired if end date is before today
        }

        // Load contracts from server
        async function loadContracts() {
          try {
            const q = $('search').value || '';
            const status = $('filter').value || '';
            const params = new URLSearchParams();
            if (q) params.set('q', q);
            if (status) params.set('status', status);
            const rows = await apiFetch('/contracts?' + params.toString(), { method: 'GET' });

            // Check for expired contracts and update their status automatically
            if (rows && Array.isArray(rows)) {
              for (const contract of rows) {
                // Only update if contract has an end date, is not already expired, and has passed its end date
                if (contract.to_date && contract.status !== 'expired' && isContractExpired(contract.to_date)) {
                  try {
                    console.log(`Auto-expiring contract ${contract.id} with end date ${contract.to_date}`);
                    await apiFetch('/contracts/' + encodeURIComponent(contract.id), {
                      method: 'PUT',
                      body: JSON.stringify({ status: 'expired' })
                    });
                    // Update local data to reflect the change
                    contract.status = 'expired';
                  } catch (err) {
                    console.error(`Failed to auto-expire contract ${contract.id}:`, err);
                  }
                }
              }
            }

            renderContracts(rows || []);
          } catch (err) { console.error(err); }
        }

        // Format date to YYYY-MM-DD only (remove timestamp)
        function formatDate(dateStr) {
          if (!dateStr) return '-';
          // Check for ISO UTC string -> Convert to Local Date
          if (typeof dateStr === 'string' && dateStr.includes('T') && dateStr.endsWith('Z')) {
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
          }
          // If it's a string like YYYY-MM-DD or standard datetime without Z, simple substring
          if (typeof dateStr === 'string' && dateStr.length >= 10) {
            return dateStr.substring(0, 10);
          }
          return dateStr;
        }

        function renderContracts(rows) {
          // Store contracts globally for sorting
          contractsData = rows || [];

          const tbody = $('contractsTbody'); tbody.innerHTML = '';
          let active = 0, pending = 0;
          rows.forEach(c => {
            if (c.status === 'active') active++;
            if (c.status === 'pending') pending++;
            const tr = document.createElement('tr');
            const containerMapLink = c.container_location ? `<a href="https://www.google.com/maps?q=${c.container_location}" target="_blank">ูููุน ุงูุญุงููุฉ</a>` : '';
            // const pickupMapLink = c.pickup_location ? `<a href="https://www.google.com/maps?q=${c.pickup_location}" target="_blank">ูููุน ุงูุชุญุตูู</a>` : '';

            // Format dates to show only YYYY-MM-DD
            const fromDate = formatDate(c.from_date);
            const toDate = formatDate(c.to_date);

            tr.innerHTML = `
            <td data-label="ุฑูู" style="white-space: nowrap;">${c.id}</td>
            <td data-label="ุงูุนููู" style="white-space: nowrap;">${c.second_party || ''}</td>
            <td data-label="ุงูุฎุฏูุฉ" style="white-space: nowrap;">${c.service_name || ''}</td>
            <td data-label="ุงููุชุฑุฉ" style="white-space: nowrap;">${fromDate} โ ${toDate}</td>
            <td data-label="ุงูุณุนุฑ" style="white-space: nowrap;">${c.total_price || 0}</td>
            <td data-label="ูุณูู" style="white-space: nowrap;">${c.manager || ''}</td>
            <td data-label="ูุญุตู" style="white-space: nowrap;">${c.collector || ''}</td>
            <td data-label="ุงูุญุงูุฉ" style="white-space: nowrap;">
                <span class="chip ${c.status === 'active' ? 'active' : (c.status === 'pending' ? 'pending' : 'expired')}">
                ${c.status === 'active' ? 'ูุดุท' : (c.status === 'pending' ? 'ููุฏ ุงูุชูููุน' : 'ููุชูู')}
                </span>
            </td>
            <td data-label="" style="white-space: nowrap;">
              <div style="display:inline-flex; gap:3px; align-items:center; flex-wrap:nowrap;">
                  <button class="btn" onclick="openView('${c.id}')" title="ุนุฑุถ ุงูุนูุฏ ุงูููุงุฆู" style="padding:4px 8px; font-size:0.85em;">ุนุฑุถ</button>
                  <button class="btn" onclick="openEdit('${c.id}')" title="ุชุนุฏูู ุงูุนูุฏ" style="padding:4px 8px; font-size:0.85em;">ุชุนุฏูู</button>
                  <button class="btn" onclick="openRenew('${c.id}')" title="ุชุฌุฏูุฏ ุงูุนูุฏ" style="padding:4px 8px; font-size:0.85em; background:#10b981; color:white; border:none;">ุชุฌุฏูุฏ</button>
                  <button class="btn small" onclick="updateStatus('${c.id}','active')" title="ุชูุนูู">โ</button>
                  <button class="btn small" onclick="updateStatus('${c.id}','pending')" title="ููุฏ ุงูุชูููุน">โณ</button>
                  <button class="btn small" onclick="updateStatus('${c.id}','expired')" title="ุฅููุงุก">๐</button>
                  ${containerMapLink ? `<a href="https://www.google.com/maps?q=${c.container_location}" target="_blank" style="font-size:0.75em; margin-right:4px; white-space:nowrap;">๐</a>` : ''}
                  ${(window.currentUser && window.currentUser.role === 'admin') ?
                `<button class="btn small" onclick="deleteContract('${c.id}')" title="ุญุฐู ุงูุนูุฏ" style="background:#ef4444; color:white; border:none;">๐๏ธ</button>` :
                ''}
              </div>
            </td>
          `;
            tbody.appendChild(tr);
          });
          $('countActive').textContent = active;
          $('countPending').textContent = pending;
        }

        // Open View (Final Contract) - Show in Modal
        async function openView(id) {
          console.log('[DEBUG] openView called for ID:', id);
          const modal = document.getElementById('viewContractModal');
          if (!modal) {
            console.error('[ERROR] viewContractModal not found in DOM!');
            return alert('ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ูุงูุฐุฉ ุงูุนุฑุถ');
          }
          try {
            // Fetch contract data
            console.log('[DEBUG] openView: fetching contract data for ID:', id);
            // Add cache buster to ensure we get fresh data after save
            const rows = await apiFetch('/contracts?q=' + id + '&_t=' + Date.now(), { method: 'GET' });
            console.log('[DEBUG] openView: apiFetch raw response:', rows);
            let c = Array.isArray(rows) ? rows.find(r => String(r.id) === String(id)) : rows;

            if (!c && id !== 'new') {
              console.error('[DEBUG] openView: Contract not found after search for ID:', id);
              alert('ุงูุนูุฏ ุบูุฑ ููุฌูุฏ');
              return;
            }

            // LIVE PREVIEW OVERRIDE: If we are currently editing THIS contract (or creating new), use form values 
            const editingId = $('formWrap')?.dataset?.editing; // Check if editing ID is set
            // Check if we are viewing the contract we are editing OR if it's a new contract being created
            if ((editingId && String(editingId) === String(id)) || id === 'new') {
              console.log('๐ [LIVE] Overriding openView data with current form values for real-time preview.');
              const formData = getContractDataFromForm();
              // Map formData to contract object structure
              const currentTerms = $('terms')?.value || c?.terms || '';

              // Generate full second party text including representative if checked
              let secondPartyText = formData.client_name;
              if (typeof generateSecondPartyText === 'function') {
                secondPartyText = generateSecondPartyText();
              }

              c = {
                ...c, // keep existing props
                id: editingId || 'ุฌุฏูุฏ',
                contract_number: editingId || 'ุฌุฏูุฏ',
                second_party: secondPartyText, // Use generated text with representative
                client_email: formData.client_email,
                client_phone: formData.client_phone,
                from_date: formData.from_date,
                to_date: formData.to_date,
                monthly_fee: formData.monthly_fee,
                tax: formData.tax,
                total_price: formData.total_price,
                duration: formData.duration,
                payment_type: formData.payment_type,
                service_name: formData.service_name,
                manager: formData.manager,
                collector: formData.collector,
                terms: currentTerms
              };

              // Inject representative data into parsing context if needed
              // Actually replaceDatePlaceholders uses formData (contractData) passed to it
            }
            console.log('[DEBUG] openView: Final contract object for display:', c);

            // Fix date off-by-one if weird ISO string (e.g. 2025-05-20T21:00:00.000Z -> 2025-05-21)
            const fixDate = (d) => {
              if (typeof d === 'string' && d.includes('T') && d.endsWith('Z')) {
                const date = new Date(d);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
              }
              return d;
            };
            if (c.from_date) c.from_date = fixDate(c.from_date);
            if (c.to_date) c.to_date = fixDate(c.to_date);

            // Fetch attachments to get Tax Number and Registry for replacement in view (if stored)
            let viewAttachments = [];
            try {
              if (id !== 'new') {
                console.log('[DEBUG] openView: fetching attachments...');
                const res = await apiFetch(`/contracts/${id}/attachments`, { method: 'GET' });
                viewAttachments = (res && res.attachments) ? res.attachments : (Array.isArray(res) ? res : []);
              }
            } catch (e) { console.warn('Failed to fetch view attachments', e); }

            const taxAtt = viewAttachments?.filter(a => a.field_name === 'tax_number')?.pop()?.text_value;
            const regAtt = viewAttachments?.filter(a => a.field_name === 'commercial_registration')?.pop()?.text_value;

            // Merge attachment data with contract object for replacement
            // If live preview, c already has new data, but we might want stored tax/reg if not in form
            // Extract representative info from text if not in live edit mode
            let hasRep = $('hasRepresentative')?.checked;
            let repName = $('representativeName')?.value;
            let repTitle = $('representativeTitle')?.value;

            const isLiveOverride = (editingId && String(editingId) === String(id)) || id === 'new';

            if (!isLiveOverride) {
              const spText = (c.terms || '') + (c.second_party || '');
              if (spText.includes('ูููุซูู ูู ุงูุชูุงููุน')) {
                hasRep = true;
                const m = spText.match(/ุงูุงุณุชุงุฐ \/ (.*?)((?=\s*- ุจุตูุชู)|(?=\s*ููุดุงุฑ)|$)/);
                if (m && m[1]) repName = m[1].trim();
                const mt = spText.match(/- ุจุตูุชู (.*?)((?=\s*ููุดุงุฑ)|$)/);
                if (mt && mt[1]) repTitle = mt[1].trim();
              } else {
                hasRep = false;
                repName = '';
                repTitle = '';
              }
            }

            const contractData = {
              ...c,
              tax_number: c.tax_number || taxAtt,
              commercial_registry: c.commercial_registry || regAtt,
              has_representative: hasRep,
              representative_name: repName,
              representative_title: repTitle
            };

            // Populate modal fields
            const safeSet = (elId, val) => {
              const el = document.getElementById(elId);
              if (el) el.textContent = val || '';
            };

            safeSet('v-id-top', c.id || c.contract_number || '---');
            safeSet('v-date-top', new Date().toISOString().split('T')[0]);
            safeSet('v-collector', c.collector || '...................');
            safeSet('v-manager', c.manager || '...................');
            safeSet('v-second-party-name', c.second_party || c.client_name);
            safeSet('v-second-party-email', c.client_email || '');

            // Format and set terms
            const formatTerms = (termsText) => {
              if (!termsText) return '';
              if (termsText.match(/<[^>]+>/)) {
                return termsText;
              }
              return termsText
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0 || termsText.includes('\n\n'))
                .join('<br>');
            };

            const termsEl = document.getElementById('v-terms');
            if (termsEl) {
              let content = c.terms || '';
              if (typeof replaceDatePlaceholders === 'function') {
                console.log('[DEBUG] openView: applying date placeholders...');
                content = replaceDatePlaceholders(content, contractData);
              }

              // Check if content already has the preamble
              const hasFirstParty = content.includes('ุงูุทุฑู ุงูุฃูู');
              const hasSecondParty = content.includes('ุงูุทุฑู ุงูุซุงูู');

              // If preamble is missing, inject it
              if (!hasFirstParty || !hasSecondParty) {
                console.log('[DEBUG] openView: Preamble missing, injecting party information...');

                // Get first party text
                let firstPartyText = '';
                if (typeof generateFirstPartyText === 'function') {
                  firstPartyText = generateFirstPartyText();
                } else {
                  firstPartyText = 'ุงูุทุฑู ุงูุฃูู: ุดุฑูุฉ ุจูุช ููููุงููุงุช';
                }

                // Get second party text (with representative)
                let secondPartyText = c.second_party || '';
                if (!secondPartyText && typeof generateSecondPartyText === 'function') {
                  secondPartyText = generateSecondPartyText();
                }

                // Build and prepend preamble
                const preamble = `${firstPartyText}\n\n${secondPartyText}\n\nุชู ุงูุงุชูุงู ุนูู ูุงููู:\n\n`;
                content = preamble + content;
              }

              termsEl.innerHTML = formatTerms(content);
            }

            // Display attachments
            console.log('[DEBUG] openView: displaying attachments UI...');
            await displayViewAttachments(id);

            // === SYNC VIEW WITH PRINT LAYOUT ===
            const viewPreview = document.getElementById('view-preview');
            const docContent = document.getElementById('doc-content');

            if (viewPreview && docContent) {
              console.log('[DEBUG] openView: syncing view-preview with print layout...');
              const innerContent = docContent.innerHTML;

              // Build high-fidelity HTML matching printViewContract logic
              viewPreview.innerHTML = `
              <style>
                ${typeof getBrandingStyles === 'function' ? getBrandingStyles() : ''}
                
                #view-preview { 
                  position: relative !important; 
                  overflow: visible !important; 
                  background: white;
                  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                }
                
                #view-preview .fixed-print-header, 
                #view-preview .fixed-print-footer { 
                  position: relative !important; 
                  top: auto !important; 
                  bottom: auto !important; 
                  left: auto !important; 
                  right: auto !important; 
                  padding: 10px !important; 
                  height: auto !important;
                  width: 100% !important;
                  background: #fff !important;
                  z-index: 1 !important;
                }
                
                #view-preview .header-container,
                #view-preview .footer-container {
                  border: 1px solid transparent !important;
                  background: #fff !important;
                }
                
                #view-preview .watermark-container {
                  position: absolute !important;
                  top: 50% !important;
                  left: 50% !important;
                  transform: translate(-50%, -50%) !important;
                  z-index: 0 !important;
                }
                
                #view-preview .print-table,
                #view-preview .print-table thead,
                #view-preview .print-table tbody,
                #view-preview .print-table tr,
                #view-preview .print-table td {
                  background: transparent !important;
                  background-image: none !important;
                  border: none !important;
                  box-shadow: none !important;
                }
                
                #view-preview .print-table thead,
                #view-preview .print-table tfoot {
                  display: none !important;
                }
                
                #view-preview .view-content-body {
                  background: #fff !important;
                  border: none !important;
                  padding: 0 !important;
                }
                
                #view-preview .print-spacer-header { 
                  height: 20px !important; 
                  background: transparent !important;
                  visibility: hidden !important;
                }
                #view-preview .print-spacer-footer { 
                  height: 20px !important; 
                  background: transparent !important;
                  visibility: hidden !important;
                }
                
                /* Scoped Generic Tags */
                #view-preview .terms-box { white-space: pre-wrap; word-wrap: break-word; }
                #view-preview .terms-box p { margin: 10px 0; }
                #view-preview strong, #view-preview b { font-weight: bold !important; }
                #view-preview .ql-align-center { text-align: center; }
                #view-preview .ql-align-right { text-align: right; }
                #view-preview .ql-align-justify { text-align: justify; }
              </style>
              
              <!-- Watermark -->
              ${typeof getBrandingHTML === 'function' ? getBrandingHTML('watermark') : ''}
              
              <!-- Branded Header -->
              ${typeof getBrandingHTML === 'function' ? getBrandingHTML('header') : ''}
              
              <table class="print-table">
                <thead>
                  <tr><td><div class="print-spacer-header"></div></td></tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <div class="view-content-body">
                        ${innerContent}
                      </div>
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr><td><div class="print-spacer-footer"></div></td></tr>
                </tfoot>
              </table>
              
              <!-- Branded Footer -->
              ${typeof getBrandingHTML === 'function' ? getBrandingHTML('footer') : ''}
            `;
            }

            // Store contract ID for print/share
            window.currentViewContractId = id;
            window.currentViewContractClientPhone = c.client_phone || c.phone || '';


            // NUCLEAR OPTION: Move modal to body and force ALL visibility properties
            const modalView = document.getElementById('viewContractModal');
            if (modalView) {
              // Move modal to the very end of body to escape any overflow:hidden or z-index stacking contexts
              document.body.appendChild(modalView);

              // Force all visibility-related properties
              modalView.style.display = 'flex';
              modalView.style.zIndex = '999999';
              modalView.style.opacity = '1';
              modalView.style.visibility = 'visible';
              modalView.style.position = 'fixed';
              modalView.classList.remove('hidden');

              console.log('[DEBUG] openView: NUCLEAR - Modal moved to body and forced visible');
            } else {
              console.error('[ERROR] viewContractModal not found for display');
            }

          } catch (err) {
            console.error('[ERROR] openView failed:', err);
            alert('ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช ุงูุนูุฏ: ' + err.message);
          }
        }

        // ============ BRANDING HELPERS (HTML/TEXT GENERATION) ============

        function getBrandingStyles() {
          return `
          /* Import Fonts: Tajawal (Modern/Signage) and Amiri (Classic/Contract) */
          @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@400;500;700;800;900&display=swap');

          /* Branding specific styles */
          .branding-header, .branding-footer {
            width: 100%;
            font-family: 'Arial'; 
            color: #1e3a8a; /* Primary Dark Blue */
            box-sizing: border-box;
          }
          
          /* --- HEADER REPLICA --- */
          .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #2563eb; /* Royal Blue Border */
            border-radius: 15px; /* Rounded Corners */
            padding: 8px 15px;
            margin-bottom: 20px;
            direction: rtl;
            background: #fff;
            position: relative;
            height: 140px; /* Fixed height to match aspect ratio */
          }
          
          /* Right Side: Company Info */
          .header-right { 
            text-align: center; 
            width: 35%; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
          }
          .brand-name-red {
            font-size: 40px;
            font-weight: 900; /* Extra Bold for Logo Text */
            color: #dc2626; 
            line-height: 1;
            margin-bottom: 5px;
            text-shadow: 1px 1px 0px rgba(0,0,0,0.1);
            font-family: Arial; 
          }
          .brand-desc-blue {
            font-size: 22px;
            font-weight: 700;
            color: #1e40af; 
            line-height: 1.3;
          }
          .brand-cr-blue {
            font-size: 22px;
            font-weight: 700;
            color: #1e40af;
            margin-top: 2px;
          }

          /* Center: Circle Logo (CSS) */
          .header-center { 
            text-align: center; 
            width: 20%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
          }
          .logo-circle {
            width: 80px;
            height: 80px;
            border: 3px solid #3b82f6; /* Blue Circle Border */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #fff;
          }
          .logo-circle-text {
            font-size: 40px;
            font-weight:900;
            color: #dc2626; /* Red text inside */
            padding-bottom: 4px; /* Optical centering */
          }

          /* Left: Date Fields */
          .header-left { 
            text-align: left; 
            width: 35%; 
            padding-right: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 10px;
          }
          .date-row {
            font-size: 18px;
            font-weight: 700;
            color: #1e40af; /* Dark Blue */
            direction: rtl;
          }
          
          /* --- FOOTER REPLICA --- */
          .footer-container {
            border: 2px solid #2563eb; /* Royal Blue Border */
            border-radius: 15px; /* Rounded Corners */
            padding: 8px 15px;
            text-align: center;
            direction: rtl;
            background: #fff;
            margin-top: 10px;
          }
          .footer-line-ar {
            font-size: 14px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 4px;
          }
          .footer-line-en {
            font-size: 14px;
            font-weight: 600;
            color: #1e40af;
            font-family: Arial;
            direction: ltr; /* English LTR */
          }

          /* PADDING ADJUSTMENT: RESET TO STANDARD MARGINS FOR TABLE LAYOUT */
          .print-header-container, .print-footer-container {
             /* Reset defaults, specific styling handled in fixed classes below */
          }

          /* --- HYBRID LAYOUT: FIXED VISUALS + TABLE SPACERS --- */
          
          /* 1. VISUALS: Fixed to Page Edges (Stays at Bottom/Top) */
          .fixed-print-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: white;
            padding: 5mm 10mm 0mm 10mm; /* User's custom padding */
            height: 150px; /* Fixed height for spacer matching */
          }
          .fixed-print-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: white;
            padding: 0 10mm 0mm 10mm; /* User's custom padding */
            height: 100px; /* Fixed height for spacer matching */
          }

          /* 2. SPACERS: Invisible blocks in Table to reserve space */
          .print-spacer-header {
            height: 160px; /* Slightly larger than visual to provide gap */
            visibility: hidden;
          }
          .print-spacer-footer {
            height: 95px; /* Reduced slightly to prevent table overflow */
            visibility: hidden;
          }

          /* --- TABLE STRUCTURE --- */
          table.print-table {
            width: 100%;
            border-collapse: collapse;
          }
          table.print-table thead {
            display: table-header-group;
          }
          table.print-table tfoot {
            display: table-footer-group;
          }
          table.print-table tbody {
            display: table-row-group;
          }
          
          /* Only Watermark stays fixed */
          .watermark-container {
             position: fixed;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             z-index: -1;
             opacity: 0.1; /* Slightly visible */
             pointer-events: none;
          }
          .watermark-circle {
            width: 500px;
            height: 500px;
            border: 15px solid #3b82f6;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
          }
          .watermark-text-inner {
            font-size: 180px;
            font-weight: 900;
            color: #dc2626;
          }
        `;
        }

        function getBrandingHTML(type) {
          // Company Data
          const crNumber = "5850026989";
          // Fixed contact info as per image replica request (placeholders replaced with real data where known or approximated)
          // Image says: Tel 0172278666, Fax 0172278666, Ext 105, Mob 0552200931, PO 4664, Zip 61412
          const arPhoneLine = "ุชููููู / ูขูขูงูจูฆูฆูฆ / ููกูง - ูุงูุณ : ูขูขูงูจูฆูฆูฆ / ููกูง - ุชุญูููุฉ : ูกููฅ - ุฌูุงู / ููฅูฅูขูขูููฉูฃูก - ุต.ุจ : ูคูฆูฆูค - ุฑูุฒ ุจุฑูุฏู : ูฆูกูคูกูข";
          const enPhoneLine = "Tel.: 0172278666 - Fax: 017/2278666 - Ext.: 105 - Mob. / 0552200931 - P.O.Box: 4664 - P.Code: 61412";

          if (type === 'header') {
            return `
            <div class="fixed-print-header">
              <div class="branding-header header-container">
                <!-- Right: Company Info -->
                <div class="header-right">
                  <div class="brand-name-red">ุจูููุช</div>
                  <div class="brand-desc-blue">ููููุงููุงุช ุงูุนุงูุฉ ูุงูุตูุงููุฉ</div>
                  <div class="brand-desc-blue">ูุงูุชุดุบูู ููุธุงููุฉ ุงูููุฏู</div>
                  <div class="brand-cr-blue">ุณ.ุช : ${crNumber}</div>
                </div>

                <!-- Center: Circle -->
                <div class="header-center">
                   <div class="logo-circle">
                      <div class="logo-circle-text">ุจููุช</div>
                   </div>
                </div>

                <!-- Left: Date Fields -->
                <div class="header-left">
                  <div class="date-row">ุงูุชูุงุฑููุฎ : &nbsp;&nbsp;&nbsp; / &nbsp;&nbsp;&nbsp; / &nbsp;&nbsp;&nbsp; ูกูค ูู</div>
                  <div class="date-row">ุงูููุงูู : &nbsp;&nbsp;&nbsp; / &nbsp;&nbsp;&nbsp; / &nbsp;&nbsp;&nbsp; ูขู ู</div>
                </div>
              </div>
            </div>
          `;
          }

          if (type === 'footer') {
            return `
            <div class="fixed-print-footer">
              <div class="branding-footer footer-container">
                  <div class="footer-line-ar">${arPhoneLine}</div>
                  <div class="footer-line-en">${enPhoneLine}</div>
              </div>
            </div>
          `;
          }

          if (type === 'watermark') {
            return `
             <div class="watermark-container">
               <div class="watermark-circle">
                 <div class="watermark-text-inner">ุจูุช</div>
               </div>
             </div>
          `;
          }

          return '';
        }

        /*
          WORD EXPORT HELPERS (Using Tables and Inline Styles)
          Microsoft Word is notoriously bad at CSS borders/radius on divs.
          We will use nested tables with border-color mimicking the look.
          Rounded corners are hard in Word HTML without VML, but we will use standard borders which is acceptable "Pixel Perfect" for layout/color.
        */
        function getWordBrandingHTML(type, baseUrl) {
          const crNumber = "5850026989";
          const arPhoneLine = "ุชููููู / ูขูขูงูจูฆูฆูฆ / ููกูง - ูุงูุณ : ูขูขูงูจูฆูฆูฆ / ููกูง - ุชุญูููุฉ : ูกููฅ - ุฌูุงู / ููฅูฅูขูขูููฉูฃูก - ุต.ุจ : ูคูฆูฆูค - ุฑูุฒ ุจุฑูุฏู : ูฆูกูคูกูข";
          const enPhoneLine = "Tel.: 0172278666 - Fax: 017/2278666 - Ext.: 105 - Mob. / 0552200931 - P.O.Box: 4664 - P.Code: 61412";

          // Exact Colors from Print CSS
          const red = "#dc2626";
          const darkBlue = "#1e40af";
          const borderBlue = "#2563eb";
          const lightBorderBlue = "#3b82f6";

          if (type === 'header') {
            return `
            <div style="mso-element:header" id=h1>
              <!-- Page Watermark: Transparent Absolute Div inside Header repeats on all pages -->
              <div style='position:absolute; width:450pt; height:450pt; z-index:-10; mso-position-horizontal:center; mso-position-vertical:center; mso-position-horizontal-relative:page; mso-position-vertical-relative:page;'>
                <p align="center" style="font-size:140pt; font-weight:900; font-family:Arial; color:#ffe4e6; margin:0; opacity:0.1; filter:alpha(opacity=10);">ุจูุช</p>
              </div>

              <!-- Visual Header Branding: Mirroring Print CSS exactly (30pt title, 16.5pt desc) -->
              <table border="0" cellspacing="0" cellpadding="0" style="width:100%; direction:rtl; border:2.5pt solid ${borderBlue}; mso-border-alt:2.5pt solid ${borderBlue};">
                <tr>
                  <td style="padding:10pt;">
                    <table border="0" cellspacing="0" cellpadding="0" style="width:100%; direction:rtl;">
                      <tr>
                        <!-- Right: Company Info -->
                        <td width="38%" align="center" valign="middle">
                          <p style="font-size:30pt; font-weight:bold; font-family:Arial; color:${red}; margin:0;">ุจูููุช</p>
                          <p style="font-size:16.5pt; font-weight:bold; font-family:Arial; color:${darkBlue}; margin:2pt 0 0 0;">ููููุงููุงุช ุงูุนุงูุฉ ูุงูุตูุงููุฉ</p>
                          <p style="font-size:16.5pt; font-weight:bold; font-family:Arial; color:${darkBlue}; margin:2pt 0 0 0;">ูุงูุชุดุบูู ููุธุงููุฉ ุงูููุฏู</p>
                          <p style="font-size:16.5pt; font-weight:bold; font-family:Arial; color:${darkBlue}; margin:2pt 0 0 0;">ุณ.ุช : ${crNumber}</p>
                        </td>
                        
                        <!-- Center: Logo Circle Representation -->
                        <td width="24%" align="center" valign="middle">
                            <table border="0" cellspacing="0" cellpadding="0" style="border:2.5pt solid ${lightBorderBlue}; mso-border-alt:2.5pt solid ${lightBorderBlue}; border-radius:35pt; width:65pt; height:65pt; text-align:center;">
                              <tr>
                                <td align="center" valign="middle" style="height:65pt; width:65pt;">
                                   <p style="font-size:30pt; font-weight:bold; font-family:Arial; color:${red}; margin:0;">ุจููุช</p>
                                </td>
                              </tr>
                            </table>
                        </td>
                        
                        <!-- Left: Date Fields -->
                        <td width="38%" align="right" valign="middle" style="padding-right:15pt;">
                          <p style="font-size:14.5pt; font-weight:bold; font-family:Arial; color:${darkBlue}; margin:0 0 10pt 0;">ุงูุชูุงุฑููุฎ : &nbsp;&nbsp;&nbsp; / &nbsp;&nbsp; / &nbsp;&nbsp; ูกูค ูู</p>
                          <p style="font-size:14.5pt; font-weight:bold; font-family:Arial; color:${darkBlue}; margin:0;">ุงูููุงูู : &nbsp;&nbsp;&nbsp; / &nbsp;&nbsp; / &nbsp;&nbsp; ูขู ู</p>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </div>
          `;
          }

          if (type === 'footer') {
            return `
            <div style="mso-element:footer" id=f1>
              <p class=MsoFooter style='direction:rtl; border-top:2.5pt solid ${borderBlue}; mso-border-top-alt:2.5pt solid ${borderBlue}; padding-top:10pt; text-align:center;'>
                 <span style="font-size:11pt; font-weight:bold; font-family:Arial; color:${darkBlue};">
                    ${arPhoneLine}
                 </span>
                 <br>
                 <span style="font-size:11pt; font-weight:bold; font-family:Arial; color:${darkBlue}; direction:ltr; display:block; margin-top:2pt;">
                    ${enPhoneLine}
                 </span>
              </p>
            </div>
           `;
          }
          return '';
        }

        /*
          PRINT VIEW CONTRACT using Iframe
        */
        const isMobile = (window.innerWidth <= 768) || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        window.printViewContract = function () {
          const content = document.getElementById('doc-content');
          if (!content) return alert('ุฎุทุฃ: ูุญุชูู ุงูุนูุฏ ุบูุฑ ููุฌูุฏ');

          // Create a hidden iframe
          const iframe = document.createElement('iframe');
          iframe.style.position = 'fixed';
          iframe.style.right = '0';
          iframe.style.bottom = '0';
          iframe.style.width = '0';
          iframe.style.height = '0';
          iframe.style.border = '0';
          document.body.appendChild(iframe);

          // Build the HTML for the iframe
          const doc = iframe.contentWindow.document;
          doc.open();
          doc.write(`
          <!DOCTYPE html>
          <html lang="ar" dir="rtl">
          <head>
            <meta charset="utf-8">
            <title>ุทุจุงุนุฉ ุงูุนูุฏ</title>
            <!-- Fonts -->
            <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
            <style>
            /* Table Layout CSS */
            @page {
              size: A4;
              margin: 0; /* Changed to 0 to allow footer to hit the bottom edge */
            }
            body {
              font-family: 'Tajawal', 'Arial', sans-serif;
              font-size: 14pt;
              padding: 10mm; /* Moved safety margin here */
              margin: 0;
              background: white;
              direction: rtl;
            }
            
            .print-table td { border: none !important; } /* FIX: Remove lines from spacer cells */
            
            ${getBrandingStyles()}

            /* CONTENT FORMATTING FIXES */
            /* 1. Reset margins but keep small gap for readability (Compact but distinct) */
            .contract-section { margin-bottom: 20px; }
            .terms-box p { margin: 0 0 6px 0; padding: 0; }
            .terms-box div { margin: 0; padding: 0; }
            
            /* 2. Respect User Line Breaks (Do not hide br+br) - Commented out to allow intentional spacing */
            /* .terms-box br + br { display: none; } */

            /* 3. Ensure Bold/Center works */
            strong, b { font-weight: bold !important; }
            .ql-align-center { text-align: center; }
            .ql-align-right { text-align: right; }
            .ql-align-justify { text-align: justify; }

            /* 4. Quill Custom Font Sizes (Explicitly defined for Print Iframe) */
            .ql-size-8px { font-size: 8px !important; }
            .ql-size-10px { font-size: 10px !important; }
            .ql-size-12px { font-size: 12px !important; }
            .ql-size-14px { font-size: 14px !important; }
            .ql-size-16px { font-size: 16px !important; }
            .ql-size-18px { font-size: 18px !important; }
            .ql-size-20px { font-size: 20px !important; }
            .ql-size-24px { font-size: 24px !important; }
            .ql-size-30px { font-size: 30px !important; }
            .ql-size-36px { font-size: 36px !important; }
            .ql-size-48px { font-size: 48px !important; }
            .ql-size-60px { font-size: 60px !important; }
            .ql-size-72px { font-size: 72px !important; }
            
            /* Hide print iframe artifacts */
            iframe { display: none; }
            
            /* Hide Attachments in Print */
            #contractAttachmentsSection, #v-attachments-section, #v-attachments-display { 
              display: none !important; 
            }
          </style>
        </head>
          <body>
            <!-- Watermark -->
            ${getBrandingHTML('watermark')}
            
            <!-- Fixed Visual Header/Footer (Outside Table) -->
            ${getBrandingHTML('header')}
            ${getBrandingHTML('footer')}

            <!-- Main Structural Table (Content + Spacers) -->
            <table class="print-table">
              <thead>
                <tr>
                  <td>
                    <!-- Invisible Spacer for Header -->
                    <div class="print-spacer-header"></div>
                  </td>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <div id="doc-content">
                      ${content.innerHTML.trim()}
                    </div>
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td>
                     <!-- Invisible Spacer for Footer -->
                     <div class="print-spacer-footer"></div>
                  </td>
                </tr>
              </tfoot>
            </table>

          <script>
            window.onload = function() {
              setTimeout(function() {
                window.print();
                setTimeout(function() { 
                    try { window.frameElement.remove(); } catch(e){} 
                }, 500);
              }, 500);
            };
          <\/script>
        </body>
        </html>
      `);
          doc.close();
        };

        // Download View Contract as PDF
        window.downloadViewContractPDF = async function () {
          const content = document.getElementById('doc-content');
          if (!content) return alert('ุฎุทุฃ: ูุญุชูู ุงูุนูุฏ ุบูุฑ ููุฌูุฏ');

          try {
            await loadHtml2Pdf();
            const contractId = window.currentViewContractId || 'Contract';

            const iframe = document.createElement('iframe');
            iframe.style.position = 'fixed';
            iframe.style.right = '0';
            iframe.style.bottom = '0';
            iframe.style.width = '0';
            iframe.style.height = '0';
            iframe.style.border = '0';
            document.body.appendChild(iframe);

            const doc = iframe.contentWindow.document;
            doc.open();
            doc.write(`
          <!DOCTYPE html>
          <html lang="ar" dir="rtl">
          <head>
            <meta charset="utf-8">
            <title>Contract ${contractId}</title>
            <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
            <style>
              @page { margin: 0; } /* Changed to 0 for full edge access */
              body {
                font-family: 'Tajawal', 'Arial', sans-serif;
                margin: 0;
                padding: 0;
                background: white;
                direction: rtl;
                -webkit-font-smoothing: antialiased;
                text-rendering: optimizeLegibility;
                font-variant-ligatures: none; /* KEY FIX: Prevents html2canvas from jumbling Arabic characters */
              }
              .pdf-container {
                width: 190mm; /* A4 width minus margins */
                margin: 0 auto;
                padding: 10mm 0;
              }
              ${getBrandingStyles()}
              ${generateFontSizeCSS()}

              .print-table td { border: none !important; }

              /* CONTENT FORMATTING FIXES */
              .contract-section { margin-bottom: 20px; }
              .terms-box p { margin: 0 0 6px 0; padding: 0; }
              .terms-box div { margin: 0; padding: 0; }
              .terms-box ol, .terms-box ul { margin: 10px 0; padding-right: 20px; }
              .terms-box li { margin-bottom: 5px; }
              strong, b { font-weight: bold !important; }
              .ql-align-center { text-align: center; }
              .ql-align-right { text-align: right; }
              .ql-align-justify { text-align: justify; }
            </style>
          </head>
           <div class="pdf-container">
              <!-- Watermark -->
              ${getBrandingHTML('watermark')}
              
              <!-- Fixed Visual Header/Footer -->
              ${getBrandingHTML('header')}
              ${getBrandingHTML('footer')}
              
              <table class="print-table" style="width:100% !important;">
                <thead><tr><td><div class="print-spacer-header"></div></td></tr></thead>
                <tbody>
                  <tr>
                    <td>
                      <div id="doc-content">
                         ${content.innerHTML.trim()}
                      </div>
                    </td>
                  </tr>
                </tbody>
                <tfoot><tr><td><div class="print-spacer-footer"></div></td></tr></tfoot>
              </table>
           </div>
          </body>
          </html>
        `);
            doc.close();

            // Wait for fonts and layouts to settle
            if (iframe.contentWindow.document.fonts) {
              try { await iframe.contentWindow.document.fonts.ready; } catch (e) { }
            }
            await new Promise(resolve => setTimeout(resolve, 800));

            const opt = {
              margin: 0,
              filename: `Contract_${contractId}.pdf`,
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: {
                scale: 2,
                useCORS: true,
                letterRendering: true, /* Enabled with ligature fix for better spacing */
                allowTaint: true,
                scrollX: 0,
                scrollY: 0,
                width: 794, /* Fixed A4 width in pixels */
                windowWidth: 794
              },
              jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            await html2pdf().set(opt).from(iframe.contentWindow.document.body).save();

            iframe.remove();
          } catch (e) {
            console.error(e);
            alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ููู PDF');
          }
        };

        // Download View Contract as Word (doc) with Header/Footer
        window.downloadViewContractWord = function () {
          const content = document.getElementById('doc-content');
          if (!content) return alert('ุฎุทุฃ: ูุญุชูู ุงูุนูุฏ ุบูุฑ ููุฌูุฏ');

          const contractId = window.currentViewContractId || 'Contract';
          // Use absolute paths for images to ensure they load
          const baseUrl = window.location.origin + '/';

          const htmlContent = `
          <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
          <head>
            <meta charset="utf-8">
            <title>Contract ${contractId}</title>
            <style>
              /* Page Setup for A4 */
              @page Section1 {
                size: 210mm 297mm;
                margin: 50mm 15mm 45mm 15mm; /* Balanced margins for resized branding */
                mso-header-margin: 30pt;
                mso-footer-margin: 30pt;
                mso-header: h1;
                mso-footer: f1;
              }
              div.Section1 { page: Section1; }
              
              body {
                font-family: 'Arial', sans-serif;
                font-size: 14pt;
                direction: rtl;
                text-align: right;
              }
              
              ${generateFontSizeCSS()}
              
              /* Word-specific font overrides: map px classes to 14pt */
              .ql-size-12px, .ql-size-14px, .terms-box p, .terms-box span { 
                 font-size: 14pt !important; 
              }
              .ql-size-small { font-size: 10pt !important; }
              .ql-size-large { font-size: 18pt !important; }
              .ql-size-huge { font-size: 24pt !important; }
              
              /* Styles simulation */
              .ql-align-center { text-align: center; }
              .ql-align-right { text-align: right; }
              .ql-align-justify { text-align: justify; }
              .term-title { font-weight: bold; }
              table { width: 100% !important; border-collapse: collapse; table-layout: fixed; }
              td { padding: 4px; word-wrap: break-word; }
              
              /* Content Formatting */
              .contract-section { margin-bottom: 20pt; }
              p { margin: 0 0 6pt 0; line-height: 1.4; }
              .terms-box p { margin: 0 0 6pt 0; padding: 0; }
              .terms-box ol, .terms-box ul { margin: 10pt 20pt 10pt 0; }
                li { margin-bottom: 5pt; }
            </style>
          </head>
          <body>
            <div class=Section1>
              <!-- Main Content ONLY -->
              <div dir="rtl">
                ${content.innerHTML}
              </div>
            </div>

            <!-- Hidden Branding Definitions: Robust mso-hide:all to prevent Page 3 leakage -->
            <div style='mso-hide:all; display:none; height:1px; overflow:hidden;'>
              ${getWordBrandingHTML('header', baseUrl)}
              ${getWordBrandingHTML('footer', baseUrl)}
            </div>
          </body>
          </html>
        `;

          // Create Blob and Download
          const blob = new Blob(['\ufeff', htmlContent], {
            type: 'application/msword'
          });

          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Contract_${contractId}.doc`;
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
          }, 100);
        };

        // Helper function to generate font size CSS
        function generateFontSizeCSS() {
          return `
          .ql-size-small { font-size: 0.75em; }
          .ql-size-large { font-size: 1.5em; }
          .ql-size-huge { font-size: 2.5em; }
          .ql-size-8px { font-size: 8px; }
          .ql-size-10px { font-size: 10px; }
          .ql-size-12px { font-size: 12px; }
          .ql-size-14px { font-size: 14px; }
          .ql-size-16px { font-size: 16px; }
          .ql-size-18px { font-size: 18px; }
          .ql-size-20px { font-size: 20px; }
          .ql-size-24px { font-size: 24px; }
          .ql-size-30px { font-size: 30px; }
          .ql-size-36px { font-size: 36px; }
          .ql-size-48px { font-size: 48px; }
          .ql-size-60px { font-size: 60px; }
          .ql-size-72px { font-size: 72px; }
        `;
        }

        // Helper to load html2pdf
        async function loadHtml2Pdf() {
          if (window.html2pdf) return window.html2pdf;
          return new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
            s.onload = () => resolve(window.html2pdf);
            s.onerror = () => reject(new Error('Failed to load html2pdf'));
            document.head.appendChild(s);
          });
        }

        // Share View Contract via WhatsApp (No PDF download)
        window.shareViewContract = async function () {
          const contractId = window.currentViewContractId || 'Contract';
          const clientPhone = window.currentViewContractClientPhone || '';

          // Prompt for number
          let phone = prompt('ุฃุฏุฎู ุฑูู ุงููุงุชุณุงุจ (ูุซุงู: 9665xxxxxxxx):', clientPhone.replace(/^\+/, '').replace(/^00/, ''));
          if (!phone) return;

          // Basic cleanup
          phone = phone.replace(/[^0-9]/g, '');

          // Open WhatsApp with contract link
          // const url = `${window.location.origin}/pdf-sign.html?id=${contractId}`;
          const text = `ูุฑุญุจุงูุ ุฅููู ูุณุฎุฉ ูู ุงูุนูุฏ ุฑูู ${contractId}.\n`;
          const shareUrl = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;

          window.open(shareUrl, '_blank');
        };

        // Display contract attachments in view modal
        async function displayViewAttachments(contractId) {
          const container = document.getElementById('v-attachments-display');
          if (!container) return;

          try {
            console.log('Fetching attachments for contract:', contractId);
            const res = await apiFetch(`/contracts/${contractId}/attachments`, { method: 'GET' });

            // Fix: server returns array directly, or object with attachments property
            const attachments = Array.isArray(res) ? res : (res && res.attachments ? res.attachments : []);

            if (attachments.length === 0) {
              container.innerHTML = '<p class="muted">ูุง ุชูุฌุฏ ูุฑููุงุช</p>';
              return;
            }

            const labels = {
              license_photo: 'ุตูุฑุฉ ุงูุฑุฎุตุฉ',
              container_location_doc: 'ูููุน ุงูุญุงููุฉ',
              commercial_registration: 'ุงูุณุฌู ุงูุชุฌุงุฑู',
              activity_license: 'ุฑุฎุตุฉ ุงููุดุงุท',
              tax_number: 'ุงูุฑูู ุงูุถุฑูุจู'
            };

            let html = '';
            attachments.forEach(att => {
              const label = labels[att.field_name] || att.field_name;
              html += `<div style="margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <strong style="color: #475569;">${label}:</strong> `;

              if (att.field_type === 'text') {
                html += `<span>${att.text_value || '-'}</span>`;
              } else if (att.field_type === 'image' && att.image_filename) {
                const fileUrl = `/api/contracts/${contractId}/attachments/file/${att.image_filename}`;
                html += `<br><a href="${fileUrl}" target="_blank">
                           <img src="${fileUrl}" 
                                style="max-width: 100%; max-height: 400px; margin-top: 8px; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;"
                                onerror="this.src='https://placehold.co/400x300?text=Image+Not+Found'; console.error('Image load failed:', '${fileUrl}')">
                         </a>`;
              }
              html += '</div>';
            });

            container.innerHTML = html;
          } catch (err) {
            console.error('Error fetching attachments:', err);
            container.innerHTML = '<p class="muted" style="color:#ef4444;">ูุดู ุชุญููู ุงููุฑููุงุช: ' + err.message + '</p>';
          }
        }

        // status update
        async function updateStatus(id, status) {
          if (!confirm('ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู ' + (status === 'active' ? 'ูุดุท' : (status === 'pending' ? 'ููุฏ ุงูุชูููุน' : 'ููุชูู')) + 'ุ')) return;
          try {
            await apiFetch('/contracts/' + encodeURIComponent(id), {
              method: 'PUT',
              body: JSON.stringify({ status: status })
            });
            await loadContracts();
          } catch (err) { alert('ุฎุทุฃ: ' + err.message); }
        }
        window.updateStatus = updateStatus;

        // open edit
        async function openEdit(id) {
          try {
            // Fetch contract from API
            const rows = await apiFetch('/contracts?q=' + id, { method: 'GET' });
            const c = Array.isArray(rows) ? rows.find(r => r.id === id) : rows;

            if (!c) return alert('ุงูุนูุฏ ุบูุฑ ููุฌูุฏ');

            // Safely set values with null checks
            let clientNameVal = c.second_party || '';
            // If it's a preamble, extract the name
            if (clientNameVal.includes('ุงูุทุฑู ุงูุซุงูู') && clientNameVal.includes('ูุฌูุณูุชูุง')) {
              const m = clientNameVal.match(/ุงูุทุฑู ุงูุซุงูู\s+(?:<[^>]+>)*([^\u0648<]+)/);
              if (m && m[1]) clientNameVal = m[1].trim();
            }
            if ($('clientName')) $('clientName').value = clientNameVal;
            if ($('secondParty')) $('secondParty').value = clientNameVal;
            if ($('clientType')) $('clientType').value = c.client_type || 'ูุฑุฏ';

            // If client details are missing in contract response, try to fetch client
            if (c.client_id && (!c.city || !c.district)) {
              try {
                const client = await apiFetch('/clients/' + c.client_id);
                if (client) {
                  if ($('city') && !c.city) $('city').value = client.city || '';
                  if ($('district') && !c.district) $('district').value = client.district || '';
                  // Update other client fields if needed
                }
              } catch (e) { console.warn('Could not fetch client details', e); }
            } else {
              if ($('clientType')) $('clientType').value = c.client_type || 'ูุฑุฏ';
              if ($('city')) $('city').value = c.city || '';
              if ($('district')) $('district').value = c.district || '';
              if ($('containerType')) $('containerType').value = c.container_type || 'ุจุฑููู';
            }

            // Restore Representative Info from Terms Content (Solidified Text)
            // We search the full terms because that's where the preamble usually lives in solidified contracts
            const allText = (c.terms || '') + (c.second_party || '');
            if (allText && allText.includes('ูููุซูู ูู ุงูุชูุงููุน')) {
              if ($('hasRepresentative')) {
                $('hasRepresentative').checked = true;
                toggleRepresentativeInput();

                // Extract Name and Title
                // Regex: ... ุงูุงุณุชุงุฐ / [Name] - ุจุตูุชู [Title] ...
                const m = allText.match(/ุงูุงุณุชุงุฐ \/ (.*?)((?=\s*- ุจุตูุชู)|(?=\s*ููุดุงุฑ)|$)/);
                if (m && m[1]) {
                  $('representativeName').value = m[1].trim();
                }
                const mTitle = allText.match(/- ุจุตูุชู (.*?)((?=\s*ููุดุงุฑ)|$)/);
                if (mTitle && mTitle[1]) {
                  $('representativeTitle').value = mTitle[1].trim();
                }
              }
            } else {
              if ($('hasRepresentative')) {
                $('hasRepresentative').checked = false;
                // Don't clear values here immediately if they might be needed, but safe to clear for visual consistency
                // Actually, if we are editing an existing contract that DOESN'T have a rep, we should clear.
                toggleRepresentativeInput();
                $('representativeName').value = '';
                $('representativeTitle').value = '';
              }
            }

            if (c.service_name && $('serviceType')) {
              const sel = $('serviceType');
              if (![...sel.options].some(o => o.value === c.service_name)) {
                const opt = document.createElement('option');
                opt.value = c.service_name;
                opt.textContent = c.service_name;
                sel.appendChild(opt);
              }
              $('serviceType').value = c.service_name;
            }

            // Handle dates - ensure we format YYYY-MM-DD
            const fmtDate = (d) => {
              if (!d) return '';
              if (typeof d === 'string' && d.includes('T') && d.endsWith('Z')) {
                const date = new Date(d);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
              }
              if (typeof d === 'string' && d.length >= 10) return d.substring(0, 10);
              return d;
            };

            if ($('dateFrom')) $('dateFrom').value = fmtDate(c.from_date);
            if ($('dateTo')) $('dateTo').value = fmtDate(c.to_date);

            if ($('monthlyFee')) $('monthlyFee').value = c.monthly_fee || '';
            if ($('tax')) $('tax').value = c.tax || '15%';
            if ($('totalPrice')) $('totalPrice').value = c.total_price || '';
            if ($('manager')) {
              const val = c.manager || '';
              const sel = $('manager');
              if (val && ![...sel.options].some(o => o.value === val)) {
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                sel.appendChild(opt);
              }
              sel.value = val;
            }
            if ($('collector')) {
              const val = c.collector || '';
              const sel = $('collector');
              if (val && ![...sel.options].some(o => o.value === val)) {
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                sel.appendChild(opt);
              }
              sel.value = val;
            }
            if ($('status')) $('status').value = c.status || 'pending';
            if ($('containerType')) $('containerType').value = c.container_type || 'ุจุฑููู';

            // Location fields
            if ($('containerLocation')) $('containerLocation').value = c.container_location || '';
            // if ($('pickupLocation')) $('pickupLocation').value = c.pickup_location || '';
            if ($('location')) $('location').value = c.location || '';

            if ($('duration')) $('duration').value = c.duration || 'ุณููู';
            if ($('paymentType')) $('paymentType').value = c.payment_type || 'ุณูููุฉ';
            if ($('signMethod')) $('signMethod').value = c.sign_method || 'ุฅููุชุฑููู';

            // Terms handling
            if ($('terms')) $('terms').value = c.terms || '';
            if ($('termsSummary')) {
              if (c.terms && c.terms.trim().length > 0) {
                const firstLine = c.terms.split('\n')[0];
                $('termsSummary').value = 'ุชู ุงุณุชุฑุฌุงุน ุงูุดุฑูุท: ' + (firstLine.substring(0, 30) + '...');
              } else {
                $('termsSummary').value = '';
              }
            }

            // Handle signing fields
            if ($('firstParty')) $('firstParty').value = c.first_party || 'ุดุฑูุฉ ุจูุช ููููุงููุงุช';
            if ($('secondParty')) $('secondParty').value = c.second_party || c.client_name || '';
            if ($('clientEmail')) $('clientEmail').value = c.client_email || '';
            if ($('clientPhone')) $('clientPhone').value = c.client_phone || '';
            if ($('clientPhone')) $('clientPhone').value = c.client_phone || '';

            updateGoogleLink('container', c.container_location);
            // updateGoogleLink('pickup', c.pickup_location);
            $('formWrap').dataset.editing = c.id;

            // Fetch and display attachments
            try {
              const attachments = await apiFetch(`/contracts/${id}/attachments`, { method: 'GET' });
              displayAttachments(attachments || []);

              // Also populate the attachment INPUT fields with existing data
              if (attachments && Array.isArray(attachments)) {
                attachments.forEach(att => {
                  if (att.field_type === 'text' && att.text_value) {
                    // Populate text fields
                    if (att.field_name === 'container_location_doc' && $('containerLocationAttachment')) {
                      $('containerLocationAttachment').value = att.text_value;
                    } else if (att.field_name === 'commercial_registration' && $('commercialRegistry')) {
                      $('commercialRegistry').value = att.text_value;
                    } else if (att.field_name === 'activity_license' && $('activityLicense')) {
                      $('activityLicense').value = att.text_value;
                    } else if (att.field_name === 'tax_number' && $('taxNumber')) {
                      $('taxNumber').value = att.text_value;
                    }
                  }
                  // Note: Image files are displayed in the attachmentsDisplay section, not in input field
                });
                console.log('โ Loaded attachment values into input fields');
              }
            } catch (err) {
              console.warn('Could not load attachments:', err);
              displayAttachments([]);
            }

            // Hide attachments input section when editing (attachments can only be added when creating new contract)
            setContractAttachmentsVisible(true);
            delete $('formWrap').dataset.renewing; // Clear renewal flag when editing

            showElem($('formWrap'));
            window.scrollTo({ top: 0, behavior: 'smooth' });
          } catch (err) {
            console.error('Open edit error:', err);
            alert('ุฎุทุฃ: ' + (err.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'));
          }
        }
        window.openEdit = openEdit;

        // ============ OPEN RENEW - Contract Renewal Function ============
        async function openRenew(id) {
          try {
            const rows = await apiFetch('/contracts?q=' + id, { method: 'GET' });
            const c = Array.isArray(rows) ? rows.find(r => r.id === id) : rows;
            if (!c) return alert('ุงูุนูุฏ ุบูุฑ ููุฌูุฏ');

            delete $('formWrap').dataset.editing;
            $('formWrap').dataset.renewing = 'true';
            $('formWrap').dataset.parentContractId = id;

            // Load form fields
            if ($('clientName')) $('clientName').value = c.second_party || '';
            if ($('clientType')) $('clientType').value = c.client_type || 'ูุฑุฏ';
            if ($('city')) $('city').value = c.city || '';
            if ($('district')) $('district').value = c.district || '';

            if (c.service_name && $('serviceType')) {
              const sel = $('serviceType');
              if (![...sel.options].some(o => o.value === c.service_name)) {
                const opt = document.createElement('option');
                opt.value = c.service_name;
                opt.textContent = c.service_name;
                sel.appendChild(opt);
              }
              $('serviceType').value = c.service_name;
            }

            // Set new dates: today to one year later
            const today = new Date();
            const oneYearLater = new Date(today);
            oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);
            if ($('dateFrom')) $('dateFrom').value = today.toISOString().split('T')[0];
            if ($('dateTo')) $('dateTo').value = oneYearLater.toISOString().split('T')[0];

            if ($('monthlyFee')) $('monthlyFee').value = c.monthly_fee || '';
            if ($('tax')) $('tax').value = c.tax || '15%';
            if ($('totalPrice')) $('totalPrice').value = c.total_price || '';

            if ($('manager')) {
              const val = c.manager || '';
              const sel = $('manager');
              if (val && ![...sel.options].some(o => o.value === val)) {
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                sel.appendChild(opt);
              }
              sel.value = val;
            }
            if ($('collector')) {
              const val = c.collector || '';
              const sel = $('collector');
              if (val && ![...sel.options].some(o => o.value === val)) {
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                sel.appendChild(opt);
              }
              sel.value = val;
            }

            if ($('status')) $('status').value = 'pending';
            if ($('containerType')) $('containerType').value = c.container_type || 'ุจุฑููู';
            if ($('containerLocation')) $('containerLocation').value = c.container_location || '';
            if ($('location')) $('location').value = c.location || '';
            if ($('duration')) $('duration').value = c.duration || 'ุณููู';
            if ($('paymentType')) $('paymentType').value = c.payment_type || 'ุณูููุฉ';
            if ($('signMethod')) $('signMethod').value = c.sign_method || 'ุฅููุชุฑููู';

            if ($('terms')) $('terms').value = c.terms || '';
            if ($('termsSummary')) {
              if (c.terms && c.terms.trim().length > 0) {
                $('termsSummary').value = 'ุชุฌุฏูุฏ: ' + c.terms.split('\n')[0].substring(0, 30) + '...';
              } else {
                $('termsSummary').value = '';
              }
            }

            if ($('firstParty')) $('firstParty').value = c.first_party || 'ุดุฑูุฉ ุจูุช ููููุงููุงุช';
            if ($('secondParty')) $('secondParty').value = c.second_party || '';
            if ($('clientEmail')) $('clientEmail').value = c.client_email || '';
            if ($('clientPhone')) $('clientPhone').value = c.client_phone || '';

            updateGoogleLink('container', c.container_location);

            // Fetch parent attachments
            try {
              const attachments = await apiFetch(`/contracts/${id}/attachments`, { method: 'GET' });
              displayRenewalAttachments(attachments || [], id);

              if (attachments && Array.isArray(attachments)) {
                attachments.forEach(att => {
                  if (att.field_type === 'text' && att.text_value) {
                    if (att.field_name === 'commercial_registration' && $('commercialRegistry')) {
                      $('commercialRegistry').value = att.text_value;
                    } else if (att.field_name === 'activity_license' && $('activityLicense')) {
                      $('activityLicense').value = att.text_value;
                    } else if (att.field_name === 'tax_number' && $('taxNumber')) {
                      $('taxNumber').value = att.text_value;
                    }
                  }
                });
              }
            } catch {
              displayRenewalAttachments([], id);
            }

            setContractAttachmentsVisible(true);
            showElem($('formWrap'));
            window.scrollTo({ top: 0, behavior: 'smooth' });
            alert(`ุชู ุชุญููู ุจูุงูุงุช ุงูุนูุฏ ${id} ููุชุฌุฏูุฏ. ุณูุชู ุฅูุดุงุก ุนูุฏ ุฌุฏูุฏ ุนูุฏ ุงูุญูุธ.`);
          } catch (err) {
            console.error('Open renew error:', err);
            alert('ุฎุทุฃ: ' + (err.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'));
          }
        }
        window.openRenew = openRenew;

        function displayRenewalAttachments(attachments, parentId) {
          const container = $('attachmentsDisplay');
          const list = $('attachmentsList');
          if (!container || !list) return;

          if (attachments.length === 0) {
            container.style.display = 'block';
            list.innerHTML = '<div class="muted" style="padding:12px; text-align:center;">ูุง ุชูุฌุฏ ูุฑููุงุช ูู ุงูุนูุฏ ุงูุฃุตูู</div>';
            return;
          }

          container.style.display = 'block';
          list.innerHTML = `
          <div style="margin-bottom:12px; padding:12px; background:#f0fdf4; border-radius:6px; border:1px solid #bbf7d0;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <strong style="color:#15803d;">๐ ูุฑููุงุช ูู ุงูุนูุฏ ุงูุฃุตูู (${parentId})</strong>
                <p style="margin:4px 0 0 0; font-size:0.85em; color:#4ade80;">ุณูุชู ูุณุฎูุง ููุนูุฏ ุงูุฌุฏูุฏ ุชููุงุฆูุงู</p>
              </div>
              <button id="toggleOldAttachments" class="btn small" style="background:#10b981; color:white;" onclick="toggleOldAttachmentsVisibility()">ุฅุฎูุงุก</button>
            </div>
          </div>
          <div id="oldAttachmentsContainer" style="display:block;"></div>
        `;

          const oldContainer = document.getElementById('oldAttachmentsContainer');
          const labels = { license_photo: 'ุตูุฑุฉ ุงูุฑุฎุตุฉ', commercial_registration: 'ุงูุณุฌู ุงูุชุฌุงุฑู', activity_license: 'ุฑุฎุตุฉ ุงููุดุงุท', tax_number: 'ุงูุฑูู ุงูุถุฑูุจู' };

          attachments.forEach(att => {
            const label = labels[att.field_name] || att.field_name;
            const div = document.createElement('div');
            div.style.cssText = 'margin-bottom:12px; padding:12px; background:#fef3c7; border-radius:6px; border:1px solid #fde047;';

            if (att.field_type === 'text') {
              div.innerHTML = `<div style="font-weight:600; color:#92400e; margin-bottom:4px;">${label} <span style="font-size:0.75em;">(ูุฏูู)</span></div>
              <div style="color:#78350f; font-size:14px;">${att.text_value || ''}</div>`;
            } else if (att.field_type === 'image' && att.image_filename) {
              const url = `/api/contracts/${parentId}/attachments/file/${att.image_filename}`;
              const isImg = att.image_filename.match(/\.(jpg|jpeg|png|gif)$/i);
              div.innerHTML = `<div style="font-weight:600; color:#92400e; margin-bottom:8px;">${label} <span style="font-size:0.75em;">(ูุฏูู)</span></div>
              ${isImg ? `<a href="${url}" target="_blank"><img src="${url}" style="max-width:200px; border-radius:4px; border:1px solid #fde047;"/></a>` :
                  `<a href="${url}" target="_blank" style="color:#92400e; text-decoration:none;"><span>๐</span> ${att.image_filename}</a>`}`;
            }
            oldContainer.appendChild(div);
          });
        }

        window.toggleOldAttachmentsVisibility = function () {
          const container = document.getElementById('oldAttachmentsContainer');
          const btn = document.getElementById('toggleOldAttachments');
          if (container && btn) {
            if (container.style.display === 'none') {
              container.style.display = 'block';
              btn.textContent = 'ุฅุฎูุงุก';
            } else {
              container.style.display = 'none';
              btn.textContent = 'ุนุฑุถ';
            }
          }
        };


        // Display contract attachments
        function displayAttachments(attachments) {
          const container = $('attachmentsDisplay');
          const list = $('attachmentsList');

          if (!container || !list) return;

          if (attachments.length === 0) {
            container.style.display = 'none';
            return;
          }

          container.style.display = 'block';
          list.innerHTML = '';

          const fieldLabels = {
            license_photo: 'ุตูุฑุฉ ุงูุฑุฎุตุฉ',
            container_location_doc: 'ูุซููุฉ ูููุน ุงูุนููู',
            commercial_registration: 'ุงูุณุฌู ุงูุชุฌุงุฑู',
            activity_license: 'ุฑุฎุตุฉ ุงููุดุงุท',
            tax_number: 'ุงูุฑูู ุงูุถุฑูุจู'
          };

          // Deduplicate attachments by field_name - keep only the most recent one for each field
          const uniqueAttachments = {};
          attachments.forEach(att => {
            const fieldName = att.field_name;
            // If we haven't seen this field yet OR this one has a later ID (more recent), use it
            if (!uniqueAttachments[fieldName] || (att.id > uniqueAttachments[fieldName].id)) {
              uniqueAttachments[fieldName] = att;
            }
          });

          // Convert back to array and display
          Object.values(uniqueAttachments).forEach(att => {
            const fieldLabel = fieldLabels[att.field_name] || att.field_name;
            const div = document.createElement('div');
            div.style.cssText = 'margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;';

            if (att.field_type === 'text') {
              div.innerHTML = `
              <div style="font-weight: 600; color: #475569; margin-bottom: 4px;">${fieldLabel}</div>
              <div style="color: #64748b; font-size: 14px;">${att.text_value || ''}</div>
            `;
            } else if (att.field_type === 'image' && att.image_filename) {
              const contractId = $('formWrap').dataset.editing;
              const fileUrl = `/api/contracts/${contractId}/attachments/file/${att.image_filename}`;
              const isImage = att.image_filename.match(/\.(jpg|jpeg|png|gif)$/i);

              div.innerHTML = `
              <div style="font-weight: 600; color: #475569; margin-bottom: 8px;">${fieldLabel}</div>
              ${isImage ? `
                <a href="${fileUrl}" target="_blank">
                  <img src="${fileUrl}" alt="${fieldLabel}" style="max-width: 200px; max-height: 200px; border-radius: 4px; border: 1px solid #e2e8f0; cursor: pointer;" />
                </a>
              ` : `
                <a href="${fileUrl}" target="_blank" style="color: #3b82f6; text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
                  <span>๐</span>
                  <span>${att.image_filename}</span>
                </a>
              `}
            `;
            }

            list.appendChild(div);
          });
        }

        // save contract (create or update)
        // NOTE: When $('formWrap').dataset.renewing is 'true', this is a renewal contract
        // that doesn't require attachments (ูุฑููุงุช ุงูุนูุฏ). Attachments are handled separately
        // via the pdf-sign.html page and are optional for all contracts.
        $('saveContractBtn').addEventListener('click', async () => {
          try {
            if (!token) return alert('ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู');

            // 1. Ensure pricing term is up-to-date with current form values in background
            if (typeof updatePricingTermContent === 'function') {
              console.log('๐ Solidifying pricing term...');
              await updatePricingTermContent();
            }

            // Validate required fields
            const clientName = $('clientName').value;
            if (!clientName || clientName.trim() === '') {
              alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุนููู');
              return;
            }

            const clientPhone = $('clientPhone').value;
            if (!clientPhone || clientPhone.trim() === '') {
              alert('ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงูุฌูุงู');
              return;
            }


            let contractId = $('formWrap').dataset.editing;
            const isNew = !contractId;

            let clientId;

            // Only create a new client if this is a NEW contract
            // For existing contracts, we'll get the client_id from the contract data
            if (isNew) {
              // Generate a client_id for new contracts (no database record needed)
              clientId = 'client-' + Date.now();
              // Let server generate contract ID
              contractId = null;
            } else {
              // For editing, fetch the existing contract to get client_id
              const existingContract = await apiFetch('/contracts?q=' + contractId, { method: 'GET' });
              const contract = Array.isArray(existingContract) ? existingContract.find(c => c.id === contractId) : existingContract;
              clientId = contract?.client_id;

              if (!clientId) {
                alert('ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ูุนุฑู ุงูุนููู');
                return;
              }

              // Update client information when editing
              // Only update if client_id is a valid integer (new data format)
              // Skip if it's a string ID (legacy data)
              if (clientId && !isNaN(parseInt(clientId))) {
                try {
                  await apiFetch('/clients/' + clientId, {
                    method: 'PUT',
                    body: JSON.stringify({
                      name: clientName.trim(),
                      type: $('clientType').value || 'ูุฑุฏ',
                      city: $('city')?.value || '',
                      district: $('district')?.value || ''
                    })
                  });
                } catch (updateErr) {
                  console.warn('Failed to update client info:', updateErr);
                  // Continue anyway - contract update is more important
                }
              } else {
                console.log('Skipping client update - legacy string ID:', clientId);
              }
            }


            // Helper to handle date fields: send null if empty, otherwise value
            const getDateVal = (id) => {
              const val = $(id)?.value;
              return val ? val : null;
            };

            // Build contract payload
            const payload = {
              id: contractId,
              client_id: clientId, // Backend expects client_id
              client_type: $('clientType')?.value || 'ูุฑุฏ',
              service_name: $('serviceType')?.value || 'ูุธุงูุฉ ููููุฉ',

              from_date: getDateVal('dateFrom'),
              to_date: getDateVal('dateTo'),

              container_type: $('containerType')?.value || 'ุจุฑููู',
              location: $('location')?.value || null, // Backend expects location

              monthly_fee: parseFloat($('monthlyFee')?.value || 0),
              tax: $('tax')?.value || '15%',
              total_price: parseFloat($('totalPrice')?.value || 0),
              manager: $('manager')?.value || '',
              status: $('status')?.value || 'pending',
              sign_method: $('signMethod')?.value || 'ุฅููุชุฑููู',
              // SOLIDIFY TERMS: Apply all dynamic replacements before saving to database
              terms: (typeof replaceDatePlaceholders === 'function' && typeof getContractDataFromForm === 'function')
                ? replaceDatePlaceholders($('terms')?.value || '', getContractDataFromForm())
                : ($('terms')?.value || ''),

              // Backend fields from error log:
              // file_url: COALESCE(?, file_url) -> handled by backend usually, we send null or undefined if not changing
              client_email: $('clientEmail')?.value || '',

              // Extra fields that might not be in backend but we send anyway just in case:
              city: $('city')?.value || '',
              district: $('district')?.value || '',
              container_location: $('containerLocation')?.value || null,
              // pickup_location: $('pickupLocation')?.value || null,
              duration: $('duration')?.value || 'ุณููู',
              payment_type: $('paymentType')?.value || 'ุณูููุฉ',
              first_party: $('firstParty')?.value || 'ุดุฑูุฉ ุจูุช ููููุงููุงุช',
              second_party: $('secondParty')?.value || $('clientName')?.value || '',
              client_phone: $('clientPhone')?.value || '',
              collector: $('collector')?.value || '' // Sending it even if backend might ignore it
            };

            // If this is a renewal, track the parent contract ID
            if ($('formWrap').dataset.renewing === 'true' && $('formWrap').dataset.parentContractId) {
              payload.parent_contract_id = $('formWrap').dataset.parentContractId;
              console.log(`๐ Renewal: Linking to parent contract ${payload.parent_contract_id}`);
            }

            console.log('Saving contract payload:', payload);

            if (!isNew) {
              // Update existing contract
              await apiFetch('/contracts/' + encodeURIComponent(contractId), { method: 'PUT', body: JSON.stringify(payload) });

              // Also update attachments if the section is visible and has data
              const attachmentsVisible = $('contractAttachmentsSection') &&
                $('contractAttachmentsSection').style.display !== 'none';

              if (attachmentsVisible) {
                try {
                  console.log('Updating attachments for contract:', contractId);
                  await uploadContractAttachments(contractId);
                  console.log('โ Attachments updated successfully');
                } catch (attachErr) {
                  console.warn('โ๏ธ Failed to update attachments:', attachErr);
                  alert('ุชู ุชุญุฏูุซ ุงูุนูุฏ ุจูุฌุงุญ ูููู ุญุฏุซ ุฎุทุฃ ูู ุชุญุฏูุซ ุงููุฑููุงุช: ' + attachErr.message);
                }
              }

              alert('ุชู ุชุญุฏูุซ ุงูุนูุฏ ุจูุฌุงุญ');
              delete $('formWrap').dataset.editing;
            } else {
              // For new contracts, let server generate ID or handle it. 
              // We send payload without ID (or with null ID) if we want server to gen, 
              // but our payload construction used contractId. 
              // We will send payload with null ID and let server assign it.
              if (payload.id === undefined || payload.id === null) delete payload.id;

              const res = await apiFetch('/contracts', { method: 'POST', body: JSON.stringify(payload) });
              const newContractId = res.id || contractId;

              // Upload attachments for NEW contracts
              const isRenewal = $('formWrap').dataset.renewing === 'true';
              const parentContractId = $('formWrap').dataset.parentContractId;
              const attachmentsVisible = $('contractAttachmentsSection') &&
                $('contractAttachmentsSection').style.display !== 'none';

              if (isRenewal && parentContractId) {
                // For renewals: copy attachments from parent contract
                try {
                  console.log('๐ Copying attachments from parent contract:', parentContractId);
                  const parentAttachments = await apiFetch(`/contracts/${parentContractId}/attachments`, { method: 'GET' });

                  if (parentAttachments && parentAttachments.length > 0) {
                    // Prepare attachment data to copy
                    const attachmentsCopy = parentAttachments.map(att => ({
                      fieldName: att.field_name,
                      fieldType: att.field_type,
                      textValue: att.text_value,
                      isFromParent: true // Mark as inherited
                    }));

                    // Send to server
                    await apiFetch(`/contracts/${newContractId}/attachments`, {
                      method: 'POST',
                      body: JSON.stringify({ attachmentsData: attachmentsCopy })
                    });

                    console.log(`โ Copied ${attachmentsCopy.length} attachments from parent contract`);
                  }
                } catch (copyErr) {
                  console.warn('โ๏ธ Failed to copy parent attachments:', copyErr);
                  // Don't alert user - this is not critical
                }

                // Also upload any NEW attachments user added
                if (attachmentsVisible) {
                  try {
                    await uploadContractAttachments(newContractId);
                    console.log('โ Uploaded new attachments');
                  } catch (attachErr) {
                    console.warn('โ๏ธ Failed to upload new attachments:', attachErr);
                  }
                }
              } else if (!isRenewal && attachmentsVisible) {
                // Regular new contract - upload attachments normally
                try {
                  console.log('Uploading attachments for new contract:', newContractId);
                  await uploadContractAttachments(newContractId);
                  console.log('โ Attachments uploaded successfully');
                } catch (attachErr) {
                  console.warn('โ๏ธ Failed to upload some attachments:', attachErr);
                  alert('ุชู ุฅูุดุงุก ุงูุนูุฏ ุจูุฌุงุญ ูููู ุญุฏุซ ุฎุทุฃ ูู ุฑูุน ุจุนุถ ุงููุฑููุงุช: ' + attachErr.message);
                }
              }

              alert('ุชู ุฅูุดุงุก ุงูุนูุฏ ุจูุฌุงุญ: ' + newContractId);
            }

            // Clear renewal flag if it was set
            delete $('formWrap').dataset.renewing;

            hideElem($('formWrap'));
            await loadContracts();
          } catch (err) {
            console.error('Contract save error:', err);
            const errorMessage = err.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู';
            alert('ุฎุทุฃ ูู ุงูุญูุธ: ' + errorMessage);
          }
        });

        $('cancelFormBtn').addEventListener('click', () => {
          delete $('formWrap').dataset.renewing; // Clear renewal flag
          hideElem($('formWrap'));
        });

        // ============ CONTRACT ATTACHMENTS FUNCTIONALITY ============

        // License Image Preview
        const licenseImageInput = $('licenseImage');
        if (licenseImageInput) {
          licenseImageInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            const preview = $('licenseImagePreview');

            if (file && preview) {
              // Validate file type
              const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
              if (!allowedTypes.includes(file.type)) {
                alert('ูุฑุฌู ุงุฎุชูุงุฑ ุตูุฑุฉ ุจุตูุบุฉ JPG, PNG, ุฃู GIF');
                e.target.value = '';
                preview.innerHTML = '';
                return;
              }

              // Validate file size (max 5MB)
              if (file.size > 5 * 1024 * 1024) {
                alert('ุญุฌู ุงูุตูุฑุฉ ูุฌุจ ุฃู ูุง ูุชุฌุงูุฒ 5 ููุฌุงุจุงูุช');
                e.target.value = '';
                preview.innerHTML = '';
                return;
              }

              // Show preview
              const reader = new FileReader();
              reader.onload = function (event) {
                preview.innerHTML = `
                <div style="margin-top: 8px; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                  <div style="font-weight: 600; color: #475569; margin-bottom: 6px; font-size: 13px;">ูุนุงููุฉ:</div>
                  <img src="${event.target.result}" alt="License Preview" 
                    style="max-width: 200px; max-height: 200px; border-radius: 4px; border: 1px solid #cbd5e1;" />
                  <div style="margin-top: 6px; font-size: 12px; color: #64748b;">
                    ${file.name} (${(file.size / 1024).toFixed(2)} KB)
                  </div>
                </div>
              `;
              };
              reader.readAsDataURL(file);
            } else if (preview) {
              preview.innerHTML = '';
            }
          });
        }

        // Function to show/hide attachments section based on contract type
        window.setContractAttachmentsVisible = function (isVisible) {
          const section = $('contractAttachmentsSection');
          if (section) {
            section.style.display = isVisible ? 'block' : 'none';
          }
        };

        // Function to clear attachment fields
        window.clearAttachmentFields = function () {
          if ($('licenseImage')) $('licenseImage').value = '';
          if ($('licenseImagePreview')) $('licenseImagePreview').innerHTML = '';
          if ($('containerLocationAttachment')) $('containerLocationAttachment').value = '';
          if ($('commercialRegistry')) $('commercialRegistry').value = '';
          if ($('activityLicense')) $('activityLicense').value = '';
          if ($('taxNumber')) $('taxNumber').value = '';
        };

        // Function to upload attachments to server using FormData for reliability
        async function uploadContractAttachments(contractId) {
          try {
            const formData = new FormData();
            const attachmentsMeta = [];

            // Helper to get file from either main input or camera input
            const getFile = (mainId, camId) => {
              const main = $(mainId);
              const cam = $(camId);
              return (main && main.files && main.files[0]) || (cam && cam.files && cam.files[0]);
            };

            const fields = [
              { id: 'licenseImage', camId: 'licenseImageCamera', name: 'license_photo' },
              { id: 'commercialRegistry', camId: 'commercialRegistryCamera', name: 'commercial_registration' },
              { id: 'activityLicense', camId: 'activityLicenseCamera', name: 'activity_license' },
              { id: 'taxNumber', camId: 'taxNumberCamera', name: 'tax_number' }
            ];

            fields.forEach(f => {
              const file = getFile(f.id, f.camId);
              if (file) {
                formData.append('files', file);
                attachmentsMeta.push({ field_name: f.name, field_type: 'image' });
              }
            });

            // Handle text-based placeholder if needed
            const containerLoc = $('containerLocationAttachment');
            if (containerLoc && containerLoc.value.trim()) {
              attachmentsMeta.push({ field_name: 'container_location_doc', field_type: 'text', text_value: containerLoc.value.trim() });
            }

            if (attachmentsMeta.length === 0) {
              console.log('No attachments to upload');
              return { success: true };
            }

            formData.append('attachmentsData', JSON.stringify(attachmentsMeta));

            console.log(`Uploading ${attachmentsMeta.length} attachments for contract ${contractId} via FormData`);

            const response = await apiFetch(`/contracts/${contractId}/attachments`, {
              method: 'POST',
              body: formData
            });

            console.log('โ Attachments uploaded successfully');
            return { success: true, data: response };

          } catch (error) {
            console.error('โ Error uploading attachments:', error);
            throw error;
          }
        }

        // Expose function globally for      // Delete Contract Function
        window.deleteContract = async function (contractId) {
          if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุนูุฏ ${contractId}ุ\n\nุณูุชู ุญุฐู ุงูุนูุฏ ุจุดูู ููุงุฆู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุฌููุน ุงููุฑููุงุช ุงููุชุนููุฉ ุจู.`)) {
            return;
          }

          try {
            const response = await apiFetch(`/contracts/${contractId}`, {
              method: 'DELETE'
            });

            if (response && response.message) {
              alert(`โ ${response.message}`);
              // Reload contracts list
              await loadContracts();
            }
          } catch (err) {
            console.error('Delete error:', err);
            alert('โ ูุดู ุญุฐู ุงูุนูุฏ: ' + (err.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'));
          }
        };

        // Save Contract Function
        window.uploadContractAttachments = uploadContractAttachments;

        // ============ NEW CONTRACT & RENEW CONTRACT BUTTON HANDLERS ============

        // New Contract Button - Show form with attachments section
        const newContractBtn = $('newContractBtn');
        if (newContractBtn) {
          newContractBtn.addEventListener('click', () => {
            if (!token) {
              alert('ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู');
              return;
            }

            // Clear all form fields
            const inputs = $('formWrap').querySelectorAll('input:not([readonly]), select, textarea');
            inputs.forEach(input => {
              if (input.type === 'checkbox') {
                input.checked = false;
              } else if (input.type !== 'hidden' && input.id !== 'firstParty') {
                input.value = '';
              }
            });

            // Set defaults
            if ($('clientType')) $('clientType').value = 'ูุฑุฏ';
            if ($('serviceType')) $('serviceType').value = 'ูุธุงูุฉ ููููุฉ';
            if ($('containerType')) $('containerType').value = 'ุจุฑููู';
            if ($('duration')) $('duration').value = 'ุณููู';
            if ($('paymentType')) $('paymentType').value = 'ุณูููุฉ';
            if ($('status')) $('status').value = 'pending';
            if ($('tax')) $('tax').value = '15%';
            if ($('firstParty')) $('firstParty').value = 'ุดุฑูุฉ ุจูุช ููููุงููุงุช';
            if ($('clientName')) $('secondParty').value = '';
            if ($('terms')) $('terms').value = '';
            if ($('termsSummary')) $('termsSummary').value = '';

            // Automatically generate and insert First Party text with today's dates
            if (typeof generateFirstPartyText === 'function') {
              const firstPartyText = generateFirstPartyText('ุดุฑูุฉ ุจูุช ููููุงููุงุช');
              if ($('terms')) {
                $('terms').value = firstPartyText;
                console.log('โ Auto-inserted First Party text with today\'s dates');
              }
            }

            // Clear editing flag and renewal flag
            delete $('formWrap').dataset.editing;
            delete $('formWrap').dataset.renewing;

            // Clear and show attachments section for NEW contracts
            clearAttachmentFields();
            setContractAttachmentsVisible(true);

            // Show the form
            showElem($('formWrap'));
            window.scrollTo({ top: 0, behavior: 'smooth' });

            console.log('โ New contract form opened with attachments visible');
          });
        }

        // Renew Contract Button - Show form WITHOUT attachments section
        const renewContractBtn = $('renewContractBtn');
        if (renewContractBtn) {
          renewContractBtn.addEventListener('click', () => {
            if (!token) {
              alert('ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู');
              return;
            }

            // Ask user to select a contract to renew
            const contractId = prompt('ุฃุฏุฎู ุฑูู ุงูุนูุฏ ุงููุฑุงุฏ ุชุฌุฏูุฏู:');
            if (!contractId) return;

            // Load the existing contract data
            (async () => {
              try {
                const rows = await apiFetch('/contracts?q=' + contractId, { method: 'GET' });
                const contract = Array.isArray(rows) ? rows.find(r => r.id === contractId) : rows;

                if (!contract) {
                  alert('ุงูุนูุฏ ุบูุฑ ููุฌูุฏ');
                  return;
                }

                // Load existing contract data into form (similar to openEdit)
                if ($('clientName')) $('clientName').value = contract.second_party || '';
                if ($('clientType')) $('clientType').value = contract.client_type || 'ูุฑุฏ';
                if ($('serviceType')) $('serviceType').value = contract.service_name || 'ูุธุงูุฉ ููููุฉ';
                if ($('city')) $('city').value = contract.city || '';
                if ($('district')) $('district').value = contract.district || '';
                if ($('containerType')) $('containerType').value = contract.container_type || 'ุจุฑููู';
                if ($('monthlyFee')) $('monthlyFee').value = contract.monthly_fee || '';
                if ($('tax')) $('tax').value = contract.tax || '15%';
                if ($('totalPrice')) $('totalPrice').value = contract.total_price || '';
                if ($('manager')) $('manager').value = contract.manager || '';
                if ($('collector')) $('collector').value = contract.collector || '';
                if ($('paymentType')) $('paymentType').value = contract.payment_type || 'ุณูููุฉ';
                if ($('duration')) $('duration').value = contract.duration || 'ุณููู';
                if ($('status')) $('status').value = 'pending'; // New renewal starts as pending
                if ($('firstParty')) $('firstParty').value = contract.first_party || 'ุดุฑูุฉ ุจูุช ููููุงููุงุช';
                if ($('secondParty')) $('secondParty').value = contract.second_party || '';
                if ($('clientEmail')) $('clientEmail').value = contract.client_email || '';
                if ($('clientPhone')) $('clientPhone').value = contract.client_phone || '';
                if ($('terms')) $('terms').value = contract.terms || '';
                if ($('container Location')) $('containerLocation').value = contract.container_location || '';

                // Set new dates for renewal (e.g., start from today, end 1 year from now)
                const today = new Date();
                const oneYearLater = new Date(today);
                oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);

                if ($('dateFrom')) $('dateFrom').value = today.toISOString().split('T')[0];
                if ($('dateTo')) $('dateTo').value = oneYearLater.toISOString().split('T')[0];

                // Mark as renewal and clear editing ID (so it creates a new contract)
                delete $('formWrap').dataset.editing;
                $('formWrap').dataset.renewing = 'true';

                // Hide attachments section for RENEWAL contracts
                clearAttachmentFields();
                setContractAttachmentsVisible(false);

                // Show the form
                showElem($('formWrap'));
                window.scrollTo({ top: 0, behavior: 'smooth' });

                console.log('โ Renewal form opened for contract:', contractId);
                alert(`ุชู ุชุญููู ุจูุงูุงุช ุงูุนูุฏ ${contractId} ููุชุฌุฏูุฏ. ุณูุชู ุฅูุดุงุก ุนูุฏ ุฌุฏูุฏ ุนูุฏ ุงูุญูุธ.`);
              } catch (err) {
                console.error('Error loading contract for renewal:', err);
                alert('ุฎุทุฃ ูู ุชุญููู ุงูุนูุฏ: ' + (err.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'));
              }
            })();
          });
        }

        // Preview Contract Button
        const previewContractBtn = $('previewContractBtn');
        if (previewContractBtn) {
          previewContractBtn.addEventListener('click', () => {
            const editingId = $('formWrap')?.dataset?.editing;
            if (editingId) {
              openView(editingId);
            } else {
              openView('new'); // For new contracts, show a live preview
            }
          });
        }

        /* MOVED TO ROBUST GLOBAL SCRIPT AT END OF FILE
        // Restore Missing Google Maps Picker Functions
        window.openMapModalFor = function openMapModalFor(target) {
          // only allow when form visible
          if ($('formWrap').style.display === 'none') {
            alert('ุงูุชุญ ูููุฐุฌ ุฅูุดุงุก/ุชุนุฏูู ุงูุนูุฏ ุฃููุงู ุซู ุงุฎุชุฑ ุงููููุน ูู ุฎุฑุงุฆุท Google.');
            return;
          }
          currentPickerTarget = target;
          $('selectedCoords').value = '';
          showElem($('mapModal'));
        }

        function openGoogleMapsWindow() {
          const url = 'https://www.google.com/maps';
          const w = window.open(url, '_blank', 'noopener');
          if (!w) alert('ุชุนุฐุฑ ูุชุญ ูุงูุฐุฉ ุงูุฎุฑุงุฆุท. ุชุญูู ูู ุฅุนุฏุงุฏุงุช ุญุธุฑ ุงูููุงูุฐ ุงูููุจุซูุฉ.');
        }

        async function pasteCoordsFromClipboard() {
          try {
            const text = await navigator.clipboard.readText();
            if (!text) { alert('ุงูุญุงูุธุฉ ูุงุฑุบุฉ ุฃู ูู ุชุชู ุงูููุงููุฉ ุนูู ุงููุตูู'); return; }
            $('selectedCoords').value = text.trim();
          } catch (err) {
            alert('ูุง ููุฌุฏ ุฅุฐู ููุฑุงุกุฉ ุงูุญุงูุธุฉ. ุงูุฑุฌุงุก ูุตู ุงูุฑุงุจุท ุฃู ุงูุฅุญุฏุงุซูุงุช ูุฏููุงู ูู ุงูุญูู.');
          }
        }

        // parse coordinates from Google Maps URL or from manual coordinate input
        function parseCoordsFromGoogleLinkOrText(input) {
          if (!input) return null;
          input = input.trim();

          // If input looks like direct lat,lng
          const simpleCoord = input.match(/(-?\d+(?:\.\d+)?)[,\s]+(-?\d+(?:\.\d+)?)/);
          if (simpleCoord) {
            const lat = parseFloat(simpleCoord[1]), lng = parseFloat(simpleCoord[2]);
            if (!isNaN(lat) && !isNaN(lng)) return lat.toFixed(6) + ',' + lng.toFixed(6);
          }

          // Try Google Maps @lat,lng,zoom (e.g. https://www.google.com/maps/@24.7136,46.6753,15z)
          let m = input.match(/@(-?\d+\.\d+),(-?\d+\.\d+),/);
          if (m) return parseFloat(m[1]).toFixed(6) + ',' + parseFloat(m[2]).toFixed(6);

          // Try q=lat,lng or /place/.../data=!3m1!4b1!4m5!...!3dLAT!4dLNG
          m = input.match(/[?&]q=([-.\d]+),\s*([-.\d]+)/);
          if (m) return parseFloat(m[1]).toFixed(6) + ',' + parseFloat(m[2]).toFixed(6);

          m = input.match(/!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/);
          if (m) return parseFloat(m[1]).toFixed(6) + ',' + parseFloat(m[2]).toFixed(6);

          // Try to find any lat,lng pair inside the URL
          m = input.match(/(-?\d+\.\d+),\s*(-?\d+\.\d+)/);
          if (m) return parseFloat(m[1]).toFixed(6) + ',' + parseFloat(m[2]).toFixed(6);

          // If not found, attempt to normalize formats with N/E/S/W (like 24.7136N,46.6753E)
          const normalized = normalizeCoordinates(input);
          if (normalized) return normalized;

          return null;
        }

        // reuse normalization function from prior logic (supports N/S/E/W and DMS)
        function normalizeCoordinates(input) {
          if (!input) return null;
          input = input.trim();
          input = input.replace(/[ยฐโฒ'โณ"]/g, ' ').replace(/\s+/g, ' ').trim();
          let parts = [];
          if (input.includes(',')) parts = input.split(',').map(s => s.trim());
          else {
            const tokens = input.split(' ');
            if (tokens.length >= 2) {
              const mid = Math.ceil(tokens.length / 2);
              parts = [tokens.slice(0, mid).join(' '), tokens.slice(mid).join(' ')];
            } else return null;
          }
          function parseCoordStr(s, isLat) {
            s = s.trim();
            const dirMatch = s.match(/([NnSsEeWw])/);
            const dir = dirMatch ? dirMatch[1].toUpperCase() : null;
            s = s.replace(/[NnSsEeWw]/g, '').trim();
            const nums = s.split(/[\s:]+/).map(x => parseFloat(x)).filter(x => !isNaN(x));
            if (nums.length === 0) return null;
            let val = null;
            if (nums.length === 1) val = nums[0];
            else val = Math.abs(nums[0]) + (nums[1] || 0) / 60 + (nums[2] || 0) / 3600;
            if (dir) {
              if (dir === 'S' || dir === 'W') val = -Math.abs(val);
              else val = Math.abs(val);
            }
            if (isLat && Math.abs(val) > 90) return null;
            if (!isLat && Math.abs(val) > 180) return null;
            return val;
          }
          const lat = parseCoordStr(parts[0], true);
          const lng = parseCoordStr(parts[1], false);
          if (lat === null || lng === null) return null;
          return lat.toFixed(6) + ',' + lng.toFixed(6);
        }

        function confirmCoordsFromModal() {
          const raw = $('selectedCoords').value.trim();
          const coords = parseCoordsFromGoogleLinkOrText(raw);
          if (!coords) return alert('ุชุนุฐุฑ ุงุณุชุฎุฑุงุฌ ุงูุฅุญุฏุงุซูุงุช. ุงูุฑุฌุงุก ูุตู ุฑุงุจุท ุฎุฑุงุฆุท Google ุฃู ุฅุญุฏุงุซูุงุช ุจุตูุบุฉ lat,lng ุฃู ุจุตูุบุฉ ุชุญุชูู N/S/E/W.');
          if (currentPickerTarget === 'container') {
            $('containerLocation').value = coords;
            updateGoogleLink('container', coords);
          } else if (currentPickerTarget === 'pickup') {
            $('pickupLocation').value = coords;
            updateGoogleLink('pickup', coords);
          }
          closeMapModal();
        }

        function closeMapModal() {
          currentPickerTarget = null;
          hideElem($('mapModal'));
        }

        function updateGoogleLink(type, coordStr) {
          const link = (type === 'container') ? $('containerGoogleLink') : $('pickupGoogleLink');
          if (coordStr && coordStr.includes(',')) {
            link.href = 'https://www.google.com/maps?q=' + encodeURIComponent(coordStr);
            link.style.display = 'inline';
          } else {
            link.href = '#';
            link.style.display = 'none';
          }
        }

        // attach events
        // $('pickContainerBtn').addEventListener('click', () => openMapModalFor('container')); // Moved to inline onclick for robustness
        // $('pickPickupBtn').addEventListener('click', () => openMapModalFor('pickup'));
        $('openGoogleMapsBtn').addEventListener('click', openGoogleMapsWindow);
        $('pasteCoordsBtn').addEventListener('click', pasteCoordsFromClipboard);
        $('confirmCoordsBtn').addEventListener('click', confirmCoordsFromModal);
        $('cancelCoordsBtn').addEventListener('click', closeMapModal);
        */

        // Terms modal bindings
        const safe = (id, fn) => { const el = $(id); if (el) el.addEventListener('click', fn); };
        safe('manageTermsBtn', openTermsModal);
        // allow keyboard open
        if ($('manageTermsBtn')) $('manageTermsBtn').addEventListener('keydown', (e) => { if (e.key === 'Enter') openTermsModal(); });
        safe('termsCloseBtn', closeTermsModal);
        safe('termsRefreshBtn', loadTerms);
        // select/deselect helpers (UI elements exist in modal)
        const selAll = () => document.querySelectorAll('#termsList .termCheckbox').forEach(cb => cb.checked = true);
        const deselectAll = () => document.querySelectorAll('#termsList .termCheckbox').forEach(cb => cb.checked = false);
        if ($('termsSelectAllBtn')) $('termsSelectAllBtn').addEventListener('click', selAll);
        if ($('termsDeselectAllBtn')) $('termsDeselectAllBtn').addEventListener('click', deselectAll);

        // other UI wiring
        $('refreshBtn').addEventListener('click', loadContracts);
        // Ensure search is instant
        $('search').addEventListener('input', () => {
          console.log('Search input detected');
          loadContracts();
        });
        $('filter').addEventListener('change', loadContracts);

        // Export to Excel
        $('exportExcelBtn').addEventListener('click', () => {
          if (!contractsData || contractsData.length === 0) {
            alert('ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุตุฏูุฑ');
            return;
          }

          // Format data for Excel
          const data = contractsData.map(c => ({
            'ุฑูู ุงูุนูุฏ': c.id,
            'ุงูุนููู': c.second_party || c.client_name,
            'ุงูุฎุฏูุฉ': c.service_name,
            'ุงูุณุนุฑ ุงูุฅุฌูุงูู': c.total_price,
            'ุงูุฏูุนุฉ ุงูุดูุฑูุฉ': c.monthly_fee,
            'ุชุงุฑูุฎ ุงูุจุฏุงูุฉ': c.from_date ? String(c.from_date).substring(0, 10) : '',
            'ุชุงุฑูุฎ ุงูููุงูุฉ': c.to_date ? String(c.to_date).substring(0, 10) : '',
            'ุงููุณูู': c.manager || '',
            'ุงููุญุตู': c.collector || '',
            'ุงูุญุงูุฉ': c.status === 'active' ? 'ูุดุท' : (c.status === 'pending' ? 'ููุฏ ุงูุชูููุน' : 'ููุชูู'),
            'ูููุน ุงูุนููู': c.container_location,
            // 'ูููุน ุงูุชุญุตูู': c.pickup_location,
            'ุงููุฏููุฉ': c.city,
            'ุงูุญู': c.district,
            'ุงูุฌูุงู': c.client_phone,
            'ุงูุจุฑูุฏ': c.client_email,




          }));

          const ws = XLSX.utils.json_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "ุงูุนููุฏ");
          XLSX.writeFile(wb, "contracts_export.xlsx");
        });

        $('newContractBtn').addEventListener('click', () => {
          delete $('formWrap').dataset.editing;

          // Clear all form fields safely
          const fieldsToClear = [
            'clientName', 'city', 'district', 'location', 'dateFrom', 'dateTo',
            'monthlyFee', 'tax', 'totalPrice', 'manager', 'collector', 'terms', 'termsSummary',
            'containerLocation', 'pickupLocation', 'clientType', 'serviceType',
            'containerType', 'duration', 'paymentType', 'signMethod',
            'clientEmail', 'clientPhone',
            'representativeName', 'representativeTitle'
          ];

          fieldsToClear.forEach(id => {
            const el = $(id);
            if (el) {
              if (el.tagName === 'SELECT') {
                el.selectedIndex = 0;
              } else {
                el.value = '';
              }
            }
          });

          // Reset Representative Checkbox
          if ($('hasRepresentative')) {
            $('hasRepresentative').checked = false;
            if (typeof toggleRepresentativeInput === 'function') toggleRepresentativeInput();
            else if ($('representativeFields')) $('representativeFields').style.display = 'none';
          }

          // Set default values
          if ($('status')) $('status').value = 'pending';
          if ($('tax')) $('tax').value = '15%';
          if ($('clientType')) $('clientType').value = 'ูุฑุฏ';
          if ($('serviceType')) $('serviceType').value = 'ูุธุงูุฉ ููููุฉ';
          if ($('containerType')) $('containerType').value = 'ุจุฑููู';
          if ($('duration')) $('duration').value = 'ุณููู';
          if ($('paymentType')) $('paymentType').value = 'ุณูููุฉ';
          if ($('signMethod')) $('signMethod').value = 'ุฅููุชุฑููู';

          updateGoogleLink('container', '');
          // updateGoogleLink('pickup', '');

          // Hide attachments display for new contracts
          const attachmentsDisplay = $('attachmentsDisplay');
          if (attachmentsDisplay) attachmentsDisplay.style.display = 'none';

          showElem($('formWrap'));
          hideElem($('mapModal'));
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Renew Contract Button - Same as New Contract but without attachments requirement
        $('renewContractBtn').addEventListener('click', () => {
          delete $('formWrap').dataset.editing;

          // Clear all form fields safely (same as new contract)
          const fieldsToClear = [
            'clientName', 'city', 'district', 'location', 'dateFrom', 'dateTo',
            'monthlyFee', 'tax', 'totalPrice', 'manager', 'collector', 'terms', 'termsSummary',
            'containerLocation', 'pickupLocation', 'clientType', 'serviceType',
            'containerType', 'duration', 'paymentType', 'signMethod',
            'clientEmail', 'clientPhone'
          ];

          fieldsToClear.forEach(id => {
            const el = $(id);
            if (el) {
              if (el.tagName === 'SELECT') {
                // Set select to first option instead of empty
                el.selectedIndex = 0;
              } else {
                el.value = '';
              }
            }
          });

          // Set default values (same as new contract)
          if ($('status')) $('status').value = 'pending';
          if ($('tax')) $('tax').value = '15%';
          if ($('clientType')) $('clientType').value = 'ูุฑุฏ';
          if ($('serviceType')) $('serviceType').value = 'ูุธุงูุฉ ููููุฉ';
          if ($('containerType')) $('containerType').value = 'ุจุฑููู';
          if ($('duration')) $('duration').value = 'ุณููู';
          if ($('paymentType')) $('paymentType').value = 'ุณูููุฉ';
          if ($('signMethod')) $('signMethod').value = 'ุฅููุชุฑููู';

          updateGoogleLink('container', '');
          // updateGoogleLink('pickup', '');

          // Hide attachments display for renewal contracts
          const attachmentsDisplay = $('attachmentsDisplay');
          if (attachmentsDisplay) attachmentsDisplay.style.display = 'none';

          // Set flag to indicate this is a renewal contract (no attachments required)
          $('formWrap').dataset.renewing = 'true';

          showElem($('formWrap'));
          hideElem($('mapModal'));
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });


        // Navigation System
        document.querySelectorAll('.nav button[data-view]').forEach(btn => {
          btn.addEventListener('click', () => {
            const view = btn.dataset.view;
            switchView(view);

            // Update active button
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
          });
        });

        function switchView(view) {
          // Hide all views
          ['contractsArea', 'reportsArea'].forEach(id => {
            const el = $(id);
            if (el) el.style.display = 'none';
          });

          // Show selected view
          const viewEl = $(view + 'Area');
          if (viewEl) viewEl.style.display = 'block';

          // Load data for the view
          switch (view) {
            case 'contracts':
              loadContracts();
              break;
            case 'reports':
              loadReports();
              break;
          }
        }

        // Reports and Statistics - Enhanced with Manager & Collector Performance
        async function loadReports() {
          try {
            const contracts = await apiFetch('/contracts', { method: 'GET' });
            const clients = await apiFetch('/clients', { method: 'GET' });

            generateReports(contracts || [], clients || []);
          } catch (err) {
            console.error('Error loading reports:', err);
            generateReports([], []);
          }
        }

        function generateReports(contracts, clients) {
          // Total contracts
          $('reportTotalContracts').textContent = contracts.length;

          // Total revenue
          const totalRevenue = contracts.reduce((sum, c) => sum + (parseFloat(c.total_price) || 0), 0);
          $('reportTotalRevenue').textContent = totalRevenue.toLocaleString('ar-SA');

          // Total clients (unique)
          const uniqueClients = new Set(contracts.map(c => c.second_party).filter(Boolean));
          $('reportTotalClients').textContent = uniqueClients.size;

          // Average contract value
          const avgContract = contracts.length > 0 ? totalRevenue / contracts.length : 0;
          $('reportAvgContract').textContent = avgContract.toLocaleString('ar-SA', { maximumFractionDigits: 0 });

          // Status distribution
          const activeCount = contracts.filter(c => c.status === 'active').length;
          const pendingCount = contracts.filter(c => c.status === 'pending').length;
          const expiredCount = contracts.filter(c => c.status === 'expired').length;

          $('reportActiveCount').textContent = activeCount;
          $('reportPendingCount').textContent = pendingCount;
          $('reportExpiredCount').textContent = expiredCount;

          // Manager Performance Statistics
          const managerStats = {};
          contracts.forEach(c => {
            const manager = c.manager || 'ุบูุฑ ูุญุฏุฏ';
            if (!managerStats[manager]) {
              managerStats[manager] = { count: 0, total: 0, monthlyFees: 0 };
            }
            managerStats[manager].count++;
            managerStats[manager].total += parseFloat(c.total_price) || 0;
            managerStats[manager].monthlyFees += parseFloat(c.monthly_fee) || 0;
          });

          const managerStatsTbody = $('managerStatsTbody');
          if (managerStatsTbody) {
            managerStatsTbody.innerHTML = '';
            const sortedManagers = Object.entries(managerStats)
              .sort((a, b) => b[1].total - a[1].total);

            sortedManagers.forEach(([name, stats]) => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
              <td><strong>${name}</strong></td>
              <td>${stats.count}</td>
              <td>${stats.total.toLocaleString('ar-SA')} ุฑูุงู</td>
              <td>${stats.monthlyFees.toLocaleString('ar-SA')} ุฑูุงู/ุดูุฑ</td>
            `;
              managerStatsTbody.appendChild(tr);
            });
          }

          // Collector Performance Statistics
          const collectorStats = {};
          contracts.forEach(c => {
            const collector = c.collector || 'ุบูุฑ ูุญุฏุฏ';
            if (!collectorStats[collector]) {
              collectorStats[collector] = { count: 0, total: 0, monthlyFees: 0 };
            }
            collectorStats[collector].count++;
            collectorStats[collector].total += parseFloat(c.total_price) || 0;
            collectorStats[collector].monthlyFees += parseFloat(c.monthly_fee) || 0;
          });

          const collectorStatsTbody = $('collectorStatsTbody');
          if (collectorStatsTbody) {
            collectorStatsTbody.innerHTML = '';
            const sortedCollectors = Object.entries(collectorStats)
              .sort((a, b) => b[1].total - a[1].total);

            sortedCollectors.forEach(([name, stats]) => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
              <td><strong>${name}</strong></td>
              <td>${stats.count}</td>
              <td>${stats.total.toLocaleString('ar-SA')} ุฑูุงู</td>
              <td>${stats.monthlyFees.toLocaleString('ar-SA')} ุฑูุงู/ุดูุฑ</td>
            `;
              collectorStatsTbody.appendChild(tr);
            });
          }

          // Top 5 clients by contract value
          const clientStats = {};
          contracts.forEach(c => {
            const clientName = c.second_party || 'ุบูุฑ ูุญุฏุฏ';
            if (!clientStats[clientName]) {
              clientStats[clientName] = { count: 0, total: 0 };
            }
            clientStats[clientName].count++;
            clientStats[clientName].total += parseFloat(c.total_price) || 0;
          });

          const topClients = Object.entries(clientStats)
            .sort((a, b) => b[1].total - a[1].total)
            .slice(0, 5);

          const topClientsTbody = $('topClientsTbody');
          if (topClientsTbody) {
            topClientsTbody.innerHTML = '';
            topClients.forEach(([name, stats]) => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
              <td>${name}</td>
              <td>${stats.count}</td>
              <td>${stats.total.toLocaleString('ar-SA')} ุฑูุงู</td>
            `;
              topClientsTbody.appendChild(tr);
            });
          }
        }

        // $('exportCsvBtn').addEventListener('click', () => {
        //   alert('ุชุตุฏูุฑ CSV ุบูุฑ ูุชุงุญ ูู ุงููุณุฎุฉ ุงููุญููุฉ (Client-side only)');
        // });

        // helper to generate contract id: CN-YYYY-N
        function generateContractId() {
          const now = new Date();
          const yr = now.getFullYear();

          // Find max ID for this year
          const contracts = getStoredData(STORAGE_KEY_CONTRACTS);
          const prefix = `CN-${yr}-`;
          let maxSeq = 0;

          contracts.forEach(c => {
            if (c.id && c.id.startsWith(prefix)) {
              const seq = parseInt(c.id.replace(prefix, ''));
              if (!isNaN(seq) && seq > maxSeq) maxSeq = seq;
            }
          });

          return `${prefix}${maxSeq + 1}`;
        }

        // helper to generate secure signing token
        function generateSigningToken(contractId, clientEmail) {
          const timestamp = Date.now();
          const random = Math.random().toString(36).substring(2);
          const data = `${contractId}:${clientEmail}:${timestamp}:${random}`;
          // Return full Base64 without truncation
          return btoa(data);
        }

        // helper to create secure signing link
        function createSigningLink(contractId, clientEmail, token) {
          const baseUrl = window.location.origin;
          // Encode token to be URL-safe
          return `${baseUrl}/sign/${contractId}/${encodeURIComponent(token)}`;
        }

        // Test server connection
        async function testServerConnection() {
          try {
            const response = await fetch('/health');
            const data = await response.json();
            console.log('โ Server connected:', data);
            return true;
          } catch (error) {
            console.error('โ Server connection failed:', error);
            return false;
          }
        }

        // Test server connection on page load
        // Test server connection on page load - Disabled for client-side version
        // testServerConnection();

        // update second party field when client name changes - Just copy the name!
        $('clientName').addEventListener('input', () => {
          if ($('secondParty')) {
            $('secondParty').value = $('clientName').value || '';
          }
        });

        // Auto-calculate Total Price
        function calculateTotal() {
          const monthly = parseFloat($('monthlyFee').value) || 0;
          const taxStr = $('tax').value || '0';
          const taxRate = parseFloat(taxStr.replace('%', '')) / 100;

          // Determine multiplier based on duration
          const duration = $('duration').value;
          let multiplier = 12; // Default to Annual
          if (duration === '6 ุฃุดูุฑ') multiplier = 6;
          else if (duration === '3 ุฃุดูุฑ') multiplier = 3;
          else if (duration === 'ุฏูุนุฉ ูุงุญุฏุฉ') multiplier = 1;

          const subtotal = monthly * multiplier;
          const total = subtotal + (subtotal * taxRate);
          $('totalPrice').value = Math.round(total);
        }

        // Live Update Trigger for Terms text
        // Whenever pricing affects the text, we must update the terms IF they are already generated.
        function triggerTermsUpdate() {
          if ($('terms').value) {
            updateTermsFromUI();
          }
        }

        if ($('monthlyFee')) $('monthlyFee').addEventListener('input', () => { calculateTotal(); triggerTermsUpdate(); });
        if ($('tax')) $('tax').addEventListener('input', () => { calculateTotal(); triggerTermsUpdate(); });
        if ($('duration')) $('duration').addEventListener('change', () => { calculateTotal(); triggerTermsUpdate(); });
        if ($('paymentType')) $('paymentType').addEventListener('change', triggerTermsUpdate);

        // Auto-calculate End Date (1 year later)
        if ($('dateFrom')) {
          $('dateFrom').addEventListener('change', function () {
            const val = this.value;
            if (val) {
              const date = new Date(val);
              date.setFullYear(date.getFullYear() + 1);
              $('dateTo').value = date.toISOString().split('T')[0];
            }
          });
        }

        // Contract signing modal functions
        function openSigningModal(contractId = null, clientEmail = null) {
          const modal = $('signingModal');
          if (!modal) return;

          // Reset modal state
          $('sendMethod').value = 'link';
          hideAllSendSections();
          $('linkSection').style.display = 'block';

          // Auto-generate link if we have contract data
          if (contractId && clientEmail) {
            const token = generateSigningToken(contractId, clientEmail);
            const link = createSigningLink(contractId, clientEmail, token);
            $('signingLink').value = link;
          }

          showElem(modal);
        }

        function closeSigningModal() {
          hideElem($('signingModal'));
        }

        function hideAllSendSections() {
          ['linkSection', 'emailSection', 'whatsappSection', 'fileSection'].forEach(id => {
            const el = $(id);
            if (el) el.style.display = 'none';
          });
        }

        // Send method change handler
        $('sendMethod').addEventListener('change', (e) => {
          hideAllSendSections();
          const method = e.target.value;
          const section = $(method + 'Section');
          if (section) {
            section.style.display = 'block';

            // Auto-fill email from form if available
            if (method === 'email' && $('clientEmail')?.value) {
              $('signingEmail').value = $('clientEmail').value;
            }

            // Auto-fill phone from form if available
            if (method === 'whatsapp' && $('clientPhone')?.value) {
              $('whatsappNumber').value = $('clientPhone').value;
              updateWhatsappMessage();
            }
          }
        });

        // Copy link handler
        $('copyLinkBtn').addEventListener('click', () => {
          const linkInput = $('signingLink');
          if (!linkInput?.value) {
            alert('ูุง ููุฌุฏ ุฑุงุจุท ูููุณุฎ');
            return;
          }

          navigator.clipboard.writeText(linkInput.value).then(() => {
            alert('ุชู ูุณุฎ ุงูุฑุงุจุท ุจูุฌุงุญ');
          }).catch(() => {
            // Fallback for older browsers
            linkInput.select();
            document.execCommand('copy');
            alert('ุชู ูุณุฎ ุงูุฑุงุจุท ุจูุฌุงุญ');
          });
        });

        // Update whatsapp message
        function updateWhatsappMessage() {
          const clientName = $('clientName')?.value || 'ุงูุนููู';
          const companyName = $('firstParty')?.value || 'ุดุฑูุฉ ุจูุช ููููุงููุงุช';
          const link = $('signingLink')?.value || '';

          const message = `ูุฑุญุจุงู ${clientName}ุ\n\nุชู ุฅุนุฏุงุฏ ุนูุฏูู ูุน ${companyName} ุฌุงูุฒ ููุชูููุน.\n\nูููููู ุชูููุน ุงูุนูุฏ ุจุดูู ุขูู ููุจุงุดุฑ ุนุจุฑ ุงูุฑุงุจุท ุงูุชุงูู:\n${link}\n\nุงูุฑุงุจุท ูุฑูุฏ ููุฎุตุต ููู ููุท ูุฃุบุฑุงุถ ุงูุชูููุน.\n\nูุน ุชุญูุงุชุ\n${companyName}`;

          if ($('whatsappMessage')) {
            $('whatsappMessage').value = message;
          }
        }

        $('whatsappNumber').addEventListener('input', updateWhatsappMessage);

        // Send for signing button
        $('sendForSigningBtn').addEventListener('click', () => {
          const clientName = $('clientName')?.value;
          const clientEmail = $('clientEmail')?.value;
          const editingId = $('formWrap').dataset.editing;

          if (!clientName || !clientEmail) {
            alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุนููู ูุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃููุงู');
            return;
          }

          if (!editingId) {
            alert('ูุฑุฌู ุญูุธ ุงูุนูุฏ ุฃููุงู ูุจู ุงูุฅุฑุณุงู ููุชูููุน');
            return;
          }

          const contractId = editingId;
          openSigningModal(contractId, clientEmail);
        });

        // Generate contract file button
        // $('generateContractFileBtn').addEventListener('click', async () => {
        //   const clientName = $('clientName')?.value;
        //   if (!clientName) {
        //     alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุนููู ุฃููุงู');
        //     return;
        //   }

        //   // Open modal with file section
        //   openSigningModal();
        //   $('sendMethod').value = 'file';
        //   hideAllSendSections();
        //   $('fileSection').style.display = 'block';
        // });

        // Confirm send button
        $('confirmSendBtn').addEventListener('click', async () => {
          const method = $('sendMethod').value;
          const clientName = $('clientName')?.value;
          const clientEmail = $('clientEmail')?.value;
          // const authMethod = $('authMethod').value;

          try {
            switch (method) {
              case 'link':
                await handleLinkGeneration();
                break;
              case 'email':
                await handleEmailSending();
                break;
              case 'whatsapp':
                await handleWhatsappSending();
                break;
              case 'file':
                await handleFileGeneration();
                break;
            }

            alert('ุชู ุฅูุดุงุก ุฑุงุจุท ุงูุชูููุน ุจูุฌุงุญ');
            closeSigningModal();

          } catch (error) {
            console.error('Sending error:', error);
            alert('ุฎุทุฃ: ' + (error.message || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุฅุฑุณุงู'));
          }
        });

        async function handleLinkGeneration() {
          const link = $('signingLink').value;
          if (!link) {
            throw new Error('ูุง ููุฌุฏ ุฑุงุจุท ูุชุงุญ');
          }

          // Here you would save the signing request to your backend
          console.log('Generated signing link:', link);
        }

        async function handleEmailSending() {
          const email = $('signingEmail').value;
          const message = $('emailMessage').value;

          if (!email) {
            throw new Error('ูุฑุฌู ุฅุฏุฎุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู');
          }

          // Here you would call your email service
          console.log('Sending email to:', email, 'Message:', message);
        }

        async function handleWhatsappSending() {
          const phone = $('whatsappNumber').value;
          const message = $('whatsappMessage').value;

          if (!phone) {
            throw new Error('ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงูุฌูุงู');
          }

          // Create WhatsApp link
          const whatsappLink = `https://wa.me/${phone.replace(/[^\d]/g, '')}?text=${encodeURIComponent(message)}`;
          window.open(whatsappLink, '_blank');

          console.log('WhatsApp link:', whatsappLink);
        }

        async function handleFileGeneration() {
          const format = $('fileFormat').value;
          const includeTerms = $('includeTerms').checked;
          const includeSignatures = $('includeSignatures').checked;
          const includeQrCode = $('includeQrCode').checked;

          // Here you would generate the actual file
          console.log('Generating file:', {
            format,
            includeTerms,
            includeSignatures,
            includeQrCode
          });

          // Placeholder for file generation
          alert('ุณูุชู ุฅูุดุงุก ุงูููู ูุชุญูููู...');
        }

        // Cancel signing button
        $('cancelSigningBtn').addEventListener('click', closeSigningModal);

        // expose some helpers for console if needed
        window.openEdit = openEdit;
        window.updateStatus = updateStatus;

        // ---------------- Terms manager ----------------

        const LOCAL_TERMS_KEY = 'local_terms_v1';

        const defaultTerms = [
          {
            id: 'def_term_3',
            name: 'ุงูุจูุฏ ุงูุซุงูุซ: ูุฏุฉ ุงูุนูุฏ',
            type: 'text',
            content: 'ูุฏุฉ ูุฐุง ุงูุนูุฏ ( ุณูุฉ ูููุงุฏูุฉ ) ุชุจุฏุฃ ูู ุชุงุฑูุฎ {START_DATE_GREGORIAN} ููุชุฌุฏุฏ ุชููุงุฆูุง ูุง ูู ูุดุนุฑ ุฃุญุฏ ุงูุทุฑููู ุงูุทุฑู ุงูุขุฎุฑ ุจุนุฏู ุฑุบุจุชู ูู ุงูุชุฌุฏูุฏ ูุจู ุดูุฑ ุนูู ุงูุฃูู ูู ุชุงุฑูุฎ ููุงูุฉ ูุฏุฉ ุงูุนูุฏ ุนูู ุจูุงูุงุช ุงูุชูุงุตู ุงูููุถุญุฉ ูู ูุฐู ุงูุฅุชูุงููุฉ.'
          },
          {
            id: 'def_term_scope',
            name: 'ูุทุงู ุงูุนูู ูุงููุณุคูููุงุช',
            type: 'selection',
            content: `1- ูููู ุงูุทุฑู ุงูุฃูู ุจููู ูุชุฑุญูู ูุง ููุชุฌู ุงูุทุฑู ุงูุซุงูู ูู ููุงูุงุช ุจูุงุณุทุฉ ุนูุงูู ูุขููุงุชู ููุนุฏุงุชู ูุงูุชุฎูุต ูููุง ุจุชุฑุญูููุง ุฅูู ุงููุฑูู ุงูุนุงูุ ุนูู ุฃู ูููู ุฐูู ุจุดูู ูููู ุทูุงู ุฃูุงู ุงูุฃุณุจูุน ูุฎูุงู ุณุงุนุงุช ุงูุนูู ูุจุดูู ูุธุงูู.
2- ููุชุฒู ุงูุทุฑู ุงูุฃูู ุจุนุฏู ุงูุชุฃุฎุฑ ูู ููู ู ุชุฑุญูู ุฃูุงู ูู ุงูููุงูุงุช ูุฃู ููุชุฒู ุจุงูุญุถูุฑ ุจุดูู ูููู ุฅูู ููุฑ ุงูุทุฑู ุงูุซุงููุ ููู ุญุงู ุชุฎูู ุนู ุงูุญุถูุฑ ูุฃู ุณุจุจ ูุงู ูุณูููู ุงูุทุฑู ุงูุฃูู ูุณุคููุงู ูุญุฏู ุนู ุฐูู ูู ููุงุฌูุฉ ุงูุทุฑู ุงูุซุงูู ูุงูุบูุฑ.
3- ููุชุฒู ุงูุทุฑู ุงูุฃูู ุจุชุฃููู ุญุงููุฉ ููุงุณ ( {CONTAINER_TYPE} ) ุนุฏุฏ (1) ูุง ุจุฏุงุฎู ุงูุญุงููุฉ ููุท.
4- ูุชุนูุฏ ุงูุทุฑู ุงูุฃูู ู ูุถูู ูุธุงูุฉ ุงูููุงู ุงูุฐู ุชูุน ููู ุงูุญุงููุฉ ุนูุฏ ุนูููุงุช ุงูุชูุฑูุบ ูุงูููู ูุงูุชุฑุญูู ูุฃู ุชููู ุฌููุน ุงูุฅุฌุฑุงุกุงุช ุงููุชุฎุฐุฉ ูู ูุจูู ุตุญูุญุฉ ููุธุงููุฉ.
5- ูู ุญุงู ูุงู ููุงู ุชูุงุฌุฏ ุงูุญุงููุฉ ูุฑูุจุงู ูู ุงูุณูุงุฑุงุช ุฃู ูู ููุชููุงุช ุงูุทุฑู ุงูุซุงููุ ูุฅู ุงูุทุฑู ุงูุฃูู ูุชุนูุฏ ุจุฃู ุชุฃููู ูุฑูุจุงุชู ู ูุนุฏุงุชู ุณุงุฑู ู ุณูุชู ุชูุฏูู ุงููุทุงูุจุฉ ุงูุชุฃููููุฉ ูู ูุจูู ููุชุงุจุนุชูุง ุฅูู ุญูู ุชุญุตูู ุงููุจูุบ ุงููุงูู.`
          }
        ];

        // localStorage helpers
        const BLACKLISTED_TERMS = [
          'ูููุฐุฌ ุนูุฏ ูุงูู (ูุซุงู)',
          'ุงูุจูุฏ: ูููุฉ ุงูุนูุฏ ู ุงูุฏูุน',

          'ุงูุจูุฏ ุงูุฃูู :',
          'ุงูุจูุฏ ุงูุซุงูู :'
        ];

        function loadLocalTerms() {
          try {
            const raw = localStorage.getItem(LOCAL_TERMS_KEY);
            let terms = [];

            if (!raw) {
              terms = defaultTerms.map(t => Object.assign({}, t)); // Deep copy to avoid reference issues
            } else {
              terms = JSON.parse(raw);
            }

            // MIGRATION: Ensure all terms have IDs
            let changed = false;
            terms.forEach(t => {
              if (!t.id && !t._id) {
                // IMPORTANT: Match by name to defaultTerms to restore stable IDs even if user already had them without IDs
                const def = (typeof defaultTerms !== 'undefined') ? defaultTerms.find(d => d.name === t.name) : null;
                if (def && def.id) {
                  t.id = def.id;
                  console.log('๐ Restored stable ID for default term:', t.name);
                } else {
                  t.id = 'loc_' + Math.random().toString(36).slice(2);
                  console.log('๐ Assigned new random ID for custom term:', t.name);
                }
                changed = true;
              }
            });

            if (changed) {
              saveLocalTerms(terms);
            }

            // Filter out blacklisted terms
            const filtered = terms.filter(t => !BLACKLISTED_TERMS.includes(t.name));

            // If we removed any blacklisted terms, save the cleaned list back
            if (filtered.length !== terms.length) {
              console.log('๐งน Removed', terms.length - filtered.length, 'blacklisted terms');
              saveLocalTerms(filtered);
            }

            return filtered;
          } catch (e) {
            console.warn('loadLocalTerms error:', e);
            return defaultTerms.map(t => Object.assign({}, t)).filter(t => !BLACKLISTED_TERMS.includes(t.name));
          }
        }
        function saveLocalTerms(arr) {
          try { localStorage.setItem(LOCAL_TERMS_KEY, JSON.stringify(arr)); } catch (e) { console.warn('local save failed', e); }
        }

        // API wrapper with fallback to local storage
        async function getTerms() {
          try {
            const rows = await apiFetch('/terms', { method: 'GET' });
            if (Array.isArray(rows)) return rows;
          } catch (err) {
            // fallback silently
          }
          return loadLocalTerms();
        }

        // ===== HELPER: Get complete contract data from form =====
        function getContractDataFromForm() {
          return {
            from_date: $('dateFrom')?.value,
            to_date: $('dateTo')?.value,
            container_type: $('containerType')?.value,
            client_name: $('clientName')?.value || $('secondParty')?.value,
            client_phone: $('clientPhone')?.value || $('phone')?.value,
            client_email: $('clientEmail')?.value || $('email')?.value,
            second_party: $('secondParty')?.value || $('clientName')?.value,
            first_party: $('firstParty')?.value || 'ุดุฑูุฉ ุจูุช ููููุงููุงุช',
            monthly_fee: $('monthlyFee')?.value,
            total_price: $('totalPrice')?.value,
            tax: $('tax')?.value,
            duration: $('duration')?.value,
            payment_type: $('paymentType')?.value,
            service_name: $('serviceName')?.value,
            manager: $('manager')?.value,
            collector: $('collector')?.value,
            // Representative fields
            has_representative: $('hasRepresentative')?.checked,
            representative_name: $('representativeName')?.value,
            representative_title: $('representativeTitle')?.value
          };
        }
        // Master helper to refresh ALL contract UI components instantly
        async function refreshContractLiveUI() {
          console.log('๐ [LIVE] Refreshing all contract components...');
          try {
            // 1. Update pricing term content (returns the new solid term text)
            if (typeof updatePricingTermContent === 'function') {
              await updatePricingTermContent();
            }
            // 2. Update the main "terms" (ูุต ุงูุจูุฏ) textarea with all pattern replacements
            if (typeof replaceDatePatternsInTerms === 'function') {
              replaceDatePatternsInTerms();
            }
            // 2.5 Update First Party Text Live
            if (typeof replaceFirstPartyText === 'function') {
              const fp = document.getElementById('firstParty');
              if (fp) fp.value = replaceFirstPartyText(fp.value);
            }
            // 2.6 Update Second Party Field Live (Show just the name)
            const sp = document.getElementById('secondParty');
            if (sp) {
              sp.value = $('clientName')?.value || '';
            }
            // 3. If "Open View" modal is active, update it (if applicable)
            // Note: openView usually reads from database, but we can trigger a refresh if ID is known
            const viewModal = document.getElementById('viewContractModal');
            if (viewModal && viewModal.style.display === 'block') {
              const editingId = $('formWrap')?.dataset?.editing || 'new';
              // openView has logic to use current form data if IDs match or if it's 'new'
              if (typeof openView === 'function') openView(editingId);
            }
          } catch (err) {
            console.error('Error in refreshContractLiveUI:', err);
          }
        }

        async function replaceDatePatternsInTerms() {
          console.log('๐ replaceDatePatternsInTerms: Updating terms textarea...');
          const termsField = $('terms');
          if (!termsField) return;

          // Read content from Quill if available (source of truth for editor), else hidden field
          let content = (window.quill) ? window.quill.root.innerHTML : termsField.value;
          const contractData = getContractDataFromForm();

          if (typeof replaceDatePlaceholders === 'function') {
            content = replaceDatePlaceholders(content, contractData);
          }

          // Write back to Quill to show updates instantly
          if (window.quill) {
            // Only update if changed to avoid unnecessary re-renders (though innerHTML is brute force)
            if (window.quill.root.innerHTML !== content) {
              window.quill.root.innerHTML = content;
            }
          }
          termsField.value = content;
        }
        async function createTerm(term) {
          // Apply all replacements to get SOLID TEXT before saving
          // REMOVED: Do NOT bake in date placeholders. Keep them as template variables.
          let solidContent = term.content;
          /*
          if (typeof replaceDatePlaceholders === 'function') {
            const contractData = getContractDataFromForm();
            solidContent = replaceDatePlaceholders(term.content, contractData);
          }
          */

          const solidTerm = { ...term, content: solidContent };

          // PRIORITY 1: Save to DATABASE/API (PERMANENT)
          try {
            const created = await apiFetch('/terms', { method: 'POST', body: JSON.stringify(solidTerm) });
            if (created) {
              console.log('โ Term saved to DATABASE (permanent)');
              // Also cache locally
              const local = loadLocalTerms();
              local.push(created);
              saveLocalTerms(local);
              return created;
            }
          } catch (err) {
            console.error('โ๏ธ Database save failed:', err);
            // alert('โ๏ธ ุชุญุฐูุฑ: ูู ูุชู ุญูุธ ุงูุจูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช. ุณูุชู ุงูุญูุธ ูุญููุงู ููุท.');
          }

          // PRIORITY 2: Fallback to localStorage only
          const local = loadLocalTerms();
          const id = Date.now().toString(36);
          const item = Object.assign({ id }, solidTerm);
          local.push(item);
          saveLocalTerms(local);
          console.warn('โ๏ธ Term saved to localStorage only (may be lost)');
          return item;
        }
        async function updateTerm(id, term) {
          // Apply all replacements to get SOLID TEXT before saving
          // REMOVED: Do NOT bake in date placeholders. Keep them as template variables.
          let solidContent = term.content;
          /*
          if (typeof replaceDatePlaceholders === 'function') {
            const contractData = getContractDataFromForm();
            solidContent = replaceDatePlaceholders(term.content, contractData);
          }
          */

          const solidTerm = { ...term, content: solidContent };

          // PRIORITY 1: Save to DATABASE/API (PERMANENT)
          try {
            const updated = await apiFetch('/terms/' + encodeURIComponent(id), { method: 'PUT', body: JSON.stringify(solidTerm) });
            if (updated) {
              console.log('โ Term updated in DATABASE (permanent)');
              // Also update local cache
              const local = loadLocalTerms();
              const idx = local.findIndex(t => String(t.id) === String(id) || String(t._id) === String(id));
              if (idx >= 0) {
                local[idx] = updated;
                saveLocalTerms(local);
              }
              return updated;
            }
          } catch (err) {
            console.error('โ๏ธ Database update failed:', err);
            // alert('โ๏ธ ุชุญุฐูุฑ: ูู ูุชู ุชุญุฏูุซ ุงูุจูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช. ุณูุชู ุงูุชุญุฏูุซ ูุญููุงู ููุท.');
          }

          // PRIORITY 2: Fallback to localStorage only
          const local = loadLocalTerms();
          const idx = local.findIndex(t => String(t.id) === String(id) || String(t._id) === String(id));
          if (idx >= 0) {
            local[idx] = Object.assign({}, local[idx], solidTerm);
            saveLocalTerms(local);
            console.warn('โ๏ธ Term updated in localStorage only (may be lost)');
            return local[idx];
          }
          return null;
        }
        async function deleteTermById(id) {
          // PRIORITY 1: Delete from DATABASE/API (PERMANENT)
          let apiDeleteSuccess = false;
          try {
            await apiFetch('/terms/' + encodeURIComponent(id), { method: 'DELETE' });
            console.log('โ Term deleted from DATABASE (permanent)');
            apiDeleteSuccess = true;
          } catch (err) {
            console.error('โ๏ธ Database delete failed:', err);
            // alert('โ๏ธ ุชุญุฐูุฑ: ูู ูุชู ุญุฐู ุงูุจูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช. ุณูุชู ุงูุญุฐู ูุญููุงู ููุท.');
          }

          // PRIORITY 2: Also delete from localStorage cache
          let local = loadLocalTerms();
          local = local.filter(t => !(String(t.id) === String(id) || String(t._id) === String(id)));
          saveLocalTerms(local);

          if (!apiDeleteSuccess) {
            console.warn('โ๏ธ Term deleted from localStorage only (may reappear)');
          }

          return true;
        }

        const termsModal = $('termsModal');
        const termsList = $('termsList');
        const termId = $('termId');
        const termName = $('termName');
        const termType = $('termType');
        const termContent = $('termContent');
        const termContentLabel = $('termContentLabel');

        async function openTermsModal() {
          // allow opening modal even if form is hidden (convenience)
          $('termId').value = '';
          $('termName').value = '';
          $('termType').value = 'text';
          $('termContent').value = '';
          showElem(termsModal);
          await loadTerms();

          // Auto-check the pricing term after loading
          try {
            console.log('๐ [DEBUG] openTermsModal: Auto-checking pricing term...');
            const uiState = loadTermsUIState();
            uiState[PRICING_TERM_ID] = uiState[PRICING_TERM_ID] || {};
            uiState[PRICING_TERM_ID].checked = true;
            saveTermsUIState(uiState);
            console.log('โ [DEBUG] openTermsModal: UI state updated');

            // Also check the checkbox in the DOM
            setTimeout(() => {
              console.log('๐ [DEBUG] openTermsModal: Looking for pricing checkbox...');
              const pricingCheckbox = document.querySelector(`#termsList .termCheckbox[data-id="${PRICING_TERM_ID}"]`);
              if (pricingCheckbox) {
                console.log('โ [DEBUG] openTermsModal: Found checkbox, checking it');
                pricingCheckbox.checked = true;
                // Trigger the update to sync with the form
                updateTermsFromUI();
              } else {
                console.error('โ [DEBUG] openTermsModal: Pricing checkbox NOT FOUND in DOM!');
                console.log('๐ [DEBUG] openTermsModal: Available checkboxes:', document.querySelectorAll('#termsList .termCheckbox').length);
              }
            }, 100);
          } catch (err) {
            console.error('โ [DEBUG] openTermsModal: Auto-check error:', err);
          }
        }

        function closeTermsModal() {
          hideElem(termsModal);
        }

        async function saveContract(id, data) {
          try {
            // Save to backend
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/contracts/${id}` : '/contracts';

            // IF NEW: id is null, we need to send POST. If success, we get back {id, ...}
            // IF EDIT: id is present.

            const saved = await apiFetch(url, { method, body: JSON.stringify(data) });

            if (saved) {
              console.log('โ Contract saved:', saved);
              alert('ุชู ุญูุธ ุงูุนูุฏ ุจูุฌุงุญ');
              closeEdit();

              // CRITICAL FIX: Update global contractsData IMMEDIATELY to prevent lag
              if (id) {
                const existingIdx = contractsData.findIndex(c => String(c.id) === String(id));
                if (existingIdx >= 0) contractsData[existingIdx] = saved;
              } else {
                contractsData.unshift(saved);
              }
              // Also reload from server to be safe, but we have instant data now for View
              loadContracts();
            }
          } catch (err) {
            console.error('Save failed:', err);
            alert('ูุดู ุงูุญูุธ: ' + err.message);
          }
        }

        async function ensureDefaultsOnServer() {
          // try server, if fails populate local storage with defaults
          try {
            const server = await apiFetch('/terms', { method: 'GET' });
            if (!Array.isArray(server) || server.length === 0) {
              try {
                for (const t of defaultTerms) await apiFetch('/terms', { method: 'POST', body: JSON.stringify(t) });
                return;
              } catch (e) {
                // no-op
              }
            } else {
              return;
            }
          } catch (err) {
            // ignore
          }
          const local = loadLocalTerms();
          if (!local || local.length === 0) saveLocalTerms(defaultTerms.slice());
        }

        async function loadTerms() {
          console.log('๐ [DEBUG] loadTerms: Starting... VERSION: 2025-12-06-02:35');
          termsList.innerHTML = '<div class="muted">ุฌุงุฑู ุงูุชุญููู...</div>';
          try {
            await ensureDefaultsOnServer();
            console.log('๐ [DEBUG] loadTerms: About to call ensurePricingTerm()');
            // Ensure pricing term exists in localStorage
            await ensurePricingTerm();
            console.log('๐ [DEBUG] loadTerms: About to call updatePricingTermContent()');
            // Update pricing term with current form values
            await updatePricingTermContent();
            console.log('๐ [DEBUG] loadTerms: About to get terms from localStorage');

            // Use localStorage directly since that's where our pricing term is stored
            // (API might not have it due to database permission issues)
            const rows = loadLocalTerms();
            console.log('๐ [DEBUG] loadTerms: Got', rows.length, 'terms from localStorage');

            // Also try to sync with API terms (but don't fail if it doesn't work)
            try {
              const apiTerms = await apiFetch('/terms', { method: 'GET' });
              if (Array.isArray(apiTerms) && apiTerms.length > 0) {
                console.log('๐ [DEBUG] loadTerms: Got', apiTerms.length, 'terms from API. Using SERVER terms as Source of Truth.');

                // CRITICAL: Trust the Server Order completely.
                // The server returns them sorted by display_order ASC.
                // We only need to ensure the LOCAL PRICING TERM is injected if missing? 
                // Actually user said: "memory from database the drag position".

                // Let's completely replace mergedTerms with apiTerms, but keep pricing term if needed.
                let finalTerms = [...apiTerms];

                // Ensure Pricing Term exists if not in API (it might be local only)
                // But generally users want DB to be master. 
                // If pricing term is essential and local-only, we inject it at its correct place?
                // For now, let's just use API terms. If Pricing Term ID is local, we might lose it if we don't merge.
                // The user said "dragged position to be saved directly into database". 
                // So we assume ALL terms including pricing should be in DB? 
                // If pricing term is local-only logic, we should be careful.

                // Let's stick to the user's request: "dragged position ... saved into database ... show as the order of remembered drag"
                // This implies the API list IS the correct list.

                renderTermsList(finalTerms);
              } else {
                renderTermsList(rows);
              }
            } catch (err) {
              console.log('โ๏ธ [DEBUG] loadTerms: API fetch failed, using localStorage only:', err.message);
              renderTermsList(rows);
            }
          } catch (err) {
            console.error('โ [DEBUG] loadTerms: Error:', err);
            renderTermsList(loadLocalTerms());
            const note = document.createElement('div');
            note.className = 'muted';
            note.style.marginTop = '8px';
            note.textContent = 'ุชุนุฐุฑ ุงูุงุชุตุงู ุจุงูุฎุงุฏู โ ุนุฑุถ ุงูููู ุงูุงูุชุฑุงุถูุฉ ูุญููุงู.';
            termsList.insertBefore(note, termsList.firstChild);
          }
        }

        // UI state persistence for selections so modal "remembers" choices
        const TERMS_UI_KEY = 'terms_ui_state_v1';
        function loadTermsUIState() {
          try { return JSON.parse(localStorage.getItem(TERMS_UI_KEY) || '{}'); } catch (e) { return {}; }
        }
        function saveTermsUIState(state) {
          try { localStorage.setItem(TERMS_UI_KEY, JSON.stringify(state || {})); } catch (e) { console.warn('saveTermsUIState failed', e); }
        }

        // renderTermsList - FIXED VERSION with proper state restoration + DRAG-AND-DROP


        // renderTermsList - New Collapsible Version
        // renderTermsList - New Collapsible Version (Updated UI)
        function renderTermsList(rows) {
          if (!rows || rows.length === 0) { termsList.innerHTML = '<div class="muted">ูุง ุชูุฌุฏ ุจููุฏ ุญุชู ุงูุขู</div>'; return; }
          const uiState = loadTermsUIState();

          // Apply saved custom order if exists
          // IGNORE saved custom order from localStorage to enforce Server Order
          // if (uiState._termsOrder && Array.isArray(uiState._termsOrder)) { ... }
          // This ensures the server's persistent order is always respected.

          /*
          if (uiState._termsOrder && Array.isArray(uiState._termsOrder)) {
            const orderedRows = [];
            const usedIds = new Set();
            uiState._termsOrder.forEach(savedId => {
              const term = rows.find(t => String(t.id || t._id) === String(savedId));
              if (term) { orderedRows.push(term); usedIds.add(String(savedId)); }
            });
            rows.forEach(t => {
              const id = String(t.id || t._id);
              if (!usedIds.has(id)) orderedRows.push(t);
            });
            rows = orderedRows;
          }
          */

          termsList.innerHTML = '';
          let draggedElement = null;

          rows.forEach((t, index) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'term-item';
            wrapper.style.cssText = 'border-bottom: 1px solid #eef4ff; padding: 8px 4px; margin-bottom: 4px; background: white; border-radius: 6px;';
            wrapper.draggable = true;
            const id = String(t.id || t._id || Math.random().toString(36).slice(2));
            if (!t.id && !t._id) t.id = id;
            wrapper.dataset.termId = id;

            // --- Drag & Drop for Terms ---
            wrapper.addEventListener('dragstart', (e) => {
              if (e.target.closest('.sub-items-container') || e.target.closest('.rule-actions')) { return; }
              draggedElement = wrapper;
              wrapper.classList.add('dragging');
              e.dataTransfer.effectAllowed = 'move';
              e.dataTransfer.setData('text/html', wrapper.innerHTML);
            });
            wrapper.addEventListener('dragend', () => {
              wrapper.classList.remove('dragging');
              document.querySelectorAll('.term-item').forEach(item => item.classList.remove('drag-over'));
              draggedElement = null;
              saveTermsOrder();
            });
            wrapper.addEventListener('dragover', (e) => {
              e.preventDefault();
              if (draggedElement && draggedElement !== wrapper && draggedElement.classList.contains('term-item')) {
                wrapper.classList.add('drag-over');
              }
            });
            wrapper.addEventListener('dragleave', () => wrapper.classList.remove('drag-over'));
            wrapper.addEventListener('drop', (e) => {
              e.preventDefault();
              wrapper.classList.remove('drag-over');
              if (draggedElement && draggedElement !== wrapper && draggedElement.classList.contains('term-item')) {
                const allItems = Array.from(termsList.children);
                const draggedIndex = allItems.indexOf(draggedElement);
                const targetIndex = allItems.indexOf(wrapper);
                if (draggedIndex < targetIndex) wrapper.parentNode.insertBefore(draggedElement, wrapper.nextSibling);
                else wrapper.parentNode.insertBefore(draggedElement, wrapper);

                // CRITICAL: Order changed visually. Now we MUST persist this exact order to DB.
                saveTermsOrder();
              }
            });

            // --- Term Header (Title + Toggle) ---
            const headerDiv = document.createElement('div');
            headerDiv.style.cssText = 'display: flex; align-items: center; padding: 6px; background: #fff; border-radius: 6px;';

            // Toggle Expand/Collapse - Distinct Large Button
            const isExpanded = uiState[id] ? !!uiState[id].expanded : false;

            const expandBtn = document.createElement('div');
            expandBtn.className = 'expand-btn';
            expandBtn.style.cssText = 'cursor: pointer; padding: 8px 12px; font-size: 16px; color: #64748b; user-select: none; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.2s; min-width: 30px;';
            expandBtn.innerHTML = isExpanded ? 'โผ' : 'โ';
            expandBtn.title = 'ุงููุฑ ููุชุญ/ุฅุบูุงู ุงููุงุฆูุฉ';
            expandBtn.onmouseover = () => expandBtn.style.background = '#f1f5f9';
            expandBtn.onmouseout = () => expandBtn.style.background = 'transparent';

            expandBtn.onclick = (e) => {
              e.stopPropagation();
              const newState = !isExpanded;
              const subContainer = wrapper.querySelector('.sub-items-container');
              if (subContainer) {
                subContainer.style.display = newState ? 'block' : 'none';
                expandBtn.innerHTML = newState ? 'โผ' : 'โ';

                // Save state
                const st = loadTermsUIState();
                st[id] = st[id] || {};
                st[id].expanded = newState;
                saveTermsUIState(st);
              }
            };

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.dataset.id = id;
            checkbox.className = 'termCheckbox';
            checkbox.style.marginLeft = '8px';
            checkbox.style.transform = 'scale(1.2)';
            checkbox.dataset.content = t.content || '';
            if (uiState[id] && uiState[id].checked) checkbox.checked = true;

            const title = document.createElement('span');
            // NUMBERING REMOVED FROM TERM NAME per user request
            title.innerHTML = `${t.name}`;
            title.style.cssText = 'font-weight: 600; flex: 1; user-select: none; cursor: pointer; padding: 4px; font-size: 1.05em;';

            // Ensure title click matches "Customize/Edit" button behavior (loads into editor)
            title.onclick = (e) => {
              e.stopPropagation();
              loadTermIntoEditor(t);
              // Also imply selection
              checkbox.checked = true;
              const st = loadTermsUIState();
              st[id] = st[id] || {};
              st[id].checked = true;
              saveTermsUIState(st);
              updateTermsFromUI();
            };

            // Edit Term Button (Pen icon)
            const editTermBtn = document.createElement('button');
            editTermBtn.className = 'btn small icon-only flat';
            editTermBtn.innerHTML = 'โ๏ธ';
            editTermBtn.title = 'ุชุฎุตูุต ุงูุจูุฏ';
            editTermBtn.style.fontSize = '1.2em';
            editTermBtn.onclick = (e) => {
              e.stopPropagation();
              loadTermIntoEditor(t);
            };

            // Delete Term Button (Trash icon)
            const delTermBtn = document.createElement('button');
            delTermBtn.className = 'btn small icon-only flat';
            delTermBtn.innerHTML = '๐๏ธ';
            delTermBtn.title = 'ุญุฐู ุงูุจูุฏ ุจุงููุงูู';
            delTermBtn.style.color = '#ef4444';
            delTermBtn.onclick = async (e) => {
              e.stopPropagation();
              if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุจูุฏ ุจุงููุงููุ')) {
                await deleteTermById(id);
                await loadTerms();
              }
            };

            // Only show expand button for selection terms or terms with content
            if (t.type !== 'selection') {
              expandBtn.style.visibility = 'hidden';
            }

            headerDiv.appendChild(expandBtn);
            headerDiv.appendChild(checkbox);
            headerDiv.appendChild(title);
            headerDiv.appendChild(editTermBtn);
            headerDiv.appendChild(delTermBtn);
            wrapper.appendChild(headerDiv);

            // Handle Selection Type (Multi-select list)
            if (t.type === 'selection' && t.content) {
              const subItemsContainer = document.createElement('div');
              subItemsContainer.className = 'sub-items-container';
              subItemsContainer.style.cssText = 'padding-right: 28px; margin-top: 8px; border-right: 2px solid #e2e8f0;';
              subItemsContainer.style.display = isExpanded ? 'block' : 'none';

              // --- HIERARCHY PARSING LOGIC ---
              // We need to parse lines and group them: Rule -> [Inside Rules]
              // Indented lines (start with whitespace) are "Inside Rules"
              let rawLines = t.content.split(/\r?\n/).filter(line => line.trim().length > 0);

              // Build Tree
              const tree = [];
              let currentParent = null;

              rawLines.forEach(line => {
                const isIndented = line.match(/^\s+/);
                const text = line.trim();

                if (isIndented && currentParent) {
                  // It is a child of the current parent
                  currentParent.children.push({ text: text, original: line });
                } else {
                  // It is a new top-level rule
                  currentParent = { text: text, original: line, children: [] };
                  tree.push(currentParent);
                }
              });

              // --- Render Tree ---
              tree.forEach((node, nodeIndex) => {
                // --- Render Parent Rule ---
                const ruleDiv = document.createElement('div');
                ruleDiv.className = 'sub-term-item rule-parent'; // Distinct class
                ruleDiv.style.cssText = 'display: flex; align-items: flex-start; margin-bottom: 6px; padding: 6px; background: #f8fafc; border-radius: 4px; border: 1px solid transparent; transition: all 0.2s;';

                // Parent Hover
                ruleDiv.onmouseover = () => ruleDiv.style.borderColor = '#cbd5e1';
                ruleDiv.onmouseout = () => ruleDiv.style.borderColor = 'transparent';

                // Checkbox for Logic (selects all children if checked?)
                const ruleCheckbox = document.createElement('input');
                ruleCheckbox.type = 'checkbox';
                ruleCheckbox.className = 'sub-term-checkbox';
                ruleCheckbox.dataset.parent = id;
                ruleCheckbox.dataset.val = node.original;
                ruleCheckbox.style.marginTop = '4px';
                ruleCheckbox.style.marginLeft = '8px';

                if (uiState[id] && uiState[id].subSelections && uiState[id].subSelections.includes(node.original)) {
                  ruleCheckbox.checked = true;
                }

                const ruleLabel = document.createElement('div');
                // Keep Rule Numbering: 1., 2., ...
                ruleLabel.innerHTML = `<strong>${nodeIndex + 1}.</strong> ${node.text}`;
                ruleLabel.className = 'sub-term-text';
                ruleLabel.style.cssText = 'font-size: 1em; font-weight: 600; color: #334155; flex: 1; line-height: 1.5; outline: none; padding: 2px;';

                // Actions
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'rule-actions';
                actionsDiv.style.cssText = 'display: flex; gap: 4px; opacity: 0.8; margin-right: 8px;';

                // Add Inside Rule Button ( + )
                const addInsideBtn = document.createElement('button');
                addInsideBtn.innerHTML = 'โ ุฎูุงุฑ ูุฑุนู';
                addInsideBtn.className = 'btn small dashed';
                addInsideBtn.style.fontSize = '0.7em';
                addInsideBtn.style.padding = '2px 6px';
                addInsideBtn.title = 'ุฅุถุงูุฉ ุจูุฏ ูุฑุนู (Inside Rule)';
                addInsideBtn.onclick = (e) => {
                  e.stopPropagation();
                  const newText = prompt(`ุฅุถุงูุฉ ุฎูุงุฑ ูุฑุนู ุชุญุช "${node.text}":`);
                  if (newText && newText.trim()) {
                    // Logic: Find 'node.original' in content, insert '    ' + newText after it (or after its last child)
                    addInsideRule(t, node.original, newText.trim());
                  }
                };

                // Edit
                const editBtn = document.createElement('button');
                editBtn.innerHTML = 'โ๏ธ';
                editBtn.className = 'btn icon-only small flat';
                editBtn.onclick = (e) => {
                  e.stopPropagation();
                  const newText = prompt('ุชุนุฏูู ุงููุต:', node.text);
                  if (newText !== null && newText !== node.text) {
                    updateRuleText(t, node.original, newText);
                  }
                };

                // Delete
                const delBtn = document.createElement('button');
                delBtn.innerHTML = 'โ';
                delBtn.className = 'btn icon-only small flat';
                delBtn.style.color = '#ef4444';
                delBtn.onclick = (e) => {
                  e.stopPropagation();
                  const confirmMsg = node.children.length > 0
                    ? `ุญุฐู "${node.text}" ู ${node.children.length} ูู ุงูุฎูุงุฑุงุช ุงููุฑุนูุฉุ`
                    : `ุญุฐู "${node.text}"ุ`;
                  if (confirm(confirmMsg)) {
                    deleteRuleBlock(t, node);
                  }
                };

                actionsDiv.appendChild(addInsideBtn);
                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(delBtn);

                ruleCheckbox.addEventListener('change', () => {
                  if (ruleCheckbox.checked) {
                    checkbox.checked = true;
                  }
                  saveSubSelections(id, subItemsContainer);
                  updateTermsFromUI();
                });

                ruleDiv.appendChild(ruleCheckbox);
                ruleDiv.appendChild(ruleLabel);
                ruleDiv.appendChild(actionsDiv);
                subItemsContainer.appendChild(ruleDiv);

                // --- Render Children (Inside Rules) ---
                if (node.children.length > 0) {
                  const childrenContainer = document.createElement('div');
                  childrenContainer.style.marginRight = '24px'; // Indent
                  childrenContainer.style.borderRight = '2px dashed #e2e8f0';
                  childrenContainer.style.paddingRight = '8px';

                  node.children.forEach((child, childIndex) => {
                    const childDiv = document.createElement('div');
                    childDiv.className = 'sub-term-item inside-rule';
                    childDiv.style.cssText = 'display: flex; align-items: flex-start; margin-bottom: 4px; padding: 4px; border-radius: 4px;';

                    const childCheckbox = document.createElement('input');
                    childCheckbox.type = 'checkbox';
                    childCheckbox.className = 'sub-term-checkbox';
                    childCheckbox.dataset.parent = id;
                    childCheckbox.dataset.val = child.original;
                    childCheckbox.style.marginTop = '4px';
                    childCheckbox.style.marginLeft = '8px';
                    if (uiState[id] && uiState[id].subSelections && uiState[id].subSelections.includes(child.original)) {
                      childCheckbox.checked = true;
                    }

                    const childLabel = document.createElement('div');
                    // LOCAL NUMBERING: 1., 2., ... instead of 1.1., 1.2.
                    childLabel.innerHTML = `<strong>${childIndex + 1}.</strong> ${child.text}`;
                    childLabel.className = 'sub-term-text';
                    childLabel.style.cssText = 'font-size: 0.9em; color: #64748b; flex: 1; line-height: 1.5;';

                    // Actions for Child
                    const childActions = document.createElement('div');
                    childActions.className = 'rule-actions';
                    childActions.style.cssText = 'display: flex; gap: 4px; opacity: 0.6; margin-right: 8px;';
                    childDiv.onmouseenter = () => childActions.style.opacity = '1';
                    childDiv.onmouseleave = () => childActions.style.opacity = '0.6';

                    // Child Edit
                    const cEdit = document.createElement('button');
                    cEdit.innerHTML = 'โ๏ธ';
                    cEdit.className = 'btn icon-only small flat';
                    cEdit.onclick = (e) => {
                      e.stopPropagation();
                      const newT = prompt('ุชุนุฏูู ุงููุฑุนู:', child.text);
                      if (newT && newT !== child.text) {
                        // Ensure we keep indentation
                        updateRuleText(t, child.original, '    ' + newT.trim());
                      }
                    };

                    // Child Delete
                    const cDel = document.createElement('button');
                    cDel.innerHTML = 'โ';
                    cDel.className = 'btn icon-only small flat';
                    cDel.style.color = '#ef4444';
                    cDel.onclick = (e) => {
                      e.stopPropagation();
                      if (confirm('ุญุฐู ูุฐุง ุงูุฎูุงุฑ ุงููุฑุนูุ')) deleteRule(t, child.original);
                    };

                    childActions.appendChild(cEdit);
                    childActions.appendChild(cDel);

                    childCheckbox.addEventListener('change', () => {
                      saveSubSelections(id, subItemsContainer);
                      updateTermsFromUI();
                    });

                    childDiv.appendChild(childCheckbox);
                    childDiv.appendChild(childLabel);
                    childDiv.appendChild(childActions);
                    childrenContainer.appendChild(childDiv);
                  });
                  subItemsContainer.appendChild(childrenContainer);
                }
              });

              // "Add New Rule" Button (Top Level)
              const addRuleDiv = document.createElement('div');
              addRuleDiv.style.marginTop = '8px';
              const addBtn = document.createElement('button');
              addBtn.className = 'btn small dashed';
              addBtn.innerHTML = '+ ุฅุถุงูุฉ ุฎูุงุฑ ุฑุฆูุณู ุฌุฏูุฏ';
              addBtn.style.width = '100%';
              addBtn.onclick = (e) => {
                e.stopPropagation();
                const newRule = prompt('ุฃุฏุฎู ูุต ุงูุฎูุงุฑ ุงูุฑุฆูุณู:');
                if (newRule && newRule.trim()) {
                  addRule(t, newRule.trim());
                }
              };
              addRuleDiv.appendChild(addBtn);
              subItemsContainer.appendChild(addRuleDiv);

              wrapper.appendChild(subItemsContainer);
            }

            checkbox.addEventListener('change', () => {
              const st = loadTermsUIState();
              st[id] = st[id] || {};
              st[id].checked = checkbox.checked;
              saveTermsUIState(st);
              updateTermsFromUI();
            });

            termsList.appendChild(wrapper);
          });

          updateTermsFromUI();
        }

        // --- New Helper Functions for Hierarchy ---

        async function addInsideRule(term, parentOriginalLine, newChildText) {
          let lines = (term.content || '').split(/\r?\n/);
          // Find index of parent
          // Note: if there are duplicate lines, this might pick the first one. 
          // Ideally we use unique IDs, but text-based is the constraint.
          const parentIdx = lines.indexOf(parentOriginalLine);
          if (parentIdx === -1) return;

          // Find where to insert: after parent AND all its current children
          let insertIdx = parentIdx + 1;
          while (insertIdx < lines.length && lines[insertIdx].match(/^\s+/)) {
            insertIdx++;
          }

          // Insert with 4 spaces indentation
          lines.splice(insertIdx, 0, '    ' + newChildText);

          term.content = lines.join('\n');
          await updateTerm(term.id || term._id, term);
          await loadTerms();
        }

        async function deleteRuleBlock(term, node) {
          let lines = (term.content || '').split(/\r?\n/);

          // We need to remove the parent line AND any immediately following indented lines
          // First, find the exact block indices.
          const idx = lines.indexOf(node.original);
          if (idx === -1) return;

          let count = 1; // Removing parent
          // Look ahead for children
          while (idx + count < lines.length && lines[idx + count].match(/^\s+/)) {
            count++;
          }

          // Remove block
          const removed = lines.splice(idx, count);

          // Cleanup UI selections for all removed lines
          const st = loadTermsUIState();
          const tid = String(term.id || term._id);
          if (st[tid]) {
            if (st[tid].subSelections) {
              removed.forEach(remLine => {
                st[tid].subSelections = st[tid].subSelections.filter(x => x !== remLine);
              });
            }
            saveTermsUIState(st);
          }

          term.content = lines.join('\n');
          await updateTerm(term.id || term._id, term);
          await loadTerms();
        }

        // Old renderTermsList implementation (Deprecated)
        function renderTermsListDeprecated(rows) {
          if (!rows || rows.length === 0) { termsList.innerHTML = '<div class="muted">ูุง ุชูุฌุฏ ุจููุฏ ุญุชู ุงูุขู</div>'; return; }
          const uiState = loadTermsUIState();

          // Apply saved custom order if exists
          if (uiState._termsOrder && Array.isArray(uiState._termsOrder)) {
            const orderedRows = [];
            const usedIds = new Set();
            uiState._termsOrder.forEach(savedId => {
              const term = rows.find(t => String(t.id || t._id) === String(savedId));
              if (term) { orderedRows.push(term); usedIds.add(String(savedId)); }
            });
            rows.forEach(t => {
              const id = String(t.id || t._id);
              if (!usedIds.has(id)) orderedRows.push(t);
            });
            rows = orderedRows;
          }

          termsList.innerHTML = '';
          let draggedElement = null;

          rows.forEach((t, index) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'term-item';
            wrapper.style.cssText = 'border-bottom: 1px solid #eef4ff; padding: 8px 4px; margin-bottom: 4px; background: white; border-radius: 6px;';
            wrapper.draggable = true;
            const id = String(t.id || t._id || Math.random().toString(36).slice(2));
            wrapper.dataset.termId = id;

            // --- Drag & Drop for Terms ---
            wrapper.addEventListener('dragstart', (e) => {
              if (e.target.closest('.sub-items-container') || e.target.closest('.rule-actions')) { return; }
              draggedElement = wrapper;
              wrapper.classList.add('dragging');
              e.dataTransfer.effectAllowed = 'move';
              e.dataTransfer.setData('text/html', wrapper.innerHTML);
            });
            wrapper.addEventListener('dragend', () => {
              wrapper.classList.remove('dragging');
              document.querySelectorAll('.term-item').forEach(item => item.classList.remove('drag-over'));
              draggedElement = null;
              saveTermsOrder();
            });
            wrapper.addEventListener('dragover', (e) => {
              e.preventDefault();
              if (draggedElement && draggedElement !== wrapper && draggedElement.classList.contains('term-item')) {
                wrapper.classList.add('drag-over');
              }
            });
            wrapper.addEventListener('dragleave', () => wrapper.classList.remove('drag-over'));
            wrapper.addEventListener('drop', (e) => {
              e.preventDefault();
              wrapper.classList.remove('drag-over');
              if (draggedElement && draggedElement !== wrapper && draggedElement.classList.contains('term-item')) {
                const allItems = Array.from(termsList.children);
                const draggedIndex = allItems.indexOf(draggedElement);
                const targetIndex = allItems.indexOf(wrapper);
                if (draggedIndex < targetIndex) wrapper.parentNode.insertBefore(draggedElement, wrapper.nextSibling);
                else wrapper.parentNode.insertBefore(draggedElement, wrapper);
              }
            });

            // --- Term Header (Title + Toggle) ---
            const headerDiv = document.createElement('div');
            headerDiv.style.cssText = 'display: flex; align-items: center; cursor: pointer; padding: 4px;';
            headerDiv.title = 'ุงููุฑ ููุชุญ/ุฅุบูุงู ุงููุงุฆูุฉ';

            // Toggle Expand/Collapse
            const isExpanded = uiState[id] ? !!uiState[id].expanded : false;

            headerDiv.onclick = (e) => {
              if (e.target.closest('button') || e.target.closest('.termCheckbox')) return;
              const newState = !isExpanded;
              const subContainer = wrapper.querySelector('.sub-items-container');
              if (subContainer) {
                subContainer.style.display = newState ? 'block' : 'none';
                // Update Arrow
                const arrow = headerDiv.querySelector('.expand-arrow');
                if (arrow) arrow.textContent = newState ? 'โผ' : 'โ';

                // Save state
                const st = loadTermsUIState();
                st[id] = st[id] || {};
                st[id].expanded = newState;
                saveTermsUIState(st);
              }
            };

            const expandArrow = document.createElement('span');
            expandArrow.className = 'expand-arrow';
            expandArrow.textContent = isExpanded ? 'โผ' : 'โ';
            expandArrow.style.cssText = 'color: #94a3b8; font-size: 10px; margin-left: 8px; width: 14px; text-align: center;';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.dataset.id = id;
            checkbox.className = 'termCheckbox';
            checkbox.style.marginLeft = '8px';
            checkbox.dataset.content = t.content || '';
            if (uiState[id] && uiState[id].checked) checkbox.checked = true;

            const title = document.createElement('span');
            title.innerHTML = t.name;
            title.style.cssText = 'font-weight: 600; flex: 1; user-select: none;';

            // Edit Term Button (Pen icon)
            const editTermBtn = document.createElement('button');
            editTermBtn.className = 'btn small icon-only flat';
            editTermBtn.innerHTML = 'โ๏ธ';
            editTermBtn.title = 'ุชุฎุตูุต ุงูุจูุฏ';
            editTermBtn.onclick = (e) => {
              e.stopPropagation();
              loadTermIntoEditor(t);
            };

            // Delete Term Button (Trash icon)
            const delTermBtn = document.createElement('button');
            delTermBtn.className = 'btn small icon-only flat';
            delTermBtn.innerHTML = '๐๏ธ';
            delTermBtn.title = 'ุญุฐู ุงูุจูุฏ ุจุงููุงูู';
            delTermBtn.style.color = '#ef4444';
            delTermBtn.onclick = async (e) => {
              e.stopPropagation();
              if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุจูุฏ ุจุงููุงููุ')) {
                await deleteTermById(id);
                await loadTerms();
              }
            };

            headerDiv.appendChild(expandArrow);
            headerDiv.appendChild(checkbox);
            headerDiv.appendChild(title);
            headerDiv.appendChild(editTermBtn);
            headerDiv.appendChild(delTermBtn);
            wrapper.appendChild(headerDiv);

            // Handle Selection Type (Multi-select list)
            if (t.type === 'selection' && t.content) {
              const subItemsContainer = document.createElement('div');
              subItemsContainer.className = 'sub-items-container';
              subItemsContainer.style.cssText = 'padding-right: 28px; margin-top: 8px; border-right: 2px solid #e2e8f0;';
              subItemsContainer.style.display = isExpanded ? 'block' : 'none';

              let lines = t.content.split(/\r?\n/).filter(line => line.trim().length > 0);

              // Reorder lines based on saved subOrder
              if (uiState[id] && uiState[id].subOrder) {
                const orderMap = new Map(uiState[id].subOrder.map((val, idx) => [val, idx]));
                lines.sort((a, b) => {
                  const idxA = orderMap.has(a) ? orderMap.get(a) : 9999;
                  const idxB = orderMap.has(b) ? orderMap.get(b) : 9999;
                  return idxA - idxB;
                });
              }

              let draggedSubItem = null;

              // --- Render each Rule/Line ---
              lines.forEach((line) => {
                const subItemDiv = document.createElement('div');
                subItemDiv.className = 'sub-term-item';
                subItemDiv.draggable = true;
                subItemDiv.style.cssText = 'display: flex; align-items: flex-start; margin-bottom: 6px; padding: 6px; background: #f8fafc; border-radius: 4px; border: 1px solid transparent; transition: all 0.2s;';

                // Hover effect
                subItemDiv.onmouseover = () => subItemDiv.style.borderColor = '#cbd5e1';
                subItemDiv.onmouseout = () => subItemDiv.style.borderColor = 'transparent';

                // Sub-item Drag Logic
                subItemDiv.addEventListener('dragstart', (e) => {
                  e.stopPropagation();
                  draggedSubItem = subItemDiv;
                  subItemDiv.style.opacity = '0.5';
                  e.dataTransfer.effectAllowed = 'move';
                });
                subItemDiv.addEventListener('dragend', (e) => {
                  e.stopPropagation();
                  subItemDiv.style.opacity = '1';
                  draggedSubItem = null;
                  // Save Order & UI State
                  saveSubItemsOrder(id, subItemsContainer);
                  updateTermsFromUI();
                });
                subItemDiv.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); });
                subItemDiv.addEventListener('drop', (e) => {
                  e.preventDefault(); e.stopPropagation();
                  if (draggedSubItem && draggedSubItem !== subItemDiv && draggedSubItem.parentNode === subItemsContainer) {
                    const items = Array.from(subItemsContainer.querySelectorAll('.sub-term-item'));
                    const srcPos = items.indexOf(draggedSubItem);
                    const tgtPos = items.indexOf(subItemDiv);
                    if (srcPos < tgtPos) subItemsContainer.insertBefore(draggedSubItem, subItemDiv.nextSibling);
                    else subItemsContainer.insertBefore(draggedSubItem, subItemDiv);
                    // dragend handles save state
                  }
                });

                const subCheckbox = document.createElement('input');
                subCheckbox.type = 'checkbox';
                subCheckbox.className = 'sub-term-checkbox';
                subCheckbox.dataset.parent = id;
                subCheckbox.dataset.val = line;
                subCheckbox.style.marginTop = '4px';
                subCheckbox.style.marginLeft = '8px';

                if (uiState[id] && uiState[id].subSelections && uiState[id].subSelections.includes(line)) {
                  subCheckbox.checked = true;
                }

                const subLabel = document.createElement('div');
                subLabel.innerHTML = line;
                subLabel.className = 'sub-term-text';
                subLabel.style.cssText = 'font-size: 0.9em; color: #475569; flex: 1; line-height: 1.5; outline: none; padding: 2px; border-radius: 4px; border: 1px dashed transparent;';

                // Actions Container (Edit/Delete)
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'rule-actions';
                actionsDiv.style.cssText = 'display: flex; gap: 4px; opacity: 0.6; margin-right: 8px;';
                subItemDiv.onmouseenter = () => actionsDiv.style.opacity = '1';
                subItemDiv.onmouseleave = () => actionsDiv.style.opacity = '0.6';

                // Edit Button
                const editBtn = document.createElement('button');
                editBtn.innerHTML = 'โ๏ธ';
                editBtn.title = 'ุชุนุฏูู ุงููุต';
                editBtn.className = 'btn icon-only small flat';
                editBtn.onclick = (e) => {
                  e.stopPropagation();
                  const newText = prompt('ุชุนุฏูู ุงููุต:', line.replace(/<[^>]*>/g, ''));
                  if (newText !== null && newText !== line) {
                    updateRuleText(t, line, newText);
                  }
                };

                // Delete Button
                const delBtn = document.createElement('button');
                delBtn.innerHTML = 'โ';
                delBtn.title = 'ุญุฐู ูุฐุง ุงูุฎูุงุฑ';
                delBtn.className = 'btn icon-only small flat';
                delBtn.style.color = '#ef4444';
                delBtn.onclick = (e) => {
                  e.stopPropagation();
                  if (confirm('ุญุฐู ูุฐุง ุงูุฎูุงุฑุ')) {
                    deleteRule(t, line);
                  }
                };

                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(delBtn);

                subCheckbox.addEventListener('change', () => {
                  if (subCheckbox.checked) {
                    checkbox.checked = true;
                    const st = loadTermsUIState();
                    st[id] = st[id] || {};
                    st[id].checked = true;
                    saveTermsUIState(st);
                  }
                  saveSubSelections(id, subItemsContainer);
                  updateTermsFromUI();
                });

                subItemDiv.appendChild(subCheckbox);
                subItemDiv.appendChild(subLabel);
                subItemDiv.appendChild(actionsDiv);
                subItemsContainer.appendChild(subItemDiv);
              });

              // "Add New Rule" Button
              const addRuleDiv = document.createElement('div');
              addRuleDiv.style.marginTop = '8px';
              const addBtn = document.createElement('button');
              addBtn.className = 'btn small dashed';
              addBtn.innerHTML = '+ ุฅุถุงูุฉ ุฎูุงุฑ ุฌุฏูุฏ';
              addBtn.style.width = '100%';
              addBtn.onclick = (e) => {
                e.stopPropagation();
                const newRule = prompt('ุฃุฏุฎู ูุต ุงูุฎูุงุฑ ุงูุฌุฏูุฏ:');
                if (newRule && newRule.trim()) {
                  addRule(t, newRule.trim());
                }
              };
              addRuleDiv.appendChild(addBtn);
              subItemsContainer.appendChild(addRuleDiv);

              wrapper.appendChild(subItemsContainer);
            }

            checkbox.addEventListener('change', () => {
              const st = loadTermsUIState();
              st[id] = st[id] || {};
              st[id].checked = checkbox.checked;
              saveTermsUIState(st);
              updateTermsFromUI();
            });

            termsList.appendChild(wrapper);
          });

          updateTermsFromUI();
        }

        // --- Helper Functions for Rule Management ---

        function saveSubItemsOrder(termId, container) {
          const currentOrder = Array.from(container.querySelectorAll('.sub-term-checkbox')).map(cb => cb.dataset.val);
          const st = loadTermsUIState();
          st[termId] = st[termId] || {};
          st[termId].subOrder = currentOrder;
          saveTermsUIState(st);
        }

        function saveSubSelections(termId, container) {
          const checked = Array.from(container.querySelectorAll('.sub-term-checkbox:checked'));
          const st = loadTermsUIState();
          st[termId] = st[termId] || {};
          st[termId].subSelections = checked.map(cb => cb.dataset.val);
          saveTermsUIState(st);
        }

        async function addRule(term, newText) {
          let lines = (term.content || '').split(/\r?\n/);
          lines.push(newText);
          /* Remove empty lines if any? maybe keep */
          const newContent = lines.join('\n');
          term.content = newContent;
          await updateTerm(term.id || term._id, term);
          await loadTerms(); // Refresh UI
        }

        async function updateRuleText(term, oldText, newText) {
          let lines = (term.content || '').split(/\r?\n/);
          const idx = lines.indexOf(oldText);
          if (idx !== -1) {
            lines[idx] = newText;
            term.content = lines.join('\n');

            // Also update local UI state if this was selected/ordered
            const st = loadTermsUIState();
            const tid = String(term.id || term._id);
            if (st[tid]) {
              if (st[tid].subSelections) {
                const selIdx = st[tid].subSelections.indexOf(oldText);
                if (selIdx !== -1) st[tid].subSelections[selIdx] = newText;
              }
              if (st[tid].subOrder) {
                const ordIdx = st[tid].subOrder.indexOf(oldText);
                if (ordIdx !== -1) st[tid].subOrder[ordIdx] = newText;
              }
              saveTermsUIState(st);
            }

            await updateTerm(term.id || term._id, term);
            await loadTerms();
          }
        }

        async function deleteRule(term, textToDelete) {
          let lines = (term.content || '').split(/\r?\n/);
          const idx = lines.indexOf(textToDelete);
          if (idx !== -1) {
            lines.splice(idx, 1);
            term.content = lines.join('\n');

            // cleanup UI state
            const st = loadTermsUIState();
            const tid = String(term.id || term._id);
            if (st[tid]) {
              if (st[tid].subSelections) {
                st[tid].subSelections = st[tid].subSelections.filter(x => x !== textToDelete);
              }
              if (st[tid].subOrder) {
                st[tid].subOrder = st[tid].subOrder.filter(x => x !== textToDelete);
              }
              saveTermsUIState(st);
            }

            await updateTerm(term.id || term._id, term);
            await loadTerms();
          }
        }

        // Save current terms order to UI state
        async function saveTermsOrder() {
          const items = Array.from(termsList.querySelectorAll('.term-item'));
          const order = items.map(item => item.dataset.termId);
          const st = loadTermsUIState();
          st._termsOrder = order;
          saveTermsUIState(st);
          console.log('โ Terms order saved locally:', order);

          // Sync with Server
          try {
            await apiFetch('/terms/reorder', { method: 'PUT', body: JSON.stringify({ order }) });
            console.log('โ Terms order synced with server');
          } catch (e) {
            console.warn('Failed to sync order with server', e);
          }

          // Update the terms in the contract to reflect new order
          updateTermsFromUI();
        }

        // load term into editor function
        function loadTermIntoEditor(t) {
          if (!t) return;
          const id = String(t.id || t._id || '');
          if (id) $('termId').value = id;
          if (t.name) $('termName').value = t.name;
          if (t.type) $('termType').value = t.type;

          // Set content in Quill editor
          if (t.content) {
            // Replace old date patterns with today's dates before loading
            let contentToLoad = t.content;

            // Apply date replacement if the function exists
            if (typeof replaceDatePlaceholders === 'function') {
              // Gather current context data for replacement
              const contractData = {
                from_date: $('dateFrom')?.value || null,
                second_party: $('clientName')?.value || '',
                container_type: $('containerType')?.value || '', // Add container type
                // Add other potential fields if needed
              };

              contentToLoad = replaceDatePlaceholders(t.content, contractData);
              console.log('๐ Applied date replacement to term content in editor', contractData);
            }

            quill.root.innerHTML = contentToLoad;
          } else {
            quill.setText('');
          }

          // Update label based on type
          if (t.type === 'selection') {
            $('termContentLabel').textContent = 'ุฎูุงุฑุงุช ุงูุจูุฏ (ูู ุฎูุงุฑ ูู ุณุทุฑ ุฌุฏูุฏ)';
          } else {
            $('termContentLabel').textContent = 'ูุต ุงูุจูุฏ';
          }
        }

        // ============ HIJRI DATE CONVERSION & DYNAMIC DATE REPLACEMENT ============

        // Convert Gregorian date to Hijri (Islamic calendar)
        // Using browser's built-in Intl API for 100% accuracy
        function gregorianToHijri(date) {
          const gDate = new Date(date);

          // Subtract 1 day to match accurate Hijri calendar
          // The Intl API sometimes is 1 day ahead
          gDate.setDate(gDate.getDate() - 1);

          // Use Intl.DateTimeFormat with Islamic calendar (umalqura)
          const formatter = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {
            day: 'numeric',
            month: 'numeric',
            year: 'numeric',
            numberingSystem: 'latn' // Use Latin numbers (1,2,3) instead of Arabic (ูก,ูข,ูฃ)
          });

          // Format and parse the date
          const parts = formatter.formatToParts(gDate);

          const day = parseInt(parts.find(p => p.type === 'day').value);
          const month = parseInt(parts.find(p => p.type === 'month').value);
          const year = parseInt(parts.find(p => p.type === 'year').value);

          console.log(`๐ Hijri conversion (Built-in API): ${day}/${month}/${year}ูู`);

          return { day, month, year };
        }

        // Get Arabic day name
        function getArabicDayName(date) {
          const days = ['ุงูุฃุญุฏ', 'ุงูุงุซููู', 'ุงูุซูุงุซุงุก', 'ุงูุฃุฑุจุนุงุก', 'ุงูุฎููุณ', 'ุงูุฌูุนุฉ', 'ุงูุณุจุช'];
          return days[date.getDay()];
        }

        // Format date as "DD/MM/YYYY"ุก   
        function formatGregorianDate(date) {
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = date.getFullYear();
          return `${year}/${month}/${day}`;
        }

        // Format Hijri date as "DD/MM/YYYYูู"
        function formatHijriDate(hijri) {
          return `${hijri.day}/${String(hijri.month).padStart(2, '0')}/${hijri.year}ูู`;
        }

        // Replace date and pricing placeholders in term content
        function replaceDatePlaceholders(content, contractData = null) {
          if (!content) return content;

          const today = new Date();
          const hijri = gregorianToHijri(today);
          const dayName = getArabicDayName(today);
          const gregorianDate = formatGregorianDate(today);
          const hijriDate = formatHijriDate(hijri);

          // Replace placeholders
          let result = content;

          // ===== AUTOMATIC PATTERN DETECTION (NO PLACEHOLDERS NEEDED) =====
          // Automatically detects and replaces existing Arabic date patterns
          const arabicDatePattern = /ุงูู ูู ููู\s*(ุงูุฃุญุฏ|ุงูุงุซููู|ุงูุซูุงุซุงุก|ุงูุฃุฑุจุนุงุก|ุงูุฎููุณ|ุงูุฌูุนุฉ|ุงูุณุจุช)\s+ุชุงุฑูุฎ\s+\d+\/\d+\/\d+ูู\s*[ุ,]?\s*ุงูููุงูู\s+\d{4}\/\d{1,2}\/\d{1,2}/gi;
          if (arabicDatePattern.test(content)) {
            arabicDatePattern.lastIndex = 0;
            result = result.replace(arabicDatePattern, `ุงูู ูู ููู ${dayName} ุชุงุฑูุฎ ${hijriDate} ุงูููุงูู ${gregorianDate}`);
          }

          const arabicDatePattern2 = /ุงูู ูู ููู\s*(ุงูุฃุญุฏ|ุงูุงุซููู|ุงูุซูุงุซุงุก|ุงูุฃุฑุจุนุงุก|ุงูุฎููุณ|ุงูุฌูุนุฉ|ุงูุณุจุช)\s+\d+\/\d+\/\d+ูู[ุ,]?\s*ุงูููุงูู\s+\d{4}\/\d{1,2}\/\d{1,2}/gi;
          if (arabicDatePattern2.test(content)) {
            arabicDatePattern2.lastIndex = 0;
            result = result.replace(arabicDatePattern2, `ุงูู ูู ููู ${dayName} ${hijriDate}ุ ุงูููุงูู ${gregorianDate}`);
          }

          // ===== MANUAL PLACEHOLDERS (Dates) =====
          result = result.replace(/\(here will be today date in arabic hejry[^)]*\)/gi, hijriDate);
          result = result.replace(/\(today date in english format[^)]*\)/gi, gregorianDate);
          result = result.replace(/\{HIJRI_DATE\}/g, hijriDate);
          result = result.replace(/\{GREGORIAN_DATE\}/g, gregorianDate);
          result = result.replace(/\{DAY_NAME\}/g, dayName);
          result = result.replace(/\{TODAY_HIJRI\}/g, hijriDate);
          result = result.replace(/\{TODAY_GREGORIAN\}/g, gregorianDate);

          // ===== DYNAMIC START DATE FROM INPUT =====
          if (contractData && contractData.from_date) {
            let startDate = contractData.from_date;
            if (typeof startDate === 'string') {
              startDate = startDate.split('T')[0].replace(/-/g, '/');
            }
            result = result.replace(/2024\/01\/01/g, startDate);
            result = result.replace(/2024-01-01/g, startDate);
            result = result.replace(/\{START_DATE\}/g, startDate);
            result = result.replace(/\{FROM_DATE\}/g, startDate);
            result = result.replace(/\{START_DATE_GREGORIAN\}/g, startDate);

            // Also provide Hijri Start Date if possible
            const startD = new Date(contractData.from_date);
            if (!isNaN(startD.getTime())) {
              const startHijri = gregorianToHijri(startD);
              result = result.replace(/\{START_DATE_HIJRI\}/g, formatHijriDate(startHijri));
            }
          }

          // ===== PRICING & NUMERIC REPLACEMENTS =====
          if (contractData) {
            // Monthly Fee
            if (contractData.monthly_fee) {
              const mFee = parseFloat(contractData.monthly_fee) || 0;
              result = result.replace(/\{MONTHLY_FEE\}/g, mFee);
              if (typeof numberToArabicText === 'function') {
                result = result.replace(/\{MONTHLY_FEE_ARABIC\}/g, numberToArabicText(mFee));
              }

              // Added: Monthly Fee WITH TAX
              const taxRate = contractData.tax ? parseFloat(contractData.tax.toString().replace('%', '')) / 100 : 0.15;
              const mFeeWithTax = Math.round(mFee * (1 + taxRate));
              result = result.replace(/\{MONTHLY_FEE_WITH_TAX\}/g, mFeeWithTax);
              if (typeof numberToArabicText === 'function') {
                result = result.replace(/\{MONTHLY_FEE_WITH_TAX_ARABIC\}/g, numberToArabicText(mFeeWithTax));
              }
            }
            // Total Price
            if (contractData.total_price) {
              const tPrice = parseFloat(contractData.total_price) || 0;
              result = result.replace(/\{TOTAL_PRICE\}/g, tPrice);
              if (typeof numberToArabicText === 'function') {
                result = result.replace(/\{TOTAL_PRICE_ARABIC\}/g, numberToArabicText(tPrice));
              }
            }
            // Tax Rate
            if (contractData.tax) {
              const tRate = contractData.tax.toString().replace('%', '');
              result = result.replace(/\{TAX_RATE\}/g, tRate);
            }
            // Duration
            if (contractData.duration) {
              result = result.replace(/\{DURATION\}/g, contractData.duration);
            }
            // Payment Type
            if (contractData.payment_type) {
              result = result.replace(/\{PAYMENT_TYPE\}/g, contractData.payment_type);
            } else {
              // Fallback to DOM if contractData doesn't have it (e.g. initial load)
              const domVal = $('paymentType')?.value;
              if (domVal) result = result.replace(/\{PAYMENT_TYPE\}/g, domVal);
            }
          } else {
            // Fallback to DOM if contractData is null
            const domVal = $('paymentType')?.value;
            if (domVal) result = result.replace(/\{PAYMENT_TYPE\}/g, domVal);
          }

          // ===== DYNAMIC CONTAINER TYPE FROM INPUT =====
          const cType = (contractData && contractData.container_type) ? contractData.container_type : ($('containerType')?.value || '');
          if (cType) {
            // Specific patterns to replace with the selected container type
            // Supports: ( ุจุฑููู ) , ( 2 ูุงุฑุฏุฉ ) , ( 4 ูุงุฑุฏุฉ ) , ( ุจุฏูู )
            result = result.replace(/\(\s*ุจุฑููู\s*\)/g, `( ${cType} )`);
            result = result.replace(/\(\s*\d+\s*ูุงุฑุฏุฉ\s*\)/g, `( ${cType} )`);
            result = result.replace(/\(\s*ุจุฏูู\s*\)/g, `( ${cType} )`);

            // Generic fallback for "ุญุงููุฉ X"
            result = result.replace(/\(\s*ุญุงููุฉ[^\)]*\s*\)/g, `( ${cType} )`);

            // Handle English/Liter variants
            result = result.replace(/\(\s*(?:<[^>]+>\s*)*\d+\s*(?:<[^>]+>\s*)*Liter\s*(?:<[^>]+>\s*)*\)/gi, `( ${cType} )`);

            // Explicit placeholder
            result = result.replace(/\{CONTAINER_TYPE\}/g, cType);
          }

          // ===== PARTY REPLACEMENTS =====
          if (typeof replaceSecondPartyPlaceholders === 'function') {
            result = replaceSecondPartyPlaceholders(result, contractData);
          }
          if (typeof replaceFirstPartyText === 'function') {
            result = replaceFirstPartyText(result);
          }

          return result;
        }



        // ============ AUTO-GENERATE FIRST PARTY TEXT ============
        // Automatically generates "ุงูุทุฑู ุงูุฃูู" text using contract data and today's dates
        // No need for a separate database term!

        function generateFirstPartyText(firstPartyName = 'ุดุฑูุฉ ุจูุช ููููุงููุงุช') {
          const today = new Date();
          const hijri = gregorianToHijri(today);
          const dayName = getArabicDayName(today);
          const gregorianDate = formatGregorianDate(today);
          const hijriDate = formatHijriDate(hijri);

          // Company details
          const companyDetails = {
            name: firstPartyName || 'ุดุฑูุฉ ุจูุช ููููุงููุงุช',
            commercialRegistry: '5850026989',
            registryIssuePlace: 'ุฃุจูุง',
            registryIssueDate: '1427/05/16ูู',
            taxNumber: '300637265300003',
            city: 'ุฎููุณ ูุดูุท',
            district: 'ุญุฌูุฉ',
            address: 'ุฅุดุงุฑุฉ ุจุงุญุต ุฎูู ูุฌููุนุฉ ุงูุฌุฑุจูุน',
            poBox: '6454',
            postalCode: '62561',
            email: 'BAFT-EST@HOTMAIL.COM',
            phone: '2278666-017',
            extension: '105',
            mobile: '0552200931',
            representative: 'ุธุงูุฑ ุจู ุนุจุฏ ุงููู ูุญูุฏ ุงูุดูุฑู',
            representativeTitle: 'ุงููุฏูุฑ ุงูุนุงู'
          };

          // Generate the full text with today's dates
          const text = `ุงูู ูู ููู ${dayName} ุชุงุฑูุฎ ${hijriDate} ุงูููุงูู ${gregorianDate}ุ ุชู ุชููุน ูุฐุง ุงูุนูุฏ ูู ูุฏููุฉ ุฎููุณ ูุดูุท ุจูู ููุง ูู : -

ุงูุทุฑู ุงูุฃูู ูุคุณุณุฉ ${companyDetails.name} ูุฌูุณูุชูุง ุณุนูุฏูุฉุ ุจููุฌุจ ุงูุณุฌู ุงูุชุฌุงุฑู ุฑูู (${companyDetails.commercialRegistry}) ุตุงุฏุฑ ูู ${companyDetails.registryIssuePlace} ุจุชุงุฑูุฎ ${companyDetails.registryIssueDate}. ุงูุฑูู ุงูุถุฑูุจู (${companyDetails.taxNumber})ุ ูุนููุงููุง ูู ูุฏููุฉ ${companyDetails.city} (${companyDetails.district}) ${companyDetails.address}ุ ุต ุจ ${companyDetails.poBox} ุงูุฑูุฒ ุงูุจุฑูุฏู ${companyDetails.postalCode}ุ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (${companyDetails.email})ุ ูุงุชู ุฑูู ${companyDetails.phone} ุชุญูููุฉ (${companyDetails.extension})ุ ุฌูุงู ( ${companyDetails.mobile}) ูููุซูู ูู ุงูุชูููุน ุนูู ูุฐุง ุงูุนูุฏ ุงูุฃุณุชุงุฐ/ ${companyDetails.representative} ุจุตูุชู (${companyDetails.representativeTitle}) ููุดุงุฑ ุงููู ูู ูุฐุง ุงูุนูุฏ ุจู (ุงูุทุฑู ุงูุฃูู)`;

          return text;
        }

        // Make it globally available
        window.generateFirstPartyText = generateFirstPartyText;

        // ============ AUTO-GENERATE SECOND PARTY TEXT ============
        // Automatically generates "ุงูุทุฑู ุงูุซุงูู" text using contract form data
        // Pulls data from: client name, commercial registry, tax number, phone

        function generateSecondPartyText(data = null) {
          // Helper to get value from data object or DOM
          const val = (id, prop) => (data && data[prop]) || ($(id) ? $(id).value : '') || '';

          // Get data
          const clientName = (data && (data.client_name || data.second_party)) || $('clientName')?.value || '';
          const city = val('city', 'city');
          const district = val('district', 'district');
          const clientPhone = val('clientPhone', 'client_phone');
          const clientEmail = val('clientEmail', 'client_email');

          // Construct Location
          let location = city;
          if (district) location += (location ? ' - ' : '') + district;
          if (!location) location = '(................)'; // Placeholder

          // Representative logic
          const hasRep = (data && data.has_representative) || $('hasRepresentative')?.checked;
          const repName = (data && data.representative_name) || $('representativeName')?.value || '';
          const repTitle = (data && data.representative_title) || $('representativeTitle')?.value || '';

          // Build HTML text with BOLD tags, placeholders, and proper structure
          // Format based on user request:
          // ุงูุทุฑู ุงูุซุงูู / [Name] (Bold) ...

          // We use spans with dir="rtl" and \u200F markers to strictly enforce Arabic flow
          let text = `<span dir="rtl"><strong>ุงูุทุฑู ุงูุซุงูู /</strong> <strong>${clientName || '(................)'}</strong>`;

          text += `ุ ูุนููุงููุง ูู ${location}`;

          // Wrap English parts in spans with dir="ltr" but ensure the overall context remains RTL
          text += ` , ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (<span dir="ltr" style="display:inline-block; text-align:right;">${clientEmail || '................'}</span>)`;
          text += ` : ุฌูุงู ( <span dir="ltr" style="display:inline-block; text-align:right;">${clientPhone || '................'}</span> )`;

          // Append representative if selected
          if (hasRep && repName) {
            text += ` ูููุซูู ูู ุงูุชูุงููุน ุนูู ูุฐุง ุงูุนูุฏ ุงูุงุณุชุงุฐ / ${repName}`;
            if (repTitle) text += ` - ุจุตูุชู ${repTitle}`;
          }

          text += ` ููุดุงุฑ ุงููู ูู ูุฐุง ุงูุนูุฏ ุจ(ุงูุทุฑู ุงูุซุงูู)</span>`;

          return text;
        }
        // Make it globally available
        window.generateSecondPartyText = generateSecondPartyText;

        // ============ REPLACE SECOND PARTY PLACEHOLDERS ============
        // Automatically replaces placeholders in second party term with actual form data
        // Similar to date replacement, but for client fields

        function replaceSecondPartyPlaceholders(content, contractData = null) {
          if (!content) return content;

          // Get values from provided data OR form fields
          // Used for View Mode (where form is empty) or Edit Mode (from inputs)
          const clientName = (contractData?.client_name || contractData?.second_party) || ($('clientName')?.value || '');
          const clientPhone = (contractData?.client_phone) || ($('clientPhone')?.value || '');

          // Attachment fields: MUST prioritize contractData (attachments) if available
          const commercialRegistry = (contractData?.commercial_registry) || ($('commercialRegistry')?.value || '');
          const taxNumber = (contractData?.tax_number) || ($('taxNumber')?.value || '');

          let result = content;

          // Pattern 0: Full Preamble Replacement (CRITICAL for updating the Terms Text Box Live)
          // We must find the existing preamble block and replace it with the new generated one.
          const newPreamble = generateSecondPartyText(contractData);

          // Regex Match Stratgy:
          // 1. We search for "ุงูุทุฑู ุงูุซุงูู" literally.
          // 2. We accept that there might be some HTML tags *immediately* before it (like <strong> or <span dir="rtl">).
          // 3. BUT we do NOT capture the *outer* container tags (like formatting <span style="font-size:18px">).
          // 4. We replace the whole block.
          // The previous regex /(?:<[^>]+>)?/ was ambiguous and could eat the font-size span.

          // New Strategy: Match exactly the structure we generate or plain text.
          // We look for (optional tags) + "ุงูุทุฑู ุงูุซุงูู /" ... matches until ... "(ุงูุทุฑู ุงูุซุงูู)" + (optional closing span)

          // Match: [Any tags like <span dir="rtl"><strong>] + "ุงูุทุฑู ุงูุซุงูู" + [Everything] + "ุจ (ุงูุทุฑู ุงูุซุงูู)" + [Optional closing </span>]
          const preambleRegex = /(?:<[^>]+>)*\s*ุงูุทุฑู ุงูุซุงูู[\s\S]*?ููุดุงุฑ ุงููู ูู ูุฐุง ุงูุนูุฏ ุจ\s*\(ุงูุทุฑู ุงูุซุงูู\)(?:<\/[^>]+>)?/;

          if (preambleRegex.test(result)) {
            result = result.replace(preambleRegex, newPreamble);
          }

          // Pattern 1: Client name (for other references in the text)
          if (clientName) {
            // 1. Explicit placeholders
            result = result.replace(/\{SECOND_PARTY\}/g, clientName);
            result = result.replace(/\{CLIENT_NAME\}/g, clientName);

            // 2. "ุงูุทุฑู ุงูุซุงูู (NAME)" pattern - with parentheses
            result = result.replace(/(ุงูุทุฑู ุงูุซุงูู\s*)\([^)]+\)/g, `$1( ${clientName} )`);

            // 3. "ุงูุทุฑู ุงูุซุงูู NAME ูุฌูุณูุชูุง" pattern - direct name
            // Improved regex to avoid swallowing HTML tags if user styled the section (Fall back if Preamble replace didn't catch it)
            if (!preambleRegex.test(content)) {
              result = result.replace(/(ุงูุทุฑู ุงูุซุงูู\s+)(?:<[^>]+>)*[^\u0648<]+(?:<[^>]+>)*(\s*ูุฌูุณูุชูุง)/g, `$1${clientName}$2`);
            }

            // 4. "Second Party : ......." pattern (dotted lines)
            result = result.replace(/(ุงูุทุฑู ุงูุซุงูู\s*[:]\s*)[.\-_]{3,}/g, `$1${clientName}`);
          }

          // Pattern 1.6: Representative Clause
          const hasRep = contractData?.has_representative;
          const repName = contractData?.representative_name || '';
          const repTitle = contractData?.representative_title || '';

          let repText = '';
          if (hasRep && repName) {
            repText = ` ูููุซูู ูู ุงูุชูุงููุน ุนูู ูุฐุง ุงูุนูุฏ ุงูุงุณุชุงุฐ / ${repName}`;
            if (repTitle) repText += ` - ุจุตูุชู ${repTitle}`;
          }

          // Regex to identify existing clause (if any)
          // Matches " ูููุซูู ... " up to "ููุดุงุฑ" / "ููุดุงุฑ ุงููุฉ" or end of string
          const repRegex = /(\s*ูููุซูู ูู ุงูุชูุงููุน ุนูู ูุฐุง ุงูุนูุฏ ุงูุงุณุชุงุฐ \/[\s\S]*?)((?=\s*ููุดุงุฑ\s+ุงู[ู|ุฉ]ู)|$)/i;

          if (repRegex.test(result)) {
            result = result.replace(repRegex, repText);
          } else if (repText) {
            // If not found, insert before 'ููุดุงุฑ'
            if (/ููุดุงุฑ\s+ุงู[ู|ุฉ]ู/.test(result)) {
              result = result.replace(/(ููุดุงุฑ\s+ุงู[ู|ุฉ]ู)/, repText + ' $1');
            }
          }

          // Pattern 1.5: Client Email
          const clientEmail = (contractData?.client_email) || ($('clientEmail')?.value || '');
          if (clientEmail) {
            result = result.replace(/\{CLIENT_EMAIL\}/g, clientEmail);
            result = result.replace(/ุงูุจุฑูุฏ ุงูุงูู?ุชุฑููู\s*\((?:<[^>]+>)*[^)]+(?:<[^>]+>)*\)/gi, `ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (${clientEmail})`);
          }



          // Pattern 3: Tax Number


          // Pattern 4: Mobile phone
          if (clientPhone) {
            result = result.replace(/(ุฌูุงู\s*\()\s*(?:<[^>]+>)*[^)]+(?:<[^>]+>)*(\))/g, `$1 ${clientPhone} $2`);
          }

          return result;
        }

        // Make it globally available
        window.replaceSecondPartyPlaceholders = replaceSecondPartyPlaceholders;

        // ============ REPLACE FIRST PARTY TEXT (STATIC) ============
        function replaceFirstPartyText(content) {
          if (!content) return content;

          let result = content;

          // 1. Ensure First Party Mobile is static: 0552200931
          // We look for "ุฌูุงู" following "ุงูุทุฑู ุงูุฃูู" but before "ุงูุทุฑู ุงูุซุงูู"
          if (result.includes('ุงูุทุฑู ุงูุฃูู')) {
            const firstPartyMobileRegex = /(ุงูุทุฑู ุงูุฃูู(?:(?!ุงูุทุฑู ุงูุซุงูู).)*?ุฌูุงู\s*\(\s*)(?:<[^>]+>)*[0-9]{7,15}(?:<[^>]+>)*(\s*\))/i;
            if (firstPartyMobileRegex.test(result)) {
              result = result.replace(firstPartyMobileRegex, `$1 0552200931 $2`);
            } else {
              // Fallback: If no mobile found in specific block but "ุงูุทุฑู ุงูุฃูู" exists, try a broader search near "ุดุฑูุฉ ุจูุช"
              const broadMobileRegex = /(ุดุฑูุฉ ุจูุช ููููุงููุงุช[\s\S]*?ุฌูุงู\s*\(\s*)[^)]+(\s*\))/gi;
              result = result.replace(broadMobileRegex, `$1 0552200931 $2`);
            }
          }

          return result;
        }
        window.replaceFirstPartyText = replaceFirstPartyText;

        // ============ LIVE REPLACEMENT OF OLD DATE PATTERNS ============
        function replaceDatePatternsInTerms() {
          const termsField = $('terms');
          if (!termsField || !termsField.value) return;

          let content = termsField.value;

          // 1. First Party Replacement (Static)
          content = replaceFirstPartyText(content);

          // 2. Second Party Replacement (Dynamic from Form/Attachments)
          // Note: For input field edit, we use data currently in the DOM inputs.
          content = replaceSecondPartyPlaceholders(content);

          if (termsField.value !== content) {
            termsField.value = content;
          }
        }

        // Auto-replace dates/terms when field changes, focuses, or is loaded
        if ($('terms')) {
          const t = $('terms');
          t.addEventListener('blur', replaceDatePatternsInTerms);
          t.addEventListener('focus', replaceDatePatternsInTerms); // Trigger on focus/click
          t.addEventListener('click', replaceDatePatternsInTerms); // Double safety

          // Also check when form becomes visible
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.target.id === 'formWrap' && mutation.target.style.display !== 'none') {
                setTimeout(replaceDatePatternsInTerms, 100);
              }
            });
          });

          if ($('formWrap')) {
            observer.observe($('formWrap'), { attributes: true, attributeFilter: ['style'] });
          }
        }

        // updateTermsFromUI - FIXED VERSION with custom order support
        // updateTermsFromUI - FIXED VERSION with custom order support + Sub-Items
        async function updateTermsFromUI() {
          try {
            // Order checked boxes according to DOM order (which reflects saved order)
            const orderedCheckboxes = [];
            document.querySelectorAll('#termsList .term-item').forEach(termItem => {
              const checkbox = termItem.querySelector('.termCheckbox');
              if (checkbox && checkbox.checked) {
                orderedCheckboxes.push(checkbox);
              }
            });

            if (orderedCheckboxes.length === 0) {
              $('terms').value = '';
              $('termsSummary').value = '';
              return;
            }

            const all = await getTerms();
            const uiState = loadTermsUIState();
            const mergedParts = [];

            for (const cb of orderedCheckboxes) {
              const id = cb.dataset.id;
              const term = all.find(t => String(t.id) === id || String(t._id) === id) || {
                name: cb.nextSibling?.textContent || '',
                content: cb.dataset.content || '',
                type: 'text'
              };

              // Add two line breaks before the term name for better spacing
              // Clean up name from any HTML tags if desired in text output, but usually valid HTML is ok if using Rich Text
              // We'll strip tags for the text-only output if usage is text-only, but 'terms' might be used in text editor
              // Let's assume using innerText of the title span is safer for the name:
              // const nameText = cb.nextSibling ? cb.nextSibling.innerText : term.name.replace(/<[^>]*>/g, '');
              // mergedParts.push('\n' + nameText); // REMOVED: User requested to hide Term Name in final contract

              if (term.type === 'selection') {
                // Logic:
                // 1. If Rich Text (HTML) exists, use it.
                // 2. Check for active sub-items (checkboxes).
                // 3. If a sub-item is checked BUT its text is NOT in the Rich Text, append it.
                //    (This assumes the user wants the auto-list unless they manually typed it).

                let addedContent = '';
                let isRich = false;

                if (term.content && term.content.trim().startsWith('<')) {
                  isRich = true;
                  const contentWithDates = replaceDatePlaceholders(term.content);
                  addedContent += contentWithDates;
                }

                // Look for sub-items
                const termItem = cb.closest('.term-item');
                const subContainer = termItem.querySelector('.sub-items-container');

                if (subContainer) {
                  const checkedSubs = Array.from(subContainer.querySelectorAll('.sub-term-checkbox:checked'));
                  if (checkedSubs.length > 0) {
                    // If we didn't use rich text, or if we need to append missing items
                    checkedSubs.forEach((sub, subIndex) => {
                      const val = sub.dataset.val.trim();

                      // If Rich Text was used, check if this value is already inside it (to avoid duplication)
                      // We strip HTML tags from content to check text presence accurately
                      if (isRich) {
                        const rawContent = term.content.replace(/<[^>]*>/g, '');
                        if (rawContent.includes(val)) {
                          return; // Already manually added by user
                        }
                      }

                      // Append the item
                      // Auto-numbering: 1. Option...
                      addedContent += '<br>' + (subIndex + 1) + '. ' + val;
                    });
                  }
                } else if (!isRich) {
                  // Fallback if no sub-container but legacy state exists (and not rich)
                  if (uiState[id] && uiState[id].selected) {
                    addedContent += '<br>' + uiState[id].selected;
                  }
                }

                mergedParts.push(addedContent);

              } else {
                // Replace date placeholders in content before adding
                const contentWithDates = replaceDatePlaceholders(term.content || cb.dataset.content || '');
                mergedParts.push(contentWithDates);
              }
            }

            // Join terms together preserving their formatting
            // HTML content already has proper spacing, so we join without adding breaks
            let merged = mergedParts.join('').trim();

            // Apply date replacement to the entire merged content as well
            merged = replaceDatePlaceholders(merged);

            // Apply second party field replacement (client name, registry, tax, phone)
            if (typeof replaceSecondPartyPlaceholders === 'function') {
              merged = replaceSecondPartyPlaceholders(merged);
            }

            $('terms').value = merged;

            // CRITICAL: Update Quill Editor instantly so user sees the change
            if (window.quill) {
              if (window.quill.root.innerHTML !== merged) {
                // Save selection range if focused to avoid cursor jumping (though difficult with full replacement)
                window.quill.root.innerHTML = merged;
              }
            }

            const summary = orderedCheckboxes.map(cb => cb.nextSibling?.innerText).filter(Boolean).slice(0, 5).join(' ยท ') + (orderedCheckboxes.length > 5 ? ' ยท ...' : '');
            $('termsSummary').value = summary;

            // persist last inserted selection for export when modal closed
            const st = loadTermsUIState();
            st._lastInserted = orderedCheckboxes.map(cb => cb.dataset.id);
            saveTermsUIState(st);
          } catch (e) {
            console.warn('updateTermsFromUI failed', e);
          }
        }

        // Terms "Insert" button: finalize current UI selection into the main form and close modal
        const termsInsertEl = $('termsInsertBtn');
        if (termsInsertEl) {
          termsInsertEl.addEventListener('click', async () => {
            try {
              // update hidden fields from current UI selections
              await updateTermsFromUI();
              const raw = $('terms').value || '';
              if (!raw.trim()) {
                alert('ูู ูุชู ุชุญุฏูุฏ ุฃู ุจูุฏ');
                return;
              }
              // persist last inserted IDs already handled by updateTermsFromUI()
              alert('ุชู ุฅุฏุฑุงุฌ ุงูุจููุฏ ุงููุญุฏุฏุฉ ูู ูููุฐุฌ ุงูุนูุฏ. ูุง ุชูุณ ุญูุธ ุงูุนูุฏ.');
              closeTermsModal();
            } catch (err) {
              alert('ุฎุทุฃ ุฃุซูุงุก ุงูุฅุฏุฑุงุฌ: ' + (err && err.message ? err.message : err));
            }
          });
        }

        // ---------------- Terms Management Logic (Consolidated) ----------------

        // Helper to persist selection state
        async function markTermSelectedById(id, selectedValue) {
          try {
            if (!id) return;
            const st = loadTermsUIState();
            st[String(id)] = st[String(id)] || {};
            st[String(id)].checked = true;
            if (selectedValue !== undefined && selectedValue !== null) st[String(id)].selected = selectedValue;
            saveTermsUIState(st);
          } catch (e) { console.warn('markTermSelectedById failed', e); }
        }

        // Save Term Button
        const saveTermBtn = $('saveTermBtn');
        if (saveTermBtn) {
          saveTermBtn.addEventListener('click', async () => {
            console.log('Save Term Button Clicked'); // DEBUG
            const id = $('termId').value.trim();
            const name = $('termName').value.trim();
            const type = $('termType').value;
            // Get content from Quill editor
            const content = quill.root.innerHTML;

            console.log('Term Data:', { id, name, type, content }); // DEBUG

            if (!name || !content) {
              alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุจูุฏ ููุญุชูุงู');
              return;
            }

            const term = { name, type, content };

            try {
              let saved = null;
              if (id) {
                console.log('Updating term...');
                saved = await updateTerm(id, term);
                alert('ุชู ุชุญุฏูุซ ุงูุจูุฏ ุจูุฌุงุญ');
              } else {
                console.log('Creating term...');
                saved = await createTerm(term);
                alert('ุชู ุฅุถุงูุฉ ุงูุจูุฏ ุจูุฌุงุญ');
              }
              console.log('Save result:', saved);

              // Persistence logic
              const savedId = String((saved && (saved.id || saved._id)) || id || (saved && saved.id) || '');
              let selectedVal = null;
              if (term.type === 'selection') {
                const opts = (term.content || '').split(/\r?\n/).map(s => s.trim()).filter(Boolean);
                if (opts.length) selectedVal = opts[0];
              }
              await markTermSelectedById(savedId, selectedVal);

              // Reload and refresh editor
              await loadTerms();

              // If it was an update, keep it in editor? Or clear? 
              // User might want to add another. Let's clear if new, keep if update? 
              // The previous robust logic kept it. Let's stick to clearing for "New" feel, or maybe just clear.
              // Actually, let's clear to avoid confusion, as the "New" button exists.
              // BUT the robust logic had: if (savedId) loadTermIntoEditor...
              // Let's keep the robust behavior: focus the item.
              if (savedId) {
                const all = await getTerms();
                const termObj = all.find(t => String(t.id || t._id) === savedId);
                if (termObj) loadTermIntoEditor(termObj);
              }

            } catch (err) {
              console.error('Save Term Error:', err);
              alert('ุฎุทุฃ ูู ุญูุธ ุงูุจูุฏ: ' + err.message);
            }
          });
        }

        // Delete Term Button
        const deleteTermBtn = $('deleteTermBtn');
        if (deleteTermBtn) {
          deleteTermBtn.addEventListener('click', async () => {
            const id = $('termId').value.trim();
            if (!id) {
              alert('ูุฑุฌู ุงุฎุชูุงุฑ ุจูุฏ ููุญุฐู');
              return;
            }

            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุจูุฏุ')) return;

            try {
              await deleteTermById(id);

              // Cleanup UI state
              try {
                const st = loadTermsUIState();
                delete st[String(id)];
                if (Array.isArray(st._lastInserted)) st._lastInserted = st._lastInserted.filter(x => String(x) !== String(id));
                saveTermsUIState(st);
              } catch (e) { console.warn('cleanup UI state failed', e); }

              alert('ุชู ุญุฐู ุงูุจูุฏ ุจูุฌุงุญ');

              // Clear form
              $('termId').value = '';
              $('termName').value = '';
              quill.setText(''); // Clear Quill editor
              $('termType').value = 'text';

              await loadTerms();
            } catch (err) {
              console.error(err);
              alert('ุฎุทุฃ ูู ุญุฐู ุงูุจูุฏ');
            }
          });
        }

        // New Term Button (Clear Form)
        const newTermBtn = $('newTermBtn');
        if (newTermBtn) {
          newTermBtn.addEventListener('click', () => {
            $('termId').value = '';
            $('termName').value = '';
            quill.setText(''); // Clear Quill editor
            $('termType').value = 'text';
            $('termContentLabel').textContent = 'ูุต ุงูุจูุฏ';
          });
        }

        // ---------------- Terms export: docx + HTML fallback ----------------

        async function loadDocx() {
          if (window.docx) return window.docx;
          return new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/docx@8.4.1/build/index.umd.js';
            s.async = true;
            let done = false;
            const onLoad = () => { if (done) return; done = true; window.docx = window.docx || window.docxModule || window.docx || {}; resolve(window.docx); };
            const onErr = () => { if (done) return; done = true; reject(new Error('ูุดู ุชุญููู ููุชุจุฉ docx ูู CDN')); };
            s.onload = onLoad;
            s.onerror = onErr;
            document.head.appendChild(s);
            setTimeout(() => { if (!done) onErr(); }, 10000);
          }).catch(() => ({}));
        }

        function downloadBlob(blob, filename) {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => URL.revokeObjectURL(url), 5000);
        }

        function buildWordHtml(title, paragraphs) {
          const style = `
        <meta charset="utf-8" />
        <style>
          body { direction: rtl; font-family: "Cairo","Arial",sans-serif; font-size:14pt; }
          h1 { font-size:18pt; }
          .term-title { font-weight:700; margin-top:12px; margin-bottom:6px; }
          .para { margin:6px 0; white-space:pre-wrap; }
        </style>
      `;
          const body = paragraphs.map(p => `<div class="para">${p}</div>`).join('\n');
          return `<!doctype html><html lang="ar" dir="rtl"><head>${style}<title>${title}</title>
</head><body><h1>${title}</h1>${body}</body></html>`;
        }

        function escapeHtml(str) {
          return String(str || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
        }

        // export selected terms (with UI state preference) -> docx or fallback .doc (HTML)
        async function exportTermsToWordWithUI(selectedTerms, uiState) {
          try {
            const Docx = await loadDocx();
            if (Docx && Docx.Document && Docx.Packer) {
              const { Document, Packer, Paragraph, TextRun } = Docx;
              const children = [];
              for (const t of selectedTerms) {
                const id = String(t.id || t._id || '');
                children.push(new Paragraph({ children: [new TextRun({ text: t.name || '', bold: true, size: 28 })] }));
                // determine chosen value
                let chosen = null;
                if (uiState && uiState[id] && uiState[id].selected) chosen = uiState[id].selected;
                else {
                  const cb = document.querySelector(`#termsList .termCheckbox[data-id="${id}"]`);
                  const row = cb ? cb.closest('div') : null;
                  const sel = row ? row.querySelector('select') : null;
                  if (sel) chosen = sel.value;
                }
                if (t.type === 'selection') {
                  if (chosen) {
                    children.push(new Paragraph({ children: [new TextRun({ text: chosen, size: 24 })] }));
                  } else {
                    ((t.content || '').split(/\r?\n/).filter(Boolean)).forEach(line => {
                      children.push(new Paragraph({ children: [new TextRun({ text: line, size: 24 })] }));
                    });
                  }
                } else {
                  ((t.content || '').split(/\r?\n/).filter(Boolean)).forEach(line => {
                    children.push(new Paragraph({ children: [new TextRun({ text: line, size: 24 })] }));
                  });
                }
                children.push(new Paragraph({ children: [new TextRun({ text: ' ' })] }));
              }
              const doc = new Document({ sections: [{ properties: {}, children }] });
              const blob = await Packer.toBlob(doc);
              downloadBlob(blob, `terms_${Date.now()}.docx`);
              return;
            }
            throw new Error('docx library ุบูุฑ ูุชุงุญุฉ');
          } catch (err) {
            // fallback to HTML .doc
            const paragraphs = [];
            for (const t of selectedTerms) {
              const id = String(t.id || t._id || '');
              paragraphs.push(`<div class="term-title">${escapeHtml(t.name || '')}</div>`);
              let chosen = null;
              if (uiState && uiState[id] && uiState[id].selected) chosen = uiState[id].selected;
              else {
                const cb = document.querySelector(`#termsList .termCheckbox[data-id="${id}"]`);
                const row = cb ? cb.closest('div') : null;
                const sel = row ? row.querySelector('select') : null;
                if (sel) chosen = sel.value;
              }
              if (t.type === 'selection') {
                if (chosen) paragraphs.push(escapeHtml(chosen));
                else {
                  const opts = (t.content || '').split(/\r?\n/).filter(Boolean);
                  if (opts.length) paragraphs.push('<ul style="direction:rtl;text-align:right;">' + opts.map(o => `<li>${escapeHtml(o)}</li>`).join('') + '</ul>');
                  else paragraphs.push('&nbsp;');
                }
              } else {
                paragraphs.push((t.content || '').replace(/\n/g, '<br/>') || '&nbsp;');
              }
            }
            const html = buildWordHtml('ุจููุฏ ุงูุนูุฏ', paragraphs);
            const blob = new Blob([html], { type: 'application/msword;charset=utf-8' });
            downloadBlob(blob, `terms_${Date.now()}.doc`);
          }
        }

        // export plain text (hidden #terms) -> docx or fallback .doc
        async function exportTextToWord(filename, text) {
          try {
            const Docx = await loadDocx();
            if (Docx && Docx.Document && Docx.Packer) {
              const { Document, Packer, Paragraph, TextRun } = Docx;
              const children = text.split(/\r?\n/).map(line => new Paragraph({ children: [new TextRun({ text: line || '', size: 24 })] }));
              const doc = new Document({ sections: [{ children: children.length ? children : [new Paragraph({ children: [new TextRun({ text: text || '', size: 24 })] })] }] });
              const blob = await Packer.toBlob(doc);
              downloadBlob(blob, `${filename}_${Date.now()}.docx`);
              return;
            }
            throw new Error('docx library ุบูุฑ ูุชุงุญุฉ');
          } catch (err) {
            const html = buildWordHtml('ุดุฑูุท ุงูุนูุฏ', text.split(/\r?\n/).map(l => escapeHtml(l) || '&nbsp;'));
            const blob = new Blob([html], { type: 'application/msword;charset=utf-8' });
            downloadBlob(blob, `${filename}_${Date.now()}.doc`);
          }
        }

        // bindings for the two export buttons
        const termsExportBtnEl = $('termsExportBtn');
        if (termsExportBtnEl) {
          termsExportBtnEl.addEventListener('click', async () => {
            try {
              // determine selected ids (use UI state or last inserted)
              const uiState = loadTermsUIState();
              let selectedIds = Array.from(document.querySelectorAll('#termsList .termCheckbox')).filter(cb => cb.checked).map(cb => cb.dataset.id);
              if (selectedIds.length === 0 && uiState._lastInserted) selectedIds = uiState._lastInserted.slice();
              if (selectedIds.length === 0) return alert('ุงุฎุชุฑ ุจููุฏุงู ูุชุตุฏูุฑูุง');
              const all = await getTerms();
              const selected = [];
              selectedIds.forEach(id => {
                const t = all.find(x => String(x.id || x._id) === String(id));
                if (t) selected.push(t);
                else {
                  const cb = document.querySelector(`#termsList .termCheckbox[data-id="${id}"]`);
                  if (cb) selected.push({ id, name: cb.nextSibling?.textContent || 'ุจูุฏ', type: 'text', content: cb.dataset.content || '' });
                }
              });
              await exportTermsToWordWithUI(selected, uiState);
            } catch (err) {
              alert('ุฎุทุฃ ูู ุงูุชุตุฏูุฑ: ' + (err && err.message ? err.message : err));
            }
          });
        }

        const smallExportBtn = $('exportTermsBtn');
        if (smallExportBtn) {
          smallExportBtn.addEventListener('click', async () => {
            try {
              const raw = $('terms').value || '';
              if (!raw.trim()) return alert('ูุง ุชูุฌุฏ ุจููุฏ ููุฏุฑุฌุฉ ููุชุตุฏูุฑ');
              await exportTextToWord('contract_terms', raw);
            } catch (err) {
              alert('ุฎุทุฃ ูู ุงูุชุตุฏูุฑ: ' + (err && err.message ? err.message : err));
            }
          });
        }

        // ---------------- end Terms export ----------------

        // Persist UI state when user saves/creates/deletes a term so selections persist across modal open/close

        // (Redundant IIFE removed - logic consolidated above)

        // ============ Sortable Table Headers ============

        // Sorting functionality
        window.sortTable = function (column) {
          // Toggle direction if clicking same column
          if (currentSortColumn === column) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            currentSortColumn = column;
            currentSortDirection = 'asc';
          }

          // Update header arrows
          document.querySelectorAll('th.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
          });
          const activeHeader = document.querySelector(`th[data-sort="${column}"]`);
          if (activeHeader) {
            activeHeader.classList.add(currentSortDirection);
          }

          // Sort the data with Smart Arabic Sorting (Ignores 'Al-' prefix)
          contractsData.sort((a, b) => {
            let aVal = a[column];
            let bVal = b[column];

            // Handle nulls
            if (!aVal && !bVal) return 0;
            if (!aVal) return 1;
            if (!bVal) return -1;

            // Numeric comparison
            if (column === 'total_price' || (column === 'id' && !isNaN(parseFloat(aVal)))) {
              const numA = parseFloat(aVal) || 0;
              const numB = parseFloat(bVal) || 0;
              return currentSortDirection === 'asc' ? numA - numB : numB - numA;
            }

            // Smart String Sorting with Language Priority (Arabic First, English Last)
            const getSortKey = (str) => {
              if (!str) return '';

              return String(str)
                .trim()
                // Normalize Unicode
                .normalize('NFKD')
                // Remove all diacritics (tashkeel, harakat, tanween, sukun, shadda, etc.)
                .replace(/[\u064B-\u065F\u0670\u06D6-\u06ED]/g, '')
                // Remove Arabic tatweel (elongation character)
                .replace(/\u0640/g, '')
                // Remove zero-width characters and other invisible chars
                .replace(/[\u200B-\u200F\u202A-\u202E\u2060-\u2069]/g, '')
                // Collapse multiple spaces to single space
                .replace(/\s+/g, ' ')
                // Remove definition articles (ุงู, ุขู) from start
                .replace(/^(ุงู|ุขู)\s*/g, '')
                // Unify all alef variants
                .replace(/[ุฃุฅุขูฑ]/g, 'ุง')
                // Unify yaa variants
                .replace(/[ูุฆ]/g, 'ู')
                // Unify ta marbuta and haa
                .replace(/ุฉ/g, 'ู')
                // Unify hamza variants
                .replace(/[ุคุก]/g, 'ู')
                // Remove non-alphanumeric (keep Arabic, English, numbers, spaces)
                .replace(/[^\u0600-\u06FFa-zA-Z0-9\s]/g, '')
                .trim()
                .toLowerCase();
            };

            // Detect language of the name
            const isArabic = (text) => /[\u0600-\u06FF]/.test(text);
            const isEnglish = (text) => /[a-zA-Z]/.test(text);

            // Categorize names: 0=Arabic, 1=Mixed, 2=English/Other
            const aValLang = isArabic(aVal) ? 0 : (isEnglish(aVal) ? 2 : 1);
            const bValLang = isArabic(bVal) ? 0 : (isEnglish(bVal) ? 2 : 1);

            // First, sort by language category (Arabic=0, Mixed=1, English/Other=2)
            if (aValLang !== bValLang) {
              return currentSortDirection === 'asc'
                ? aValLang - bValLang
                : bValLang - aValLang;
            }

            // Within same language category, sort alphabetically
            const keyA = getSortKey(aVal);
            const keyB = getSortKey(bVal);

            // Use appropriate locale for comparison
            const locale = aValLang === 0 ? 'ar' : 'en';
            const cmp = keyA.localeCompare(keyB, locale, {
              sensitivity: 'base',
              numeric: true,
              ignorePunctuation: true
            });

            return currentSortDirection === 'asc' ? cmp : -cmp;
          });

          // Re-render the table using the same logic as loadContracts
          const tbody = document.querySelector('#contractsTbody');
          if (!tbody) return;

          tbody.innerHTML = '';
          let active = 0, pending = 0;

          contractsData.forEach(c => {
            if (c.status === 'active') active++;
            if (c.status === 'pending') pending++;

            const tr = document.createElement('tr');
            const containerMapLink = c.container_location ? `<a href="https://www.google.com/maps?q=${c.container_location}" target="_blank">ูููุน ุงูุญุงููุฉ</a>` : '';
            // const pickupMapLink = c.pickup_location ? `<a href="https://www.google.com/maps?q=${c.pickup_location}" target="_blank">ูููุน ุงูุชุญุตูู</a>` : '';

            // Format dates to show only YYYY-MM-DD
            const fromDate = formatDate(c.from_date);
            const toDate = formatDate(c.to_date);

            tr.innerHTML = `
        <td style="white-space: nowrap;">${c.id || '-'}</td>
        <td style="white-space: nowrap;">${c.second_party || ''}</td>
        <td style="white-space: nowrap;">${c.service_name || ''}</td>
        <td style="white-space: nowrap;">${fromDate} โ ${toDate}</td>
        <td style="white-space: nowrap;">${c.total_price || 0}</td>
        <td style="white-space: nowrap;">${c.manager || ''}</td>
        <td style="white-space: nowrap;">${c.collector || ''}</td>
        <td style="white-space: nowrap;">
            <span class="chip ${c.status === 'active' ? 'active' : (c.status === 'pending' ? 'pending' : 'expired')}">
            ${c.status === 'active' ? 'ูุดุท' : (c.status === 'pending' ? 'ููุฏ ุงูุชูููุน' : 'ููุชูู')}
            </span>
        </td>
        <td style="white-space: nowrap;">
      <div class="actions-set">
          <button class="btn" onclick="openView('${c.id}')" title="ุนุฑุถ ุงูุนูุฏ ุงูููุงุฆู" style="padding:4px 8px; font-size:0.85em;">ุนุฑุถ</button>
              <button class="btn" onclick="openEdit('${c.id}')" title="ุชุนุฏูู ุงูุนูุฏ" style="padding:4px 8px; font-size:0.85em;">ุชุนุฏูู</button>
              <button class="btn" onclick="openRenew('${c.id}')" title="ุชุฌุฏูุฏ ุงูุนูุฏ" style="padding:4px 8px; font-size:0.85em; background:#10b981; color:white; border:none;">ุชุฌุฏูุฏ</button>
              <button class="btn small" onclick="updateStatus('${c.id}','active')" title="ุชูุนูู">โ</button>
              <button class="btn small" onclick="updateStatus('${c.id}','pending')" title="ููุฏ ุงูุชูููุน">โณ</button>
              <button class="btn small" onclick="updateStatus('${c.id}','expired')" title="ุฅููุงุก">๐</button>
              ${containerMapLink ? `<a href="https://www.google.com/maps?q=${c.container_location}" target="_blank" style="font-size:0.75em; margin-right:4px; white-space:nowrap;">๐</a>` : ''}
              <button class="btn small" onclick="deleteContract('${c.id}')" title="ุญุฐู ุงูุนูุฏ" style="background:#ef4444; color:white; border:none;">๐๏ธ</button>
          </div>
        </td>
      `;
            tbody.appendChild(tr);
          });

          if ($('countActive')) $('countActive').textContent = active;
          if ($('countPending')) $('countPending').textContent = pending;
        };

        // Page Sizing Logic
        window.setPageSize = function (size) {
          document.body.classList.remove('size-small', 'size-large');
          if (size === 'small') document.body.classList.add('size-small');
          if (size === 'large') document.body.classList.add('size-large');
          localStorage.setItem('pageSize', size);
        };

        // Initialize size from localStorage
        const savedSize = localStorage.getItem('pageSize');
        if (savedSize) window.setPageSize(savedSize);

        // ===== ENHANCED REPORTS FUNCTIONALITY =====

        let currentEntityType = null; // 'collectors', 'marketers', 'clients'
        let currentEntities = []; // Current list of entities
        let currentEntityDetail = null; // Current entity detail data

        // ===== REAL-TIME NOTIFICATIONS LOGIC =====
        let selectedNotifUser = null;
        let currentNotifAudio = null;

        // Base64 Sounds (Short, clean alerts)
        const sounds = {
          normal: 'data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YV9vT18A...', // Placeholder - will use a real short beep
          important: 'data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YV9vT18A...',
          critical: 'data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YV9vT18A...'
        };

        // Real Base64 sounds for better experience
        const soundFiles = {
          low: new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'), // Soft Ding
          normal: new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3'), // Standard Alert
          important: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'), // Insistent Bell
          critical: new Audio('https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3') // High-stress Siren
        };

        // Preload
        Object.values(soundFiles).forEach(a => { a.load(); a.volume = 0.8; });

        if (window.socket) {
          // Handle connection and auto-registration
          window.socket.on('connect', () => {
            console.log('Connected to socket server');
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
              const user = JSON.parse(savedUser);
              window.currentUser = user;
              window.socket.emit('register', user.username);
            }
          });

          // Handle online users list updates
          window.socket.on('update-users', (users) => {
            console.log('Online users updated:', users);
            const list = $('onlineUsersList');
            if (!list) return;

            list.innerHTML = '';
            const currentUsername = window.currentUser ? window.currentUser.username : null;

            if (users.length <= 1) {
              list.innerHTML = '<div class="muted" style="text-align: center; padding: 20px;">ูุง ููุฌุฏ ููุธููู ุขุฎุฑูู ูุชุตููู ุญุงููุงู</div>';
            }

            users.forEach(username => {
              if (username === currentUsername) return; // Don't show self in list

              const div = document.createElement('div');
              div.className = 'online-user-item';
              div.style = 'padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; background: white;';
              div.innerHTML = `
              <div style="width: 10px; height: 10px; background: #10b981; border-radius: 50%;"></div>
              <span style="font-weight: 600;">${username}</span>
            `;

              div.onclick = () => {
                selectedNotifUser = username;
                document.querySelectorAll('.online-user-item').forEach(el => {
                  el.style.borderColor = '#e2e8f0';
                  el.style.background = 'white';
                });
                div.style.borderColor = '#3b82f6';
                div.style.background = '#eff6ff';
              };

              list.appendChild(div);
            });
          });

          // Handle incoming notifications
          window.socket.on('receive-notification', (data) => {
            console.log('Received notification:', data);
            showNotifOverlay(data);
          });

          // Request users list when notifications area is opened
          window.socket.on('request-users', () => {
            // This handler is intentionally left empty as the 'update-users' event
            // already handles rendering the list based on server-sent data.
            // The client just needs to emit 'request-users' to trigger the server to send 'update-users'.
          });
        }

        // Priority buttons
        document.querySelectorAll('.notif-priority-btn').forEach(btn => {
          btn.onclick = () => {
            document.querySelectorAll('.notif-priority-btn').forEach(b => {
              b.classList.remove('active');
              b.style.borderColor = '#e2e8f0';
              b.style.background = 'white';
            });
            btn.classList.add('active');
            btn.style.borderColor = '#3b82f6';
            btn.style.background = '#eff6ff';
          };
        });

        // Duration slider
        if ($('notifDuration')) {
          $('notifDuration').oninput = function () {
            $('notifDurationVal').textContent = this.value;
          };
        }

        // Send button
        if ($('sendNotifBtn')) {
          $('sendNotifBtn').onclick = () => {
            if (!selectedNotifUser) {
              alert('ูุฑุฌู ุงุฎุชูุงุฑ ููุธู ุฃููุงู ูู ูุงุฆูุฉ ุงููุชุตููู');
              return;
            }

            const priority = document.querySelector('.notif-priority-btn.active').getAttribute('data-priority');
            const duration = parseInt($('notifDuration').value);
            const message = $('notifMessage').value || 'ุงูุชุจุงู!';
            const senderName = window.currentUser ? (window.currentUser.display_name || window.currentUser.username) : 'ููุธู';

            window.socket.emit('send-notification', {
              targetUser: selectedNotifUser,
              priority,
              duration,
              message,
              senderName
            });

            alert(`ุชู ุฅุฑุณุงู ุงูุชูุจูู ุฅูู ${selectedNotifUser}`);
          };
        }

        function showNotifOverlay(data) {
          const overlay = $('notifOverlay');
          const visual = $('notifVisual');
          const title = $('notifTitle');
          const sender = $('notifSender');
          const content = $('notifContent');

          // Set visual and colors based on priority
          let icon = '๐';
          let color = '#3b82f6'; // Blue
          let bgColor = 'rgba(0, 0, 0, 0.9)';

          if (data.priority === 'low') {
            icon = '๐';
            color = '#94a3b8';
          } else if (data.priority === 'important') {
            icon = '๐';
            color = '#f59e0b'; // Gold
            bgColor = 'rgba(120, 53, 15, 0.9)'; // Dark orange
          } else if (data.priority === 'critical') {
            icon = '๐จ';
            color = '#ef4444'; // Red
            bgColor = 'rgba(153, 27, 27, 0.9)'; // Dark red
          }

          visual.textContent = icon;
          overlay.style.background = bgColor;
          content.style.borderColor = color;
          content.style.color = 'white';

          sender.textContent = `ูู: ${data.senderName}`;
          content.textContent = data.message;
          title.textContent = (data.priority === 'critical' ? 'โ๏ธ ุชูุจูู ุนุงุฌู ุฌุฏุงู' : (data.priority === 'important' ? '๐ ุชูุจูู ูุงู' : '๐ ุชูุจูู ุฌุฏูุฏ'));

          overlay.style.display = 'flex';

          // Play sound
          if (currentNotifAudio) currentNotifAudio.pause();
          currentNotifAudio = soundFiles[data.priority] || soundFiles.normal;
          currentNotifAudio.loop = true;

          // Adjust volume based on priority
          if (data.priority === 'low') currentNotifAudio.volume = 0.5;
          else if (data.priority === 'normal') currentNotifAudio.volume = 0.7;
          else currentNotifAudio.volume = 0.9;

          currentNotifAudio.play().catch(e => console.error('Audio play failed:', e));

          // Auto stop after duration
          setTimeout(() => {
            stopCurrentNotif();
          }, data.duration * 1000);
        }

        window.stopCurrentNotif = function () {
          const overlay = $('notifOverlay');
          overlay.style.display = 'none';
          if (currentNotifAudio) {
            currentNotifAudio.pause();
            currentNotifAudio.currentTime = 0;
          }
        };

        // View Switcher - Handle nav buttons
        document.querySelectorAll('.nav button').forEach(btn => {
          btn.addEventListener('click', () => {
            const view = btn.getAttribute('data-view');

            // Update active state
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Show/hide sections
            if (view === 'contracts') {
              $('contractsArea').style.display = 'block';
              $('reportsArea').style.display = 'none';
              $('notificationsArea').style.display = 'none';
            } else if (view === 'reports') {
              $('contractsArea').style.display = 'none';
              $('reportsArea').style.display = 'block';
              $('notificationsArea').style.display = 'none';
              showOverview(); // Show overview by default
            } else if (view === 'notifications') {
              $('contractsArea').style.display = 'none';
              $('reportsArea').style.display = 'none';
              $('notificationsArea').style.display = 'block';
              if (window.socket) window.socket.emit('request-users');
            }
          });
        });

        // Report Section Buttons
        if ($('showCollectorsBtn')) {
          $('showCollectorsBtn').addEventListener('click', () => {
            setActiveReportBtn('showCollectorsBtn');
            showEntitySelection('collectors');
          });
        }

        if ($('showMarketersBtn')) {
          $('showMarketersBtn').addEventListener('click', () => {
            setActiveReportBtn('showMarketersBtn');
            showEntitySelection('marketers');
          });
        }

        if ($('showClientsBtn')) {
          $('showClientsBtn').addEventListener('click', () => {
            setActiveReportBtn('showClientsBtn');
            showEntitySelection('clients');
          });
        }

        if ($('showOverviewBtn')) {
          $('showOverviewBtn').addEventListener('click', () => {
            setActiveReportBtn('showOverviewBtn');
            showOverview();
          });
        }

        if ($('backToEntitiesBtn')) {
          $('backToEntitiesBtn').addEventListener('click', () => {
            if (currentEntityType) {
              showEntitySelection(currentEntityType);
            }
          });
        }

        // Set active button in reports section
        function setActiveReportBtn(btnId) {
          ['showCollectorsBtn', 'showMarketersBtn', 'showClientsBtn', 'showOverviewBtn'].forEach(id => {
            const btn = $(id);
            if (btn) {
              btn.classList.remove('primary');
              btn.classList.add('btn');
            }
          });
          const activeBtn = $(btnId);
          if (activeBtn) {
            activeBtn.classList.add('primary');
          }
        }

        // Show Overview Section
        function showOverview() {
          if ($('overviewSection')) $('overviewSection').style.display = 'block';
          if ($('entitySelectionSection')) $('entitySelectionSection').style.display = 'none';
          if ($('entityDetailSection')) $('entityDetailSection').style.display = 'none';

          // Load overview data - this will be handled by existing logic
          // The existing code should populate the overview stats
        }

        // Show Entity Selection
        async function showEntitySelection(type) {
          currentEntityType = type;

          if ($('overviewSection')) $('overviewSection').style.display = 'none';
          if ($('entitySelectionSection')) $('entitySelectionSection').style.display = 'block';
          if ($('entityDetailSection')) $('entityDetailSection').style.display = 'none';

          // Update title
          const titles = {
            'collectors': 'ุงุฎุชุฑ ุงููุญุตู',
            'marketers': 'ุงุฎุชุฑ ุงููุณูู',
            'clients': 'ุงุฎุชุฑ ุงูุนููู / ุงูุทุฑู ุงูุซุงูู'
          };
          if ($('entitySectionTitle')) {
            $('entitySectionTitle').textContent = titles[type] || 'ุงุฎุชุฑ';
          }

          // Load entities
          await loadEntities(type);
        }

        // Load Entities List
        async function loadEntities(type) {
          try {
            const endpoints = {
              'collectors': '/reports/collectors',
              'marketers': '/reports/marketers',
              'clients': '/reports/clients'
            };

            const data = await apiFetch(endpoints[type]);
            currentEntities = data;

            renderEntityCards(data, type);
          } catch (err) {
            console.error('Error loading entities:', err);
            alert('ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช');
          }
        }

        // Render Entity Cards
        function renderEntityCards(entities, type) {
          const grid = $('entityCardsGrid');
          if (!grid) return;

          grid.innerHTML = '';

          if (!entities || entities.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #9ca3af;">ูุง ุชูุฌุฏ ุจูุงูุงุช</div>';
            return;
          }

          entities.forEach(entity => {
            const card = document.createElement('div');
            const entityName = entity.collector || entity.manager || entity.second_party || 'ุบูุฑ ูุญุฏุฏ';
            const contractCount = entity.contract_count || 0;
            const totalValue = parseFloat(entity.total_value || 0).toLocaleString('ar-SA');
            const activeCount = entity.active_count || 0;

            card.style.cssText = `
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
          `;

            card.innerHTML = `
            <div style="display: flex; align-items: start; justify-content: space-between; margin-bottom: 1rem;">
              <div style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                ${type === 'collectors' ? '๐ฐ' : (type === 'marketers' ? '๐' : '๐ข')}
              </div>
              <div style="background: #f0fdf4; color: #059669; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.875rem; font-weight: 600;">
                ${activeCount} ูุดุท
              </div>
            </div>
            <h4 style="margin: 0 0 0.5rem 0; font-size: 1.125rem; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${entityName}</h4>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #64748b; font-size: 0.875rem;">ุนุฏุฏ ุงูุนููุฏ</span>
                <span style="color: #0f172a; font-weight: 600; font-size: 1.125rem;">${contractCount}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #64748b; font-size: 0.875rem;">ุฅุฌูุงูู ุงููููุฉ</span>
                <span style="color: #6366f1; font-weight: 700; font-size: 1rem;">${totalValue} ุฑ.ุณ</span>
              </div>
            </div>
          `;

            card.addEventListener('mouseenter', () => {
              card.style.transform = 'translateY(-4px)';
              card.style.boxShadow = '0 10px 25px rgba(99, 102, 241, 0.2)';
              card.style.borderColor = '#6366f1';
            });

            card.addEventListener('mouseleave', () => {
              card.style.transform = 'translateY(0)';
              card.style.boxShadow = 'none';
              card.style.borderColor = '#e5e7eb';
            });

            card.addEventListener('click', () => {
              loadEntityDetail(type, entityName);
            });

            grid.appendChild(card);
          });

          // Add search functionality
          const searchInput = $('entitySearchInput');
          if (searchInput) {
            searchInput.oninput = () => {
              const searchTerm = searchInput.value.toLowerCase();
              const cards = grid.querySelectorAll('div');
              cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
              });
            };
          }
        }

        // Load Entity Detail
        async function loadEntityDetail(type, name) {
          try {
            const endpoints = {
              'collectors': `/reports/collectors/${encodeURIComponent(name)}`,
              'marketers': `/reports/marketers/${encodeURIComponent(name)}`,
              'clients': `/reports/clients/${encodeURIComponent(name)}`
            };

            const data = await apiFetch(endpoints[type]);
            currentEntityDetail = data;

            showEntityDetail(data);
          } catch (err) {
            console.error('Error loading entity detail:', err);
            alert('ุฎุทุฃ ูู ุชุญููู ุชูุงุตูู ุงูุชูุฑูุฑ');
          }
        }

        // Show Entity Detail
        function showEntityDetail(data) {
          if ($('overviewSection')) $('overviewSection').style.display = 'none';
          if ($('entitySelectionSection')) $('entitySelectionSection').style.display = 'none';
          if ($('entityDetailSection')) $('entityDetailSection').style.display = 'block';

          // Update header
          const typeLabels = {
            'collector': 'ูุญุตู',
            'marketer': 'ูุณูู',
            'client': 'ุนููู / ุทุฑู ุซุงูู'
          };

          if ($('entityDetailName')) $('entityDetailName').textContent = data.entityName || '';
          if ($('entityDetailType')) $('entityDetailType').textContent = typeLabels[data.entityType] || '';

          // Update statistics
          const stats = data.statistics || {};
          if ($('entityStatTotalContracts')) $('entityStatTotalContracts').textContent = stats.total_contracts || 0;
          if ($('entityStatActiveContracts')) $('entityStatActiveContracts').textContent = stats.active_contracts || 0;
          if ($('entityStatTotalValue')) $('entityStatTotalValue').textContent = parseFloat(stats.total_value || 0).toLocaleString('ar-SA') + ' ุฑ.ุณ';
          if ($('entityStatMonthlyRevenue')) $('entityStatMonthlyRevenue').textContent = parseFloat(stats.monthly_revenue || 0).toLocaleString('ar-SA') + ' ุฑ.ุณ';

          // Render contracts table
          renderEntityContracts(data.contracts || []);
        }

        // Render Entity Contracts Table
        function renderEntityContracts(contracts) {
          const tbody = $('entityContractsTbody');
          if (!tbody) return;

          tbody.innerHTML = '';

          if (!contracts || contracts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #9ca3af;">ูุง ุชูุฌุฏ ุนููุฏ</td></tr>';
            return;
          }

          contracts.forEach(c => {
            const tr = document.createElement('tr');
            const fromDate = formatDate(c.from_date);
            const toDate = formatDate(c.to_date);
            const statusText = c.status === 'active' ? 'ูุดุท' : (c.status === 'pending' ? 'ููุฏ ุงูุชูููุน' : 'ููุชูู');
            const statusClass = c.status === 'active' ? 'active' : (c.status === 'pending' ? 'pending' : 'expired');

            tr.innerHTML = `
            <td style="white-space: nowrap;">${c.id || '-'}</td>
            <td style="white-space: nowrap;">${c.second_party || c.client_name || '-'}</td>
            <td style="white-space: nowrap;">${c.service_name || '-'}</td>
            <td style="white-space: nowrap;">${fromDate}</td>
            <td style="white-space: nowrap;">${toDate}</td>
            <td style="white-space: nowrap;">${parseFloat(c.monthly_fee || 0).toLocaleString('ar-SA')}</td>
            <td style="white-space: nowrap;">${parseFloat(c.total_price || 0).toLocaleString('ar-SA')}</td>
            <td style="white-space: nowrap;">
              <span class="chip ${statusClass}">${statusText}</span>
            </td>
            <td style="white-space: nowrap;">
              <div style="display: inline-flex; gap: 4px;">
                <button class="btn small" onclick="openView('${c.id}')" title="ุนุฑุถ" style="padding: 4px 8px; font-size: 0.85em;">ุนุฑุถ</button>
                <button class="btn small" onclick="openEdit('${c.id}')" title="ุชุนุฏูู" style="padding: 4px 8px; font-size: 0.85em;">ุชุนุฏูู</button>
              </div>
            </td>
          `;

            tbody.appendChild(tr);
          });
        }

        // Export Entity Report to Excel
        if ($('exportEntityReportBtn')) {
          $('exportEntityReportBtn').addEventListener('click', () => {
            if (!currentEntityDetail) {
              alert('ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุตุฏูุฑ');
              return;
            }

            exportEntityToExcel(currentEntityDetail);
          });
        }

        // Export function (using existing exportToExcel if available, or create simple version)
        function exportEntityToExcel(data) {
          const entityName = data.entityName || 'ุชูุฑูุฑ';
          const contracts = data.contracts || [];

          // Create CSV content
          const headers = ['ุฑูู ุงูุนูุฏ', 'ุงูุนููู', 'ุงูุฎุฏูุฉ', 'ูู ุชุงุฑูุฎ', 'ุฅูู ุชุงุฑูุฎ', 'ุงูุฏูุนุฉ ุงูุดูุฑูุฉ', 'ุงููููุฉ ุงูุฅุฌูุงููุฉ', 'ุงูุญุงูุฉ', 'ุงููุณูู', 'ุงููุญุตู'];
          let csv = headers.join(',') + '\n';

          contracts.forEach(c => {
            const row = [
              c.id || '',
              (c.second_party || c.client_name || '').replace(/,/g, ' '),
              (c.service_name || '').replace(/,/g, ' '),
              formatDate(c.from_date),
              formatDate(c.to_date),
              c.monthly_fee || 0,
              c.total_price || 0,
              c.status === 'active' ? 'ูุดุท' : (c.status === 'pending' ? 'ููุฏ ุงูุชูููุน' : 'ููุชูู'),
              (c.manager || '').replace(/,/g, ' '),
              (c.collector || '').replace(/,/g, ' ')
            ];
            csv += row.join(',') + '\n';
          });

          // Download
          const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `ุชูุฑูุฑ_${entityName}_${new Date().toISOString().split('T')[0]}.csv`;
          link.click();
        }

        // Helper function to format dates
        function formatDate(dateStr) {
          if (!dateStr) return '-';
          const d = new Date(dateStr);
          if (isNaN(d.getTime())) return dateStr;
          const year = d.getFullYear();
          const month = String(d.getMonth() + 1).padStart(2, '0');
          const day = String(d.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        }

        // Load Overview Data
        async function loadOverviewData() {
          try {
            // Load all contracts to calculate overview stats
            const contracts = await apiFetch('/contracts');

            // Calculate totals
            let totalContracts = contracts.length;
            let totalRevenue = 0;
            let activeCount = 0;
            let pendingCount = 0;
            let expiredCount = 0;
            let clientsSet = new Set();

            contracts.forEach(c => {
              totalRevenue += parseFloat(c.total_price || 0);
              if (c.status === 'active') activeCount++;
              if (c.status === 'pending') pendingCount++;
              if (c.status === 'expired') expiredCount++;
              if (c.second_party) clientsSet.add(c.second_party);
            });

            const avgContract = totalContracts > 0 ? totalRevenue / totalContracts : 0;

            // Update overview cards
            if ($('reportTotalContracts')) $('reportTotalContracts').textContent = totalContracts;
            if ($('reportTotalRevenue')) $('reportTotalRevenue').textContent = Math.round(totalRevenue).toLocaleString('ar-SA');
            if ($('reportTotalClients')) $('reportTotalClients').textContent = clientsSet.size;
            if ($('reportAvgContract')) $('reportAvgContract').textContent = Math.round(avgContract).toLocaleString('ar-SA');
            if ($('reportActiveCount')) $('reportActiveCount').textContent = activeCount;
            if ($('reportPendingCount')) $('reportPendingCount').textContent = pendingCount;
            if ($('reportExpiredCount')) $('reportExpiredCount').textContent = expiredCount;

            // Load aggregated data for tables
            await loadOverviewTables();
          } catch (err) {
            console.error('Error loading overview data:', err);
          }
        }

        // Load Overview Tables
        async function loadOverviewTables() {
          try {
            // Load marketers
            const marketers = await apiFetch('/reports/marketers');
            const managerTbody = $('managerStatsTbody');
            if (managerTbody) {
              managerTbody.innerHTML = '';
              marketers.forEach(m => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.innerHTML = `
                <td>${m.manager || '-'}</td>
                <td>${m.contract_count || 0}</td>
                <td>${Math.round(m.total_value || 0).toLocaleString('ar-SA')}</td>
                <td>${Math.round(m.monthly_revenue || 0).toLocaleString('ar-SA')}</td>
                <td><button class="btn small" onclick="viewMarketerReport('${m.manager}')" style="padding: 4px 8px; font-size: 0.85em;">ุนุฑุถ ุงูุชูุงุตูู</button></td>
              `;
                managerTbody.appendChild(tr);
              });
            }

            // Load collectors
            const collectors = await apiFetch('/reports/collectors');
            const collectorTbody = $('collectorStatsTbody');
            if (collectorTbody) {
              collectorTbody.innerHTML = '';
              collectors.forEach(c => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.innerHTML = `
                <td>${c.collector || '-'}</td>
                <td>${c.contract_count || 0}</td>
                <td>${Math.round(c.total_value || 0).toLocaleString('ar-SA')}</td>
                <td>${Math.round(c.monthly_revenue || 0).toLocaleString('ar-SA')}</td>
                <td><button class="btn small" onclick="viewCollectorReport('${c.collector}')" style="padding: 4px 8px; font-size: 0.85em;">ุนุฑุถ ุงูุชูุงุตูู</button></td>
              `;
                collectorTbody.appendChild(tr);
              });
            }

            // Load top clients
            const clients = await apiFetch('/reports/clients');
            const topClients = clients.sort((a, b) => (b.total_value || 0) - (a.total_value || 0)).slice(0, 5);
            const clientsTbody = $('topClientsTbody');
            if (clientsTbody) {
              clientsTbody.innerHTML = '';
              topClients.forEach(c => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.innerHTML = `
                <td>${c.second_party || '-'}</td>
                <td>${c.contract_count || 0}</td>
                <td>${Math.round(c.total_value || 0).toLocaleString('ar-SA')}</td>
                <td><button class="btn small" onclick="viewClientReport('${c.second_party}')" style="padding: 4px 8px; font-size: 0.85em;">ุนุฑุถ ุงูุชูุงุตูู</button></td>
              `;
                clientsTbody.appendChild(tr);
              });
            }
          } catch (err) {
            console.error('Error loading overview tables:', err);
          }
        }

        // Global functions to view reports from overview tables
        window.viewMarketerReport = function (name) {
          setActiveReportBtn('showMarketersBtn');
          loadEntityDetail('marketers', name);
        };

        window.viewCollectorReport = function (name) {
          setActiveReportBtn('showCollectorsBtn');
          loadEntityDetail('collectors', name);
        };

        window.viewClientReport = function (name) {
          setActiveReportBtn('showClientsBtn');
          loadEntityDetail('clients', name);
        };

        // Update showOverview to load data
        const originalShowOverview = showOverview;
        showOverview = function () {
          originalShowOverview();
          loadOverviewData();
        };


        // Auto-login check
        (async function checkAutoLogin() {
          const savedUser = localStorage.getItem('currentUser');
          const savedToken = localStorage.getItem('token');
          if (savedUser && savedToken) {
            try {
              const user = JSON.parse(savedUser);
              window.currentUser = user;
              token = savedToken;
              window.authToken = savedToken; // Make globally accessible

              console.log('Auto-logging in user:', user.username);

              // Register with socket using unique username
              if (window.socket) {
                window.socket.emit('register', user.username);
              }

              // Update UI
              if ($('authBox')) $('authBox').style.display = 'none';
              if ($('logoutBtn')) $('logoutBtn').style.display = 'inline-block';
              if ($('notifNavBtn')) $('notifNavBtn').style.display = 'inline-block';
              if ($('userInfoDisplay')) {
                $('userInfoDisplay').style.display = 'flex';
                $('currentUserNameLabel').textContent = user.display_name || user.username;
              }
              if ($('mainDashboardContainer')) $('mainDashboardContainer').style.display = 'block';
              if ($('dashboardSidebar')) $('dashboardSidebar').style.display = 'block';

              // Show reports only if admin
              if ($('reportsNavBtn')) {
                if (user.role && user.role.trim().toLowerCase() === 'admin') {
                  $('reportsNavBtn').style.display = 'inline-block';
                } else {
                  $('reportsNavBtn').style.display = 'none';
                }
              }

              $('authMsg').textContent = 'ูุฑุญุจุงู ' + (user.display_name || user.username);
              $('contractsArea').style.display = 'block';

              // Marketers/Collectors management buttons
              const isAdmin = user.role && user.role.trim().toLowerCase() === 'admin';
              if (!isAdmin) {
                if ($('manageManagersBtn')) $('manageManagersBtn').style.display = 'none';
                if ($('manageCollectorsBtn')) $('manageCollectorsBtn').style.display = 'none';
                if ($('manageUsersBtn')) $('manageUsersBtn').style.display = 'none';
                if ($('createUserBtn')) $('createUserBtn').style.display = 'none';
              } else {
                if ($('manageManagersBtn')) $('manageManagersBtn').style.display = 'inline-block';
                if ($('manageCollectorsBtn')) $('manageCollectorsBtn').style.display = 'inline-block';
              }

              // Initialize data
              await loadServices();
              await initializeDropdownLists();
              await loadContracts();

              console.log('Auto-login successful for:', user.username);
            } catch (e) {
              console.error('Auto-login failed:', e);
              localStorage.removeItem('currentUser');
              localStorage.removeItem('token');
            }
          } else {
            // No saved user, ensure authBox is shown and dashboard hidden
            if ($('authBox')) $('authBox').style.display = 'block';
            if ($('mainDashboardContainer')) $('mainDashboardContainer').style.display = 'block';
            if ($('dashboardSidebar')) $('dashboardSidebar').style.display = 'none';
            console.log('No saved session found. Showing login form.');
          }

          // Initialize Preview Button
          const previewBtn = $('previewContractBtn');
          if (previewBtn) {
            previewBtn.onclick = () => {
              const editingId = $('formWrap')?.dataset?.editing;
              openView(editingId || 'new');
            };
          }
        })();

        // Initialized handlers above

        // Safely expose admin/feature functions if they exist
        if (typeof deleteContract !== 'undefined') window.deleteContract = deleteContract;
        if (typeof downloadViewContractWord !== 'undefined') window.downloadViewContractWord = downloadViewContractWord;
        if (typeof shareViewContract !== 'undefined') window.shareViewContract = shareViewContract;

        // Initialized closeModal above


        // FIX: Event Delegation for View Button (Accesses internal openView)
        document.body.addEventListener('click', function (e) {
          const btn = e.target.closest('.view-contract-trigger');
          if (btn) {
            e.preventDefault();
            e.stopPropagation();
            const id = btn.getAttribute('data-id');
            if (typeof openView === 'function') {
              openView(id);
            } else {
              console.error('openView function not found in scope!');
            }
          }
        });

        // Safety: Ensure Manage Terms doesn't have inline handlers
        const mtBtn = document.getElementById('manageTermsBtn');
        if (mtBtn) mtBtn.removeAttribute('onclick');

        // ============ LIVE UI LISTENERS ============
        // Ensure all inputs trigger a live refresh of the contract terms
        const liveInputs = [
          'clientName', 'clientPhone', 'clientEmail', 'commercialRegistry', 'taxNumber',
          'dateFrom', 'dateTo', 'duration', 'paymentType', 'monthlyFee', 'tax', 'totalPrice',
          'containerType', 'serviceType', 'manager', 'collector',
          'representativeName', 'representativeTitle', 'hasRepresentative',
          'city', 'district', 'containerLocation'
        ];

        liveInputs.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.addEventListener('input', () => { if (typeof refreshContractLiveUI === 'function') refreshContractLiveUI(); });
            el.addEventListener('change', () => { if (typeof refreshContractLiveUI === 'function') refreshContractLiveUI(); });
          }
        });

      }); // DOMContentLoaded
    </script>

    <!-- View Contract Modal -->
    <div id="viewContractModal" class="modal" style="display:none;">
      <div
        style="max-width: 100vw; height: 100vh; display: flex; flex-direction: column; background: #f8f9fc; margin: 0; padding: 0;">

        <!-- Header with action buttons -->
        <div
          style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
          <div></div>
          <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn" onclick="printViewContract()"
              style="background: gray; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">๐จ๏ธ
              ุทุจุงุนุฉ</button>
            <!-- <button class="btn" onclick="downloadViewContractPDF()"
            style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">๐
            ุญูุธ PDF</button> -->
            <button class="btn" onclick="downloadViewContractWord()"
              style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">๐
              ุชุตุฏูุฑ ููุฑุฏ</button>
            <button class="btn" onclick="shareViewContract()"
              style="background: #25D366; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
              <svg style="width: 18px; height: 18px; vertical-align: middle; margin-left: 4px; fill: white;"
                viewBox="0 0 24 24">
                <path
                  d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" />
              </svg>
              ูุงุชุณุงุจ
            </button>
            <span onclick="closeModal('viewContractModal')"
              style="font-size: 32px; cursor: pointer; color: #64748b; line-height: 1;">&times;</span>
          </div>
        </div>

        <!-- Doc wrapper - contains both preview and print content -->
        <div id="doc-wrapper"
          style="flex: 1; background: #ffffff; overflow: auto; display: flex; justify-content: center; padding: 20px; position: relative;">

          <!-- NEW: Visible preview container (what users see) -->
          <div id="view-preview"
            style="background: #fff; width: 210mm; min-height: 296.5mm; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: relative; box-sizing: border-box; line-height: 1.5; display: block; padding: 25mm 15mm; font-family: 'Tajawal', 'Arial', sans-serif; direction: rtl;">
            <!-- Populated by openView with branded HTML -->
          </div>

          <!-- EXISTING: Hidden print content (print button uses this - DON'T MODIFY) -->
          <div id="doc-content"
            style="display: none; background: #fff; width: 210mm; min-height: 296.5mm; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: relative; box-sizing: border-box; line-height: 1.5; background-image: linear-gradient(to bottom, transparent 0mm, transparent 297mm, rgba(0, 0, 0, 0.05) 297mm, rgba(0, 0, 0, 0.05) 297.5mm, transparent 297.5mm); background-size: 100% 297mm; background-repeat: repeat-y;">

            <div class="contract-header" style="flex-direction: column; align-items: stretch; margin-bottom:25px;">
              <!-- Top Row: Manager Info on Left -->
              <div class="top-info-row"
                style="display:flex; justify-content: flex-end; width:100%; margin-bottom: 25px;">
                <div style="text-align: left; font-size: 0.95em; color: #444; line-height: 1.5;">
                  <!-- <div style="direction:ltr; text-align:left;"> <span id="v-date-top"></span></div> -->
                  <div>ูุญุตู / <span id="v-collector"></span></div>
                  <div>ูุณูู / <span id="v-manager"></span></div>
                </div>
              </div>

              <!-- Main Title Row: Contract Num (Left) - Title (Center) -->
              <div class="main-title-row"
                style="display: flex; justify-content: space-between; align-items: center; width: 100%; position: relative;">

                <!-- Right Side: Spacer -->
                <div style="width: 200px;"></div>

                <!-- Center: Title -->
                <div style="text-align: center; flex: 1;">
                  <div style="margin: 0; font-weight: bold; font-size: 1em;">ุนูุฏ ุฅุชูุงู ูููู ุงูููุงูุงุช ุงูุชุฌุงุฑูุฉ</div>
                </div>

                <!-- Left Side: Contract Number -->
                <div style="width: 200px; text-align: left;">ุฑูู ุงูุนูุฏ: <span id="v-id-top"></span></div>
              </div>
            </div>

            <div class="contract-section">
              <div class="terms-box" id="v-terms"></div>
            </div>

            <!-- Attachments Display within Contract View -->
            <!-- Attachments Display removed as per user request -->
            <!-- <div class="contract-section" id="v-attachments-section" ... > -->
            <!-- Attachments Removed -->


            <!-- Signature Section: Table-based for Word compatibility (Side-by-side) -->
            <table border="0" cellspacing="0" cellpadding="0"
              style="width:100%; direction:rtl; margin-top:10px; margin-bottom:0; border-collapse:collapse;">
              <tr>
                <td width="50%" align="center" valign="top">
                  <p style="margin:0; font-weight:bold; font-size:1.1em;">ุงูุทุฑู ุงูุฃูู</p>
                  <p style="margin:2px 0 5px 0;">ุดุฑูุฉ ุจูุช ููููุงููุงุช</p>
                  <div style="text-align: right; padding-right: 40px;">
                    <p style="margin:3px 0;"><strong>ุงูุชูููุน:</strong> ...........................</p>
                    <p style="margin:3px 0;"><strong>ุงูุฎุชู:</strong> ...........................</p>
                  </div>
                </td>
                <td width="50%" align="center" valign="top">
                  <p style="margin:0; font-weight:bold; font-size:1.1em;">ุงูุทุฑู ุงูุซุงูู</p>
                  <p id="v-second-party-name" style="margin:2px 0 5px 0;"></p>
                  <div style="text-align: right; padding-right: 40px;">
                    <p style="margin:3px 0;"><strong>ุงูุชูููุน:</strong> ...........................</p>
                    <p style="margin:3px 0;"><strong>ุงูุฎุชู:</strong> ...........................</p>
                  </div>
                </td>
              </tr>
            </table>
          </div>

        </div>
      </div>

    </div>
  </div>

  <script>
    // Sync file inputs between camera and regular file upload for attachments
    (function () {
      const attachments = [
        { main: 'licenseImage', camera: 'licenseImageCamera' },
        { main: 'commercialRegistry', camera: 'commercialRegistryCamera' },
        { main: 'activityLicense', camera: 'activityLicenseCamera' },
        { main: 'taxNumber', camera: 'taxNumberCamera' }
      ];

      attachments.forEach(({ main, camera }) => {
        const mainInput = document.getElementById(main);
        const cameraInput = document.getElementById(camera);

        if (mainInput && cameraInput) {
          // When camera input changes, copy to main input
          cameraInput.addEventListener('change', function () {
            if (this.files && this.files.length > 0) {
              const dt = new DataTransfer();
              dt.items.add(this.files[0]);
              mainInput.files = dt.files;

              // Trigger change event on main input
              const event = new Event('change', { bubbles: true });
              mainInput.dispatchEvent(event);
            }
          });

          // When main input changes (for display purposes)
          mainInput.addEventListener('change', function () {
            if (this.files && this.files.length > 0) {
              console.log(`File selected for ${main}:`, this.files[0].name);
            }
          });
        }
      });
    })();
  </script>

  <!-- Employees Management Modal -->
  <div id="employeesModal" class="modal"
    style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; z-index:9999; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div class="modal-content"
      style="width: 100%; max-width: 400px; background:white; padding:20px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
      <h3 id="employeesModalTitle" style="margin-top:0;">ุฅุฏุงุฑุฉ</h3>
      <div style="display:flex; gap:8px; margin-bottom:12px;">
        <input id="newEmployeeName" placeholder="ุงูุงุณู"
          style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;" />
        <button id="addEmployeeBtn" class="btn primary">ุฅุถุงูุฉ</button>
      </div>
      <ul id="employeesList"
        style="list-style:none; padding:0; margin:0; max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:4px;">
        <!-- Items -->
      </ul>
      <div class="actions" style="margin-top:16px; text-align:left;">
        <button id="closeEmployeesBtn" class="btn">ุฅุบูุงู</button>
      </div>
    </div>
  </div>

  <script>
    // Employees Management Logic
    let currentEmployeeRole = 'marketer';

    async function openEmployeesModal(role) {
      currentEmployeeRole = role;
      const titleEl = document.getElementById('employeesModalTitle');
      if (titleEl) titleEl.textContent = role === 'marketer' ? 'ุฅุฏุงุฑุฉ ุงููุณูููู' : 'ุฅุฏุงุฑุฉ ุงููุญุตููู';
      const modal = document.getElementById('employeesModal');
      if (modal) modal.style.display = 'flex';
      loadEmployeesList();
    }

    // Convert role to storage type: 'marketer' -> 'managers', 'collector' -> 'collectors'
    function roleToStorageType(role) {
      return role === 'marketer' ? 'managers' : 'collectors';
    }

    // Load employees list from localStorage
    function loadEmployeesList() {
      const list = document.getElementById('employeesList');
      if (!list) return;

      const storageType = roleToStorageType(currentEmployeeRole);
      const STORAGE_MANAGERS = 'managers_list';
      const STORAGE_COLLECTORS = 'collectors_list';
      const storageKey = storageType === 'managers' ? STORAGE_MANAGERS : STORAGE_COLLECTORS;
      const stored = localStorage.getItem(storageKey);
      const items = stored ? JSON.parse(stored) : [];

      list.innerHTML = '';
      if (!items || items.length === 0) {
        list.innerHTML = '<li class="muted" style="padding:8px;">ูุง ููุฌุฏ ุจูุงูุงุช</li>';
      } else {
        items.forEach((name, index) => {
          const li = document.createElement('li');
          li.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee;';
          li.innerHTML = `<span>${name}</span> <button class="btn icon-only small" style="color:red;" onclick="deleteEmployee(${index})">๐๏ธ</button>`;
          list.appendChild(li);
        });
      }
    }

    // Add new employee to localStorage
    function addEmployee() {
      const nameInp = document.getElementById('newEmployeeName');
      const name = nameInp.value.trim();
      if (!name) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ุงูุงุณู');
        return;
      }

      const storageType = roleToStorageType(currentEmployeeRole);
      const STORAGE_MANAGERS = 'managers_list';
      const STORAGE_COLLECTORS = 'collectors_list';
      const storageKey = storageType === 'managers' ? STORAGE_MANAGERS : STORAGE_COLLECTORS;
      const stored = localStorage.getItem(storageKey);
      const items = stored ? JSON.parse(stored) : [];

      if (items.includes(name)) {
        alert('ูุฐุง ุงูุงุณู ููุฌูุฏ ูุณุจูุงู');
        return;
      }

      items.push(name);
      localStorage.setItem(storageKey, JSON.stringify(items));
      nameInp.value = '';
      loadEmployeesList();

      // Also update the dropdown
      const selectId = storageType === 'managers' ? 'manager' : 'collector';
      const selectEl = document.getElementById(selectId);
      if (selectEl) {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        selectEl.appendChild(opt);
      }
    }

    // Make globally accessible for onclick - delete employee from localStorage
    window.deleteEmployee = function (index) {
      if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุญุฐูุ')) return;

      const storageType = roleToStorageType(currentEmployeeRole);
      const STORAGE_MANAGERS = 'managers_list';
      const STORAGE_COLLECTORS = 'collectors_list';
      const storageKey = storageType === 'managers' ? STORAGE_MANAGERS : STORAGE_COLLECTORS;
      const stored = localStorage.getItem(storageKey);
      const items = stored ? JSON.parse(stored) : [];

      if (index >= 0 && index < items.length) {
        items.splice(index, 1);
        localStorage.setItem(storageKey, JSON.stringify(items));
        loadEmployeesList();

        // Also update the dropdown
        const selectId = storageType === 'managers' ? 'manager' : 'collector';
        const selectEl = document.getElementById(selectId);
        if (selectEl) {
          selectEl.innerHTML = '<option value="">-- ุงุฎุชุฑ --</option>';
          items.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            opt.textContent = item;
            selectEl.appendChild(opt);
          });
        }
      }
    }

    // Populate selects from localStorage (no API needed)
    function populateSelects() {
      const STORAGE_MANAGERS = 'managers_list';
      const STORAGE_COLLECTORS = 'collectors_list';

      const storedManagers = localStorage.getItem(STORAGE_MANAGERS);
      const storedCollectors = localStorage.getItem(STORAGE_COLLECTORS);
      const managers = storedManagers ? JSON.parse(storedManagers) : [];
      const collectors = storedCollectors ? JSON.parse(storedCollectors) : [];

      const updateSel = (id, items) => {
        const sel = document.getElementById(id);
        if (!sel) return;
        const val = sel.value;
        sel.innerHTML = '<option value="">-- ุงุฎุชุฑ --</option>';
        if (Array.isArray(items)) {
          items.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            sel.appendChild(opt);
          });
        }
        sel.value = val;
      };

      updateSel('manager', managers);
      updateSel('collector', collectors);
    }

    // Bindings
    const bindBtn = (id, fn) => { const el = document.getElementById(id); if (el) el.addEventListener('click', fn); };
    bindBtn('manageManagersBtn', () => openEmployeesModal('marketer'));
    bindBtn('manageCollectorsBtn', () => openEmployeesModal('collector'));
    bindBtn('addEmployeeBtn', addEmployee);
    bindBtn('closeEmployeesBtn', () => document.getElementById('employeesModal').style.display = 'none');

    // Init call
    // Wait a bit to ensure API is ready or just call it
    setTimeout(populateSelects, 1000);
  </script>

  <!-- Google Maps picker modal - Moved Ensure Top Level -->
  <div id="mapModal" class="map-modal" role="dialog" aria-hidden="true"
    style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; z-index:9999; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); align-items:center; justify-content:center;">
    <div class="map-modal-content"
      style="width:95%; max-width:550px; background:linear-gradient(180deg, #ffffff 0%, #f8fafc 100%); padding:0; border-radius:20px; box-shadow:0 25px 50px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1); overflow:hidden; animation: modalSlideIn 0.3s ease-out;">

      <!-- Header with gradient -->
      <div
        style="background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 50%, #1e40af 100%); padding:20px 24px; color:white;">
        <h4 id="mapModalTitle"
          style="margin:0; font-size:1.25rem; font-weight:700; display:flex; align-items:center; gap:10px;">
          <span style="font-size:1.5rem;">๐</span>
          ุงุฎุชุฑ ุงููููุน ุนุจุฑ ุฎุฑุงุฆุท Google
        </h4>
      </div>

      <!-- Content -->
      <div style="padding:24px;">
        <!-- Instructions Card -->
        <div id="mapFallback"
          style="background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border:1px solid #bae6fd; border-radius:12px; padding:16px; margin-bottom:20px;">
          <p style="color:#0369a1; font-weight:600; margin:0 0 12px 0; display:flex; align-items:center; gap:8px;">
            <span>๐ก</span> ุฎุทูุงุช ุงุฎุชูุงุฑ ุงููููุน:
          </p>
          <ol style="direction:rtl; text-align:right; margin:0; padding-right:20px; color:#075985; line-height:1.8;">
            <li>ุงุถุบุท ุนูู <strong>"ูุชุญ ุฎุฑุงุฆุท Google"</strong> ุฃุฏูุงู</li>
            <li>ุงุฎุชุฑ ุงููููุน ุงููุทููุจ ูู ุงูุฎุฑูุทุฉ</li>
            <li>ุงูุณุฎ ุฑุงุจุท ุงูุตูุญุฉ (Ctrl+C)</li>
            <li>ุงุฑุฌุน ููุง ูุงุถุบุท <strong>"ูุตู ูู ุงูุญุงูุธุฉ"</strong></li>
          </ol>
        </div>

        <!-- Action Buttons -->
        <div style="display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap;">
          <button class="btn" id="openGoogleMapsBtn"
            style="flex:1; min-width:140px; padding:14px 20px; background:linear-gradient(135deg, #10b981 0%, #059669 100%); border:none; color:white; font-weight:600; border-radius:10px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow:0 4px 12px rgba(16,185,129,0.3); transition:all 0.2s;">
            <span style="font-size:1.2rem;">๐บ๏ธ</span>
            ูุชุญ ุฎุฑุงุฆุท Google
          </button>
          <button class="btn" id="pasteCoordsBtn"
            style="flex:1; min-width:140px; padding:14px 20px; background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border:none; color:white; font-weight:600; border-radius:10px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow:0 4px 12px rgba(139,92,246,0.3); transition:all 0.2s;">
            <span style="font-size:1.2rem;">๐</span>
            ูุตู ูู ุงูุญุงูุธุฉ
          </button>
        </div>

        <!-- Input Field -->
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#374151;">ุงูุฅุญุฏุงุซูุงุช ุฃู
            ุงูุฑุงุจุท:</label>
          <input id="selectedCoords" placeholder="ุงูุตู ุฑุงุจุท ุฎุฑุงุฆุท Google ุฃู ุงูุฅุญุฏุงุซูุงุช ููุง..."
            style="width:100%; padding:14px 16px; border-radius:10px; border:2px solid #e5e7eb; font-size:0.95rem; transition:all 0.2s; box-sizing:border-box;"
            onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.2)';"
            onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';" />
        </div>

        <!-- Help Text -->
        <div style="background:#f9fafb; border-radius:8px; padding:12px; margin-bottom:20px; border:1px solid #e5e7eb;">
          <p style="color:#6b7280; font-size:0.85rem; margin:0; line-height:1.6;">
            <strong>๐ ุงูุตูุบ ุงููุฏุนููุฉ:</strong> ุฑุงุจุท ุฎุฑุงุฆุท Google (ูุญุชูู @lat,lng) โข ุฅุญุฏุงุซูุงุช ูุฏููุฉ (lat,lng) โข ุตูุบุฉ
            N/S/E/W
          </p>
        </div>

        <!-- Footer Buttons -->
        <div style="display:flex; gap:12px; justify-content:flex-end;">
          <button class="btn" id="cancelCoordsBtn"
            style="padding:12px 24px; background:#f3f4f6; border:1px solid #d1d5db; color:#374151; font-weight:600; border-radius:10px; cursor:pointer; transition:all 0.2s;">
            ุฅูุบุงุก
          </button>
          <button class="btn primary" id="confirmCoordsBtn"
            style="padding:12px 28px; background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border:none; color:white; font-weight:600; border-radius:10px; cursor:pointer; box-shadow:0 4px 12px rgba(59,130,246,0.3); transition:all 0.2s;">
            โ ุชุฃููุฏ ุงููููุน
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // ROBUST MAP MODAL LOGIC (Fixes Initialization Issues)
    // ==========================================
    (function () {
      // Local Helpers
      const $ = id => document.getElementById(id);

      // State
      let currentPickerTarget = null;

      // 1. OPEN MODAL (Global)
      window.openMapModalFor = function (target) {
        console.log('OpenMapModalFor called:', target);

        // STOP PROPAGATION if event exists (Defensive)
        if (window.event) window.event.stopPropagation();

        // FORCE CLOSE other modals to prevent "double modal" or background ghosting
        const termsModal = $('termsModal'); if (termsModal) termsModal.style.display = 'none';
        const emplModal = $('employeesModal'); if (emplModal) emplModal.style.display = 'none';
        const userModal = $('usersModal'); if (userModal) userModal.style.display = 'none';

        // Check form visibility safely
        const formWrap = $('formWrap');
        if (formWrap && getComputedStyle(formWrap).display === 'none') {
          alert('ุงูุชุญ ูููุฐุฌ ุฅูุดุงุก/ุชุนุฏูู ุงูุนูุฏ ุฃููุงู ุซู ุงุฎุชุฑ ุงููููุน ูู ุฎุฑุงุฆุท Google.');
          return;
        }

        currentPickerTarget = target;

        // PRE-FILL EXISTING INPUT VALUE
        const currentInput = $(target === 'container' ? 'containerLocation' : 'pickupLocation');
        const input = $('selectedCoords');
        if (input) {
          input.value = (currentInput && currentInput.value) ? currentInput.value : '';
        }


        const modal = $('mapModal');
        if (modal) {
          modal.style.display = 'flex'; // Force flex for centering
          modal.setAttribute('aria-hidden', 'false');
        } else {
          console.error('Map Modal Element not found!');
        }
      };

      // 2. CLOSE MODAL (Global)
      window.closeMapModal = function () {
        currentPickerTarget = null;
        const modal = $('mapModal');
        if (modal) modal.style.display = 'none';
      };

      // 3. UPDATE LINK (Global) - Fix for Edit Contract error
      window.updateGoogleLink = function (type, coordStr) {
        const link = (type === 'container') ? $('containerGoogleLink') : $('pickupGoogleLink');
        if (!link) return;

        if (coordStr && coordStr.includes(',')) {
          link.href = 'https://www.google.com/maps?q=' + encodeURIComponent(coordStr);
          link.style.display = 'inline';
        } else {
          link.href = '#';
          link.style.display = 'none';
        }
      };

      // 4. OPEN EXTERNAL MAP
      window.openGoogleMapsWindow = function () {
        window.open('https://www.google.com/maps', '_blank', 'noopener');
      };

      // 4. PASTE
      window.pasteCoordsFromClipboard = async function () {
        try {
          const text = await navigator.clipboard.readText();
          if ($('selectedCoords')) $('selectedCoords').value = text || '';
        } catch (e) {
          alert('ูุง ูููู ุงููุฑุงุกุฉ ูู ุงูุญุงูุธุฉ ุชููุงุฆูุงู. ูุฑุฌู ุงููุตู ูุฏููุงู (Ctrl+V).');
        }
      };

      // 5. CONFIRM SELECTION
      window.confirmCoordsFromModal = function () {
        const input = $('selectedCoords');
        if (!input) return;
        const raw = input.value.trim();

        // Robust Parsing Logic
        let coords = null;
        if (raw) {
          // Direct lat,lng
          let m = raw.match(/(-?\d+(?:\.\d+)?)[,\s]+(-?\d+(?:\.\d+)?)/);
          if (m) coords = parseFloat(m[1]).toFixed(6) + ',' + parseFloat(m[2]).toFixed(6);

          // Google Maps URL patterns
          if (!coords) {
            m = raw.match(/@(-?\d+\.\d+),(-?\d+\.\d+),/) ||
              raw.match(/[?&]q=([-.\d]+),\s*([-.\d]+)/) ||
              raw.match(/!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/);
            if (m) coords = parseFloat(m[1]).toFixed(6) + ',' + parseFloat(m[2]).toFixed(6);
          }
        }

        if (!coords) {
          alert('ุชุนุฐุฑ ุงุณุชุฎุฑุงุฌ ุงูุฅุญุฏุงุซูุงุช. ุงูุฑุฌุงุก ูุตู ุฑุงุจุท ุฎุฑุงุฆุท Google ุฃู ุฅุญุฏุงุซูุงุช ุจุตูุบุฉ lat,lng');
          return;
        }

        if (currentPickerTarget === 'container') {
          const targetInput = $('containerLocation');
          if (targetInput) targetInput.value = coords;

          const link = $('containerGoogleLink');
          if (link) {
            link.href = 'https://www.google.com/maps?q=' + encodeURIComponent(coords);
            link.style.display = 'inline';
          }
        } else if (currentPickerTarget === 'pickup') { // In case we re-enable pickup
          const targetInput = $('pickupLocation');
          if (targetInput) targetInput.value = coords;
        }

        closeMapModal();
      };

      // 6. BINDINGS (Wait for next tick to ensure DOM is ready, though script at end is usually fine)
      setTimeout(() => {
        const bind = (id, fn) => { const el = $(id); if (el) el.onclick = fn; };

        bind('openGoogleMapsBtn', window.openGoogleMapsWindow);
        bind('pasteCoordsBtn', window.pasteCoordsFromClipboard);
        bind('confirmCoordsBtn', window.confirmCoordsFromModal);
        bind('cancelCoordsBtn', window.closeMapModal);

        console.log('โ Map Modal Bindings Complete');
      }, 100);

    })();
  </script>
</body>

</html>