<!doctype html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ù†Ø¸Ø§Ù… Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù†Ø¸Ø§ÙØ© - ÙˆØ§Ø¬Ù‡Ø© Ù…ØªØµÙ„Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- <link rel="stylesheet" href="styles.css"> -->
    <!-- <link rel="stylesheet" href="styles/theme-modern.css"> -->

    <link rel="stylesheet" href="styles/theme-kucoin.css">

    <!-- Quill.js Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>








    <!-- <script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script> -->
    <style>
        /* Sortable table headers */
        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-left: 20px;
        }

        th.sortable:hover {
            background-color: #f0f4f8;
        }

        .sort-arrow {
            position: absolute;
            left: 5px;
            opacity: 0.3;
            font-size: 10px;
        }

        .sort-arrow::before {
            content: 'â–¼';
        }

        th.sortable.asc .sort-arrow {
            opacity: 1;
        }

        th.sortable.asc .sort-arrow::before {
            content: 'â–²';
        }

        th.sortable.desc .sort-arrow {
            opacity: 1;
        }

        th.sortable.desc .sort-arrow::before {
            content: 'â–¼';
        }

        /* Flower Theme Switcher - Improved */
        .theme-flower {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9999;
            width: 40px;
            height: 40px;
        }

        /* Keep petals visible for 2 seconds after hover ends */
        .theme-flower:hover,
        .theme-flower:focus-within {
            width: 180px;
            height: 180px;
        }

        .flower-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #24ae8f 0%, #14b8a6 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(36, 174, 143, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .flower-center:hover {
            transform: translate(-50%, -50%) scale(1.15) rotate(180deg);
            box-shadow: 0 6px 20px rgba(36, 174, 143, 0.7);
        }

        .flower-petal {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: white;
            text-align: center;
            padding: 3px;
            line-height: 1.1;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            opacity: 0;
            transform: translate(-50%, -50%) scale(0);
            pointer-events: none;
        }

        .theme-flower:hover .flower-petal,
        .theme-flower:focus-within .flower-petal {
            opacity: 1;
            pointer-events: all;
            transition-delay: 0s;
        }

        /* Petal positions - closer circle */
        .theme-flower:hover .petal-1,
        .theme-flower:focus-within .petal-1 {
            transform: translate(calc(-50% + 0px), calc(-50% - 65px)) scale(1);
            transition-delay: 0.05s;
        }

        .theme-flower:hover .petal-2,
        .theme-flower:focus-within .petal-2 {
            transform: translate(calc(-50% + 56px), calc(-50% - 33px)) scale(1);
            transition-delay: 0.1s;
        }

        .theme-flower:hover .petal-3,
        .theme-flower:focus-within .petal-3 {
            transform: translate(calc(-50% + 56px), calc(-50% + 33px)) scale(1);
            transition-delay: 0.15s;
        }

        .theme-flower:hover .petal-4,
        .theme-flower:focus-within .petal-4 {
            transform: translate(calc(-50% + 0px), calc(-50% + 65px)) scale(1);
            transition-delay: 0.2s;
        }

        .theme-flower:hover .petal-5,
        .theme-flower:focus-within .petal-5 {
            transform: translate(calc(-50% - 56px), calc(-50% + 33px)) scale(1);
            transition-delay: 0.25s;
        }

        .theme-flower:hover .petal-6,
        .theme-flower:focus-within .petal-6 {
            transform: translate(calc(-50% - 56px), calc(-50% - 33px)) scale(1);
            transition-delay: 0.3s;
        }

        /* Individual petal colors */
        .petal-1 {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .petal-2 {
            background: linear-gradient(135deg, #f0b90b 0%, #d9a809 100%);
        }

        .petal-3 {
            background: linear-gradient(135deg, #24ae8f 0%, #14b8a6 100%);
        }

        .petal-4 {
            background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);
        }

        .petal-5 {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        .petal-6 {
            background: linear-gradient(135deg, #e5e7eb 0%, #f3f4f6 100%);
            color: #1e293b;
        }

        .flower-petal:hover {
            transform: translate(-50%, -50%) scale(1.2) !important;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
            z-index: 20;
        }

        /* Tooltip on hover */
        .flower-petal::before {
            content: attr(title);
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .flower-petal:hover::before {
            opacity: 1;
        }

        /* Sidebar Panel Styling */
        main {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 1.5rem;
            align-items: start;
        }

        .panel {
            background: var(--bg-secondary, #f8fafc);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color, #e2e8f0);
            position: sticky;
            top: 20px;
        }

        .panel h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-primary, #1e293b);
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-color, #2563eb);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel h3::before {
            content: 'ğŸ“Š';
            font-size: 1.5rem;
        }

        /* Stat Cards */
        .stat {
            background: linear-gradient(135deg, var(--primary-color, #3b82f6) 0%, var(--primary-dark, #2563eb) 100%);
            color: white;
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .stat:nth-child(3) {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .stat:nth-child(3):hover {
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .stat .muted {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-bottom: 0.375rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat strong {
            font-size: 2.25rem;
            font-weight: 800;
            display: block;
            line-height: 1;
        }

        .stat .chip {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            border: 1px solid rgba(255, 255, 255, 0.4);
            white-space: nowrap;
        }

        /* Navigation Buttons */
        .nav {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .nav button {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid transparent;
            border-radius: 10px;
            background: var(--bg-tertiary, #f1f5f9);
            color: var(--text-primary, #1e293b);
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: right;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .nav button::before {
            font-size: 1.25rem;
        }

        .nav button[data-view="contracts"]::before {
            content: 'ğŸ“„';
        }

        .nav button[data-view="clients"]::before {
            content: 'ğŸ‘¥';
        }

        .nav button[data-view="services"]::before {
            content: 'ğŸ› ï¸';
        }

        .nav button[data-view="reports"]::before {
            content: 'ğŸ“Š';
        }

        .nav button::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary-color, #3b82f6);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .nav button:hover {
            background: var(--bg-secondary, #e2e8f0);
            border-color: var(--primary-color, #3b82f6);
            transform: translateX(-4px);
        }

        .nav button.active {
            background: linear-gradient(135deg, var(--primary-color, #3b82f6) 0%, var(--primary-dark, #2563eb) 100%);
            color: white;
            border-color: var(--primary-color, #3b82f6);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .nav button.active::after {
            transform: scaleY(1);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            main {
                grid-template-columns: 1fr;
            }

            .panel {
                position: relative;
                top: 0;
            }

            .nav {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .nav button {
                flex: 1;
                min-width: 150px;
            }
        }

        @media (max-width: 768px) {
            .stat {
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
            }

            .nav button {
                font-size: 0.875rem;
                padding: 0.75rem;
            }

            .nav button::before {
                font-size: 1.125rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="brand">
                <div class="logo">
                    <img src="logo.jpg" alt="Ù†Ø¸Ø§Ù… Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù†Ø¸Ø§ÙØ©" width="56" height="56" id="siteLogo">
                </div>
                <div class="title">
                    <h1>Ù†Ø¸Ø§Ù… Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù†Ø¸Ø§ÙØ© </h1>
                    <p>Ø¹Ø±Ø¶ØŒ Ø¥Ù†Ø´Ø§Ø¡ØŒ ØªÙˆÙ‚ÙŠØ¹ ÙˆØ£Ø±Ø´ÙØ© Ø§Ù„Ø¹Ù‚ÙˆØ¯ â€” Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                </div>
            </div>

            <div class="top-actions">
                <button class="btn" id="exportCsvBtn" title="ØªØµØ¯ÙŠØ± ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚ÙˆØ¯">ØªØµØ¯ÙŠØ± CSV</button>
                <button class="btn" id="uploadPdfBtn" title="Ø±ÙØ¹ PDF">Ø±ÙØ¹ PDF</button>
                <button class="btn primary" id="newContractBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </header>

        <main>
            <aside class="panel" aria-label="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©">
                <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
                <div class="stat">
                    <div>
                        <div class="muted">Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù†Ø´Ø·Ø©</div><strong id="countActive">0</strong>
                    </div>
                    <div class="chip">Ù†Ø´Ø·Ø©</div>
                </div>
                <div class="stat">
                    <div>
                        <div class="muted">Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</div><strong id="countPending">0</strong>
                    </div>
                    <div class="chip">Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</div>
                </div>
                <div class="nav" role="navigation" aria-label="Ù‚Ø§Ø¦Ù…Ø©">
                    <button class="active" data-view="contracts">Ø§Ù„Ø¹Ù‚ÙˆØ¯</button>
                    <button data-view="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
                </div>
            </aside>

            <section class="content">
                <div class="auth" id="authBox">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <input id="username" value="admin"></label>
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±: <input id="password" type="password" value="admin123"></label>
                    <button class="btn primary" id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                    <span id="authMsg" class="muted"></span>
                </div>

                <div class="controls">
                    <button class="btn" id="refreshBtn">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                    <button class="btn" id="createUserBtn">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… (admin)</button>
                    <input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯..." />
                    <select id="filter">
                        <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                        <option value="active">Ù†Ø´Ø·</option>
                        <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</option>
                        <option value="expired">Ù…Ù†ØªÙ‡ÙŠ</option>
                    </select>
                </div>

                <div class="table-wrap" id="contractsArea">
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="id" onclick="sortTable('id')">Ø±Ù‚Ù… <span
                                        class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="client_name" onclick="sortTable('client_name')">Ø§Ù„Ø¹Ù…ÙŠÙ„
                                    <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="service_name" onclick="sortTable('service_name')">Ø§Ù„Ø®Ø¯Ù…Ø©
                                    <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="from_date" onclick="sortTable('from_date')">Ø§Ù„ÙØªØ±Ø© <span
                                        class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="total_price" onclick="sortTable('total_price')">Ø§Ù„Ø³Ø¹Ø±
                                    <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="manager" onclick="sortTable('manager')">Ù…Ø³ÙˆÙ‚ <span
                                        class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="collector" onclick="sortTable('collector')">Ù…Ø­ØµÙ„ <span
                                        class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="status" onclick="sortTable('status')">Ø§Ù„Ø­Ø§Ù„Ø© <span
                                        class="sort-arrow"></span></th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="contractsTbody"></tbody>
                    </table>
                </div>

                <!-- Reports Section - Enhanced with Manager & Collector Stats -->
                <div class="table-wrap" id="reportsArea" style="display:none;">
                    <h3 style="margin-bottom: 1.5rem;">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>

                    <!-- Key Metrics -->
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div
                            style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚ÙˆØ¯</div>
                            <div style="font-size: 2.5rem; font-weight: 700;" id="reportTotalContracts">0</div>
                        </div>

                        <div
                            style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
                            </div>
                            <div style="font-size: 2.5rem; font-weight: 700;" id="reportTotalRevenue">0</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ</div>
                        </div>

                        <div
                            style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                            <div style="font-size: 2.5rem; font-weight: 700;" id="reportTotalClients">0</div>
                        </div>

                        <div
                            style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯
                            </div>
                            <div style="font-size: 2.5rem; font-weight: 700;" id="reportAvgContract">0</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ</div>
                        </div>
                    </div>

                    <!-- Status Distribution -->
                    <div
                        style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;">
                        <h4 style="margin-bottom: 1rem;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</h4>
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div
                                style="padding: 1rem; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
                                <div style="color: #059669; font-size: 0.875rem; margin-bottom: 0.25rem;">Ù†Ø´Ø·Ø©</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #047857;"
                                    id="reportActiveCount">0</div>
                            </div>
                            <div
                                style="padding: 1rem; background: #fffbeb; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                <div style="color: #d97706; font-size: 0.875rem; margin-bottom: 0.25rem;">Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
                                </div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #b45309;"
                                    id="reportPendingCount">0</div>
                            </div>
                            <div
                                style="padding: 1rem; background: #fef2f2; border-radius: 8px; border-left: 4px solid #ef4444;">
                                <div style="color: #dc2626; font-size: 0.875rem; margin-bottom: 0.25rem;">Ù…Ù†ØªÙ‡ÙŠØ©</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #b91c1c;"
                                    id="reportExpiredCount">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Manager Performance -->
                    <div
                        style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;">
                        <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">ğŸ“ˆ</span>
                            Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ†
                        </h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ù…Ø³ÙˆÙ‚</th>
                                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚ÙˆØ¯</th>
                                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                                    <th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</th>
                                </tr>
                            </thead>
                            <tbody id="managerStatsTbody"></tbody>
                        </table>
                    </div>

                    <!-- Collector Performance -->
                    <div
                        style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;">
                        <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">ğŸ’°</span>
                            Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø­ØµÙ„ÙŠÙ†
                        </h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ù…Ø­ØµÙ„</th>
                                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚ÙˆØ¯</th>
                                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                                    <th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</th>
                                </tr>
                            </thead>
                            <tbody id="collectorStatsTbody"></tbody>
                        </table>
                    </div>

                    <!-- Top Clients -->
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e5e7eb;">
                        <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">ğŸ†</span>
                            Ø£ÙØ¶Ù„ 5 Ø¹Ù…Ù„Ø§Ø¡ (Ø­Ø³Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯)
                        </h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚ÙˆØ¯</th>
                                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                                </tr>
                            </thead>
                            <tbody id="topClientsTbody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="formWrap" class="form" aria-hidden="true" style="display:none;">
                    <h3>Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡/ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù‚Ø¯</h3>

                    <div class="row">
                        <div class="field small">
                            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                            <select id="clientType">
                                <option>ÙØ±Ø¯</option>
                                <option>Ù…Ù†Ø´Ø£Ø©</option>
                            </select>
                        </div>

                        <div class="field">
                            <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                            <input type="text" id="clientName" />
                        </div>

                        <div class="field small">
                            <label>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                            <select id="serviceType">
                                <option>Ù†Ø¸Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ©</option>
                                <option>Ù†Ø¸Ø§ÙØ© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</option>
                                <option>Ø·ÙˆØ§Ø±Ø¦</option>
                                <option>Ù†Ù‚Ù„ Ù†ÙØ§ÙŠØ§Øª</option>
                                <option>Ù†Ù‚Ù„ ÙƒÙØ±Ø§Øª</option>
                                <option>Ù†Ù‚Ù„ Ø£Ø®Ø´Ø§Ø¨</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="field small"><label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label><input id="city" /></div>
                        <div class="field small"><label>Ø§Ù„Ø­ÙŠ</label><input id="district" /></div>
                        <div class="field small"><label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©</label><select id="containerType">
                                <option>Ø¨Ø±Ù…ÙŠÙ„</option>
                                <option>2 ÙŠØ§Ø±Ø¯Ø©</option>
                                <option>1 ÙŠØ§Ø±Ø¯Ø©</option>
                                <option>6 ÙŠØ§Ø±Ø¯Ø©</option>
                                <option>Ø¨Ø¯ÙˆÙ†</option>
                            </select></div>
                        <div class="field small"><label>Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø¹Ø§Ù…)</label><input id="location" /></div>
                    </div>

                    <div class="row">
                        <div class="field small"><label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label><input type="date" id="dateFrom" /></div>
                        <div class="field small"><label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label><input type="date" id="dateTo" /></div>
                        <div class="field small"><label>Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯</label><select id="duration">
                                <option>Ø³Ù†ÙˆÙŠ</option>
                                <option>6 Ø£Ø´Ù‡Ø±</option>
                                <option>3 Ø£Ø´Ù‡Ø±</option>
                                <option>Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©</option>
                            </select></div>
                        <div class="field small"><label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</label><input id="monthlyFee" /></div>
                        <div class="field small"><label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label><input id="totalPrice" /></div>
                    </div>

                    <div class="row">
                        <div class="field">
                            <label>Ø´Ø±ÙˆØ· Ùˆ Ø¨Ù†ÙˆØ¯</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input id="termsSummary" readonly placeholder="Ø§Ø¶ØºØ· 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙˆØ·' Ù„ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø±ÙˆØ·"
                                    style="flex:1;padding:8px;border-radius:8px;border:1px solid #e0e6ef" />
                                <button class="btn" id="manageTermsBtn">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙˆØ·</button>
                                <button class="btn" id="exportTermsBtn" title="ØªØµØ¯ÙŠØ± Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙƒÙ…Ù„Ù Word">ØªØµØ¯ÙŠØ±
                                    Word</button>
                            </div>
                            <input type="hidden" id="terms" />
                            <div class="muted" style="font-size:12px">Ø§ÙØªØ­ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙˆØ· Ù„Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ù†ÙˆØ¯. Ø¹Ù†Ø¯
                                Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ Ø³ØªÙØ­ÙØ¸
                                Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù‚Ù„.</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="field">
                            <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ© (Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª)</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input id="containerLocation" placeholder="lat,lng" />
                                <button class="btn" id="pickContainerBtn">Ø§Ø®ØªØ± Ù…Ù† Ø®Ø±Ø§Ø¦Ø· Google</button>
                                <a id="containerGoogleLink" class="muted" href="#" target="_blank"
                                    style="display:none">Ø¹Ø±Ø¶ ÙÙŠ Ø®Ø±Ø§Ø¦Ø·
                                    Google</a>
                            </div>
                            <div class="muted" style="font-size:12px">Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ø®Ø±Ø§Ø¦Ø· Google ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø«Ù… Ø§Ù†Ø³Ø®
                                Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ø¶ØºØ·
                                "Ù„ØµÙ‚ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©".</div>
                        </div>

                        <div class="field">
                            <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ­ØµÙŠÙ„ (Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª)</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input id="pickupLocation" placeholder="lat,lng" />
                                <button class="btn" id="pickPickupBtn">Ø§Ø®ØªØ± Ù…Ù† Ø®Ø±Ø§Ø¦Ø· Google</button>
                                <a id="pickupGoogleLink" class="muted" href="#" target="_blank" style="display:none">Ø¹Ø±Ø¶
                                    ÙÙŠ Ø®Ø±Ø§Ø¦Ø·
                                    Google</a>
                            </div>
                            <div class="muted" style="font-size:12px">Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø®Ø±Ø§Ø¦Ø· Google Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø«Ù…
                                Ø§Ø¶ØºØ· "Ù„ØµÙ‚ Ù…Ù†
                                Ø§Ù„Ø­Ø§ÙØ¸Ø©".</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="field small"><label>Ù…Ø³ÙˆÙ‚ Ø§Ù„Ø¹Ù‚Ø¯</label><input id="manager" /></div>
                        <div class="field small"><label>Ù…Ø­ØµÙ„ Ø§Ù„Ø¹Ù‚Ø¯</label><input id="collector" /></div>
                        <div class="field small"><label>Ø´Ø±ÙˆØ· Ø§Ù„Ø¯ÙØ¹</label><select id="paymentType">
                                <option>Ø³Ù†ÙˆÙŠØ©</option>
                                <option>ÙƒÙ„ 6 Ø£Ø´Ù‡Ø±</option>
                                <option>ÙƒÙ„ 3 Ø£Ø´Ù‡Ø±</option>
                                <option>Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©</option>
                            </select></div>
                        <div class="field small"><label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯</label><select id="status">
                                <option value="active">Ù†Ø´Ø·</option>
                                <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</option>
                                <option value="expired">Ù…Ù†ØªÙ‡ÙŠ</option>
                            </select></div>
                    </div>

                    <div class="row">
                        <div class="field">
                            <label>Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ (Ø«Ø§Ø¨Øª)</label>
                            <input type="text" id="firstParty" value="Ø´Ø±ÙƒØ© Ø¨ÙØª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª" readonly
                                style="background:#f8f9fc;border-color:#e6ecf8;color:#4a5568;" />
                            <div class="muted" style="font-size:12px">Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ Ø«Ø§Ø¨Øª Ø¯Ø§Ø¦Ù…Ø§Ù‹: Ø´Ø±ÙƒØ© Ø¨ÙØª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª</div>
                        </div>
                        <div class="field">
                            <label>Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø§Ù„Ø¹Ù…ÙŠÙ„)</label>
                            <input type="text" id="secondParty" readonly
                                style="background:#f8f9fc;border-color:#e6ecf8;color:#4a5568;" />
                            <div class="muted" style="font-size:12px">Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="field">
                            <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹)</label>
                            <input type="email" id="clientEmail" placeholder="client@example.com" />
                            <div class="muted" style="font-size:12px">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¢Ù…Ù† Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯</div>
                        </div>
                        <div class="field">
                            <label>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                            <input type="tel" id="clientPhone" placeholder="05xxxxxxxx" />
                            <div class="muted" style="font-size:12px">Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn primary" id="saveContractBtn">Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯</button>
                        <button class="btn" id="sendForSigningBtn" title="Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù‚Ø¯ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„ØªÙˆÙ‚ÙŠØ¹">Ø¥Ø±Ø³Ø§Ù„
                            Ù„Ù„ØªÙˆÙ‚ÙŠØ¹</button>
                        <button class="btn" id="generateContractFileBtn" title="Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø¹Ù‚Ø¯ (Word/PDF)">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù
                            Ø§Ù„Ø¹Ù‚Ø¯</button>
                        <button class="btn" id="cancelFormBtn">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>

            </section>
        </main>

        <footer style="text-align:center;margin-top:18px" class="muted">Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© - ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ÙÙŠØ± Ø§Ù„Ø£Ø³Ø±Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ…
        </footer>

        <!-- Theme Flower Switcher -->
        <div class="theme-flower">
            <div class="flower-center" title="Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ…ÙŠÙ…">ğŸŒ¸</div>
            <div class="flower-petal petal-1" onmouseover="switchTheme('theme-modern.css')" title="Modern">Modern</div>
            <div class="flower-petal petal-2" onmouseover="switchTheme('theme-binance.css')" title="Binance">Binance
            </div>
            <div class="flower-petal petal-3" onmouseover="switchTheme('theme-kucoin.css')" title="KuCoin">KuCoin</div>
            <div class="flower-petal petal-4" onmouseover="switchTheme('theme-ocean.css')" title="Ocean">Ocean</div>
            <div class="flower-petal petal-5" onmouseover="switchTheme('theme-dark-gold.css')" title="Dark Gold">Dark
            </div>
            <div class="flower-petal petal-6" onmouseover="switchTheme('theme-minimal.css')" title="Minimal">Minimal
            </div>
        </div>
    </div>

    <!-- Terms manager modal -->
    <div id="termsModal" class="map-modal" role="dialog" aria-hidden="true" style="display:none;">
        <div class="map-modal-content" style="max-width:900px;">
            <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙˆØ· Ùˆ Ø§Ù„Ø¨Ù†ÙˆØ¯</h4>

            <div style="display:flex;gap:12px;margin-bottom:8px;align-items:center;">
                <button class="btn" id="termsRefreshBtn">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                <button class="btn" id="termsSelectAllBtn">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
                <button class="btn" id="termsDeselectAllBtn">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
                <button class="btn primary" id="termsInsertBtn">Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø¹Ù‚Ø¯</button>
                <button class="btn" id="termsExportBtn">ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¥Ù„Ù‰ Word</button>
                <div style="flex:1"></div>
                <button class="btn" id="termsCloseBtn">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>

            <div style="display:flex;gap:12px;">
                <div
                    style="flex:1;min-width:300px;max-height:480px;overflow:auto;border:1px solid #e6ecf8;padding:8px;border-radius:8px;background:#fff;">
                    <div id="termsList"></div>
                </div>

                <aside style="width:380px;min-width:240px;">
                    <h5>Ù…Ø¹Ø§ÙŠÙ†Ø© / Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¯</h5>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <input id="termId" type="hidden" />
                        <label>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯</label>
                        <input id="termName" />
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</label>
                        <select id="termType">
                            <option value="text">Ù†Øµ</option>
                            <option value="selection">Ø§Ø®ØªÙŠØ§Ø± (Ù‚Ø§Ø¦Ù…Ø©)</option>
                        </select>
                        <label id="termContentLabel">Ù†Øµ Ø§Ù„Ø¨Ù†Ø¯</label>
                        <!-- Quill Editor Container -->
                        <div id="termContent" style="height:200px;background:white;"></div>
                        <div class="muted" style="font-size:12px">Ù„Ù†ÙˆØ¹ "Ø§Ø®ØªÙŠØ§Ø±" Ø¶Ø¹ ÙƒÙ„ Ø®ÙŠØ§Ø± ÙÙŠ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯.</div>

                        <div style="display:flex;gap:8px;">
                            <button class="btn primary" id="saveTermBtn">Ø­ÙØ¸ Ø§Ù„Ø¨Ù†Ø¯</button>
                            <button class="btn" id="newTermBtn">Ø¬Ø¯ÙŠØ¯</button>
                            <button class="btn" id="deleteTermBtn"
                                style="background:#f8d7da;border-color:#f5c6cb;color:#721c24">Ø­Ø°Ù</button>
                        </div>
                    </div>
                </aside>
            </div>

        </div>
    </div>

    <!-- Google Maps picker modal (hidden). It does NOT embed Google Maps; it provides "ÙØªØ­ Ø®Ø±Ø§Ø¦Ø· Google" + paste flow. -->
    <div id="mapModal" class="map-modal" role="dialog" aria-hidden="true" style="display:none;">
        <div class="map-modal-content">
            <h4 id="mapModalTitle">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø¨Ø± Ø®Ø±Ø§Ø¦Ø· Google</h4>

            <div id="mapFallback" style="margin-bottom:8px;">
                <p class="muted">Ø³ÙŠØªÙ… ÙØªØ­ Ø®Ø±Ø§Ø¦Ø· Google ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© â€” Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø«Ù… Ø§Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø©
                    (Share Ø£Ùˆ
                    Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†).</p>
                <ol style="direction:rtl;text-align:right;">
                    <li>ÙÙŠ Ø®Ø±Ø§Ø¦Ø· Google: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… "What's here?" Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª.</li>
                    <li>Ø§Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø© (Ctrl+C) Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹.</li>
                    <li>Ø§Ø±Ø¬Ø¹ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ§Ø¶ØºØ· "Ù„ØµÙ‚ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©". Ø§Ù„Ù†Ø¸Ø§Ù… Ø³ÙŠØ³ØªØ®Ø±Ø¬ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙˆÙŠØ¶Ø¹Ù‡Ø§ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„.</li>
                </ol>
            </div>

            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
                <button class="btn primary" id="openGoogleMapsBtn">Ø§ÙØªØ­ Ø®Ø±Ø§Ø¦Ø· Google</button>
                <button class="btn" id="pasteCoordsBtn">Ù„ØµÙ‚ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©</button>
                <input id="selectedCoords" placeholder="Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ø®Ø±Ø§Ø¦Ø· Google Ø£Ùˆ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù‡Ù†Ø§"
                    style="flex:1;padding:8px;border-radius:8px;border:1px solid #e0e6ef" />
                <button class="btn" id="confirmCoordsBtn">ØªØ£ÙƒÙŠØ¯</button>
                <button class="btn" id="cancelCoordsBtn">Ø¥Ù„ØºØ§Ø¡</button>
            </div>

            <div class="muted" style="font-size:12px">ÙŠØ¯Ø¹Ù… Ù„ØµÙ‚: Ø±Ø§Ø¨Ø· Ø®Ø±Ø§Ø¦Ø· Google (ÙŠØ­ØªÙˆÙŠ @lat,lng Ø£Ùˆ !3dLAT!4dLNG) Ø£Ùˆ
                Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
                ÙŠØ¯ÙˆÙŠØ§Ù‹ (lat,lng) Ø£Ùˆ Ø¨ØµÙŠØºØ© N/S/E/W.</div>
        </div>
    </div>

    <!-- Contract Signing Modal -->
    <div id="signingModal" class="map-modal" role="dialog" aria-hidden="true" style="display:none;">
        <div class="map-modal-content" style="max-width:600px;">
            <h4>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù‚Ø¯ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„ØªÙˆÙ‚ÙŠØ¹</h4>

            <div class="row" style="margin-bottom:16px;">
                <div class="field">
                    <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label>
                    <select id="sendMethod" style="width:100%;">
                        <option value="link">Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· ØªÙˆÙ‚ÙŠØ¹ Ø¢Ù…Ù†</option>
                        <option value="email">Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</option>
                        <option value="whatsapp">Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</option>
                        <option value="file">ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Word/PDF</option>
                    </select>
                </div>
            </div>

            <div id="linkSection" class="send-section">
                <div class="field">
                    <label>Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¢Ù…Ù†</label>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <input id="signingLink" readonly style="flex:1;font-family:monospace;font-size:12px;" />
                        <button class="btn" id="copyLinkBtn">Ù†Ø³Ø®</button>
                    </div>
                    <div class="muted" style="font-size:12px">Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙØ±ÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ¢Ù…Ù† Ù„Ù„ØªÙˆÙ‚ÙŠØ¹</div>
                </div>
            </div>

            <div id="emailSection" class="send-section" style="display:none;">
                <div class="field">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„</label>
                    <input type="email" id="signingEmail" placeholder="client@example.com" />
                </div>
                <div class="field">
                    <label>Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØµØµØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <textarea id="emailMessage" style="height:80px;"
                        placeholder="ÙŠØ±Ø¬Ù‰ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø±ÙÙ‚ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ..."></textarea>
                </div>
            </div>

            <div id="whatsappSection" class="send-section" style="display:none;">
                <div class="field">
                    <label>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                    <input type="tel" id="whatsappNumber" placeholder="05xxxxxxxx" />
                </div>
                <div class="field">
                    <label>Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label>
                    <textarea id="whatsappMessage" style="height:80px;" readonly></textarea>
                </div>
            </div>

            <div id="fileSection" class="send-section" style="display:none;">
                <div class="field">
                    <label>ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù</label>
                    <select id="fileFormat">
                        <option value="word">Ù…Ù„Ù Word (.docx)</option>
                        <option value="pdf">Ù…Ù„Ù PDF</option>
                    </select>
                </div>
                <div class="field">
                    <label>Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©</label>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="includeTerms" checked />
                            <span>Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="includeSignatures" checked />
                            <span>Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="includeQrCode" checked />
                            <span>Ø¥Ø¯Ø±Ø§Ø¬ ÙƒÙˆØ¯ QR Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="field">
                    <label>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ©</label>
                    <select id="authMethod" style="width:100%;">
                        <option value="email_only">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙÙ‚Ø·</option>
                        <option value="email_code">Ø§Ù„Ø¨Ø±ÙŠØ¯ + Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</option>
                        <option value="phone_code">Ø§Ù„Ø¬ÙˆØ§Ù„ + Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</option>
                        <option value="id_verification">Ø§Ù„Ø¨Ø±ÙŠØ¯ + ØªØ­Ù‚Ù‚ Ø§Ù„Ù‡ÙˆÙŠØ©</option>
                    </select>
                    <div class="muted" style="font-size:12px">Ù„Ø²ÙŠØ§Ø¯Ø© Ø£Ù…Ø§Ù† Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆÙ…Ù†Ø¹ Ø§Ù„ØªÙ„Ø§Ø¹Ø¨</div>
                </div>
            </div>

            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px;">
                <button class="btn" id="cancelSigningBtn">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn primary" id="confirmSendBtn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <script>

        // Final integrated index.html: Google Maps paste-based picker (no API key required).
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE = '/api';
            let token = null;
            let currentPickerTarget = null; // 'container' or 'pickup'

            const $ = id => document.getElementById(id);
            const showElem = el => { if (!el) return; el.style.display = (el.id === 'mapModal') ? 'flex' : 'block'; el.setAttribute('aria-hidden', 'false'); };
            const hideElem = el => { if (!el) return; el.style.display = 'none'; el.setAttribute('aria-hidden', 'true'); };

            // double-guard hide
            hideElem($('formWrap'));
            hideElem($('mapModal'));

            // Theme Switcher Function
            window.switchTheme = function (themeName) {
                const themeLink = document.querySelector('link[href*="theme-"]');
                if (themeLink) {
                    themeLink.href = 'styles/' + themeName;
                    // Save preference to localStorage
                    localStorage.setItem('selectedTheme', themeName);
                    console.log('Theme switched to:', themeName);
                }
            };

            // Load saved theme on page load
            const savedTheme = localStorage.getItem('selectedTheme');
            if (savedTheme) {
                const themeLink = document.querySelector('link[href*="theme-"]');
                if (themeLink) {
                    themeLink.href = 'styles/' + savedTheme;
                }
            }

            // --- Initialize Quill Editor ---
            var quill = new Quill('#termContent', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        [{ 'color': [] }, { 'background': [] }],
                        ['clean']
                    ]
                }
            });

            // --- LocalStorage Helpers ---
            const STORAGE_KEY_CONTRACTS = 'clean_service_contracts_v1';
            const STORAGE_KEY_CLIENTS = 'clean_service_clients_v1';
            const STORAGE_KEY_USERS = 'clean_service_users_v1';

            function getStoredData(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.error('Error reading from localStorage', e);
                    return [];
                }
            }

            function setStoredData(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error('Error writing to localStorage', e);
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù…Ù…ØªÙ„Ø¦Ø©ØŸ)');
                }
            }

            // Mock apiFetch for compatibility with existing Terms logic if needed, 
            // but we will try to rely on local storage helpers for main logic.
            // --- API helper ---
            async function apiFetch(path, opts = {}) {
                opts.headers = opts.headers || {};
                if (!opts.headers['Content-Type'] && !(opts.body instanceof FormData)) opts.headers['Content-Type'] = 'application/json';
                if (token) opts.headers['Authorization'] = 'Bearer ' + token;
                const res = await fetch(API_BASE + path, opts);
                if (res.status === 401) { alert('Ù…Ø·Ù„ÙˆØ¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ø±Ù…Ø² Ù…Ù†ØªÙ‡ÙŠ'); throw new Error('unauth'); }
                const data = await res.json().catch(() => null);
                if (!res.ok) throw new Error((data && data.message) || res.statusText);
                return data;
            }

            // --- Auth / load flows ---
            $('loginBtn').addEventListener('click', async () => {
                try {
                    const username = $('username').value;
                    const password = $('password').value;
                    const res = await fetch(API_BASE + '/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
                    const json = await res.json();
                    if (!res.ok) { $('authMsg').textContent = json.message || 'Ø®Ø·Ø£'; return; }
                    token = json.token;
                    $('authMsg').textContent = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ ' + (json.user.display_name || json.user.username);
                    await loadServices();
                    await loadContracts();
                } catch (err) { console.error(err); alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); }
            });

            // Initialize on load
            loadServices();
            loadContracts();

            $('createUserBtn').addEventListener('click', async () => {
                const username = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:', 'sales1');
                if (!username) return;
                const password = prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:', 'password1');
                const role = prompt('Ø§Ù„Ø¯ÙˆØ± (sales, ops_manager, general_manager, client, admin):', 'sales');
                try {
                    await apiFetch('/users', { method: 'POST', body: JSON.stringify({ username, password, role, display_name: username }) });
                    alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
                } catch (err) { alert('Ø®Ø·Ø£: ' + err.message); }
            });

            async function loadServices() {
                const defaultServices = ['Ù†Ø¸Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ©', 'Ù†Ø¸Ø§ÙØ© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©', 'Ø·ÙˆØ§Ø±Ø¦', 'Ù†Ù‚Ù„ Ù†ÙØ§ÙŠØ§Øª', 'Ù†Ù‚Ù„ ÙƒÙØ±Ø§Øª', 'Ù†Ù‚Ù„ Ø£Ø®Ø´Ø§Ø¨'];
                try {
                    const srv = await apiFetch('/services', { method: 'GET' });
                    const serverNames = Array.isArray(srv) ? srv.map(s => s.name).filter(Boolean) : [];
                    const merged = [...defaultServices];
                    serverNames.forEach(n => { if (!merged.includes(n)) merged.push(n); });
                    const sel = $('serviceType'); sel.innerHTML = '';
                    merged.forEach(name => { const opt = document.createElement('option'); opt.value = name; opt.textContent = name; sel.appendChild(opt); });
                } catch (err) {
                    const sel = $('serviceType'); sel.innerHTML = '';
                    ['Ù†Ø¸Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ©', 'Ù†Ø¸Ø§ÙØ© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©', 'Ø·ÙˆØ§Ø±Ø¦', 'Ù†Ù‚Ù„ Ù†ÙØ§ÙŠØ§Øª', 'Ù†Ù‚Ù„ ÙƒÙØ±Ø§Øª', 'Ù†Ù‚Ù„ Ø£Ø®Ø´Ø§Ø¨'].forEach(name => {
                        const opt = document.createElement('option'); opt.value = name; opt.textContent = name; sel.appendChild(opt);
                    });
                }
            }

            async function loadContracts() {
                try {
                    const q = $('search').value || '';
                    const status = $('filter').value || '';
                    const params = new URLSearchParams();
                    if (q) params.set('q', q);
                    if (status) params.set('status', status);
                    const rows = await apiFetch('/contracts?' + params.toString(), { method: 'GET' });
                    renderContracts(rows || []);
                } catch (err) { console.error(err); }
            }

            // Format date to YYYY-MM-DD only (remove timestamp)
            function formatDate(dateStr) {
                if (!dateStr) return '-';
                // If it's an ISO string, take first 10 characters
                if (typeof dateStr === 'string' && dateStr.length >= 10) {
                    return dateStr.substring(0, 10);
                }
                return dateStr;
            }

            function renderContracts(rows) {
                // Store contracts globally for sorting
                contractsData = rows || [];

                const tbody = $('contractsTbody'); tbody.innerHTML = '';
                let active = 0, pending = 0;
                rows.forEach(c => {
                    if (c.status === 'active') active++;
                    if (c.status === 'pending') pending++;
                    const tr = document.createElement('tr');
                    const containerMapLink = c.container_location ? `<a href="https://www.google.com/maps?q=${c.container_location}" target="_blank">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©</a>` : '';
                    const pickupMapLink = c.pickup_location ? `<a href="https://www.google.com/maps?q=${c.pickup_location}" target="_blank">Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ­ØµÙŠÙ„</a>` : '';

                    // Format dates to show only YYYY-MM-DD
                    const fromDate = formatDate(c.from_date);
                    const toDate = formatDate(c.to_date);

                    tr.innerHTML = `
            <td>${c.id}</td>
            <td>${c.second_party || ''}</td>
            <td>${c.service_name || ''}</td>
            <td>${fromDate} â†’ ${toDate}</td>
            <td>${c.total_price || 0}</td>
            <td>${c.manager || ''}</td>
            <td>${c.collector || ''}</td>
            <td>
                <span class="chip ${c.status === 'active' ? 'active' : (c.status === 'pending' ? 'pending' : 'expired')}">
                ${c.status === 'active' ? 'Ù†Ø´Ø·' : (c.status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹' : 'Ù…Ù†ØªÙ‡ÙŠ')}
                </span>
            </td>
            <td>
              <div style="display:flex; gap:4px; flex-wrap:wrap; align-items:center;">
                  <button class="btn" onclick="openEdit('${c.id}')">Ø¹Ø±Ø¶/ØªØ¹Ø¯ÙŠÙ„</button>
                  <button class="btn small" onclick="updateStatus('${c.id}','active')" title="ØªÙØ¹ÙŠÙ„">âœ…</button>
                  <button class="btn small" onclick="updateStatus('${c.id}','pending')" title="Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹">â³</button>
                  <button class="btn small" onclick="updateStatus('${c.id}','expired')" title="Ø¥Ù†Ù‡Ø§Ø¡">ğŸ›‘</button>
              </div>
              <div style="margin-top:6px; font-size:0.8em;">${containerMapLink} ${pickupMapLink}</div>
            </td>
          `;
                    tbody.appendChild(tr);
                });
                $('countActive').textContent = active;
                $('countPending').textContent = pending;
            }

            // status update
            async function updateStatus(id, status) {
                if (!confirm('ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ' + (status === 'active' ? 'Ù†Ø´Ø·' : (status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹' : 'Ù…Ù†ØªÙ‡ÙŠ')) + 'ØŸ')) return;
                try {
                    await apiFetch('/contracts/' + encodeURIComponent(id), {
                        method: 'PUT',
                        body: JSON.stringify({ status: status })
                    });
                    await loadContracts();
                } catch (err) { alert('Ø®Ø·Ø£: ' + err.message); }
            }
            window.updateStatus = updateStatus;

            // open edit
            async function openEdit(id) {
                try {
                    // Fetch contract from API
                    const rows = await apiFetch('/contracts?q=' + id, { method: 'GET' });
                    const c = Array.isArray(rows) ? rows.find(r => r.id === id) : rows;

                    if (!c) return alert('Ø§Ù„Ø¹Ù‚Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');

                    // Safely set values with null checks
                    if ($('clientName')) $('clientName').value = c.second_party || '';
                    if ($('clientType')) $('clientType').value = c.client_type || 'ÙØ±Ø¯';

                    // If client details are missing in contract response, try to fetch client
                    if (c.client_id && (!c.city || !c.district)) {
                        try {
                            const client = await apiFetch('/clients/' + c.client_id);
                            if (client) {
                                if ($('city') && !c.city) $('city').value = client.city || '';
                                if ($('district') && !c.district) $('district').value = client.district || '';
                                // Update other client fields if needed
                            }
                        } catch (e) { console.warn('Could not fetch client details', e); }
                    } else {
                        if ($('city')) $('city').value = c.city || '';
                        if ($('district')) $('district').value = c.district || '';
                    }

                    if (c.service_name && $('serviceType')) {
                        const sel = $('serviceType');
                        if (![...sel.options].some(o => o.value === c.service_name)) {
                            const opt = document.createElement('option');
                            opt.value = c.service_name;
                            opt.textContent = c.service_name;
                            sel.appendChild(opt);
                        }
                        $('serviceType').value = c.service_name;
                    }

                    // Handle dates - ensure we format YYYY-MM-DD
                    const fmtDate = (d) => {
                        if (!d) return '';
                        // If it's a full ISO string, take first 10 chars
                        if (typeof d === 'string' && d.length >= 10) return d.substring(0, 10);
                        return d;
                    };

                    if ($('dateFrom')) $('dateFrom').value = fmtDate(c.from_date);
                    if ($('dateTo')) $('dateTo').value = fmtDate(c.to_date);

                    if ($('monthlyFee')) $('monthlyFee').value = c.monthly_fee || '';
                    if ($('totalPrice')) $('totalPrice').value = c.total_price || '';
                    if ($('manager')) $('manager').value = c.manager || '';
                    if ($('collector')) $('collector').value = c.collector || '';
                    if ($('status')) $('status').value = c.status || 'pending';
                    if ($('containerType')) $('containerType').value = c.container_type || 'Ø¨Ø±Ù…ÙŠÙ„';

                    // Location fields
                    if ($('containerLocation')) $('containerLocation').value = c.container_location || '';
                    if ($('pickupLocation')) $('pickupLocation').value = c.pickup_location || '';
                    if ($('location')) $('location').value = c.location || '';

                    if ($('duration')) $('duration').value = c.duration || 'Ø³Ù†ÙˆÙŠ';
                    if ($('paymentType')) $('paymentType').value = c.payment_type || 'Ø³Ù†ÙˆÙŠØ©';
                    if ($('signMethod')) $('signMethod').value = c.sign_method || 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';

                    // Terms handling
                    if ($('terms')) $('terms').value = c.terms || '';
                    if ($('termsSummary')) {
                        if (c.terms && c.terms.trim().length > 0) {
                            const firstLine = c.terms.split('\n')[0];
                            $('termsSummary').value = 'ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø´Ø±ÙˆØ·: ' + (firstLine.substring(0, 30) + '...');
                        } else {
                            $('termsSummary').value = '';
                        }
                    }

                    // Handle signing fields
                    if ($('firstParty')) $('firstParty').value = c.first_party || 'Ø´Ø±ÙƒØ© Ø¨ÙØª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª';
                    if ($('secondParty')) $('secondParty').value = c.second_party || c.client_name || '';
                    if ($('clientEmail')) $('clientEmail').value = c.client_email || '';
                    if ($('clientPhone')) $('clientPhone').value = c.client_phone || '';
                    if ($('collector')) $('collector').value = c.collector || ''; // Ensure collector is populated

                    updateGoogleLink('container', c.container_location);
                    updateGoogleLink('pickup', c.pickup_location);
                    $('formWrap').dataset.editing = c.id;
                    showElem($('formWrap'));
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } catch (err) {
                    console.error('Open edit error:', err);
                    alert('Ø®Ø·Ø£: ' + (err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                }
            }
            window.openEdit = openEdit;

            // save contract (create or update)
            $('saveContractBtn').addEventListener('click', async () => {
                try {
                    if (!token) return alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');

                    // Validate required fields
                    const clientName = $('clientName').value;
                    if (!clientName || clientName.trim() === '') {
                        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„');
                        return;
                    }


                    let contractId = $('formWrap').dataset.editing;
                    const isNew = !contractId;

                    let clientId;

                    // Only create a new client if this is a NEW contract
                    // For existing contracts, we'll get the client_id from the contract data
                    if (isNew) {
                        // Generate a client_id for new contracts (no database record needed)
                        clientId = 'client-' + Date.now();
                        // Let server generate contract ID
                        contractId = null;
                    } else {
                        // For editing, fetch the existing contract to get client_id
                        const existingContract = await apiFetch('/contracts?q=' + contractId, { method: 'GET' });
                        const contract = Array.isArray(existingContract) ? existingContract.find(c => c.id === contractId) : existingContract;
                        clientId = contract?.client_id;

                        if (!clientId) {
                            alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„');
                            return;
                        }

                        // Update client information when editing
                        // Only update if client_id is a valid integer (new data format)
                        // Skip if it's a string ID (legacy data)
                        if (clientId && !isNaN(parseInt(clientId))) {
                            try {
                                await apiFetch('/clients/' + clientId, {
                                    method: 'PUT',
                                    body: JSON.stringify({
                                        name: clientName.trim(),
                                        type: $('clientType').value || 'ÙØ±Ø¯',
                                        city: $('city')?.value || '',
                                        district: $('district')?.value || ''
                                    })
                                });
                            } catch (updateErr) {
                                console.warn('Failed to update client info:', updateErr);
                                // Continue anyway - contract update is more important
                            }
                        } else {
                            console.log('Skipping client update - legacy string ID:', clientId);
                        }
                    }


                    // Helper to handle date fields: send null if empty, otherwise value
                    const getDateVal = (id) => {
                        const val = $(id)?.value;
                        return val ? val : null;
                    };

                    // Build contract payload
                    const payload = {
                        id: contractId,
                        client_id: clientId, // Backend expects client_id
                        client_type: $('clientType')?.value || 'ÙØ±Ø¯',
                        service_name: $('serviceType')?.value || 'Ù†Ø¸Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ©',

                        from_date: getDateVal('dateFrom'),
                        to_date: getDateVal('dateTo'),

                        container_type: $('containerType')?.value || 'Ø¨Ø±Ù…ÙŠÙ„',
                        location: $('location')?.value || null, // Backend expects location

                        monthly_fee: parseFloat($('monthlyFee')?.value || 0),
                        total_price: parseFloat($('totalPrice')?.value || 0),
                        manager: $('manager')?.value || '',
                        status: $('status')?.value || 'pending',
                        sign_method: $('signMethod')?.value || 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
                        terms: $('terms')?.value || '',

                        // Backend fields from error log:
                        // file_url: COALESCE(?, file_url) -> handled by backend usually, we send null or undefined if not changing
                        client_email: $('clientEmail')?.value || '',

                        // Extra fields that might not be in backend but we send anyway just in case:
                        city: $('city')?.value || '',
                        district: $('district')?.value || '',
                        container_location: $('containerLocation')?.value || null,
                        pickup_location: $('pickupLocation')?.value || null,
                        duration: $('duration')?.value || 'Ø³Ù†ÙˆÙŠ',
                        payment_type: $('paymentType')?.value || 'Ø³Ù†ÙˆÙŠØ©',
                        first_party: $('firstParty')?.value || 'Ø´Ø±ÙƒØ© Ø¨ÙØª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª',
                        second_party: $('clientName')?.value || '',
                        client_phone: $('clientPhone')?.value || '',
                        collector: $('collector')?.value || '' // Sending it even if backend might ignore it
                    };

                    console.log('Saving contract payload:', payload);

                    if (!isNew) {
                        await apiFetch('/contracts/' + encodeURIComponent(contractId), { method: 'PUT', body: JSON.stringify(payload) });
                        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
                        delete $('formWrap').dataset.editing;
                    } else {
                        // For new contracts, let server generate ID or handle it. 
                        // We send payload without ID (or with null ID) if we want server to gen, 
                        // but our payload construction used contractId. 
                        // We will send payload with null ID and let server assign it.
                        if (payload.id === undefined || payload.id === null) delete payload.id;

                        const res = await apiFetch('/contracts', { method: 'POST', body: JSON.stringify(payload) });
                        alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­: ' + (res.id || ''));
                    }

                    hideElem($('formWrap'));
                    await loadContracts();
                } catch (err) {
                    console.error('Contract save error:', err);
                    const errorMessage = err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + errorMessage);
                }
            });

            $('cancelFormBtn').addEventListener('click', () => {
                hideElem($('formWrap'));
            });

            // ---------------- Google Maps paste-based picker ----------------

            function openMapModalFor(target) {
                // only allow when form visible
                if ($('formWrap').style.display === 'none') {
                    alert('Ø§ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø®Ø±Ø§Ø¦Ø· Google.');
                    return;
                }
                currentPickerTarget = target;
                $('selectedCoords').value = '';
                showElem($('mapModal'));
            }

            function openGoogleMapsWindow() {
                const url = 'https://www.google.com/maps';
                const w = window.open(url, '_blank', 'noopener');
                if (!w) alert('ØªØ¹Ø°Ø± ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®Ø±Ø§Ø¦Ø·. ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø¸Ø± Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©.');
            }

            async function pasteCoordsFromClipboard() {
                try {
                    const text = await navigator.clipboard.readText();
                    if (!text) { alert('Ø§Ù„Ø­Ø§ÙØ¸Ø© ÙØ§Ø±ØºØ© Ø£Ùˆ Ù„Ù… ØªØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙˆØµÙˆÙ„'); return; }
                    $('selectedCoords').value = text.trim();
                } catch (err) {
                    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø°Ù† Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø§ÙØ¸Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„.');
                }
            }

            // parse coordinates from Google Maps URL or from manual coordinate input
            function parseCoordsFromGoogleLinkOrText(input) {
                if (!input) return null;
                input = input.trim();

                // If input looks like direct lat,lng
                const simpleCoord = input.match(/(-?\d+(?:\.\d+)?)[,\s]+(-?\d+(?:\.\d+)?)/);
                if (simpleCoord) {
                    const lat = parseFloat(simpleCoord[1]), lng = parseFloat(simpleCoord[2]);
                    if (!isNaN(lat) && !isNaN(lng)) return lat.toFixed(6) + ',' + lng.toFixed(6);
                }

                // Try Google Maps @lat,lng,zoom (e.g. https://www.google.com/maps/@24.7136,46.6753,15z)
                let m = input.match(/@(-?\d+\.\d+),(-?\d+\.\d+),/);
                if (m) return parseFloat(m[1]).toFixed(6) + ',' + parseFloat(m[2]).toFixed(6);

                // Try q=lat,lng or /place/.../data=!3m1!4b1!4m5!...!3dLAT!4dLNG
                m = input.match(/[?&]q=([-.\d]+),\s*([-.\d]+)/);
                if (m) return parseFloat(m[1]).toFixed(6) + ',' + parseFloat(m[2]).toFixed(6);

                m = input.match(/!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/);
                if (m) return parseFloat(m[1]).toFixed(6) + ',' + parseFloat(m[2]).toFixed(6);

                // Try to find any lat,lng pair inside the URL
                m = input.match(/(-?\d+\.\d+),\s*(-?\d+\.\d+)/);
                if (m) return parseFloat(m[1]).toFixed(6) + ',' + parseFloat(m[2]).toFixed(6);

                // If not found, attempt to normalize formats with N/E/S/W (like 24.7136N,46.6753E)
                const normalized = normalizeCoordinates(input);
                if (normalized) return normalized;

                return null;
            }

            // reuse normalization function from prior logic (supports N/S/E/W and DMS)
            function normalizeCoordinates(input) {
                if (!input) return null;
                input = input.trim();
                input = input.replace(/[Â°â€²'â€³"]/g, ' ').replace(/\s+/g, ' ').trim();
                let parts = [];
                if (input.includes(',')) parts = input.split(',').map(s => s.trim());
                else {
                    const tokens = input.split(' ');
                    if (tokens.length >= 2) {
                        const mid = Math.ceil(tokens.length / 2);
                        parts = [tokens.slice(0, mid).join(' '), tokens.slice(mid).join(' ')];
                    } else return null;
                }
                function parseCoordStr(s, isLat) {
                    s = s.trim();
                    const dirMatch = s.match(/([NnSsEeWw])/);
                    const dir = dirMatch ? dirMatch[1].toUpperCase() : null;
                    s = s.replace(/[NnSsEeWw]/g, '').trim();
                    const nums = s.split(/[\s:]+/).map(x => parseFloat(x)).filter(x => !isNaN(x));
                    if (nums.length === 0) return null;
                    let val = null;
                    if (nums.length === 1) val = nums[0];
                    else val = Math.abs(nums[0]) + (nums[1] || 0) / 60 + (nums[2] || 0) / 3600;
                    if (dir) {
                        if (dir === 'S' || dir === 'W') val = -Math.abs(val);
                        else val = Math.abs(val);
                    }
                    if (isLat && Math.abs(val) > 90) return null;
                    if (!isLat && Math.abs(val) > 180) return null;
                    return val;
                }
                const lat = parseCoordStr(parts[0], true);
                const lng = parseCoordStr(parts[1], false);
                if (lat === null || lng === null) return null;
                return lat.toFixed(6) + ',' + lng.toFixed(6);
            }

            function confirmCoordsFromModal() {
                const raw = $('selectedCoords').value.trim();
                const coords = parseCoordsFromGoogleLinkOrText(raw);
                if (!coords) return alert('ØªØ¹Ø°Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ø®Ø±Ø§Ø¦Ø· Google Ø£Ùˆ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¨ØµÙŠØºØ© lat,lng Ø£Ùˆ Ø¨ØµÙŠØºØ© ØªØ­ØªÙˆÙŠ N/S/E/W.');
                if (currentPickerTarget === 'container') {
                    $('containerLocation').value = coords;
                    updateGoogleLink('container', coords);
                } else if (currentPickerTarget === 'pickup') {
                    $('pickupLocation').value = coords;
                    updateGoogleLink('pickup', coords);
                }
                closeMapModal();
            }

            function closeMapModal() {
                currentPickerTarget = null;
                hideElem($('mapModal'));
            }

            function updateGoogleLink(type, coordStr) {
                const link = (type === 'container') ? $('containerGoogleLink') : $('pickupGoogleLink');
                if (coordStr && coordStr.includes(',')) {
                    link.href = 'https://www.google.com/maps?q=' + encodeURIComponent(coordStr);
                    link.style.display = 'inline';
                } else {
                    link.href = '#';
                    link.style.display = 'none';
                }
            }

            // attach events
            $('pickContainerBtn').addEventListener('click', () => openMapModalFor('container'));
            $('pickPickupBtn').addEventListener('click', () => openMapModalFor('pickup'));
            $('openGoogleMapsBtn').addEventListener('click', openGoogleMapsWindow);
            $('pasteCoordsBtn').addEventListener('click', pasteCoordsFromClipboard);
            $('confirmCoordsBtn').addEventListener('click', confirmCoordsFromModal);
            $('cancelCoordsBtn').addEventListener('click', closeMapModal);

            // Terms modal bindings
            const safe = (id, fn) => { const el = $(id); if (el) el.addEventListener('click', fn); };
            safe('manageTermsBtn', openTermsModal);
            // allow keyboard open
            if ($('manageTermsBtn')) $('manageTermsBtn').addEventListener('keydown', (e) => { if (e.key === 'Enter') openTermsModal(); });
            safe('termsCloseBtn', closeTermsModal);
            safe('termsRefreshBtn', loadTerms);
            // select/deselect helpers (UI elements exist in modal)
            const selAll = () => document.querySelectorAll('#termsList .termCheckbox').forEach(cb => cb.checked = true);
            const deselectAll = () => document.querySelectorAll('#termsList .termCheckbox').forEach(cb => cb.checked = false);
            if ($('termsSelectAllBtn')) $('termsSelectAllBtn').addEventListener('click', selAll);
            if ($('termsDeselectAllBtn')) $('termsDeselectAllBtn').addEventListener('click', deselectAll);

            // other UI wiring
            $('refreshBtn').addEventListener('click', loadContracts);
            // Ensure search is instant
            $('search').addEventListener('input', () => {
                console.log('Search input detected');
                loadContracts();
            });
            $('filter').addEventListener('change', loadContracts);

            $('newContractBtn').addEventListener('click', () => {
                delete $('formWrap').dataset.editing;

                // Clear all form fields safely
                const fieldsToClear = [
                    'clientName', 'city', 'district', 'location', 'dateFrom', 'dateTo',
                    'monthlyFee', 'totalPrice', 'manager', 'collector', 'terms', 'termsSummary',
                    'containerLocation', 'pickupLocation', 'clientType', 'serviceType',
                    'containerType', 'duration', 'paymentType', 'signMethod',
                    'clientEmail', 'clientPhone'
                ];

                fieldsToClear.forEach(id => {
                    const el = $(id);
                    if (el) {
                        if (el.tagName === 'SELECT') {
                            // Set select to first option instead of empty
                            el.selectedIndex = 0;
                        } else {
                            el.value = '';
                        }
                    }
                });

                // Set default values
                if ($('status')) $('status').value = 'pending';
                if ($('clientType')) $('clientType').value = 'ÙØ±Ø¯';
                if ($('serviceType')) $('serviceType').value = 'Ù†Ø¸Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ©';
                if ($('containerType')) $('containerType').value = 'Ø¨Ø±Ù…ÙŠÙ„';
                if ($('duration')) $('duration').value = 'Ø³Ù†ÙˆÙŠ';
                if ($('paymentType')) $('paymentType').value = 'Ø³Ù†ÙˆÙŠØ©';
                if ($('signMethod')) $('signMethod').value = 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';

                updateGoogleLink('container', '');
                updateGoogleLink('pickup', '');
                showElem($('formWrap'));
                hideElem($('mapModal'));
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // Navigation System
            document.querySelectorAll('.nav button[data-view]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    switchView(view);

                    // Update active button
                    document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            function switchView(view) {
                // Hide all views
                ['contractsArea', 'reportsArea'].forEach(id => {
                    const el = $(id);
                    if (el) el.style.display = 'none';
                });

                // Show selected view
                const viewEl = $(view + 'Area');
                if (viewEl) viewEl.style.display = 'block';

                // Load data for the view
                switch (view) {
                    case 'contracts':
                        loadContracts();
                        break;
                    case 'reports':
                        loadReports();
                        break;
                }
            }

            // Reports and Statistics - Enhanced with Manager & Collector Performance
            async function loadReports() {
                try {
                    const contracts = await apiFetch('/contracts', { method: 'GET' });
                    const clients = await apiFetch('/clients', { method: 'GET' });

                    generateReports(contracts || [], clients || []);
                } catch (err) {
                    console.error('Error loading reports:', err);
                    generateReports([], []);
                }
            }

            function generateReports(contracts, clients) {
                // Total contracts
                $('reportTotalContracts').textContent = contracts.length;

                // Total revenue
                const totalRevenue = contracts.reduce((sum, c) => sum + (parseFloat(c.total_price) || 0), 0);
                $('reportTotalRevenue').textContent = totalRevenue.toLocaleString('ar-SA');

                // Total clients (unique)
                const uniqueClients = new Set(contracts.map(c => c.second_party).filter(Boolean));
                $('reportTotalClients').textContent = uniqueClients.size;

                // Average contract value
                const avgContract = contracts.length > 0 ? totalRevenue / contracts.length : 0;
                $('reportAvgContract').textContent = avgContract.toLocaleString('ar-SA', { maximumFractionDigits: 0 });

                // Status distribution
                const activeCount = contracts.filter(c => c.status === 'active').length;
                const pendingCount = contracts.filter(c => c.status === 'pending').length;
                const expiredCount = contracts.filter(c => c.status === 'expired').length;

                $('reportActiveCount').textContent = activeCount;
                $('reportPendingCount').textContent = pendingCount;
                $('reportExpiredCount').textContent = expiredCount;

                // Manager Performance Statistics
                const managerStats = {};
                contracts.forEach(c => {
                    const manager = c.manager || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    if (!managerStats[manager]) {
                        managerStats[manager] = { count: 0, total: 0, monthlyFees: 0 };
                    }
                    managerStats[manager].count++;
                    managerStats[manager].total += parseFloat(c.total_price) || 0;
                    managerStats[manager].monthlyFees += parseFloat(c.monthly_fee) || 0;
                });

                const managerStatsTbody = $('managerStatsTbody');
                if (managerStatsTbody) {
                    managerStatsTbody.innerHTML = '';
                    const sortedManagers = Object.entries(managerStats)
                        .sort((a, b) => b[1].total - a[1].total);

                    sortedManagers.forEach(([name, stats]) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
              <td><strong>${name}</strong></td>
              <td>${stats.count}</td>
              <td>${stats.total.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</td>
              <td>${stats.monthlyFees.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„/Ø´Ù‡Ø±</td>
            `;
                        managerStatsTbody.appendChild(tr);
                    });
                }

                // Collector Performance Statistics
                const collectorStats = {};
                contracts.forEach(c => {
                    const collector = c.collector || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    if (!collectorStats[collector]) {
                        collectorStats[collector] = { count: 0, total: 0, monthlyFees: 0 };
                    }
                    collectorStats[collector].count++;
                    collectorStats[collector].total += parseFloat(c.total_price) || 0;
                    collectorStats[collector].monthlyFees += parseFloat(c.monthly_fee) || 0;
                });

                const collectorStatsTbody = $('collectorStatsTbody');
                if (collectorStatsTbody) {
                    collectorStatsTbody.innerHTML = '';
                    const sortedCollectors = Object.entries(collectorStats)
                        .sort((a, b) => b[1].total - a[1].total);

                    sortedCollectors.forEach(([name, stats]) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
              <td><strong>${name}</strong></td>
              <td>${stats.count}</td>
              <td>${stats.total.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</td>
              <td>${stats.monthlyFees.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„/Ø´Ù‡Ø±</td>
            `;
                        collectorStatsTbody.appendChild(tr);
                    });
                }

                // Top 5 clients by contract value
                const clientStats = {};
                contracts.forEach(c => {
                    const clientName = c.second_party || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    if (!clientStats[clientName]) {
                        clientStats[clientName] = { count: 0, total: 0 };
                    }
                    clientStats[clientName].count++;
                    clientStats[clientName].total += parseFloat(c.total_price) || 0;
                });

                const topClients = Object.entries(clientStats)
                    .sort((a, b) => b[1].total - a[1].total)
                    .slice(0, 5);

                const topClientsTbody = $('topClientsTbody');
                if (topClientsTbody) {
                    topClientsTbody.innerHTML = '';
                    topClients.forEach(([name, stats]) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
              <td>${name}</td>
              <td>${stats.count}</td>
              <td>${stats.total.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</td>
            `;
                        topClientsTbody.appendChild(tr);
                    });
                }
            }

            $('exportCsvBtn').addEventListener('click', () => {
                alert('ØªØµØ¯ÙŠØ± CSV ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Client-side only)');
            });

            // helper to generate contract id: CN-YYYY-N
            function generateContractId() {
                const now = new Date();
                const yr = now.getFullYear();

                // Find max ID for this year
                const contracts = getStoredData(STORAGE_KEY_CONTRACTS);
                const prefix = `CN-${yr}-`;
                let maxSeq = 0;

                contracts.forEach(c => {
                    if (c.id && c.id.startsWith(prefix)) {
                        const seq = parseInt(c.id.replace(prefix, ''));
                        if (!isNaN(seq) && seq > maxSeq) maxSeq = seq;
                    }
                });

                return `${prefix}${maxSeq + 1}`;
            }

            // helper to generate secure signing token
            function generateSigningToken(contractId, clientEmail) {
                const timestamp = Date.now();
                const random = Math.random().toString(36).substring(2);
                const data = `${contractId}:${clientEmail}:${timestamp}:${random}`;
                // Return full Base64 without truncation
                return btoa(data);
            }

            // helper to create secure signing link
            function createSigningLink(contractId, clientEmail, token) {
                const baseUrl = window.location.origin;
                // Encode token to be URL-safe
                return `${baseUrl}/sign/${contractId}/${encodeURIComponent(token)}`;
            }

            // Test server connection
            async function testServerConnection() {
                try {
                    const response = await fetch('/health');
                    const data = await response.json();
                    console.log('âœ… Server connected:', data);
                    return true;
                } catch (error) {
                    console.error('âŒ Server connection failed:', error);
                    return false;
                }
            }

            // Test server connection on page load
            // Test server connection on page load - Disabled for client-side version
            // testServerConnection();

            // update second party field when client name changes
            $('clientName').addEventListener('input', () => {
                if ($('secondParty')) {
                    $('secondParty').value = $('clientName').value || '';
                }
            });

            // Contract signing modal functions
            function openSigningModal(contractId = null, clientEmail = null) {
                const modal = $('signingModal');
                if (!modal) return;

                // Reset modal state
                $('sendMethod').value = 'link';
                hideAllSendSections();
                $('linkSection').style.display = 'block';

                // Auto-generate link if we have contract data
                if (contractId && clientEmail) {
                    const token = generateSigningToken(contractId, clientEmail);
                    const link = createSigningLink(contractId, clientEmail, token);
                    $('signingLink').value = link;
                }

                showElem(modal);
            }

            function closeSigningModal() {
                hideElem($('signingModal'));
            }

            function hideAllSendSections() {
                ['linkSection', 'emailSection', 'whatsappSection', 'fileSection'].forEach(id => {
                    const el = $(id);
                    if (el) el.style.display = 'none';
                });
            }

            // Send method change handler
            $('sendMethod').addEventListener('change', (e) => {
                hideAllSendSections();
                const method = e.target.value;
                const section = $(method + 'Section');
                if (section) {
                    section.style.display = 'block';

                    // Auto-fill email from form if available
                    if (method === 'email' && $('clientEmail')?.value) {
                        $('signingEmail').value = $('clientEmail').value;
                    }

                    // Auto-fill phone from form if available
                    if (method === 'whatsapp' && $('clientPhone')?.value) {
                        $('whatsappNumber').value = $('clientPhone').value;
                        updateWhatsappMessage();
                    }
                }
            });

            // Copy link handler
            $('copyLinkBtn').addEventListener('click', () => {
                const linkInput = $('signingLink');
                if (!linkInput?.value) {
                    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù„Ù„Ù†Ø³Ø®');
                    return;
                }

                navigator.clipboard.writeText(linkInput.value).then(() => {
                    alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­');
                }).catch(() => {
                    // Fallback for older browsers
                    linkInput.select();
                    document.execCommand('copy');
                    alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­');
                });
            });

            // Update whatsapp message
            function updateWhatsappMessage() {
                const clientName = $('clientName')?.value || 'Ø§Ù„Ø¹Ù…ÙŠÙ„';
                const companyName = $('firstParty')?.value || 'Ø´Ø±ÙƒØ© Ø¨ÙØª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª';
                const link = $('signingLink')?.value || '';

                const message = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${clientName}ØŒ\n\nØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ù‚Ø¯ÙƒÙ… Ù…Ø¹ ${companyName} Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙˆÙ‚ÙŠØ¹.\n\nÙŠÙ…ÙƒÙ†ÙƒÙ… ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† ÙˆÙ…Ø¨Ø§Ø´Ø± Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ:\n${link}\n\nØ§Ù„Ø±Ø§Ø¨Ø· ÙØ±ÙŠØ¯ ÙˆÙ…Ø®ØµØµ Ù„ÙƒÙ… ÙÙ‚Ø· Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹.\n\nÙ…Ø¹ ØªØ­ÙŠØ§ØªØŒ\n${companyName}`;

                if ($('whatsappMessage')) {
                    $('whatsappMessage').value = message;
                }
            }

            $('whatsappNumber').addEventListener('input', updateWhatsappMessage);

            // Send for signing button
            $('sendForSigningBtn').addEventListener('click', () => {
                const clientName = $('clientName')?.value;
                const clientEmail = $('clientEmail')?.value;
                const editingId = $('formWrap').dataset.editing;

                if (!clientName || !clientEmail) {
                    alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹');
                    return;
                }

                if (!editingId) {
                    alert('ÙŠØ±Ø¬Ù‰ Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªÙˆÙ‚ÙŠØ¹');
                    return;
                }

                const contractId = editingId;
                openSigningModal(contractId, clientEmail);
            });

            // Generate contract file button
            $('generateContractFileBtn').addEventListener('click', async () => {
                const clientName = $('clientName')?.value;
                if (!clientName) {
                    alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                    return;
                }

                // Open modal with file section
                openSigningModal();
                $('sendMethod').value = 'file';
                hideAllSendSections();
                $('fileSection').style.display = 'block';
            });

            // Confirm send button
            $('confirmSendBtn').addEventListener('click', async () => {
                const method = $('sendMethod').value;
                const clientName = $('clientName')?.value;
                const clientEmail = $('clientEmail')?.value;
                const authMethod = $('authMethod').value;

                try {
                    switch (method) {
                        case 'link':
                            await handleLinkGeneration();
                            break;
                        case 'email':
                            await handleEmailSending();
                            break;
                        case 'whatsapp':
                            await handleWhatsappSending();
                            break;
                        case 'file':
                            await handleFileGeneration();
                            break;
                    }

                    alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­');
                    closeSigningModal();

                } catch (error) {
                    console.error('Sending error:', error);
                    alert('Ø®Ø·Ø£: ' + (error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'));
                }
            });

            async function handleLinkGeneration() {
                const link = $('signingLink').value;
                if (!link) {
                    throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù…ØªØ§Ø­');
                }

                // Here you would save the signing request to your backend
                console.log('Generated signing link:', link);
            }

            async function handleEmailSending() {
                const email = $('signingEmail').value;
                const message = $('emailMessage').value;

                if (!email) {
                    throw new Error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
                }

                // Here you would call your email service
                console.log('Sending email to:', email, 'Message:', message);
            }

            async function handleWhatsappSending() {
                const phone = $('whatsappNumber').value;
                const message = $('whatsappMessage').value;

                if (!phone) {
                    throw new Error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„');
                }

                // Create WhatsApp link
                const whatsappLink = `https://wa.me/${phone.replace(/[^\d]/g, '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappLink, '_blank');

                console.log('WhatsApp link:', whatsappLink);
            }

            async function handleFileGeneration() {
                const format = $('fileFormat').value;
                const includeTerms = $('includeTerms').checked;
                const includeSignatures = $('includeSignatures').checked;
                const includeQrCode = $('includeQrCode').checked;

                // Here you would generate the actual file
                console.log('Generating file:', {
                    format,
                    includeTerms,
                    includeSignatures,
                    includeQrCode
                });

                // Placeholder for file generation
                alert('Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù ÙˆØªØ­Ù…ÙŠÙ„Ù‡...');
            }

            // Cancel signing button
            $('cancelSigningBtn').addEventListener('click', closeSigningModal);

            // expose some helpers for console if needed
            window.openEdit = openEdit;
            window.updateStatus = updateStatus;

            // ---------------- Terms manager ----------------

            const LOCAL_TERMS_KEY = 'local_terms_v1';

            const defaultTerms = [
                {
                    name: 'Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù‚Ø¯ ÙƒØ§Ù…Ù„ (Ù…Ø«Ø§Ù„)',
                    type: 'text',
                    content: `Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù‚Ø¯

Ù¡Ù¥ / Ù¡Ù¡ / Ù¢Ù Ù¢Ù¥Ù…

Ù…Ø­ØµÙ„ / Ø¹Ù„Ù‰ Ù…Ø­Ø³Ù† Ø³ÙˆÙ‚ / Ø¹Ù„Ù‰ Ù…Ø­Ø³Ù†

Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯

Ø¹Ù‚Ø¯ Ø§ØªÙØ§Ù‚ Ù†Ù‚Ù„ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©

Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©

Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ (3356)

Ø¹Ù†ÙˆØ§Ù†Ù‡Ø§: (Ø­Ø¬Ù„Ø© ) Ø¥Ø´Ø§Ø±Ø© Ø¨Ø§Ø­Øµ Ø®Ù„Ù Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¬Ø±Ø¨ÙˆØ¹

Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø±Ù‚Ù… : ÛµÛ¸ÛµÛ°Û°Û±Û¹Û¹Û¸Û¹ ) Ø¬ÙˆØ§Ù„ / Ù Ù¥Ù¥Ù¢Û²Û°Û°Û¹Û³Û±/Û°Û°Û³Û·Û·Û·Û±Û±Û°Û¹

Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„: Ø´Ø±ÙƒØ© Ø¨ÙØª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª Ù‡Ø§ØªÙ Ø±Ù‚Ù… : Û²Û²Û·Ù¨Ù¦Ù¦Ù¦-Û±Û· - ØªØ­ÙˆÙŠÙ„Ø© (Û±Û°Û°

Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ: Ù…Ø¤Ø³Ø³Ù‡ Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø°ÙˆÙ‚ Ù„Ù„ØªØ¬Ø§Ø±Ù‡

Ø¨Ø±ÙŠØ¯ Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ : BAFT-EST @HOTMAIL.COM

Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠ Ø±Ù‚Ù… (Ù¥Ù¨Ù¥Ù¥Ù£Ù§Ù¡Ù¢Ù¦Ù£) Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ­Ø¯ (Ù§Ù Ù£Ù§Ù©Ù§Ù¤Ù¥Ù§Ù¨).

ÙˆÙŠÙ…Ø«Ù„Ù‡Ø§ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ : Ø¬Ø§Ø¨Ø± Ù…ÙØ±Ø­ Ø¹Ù„Ù‰ Ù‡Ø±ÙˆØ¨ÙŠ ) Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ (Û±Û°Û°Û³Ù Ù¨Û²Û³Û¹Û¹) ØŒ Ø¬ÙˆØ§Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø±Ù‚Ù… (Û°Û°Û·Û¸Û·Ù Û±Û°Û°Û·)

Ø§Ù„Ø¹Ù†ÙˆØ§Ù† : Ø§Ø­Ø¯ Ø±ÙÙŠØ¯Ù‡ / Ø­ÙŠ Ø§Ù„Ø²Ù‡ÙˆØ± ) Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ© (-) Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ (-).

ÙˆØ¨Ø¹Ø¯ Ø£Ù† Ø£Ù‚Ø± Ø§Ù„Ø·Ø±ÙØ§Ù† Ø¨Ø£Ù‡Ù„ÙŠØªÙ‡Ù…Ø§ Ø§Ù„Ø´Ø±Ø¹ÙŠØ© ÙˆØ§Ù„Ù†Ø¸Ø§Ù…ÙŠØ© Ù„Ù„ØªØ¹Ø§Ù‚Ø¯ ÙˆØ§Ù„ØªØµØ±Ù Ø§Ù„Ù„Ù‚Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¢ØªÙŠ:
1- ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ Ø¨Ù†Ù‚Ù„ ÙˆØªØ±Ø­ÙŠÙ„ Ù…Ø§ ÙŠÙ†ØªØ¬Ù‡ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…Ù† Ù†Ù‚Ø§Ø¨Ø§Øª Ø¨ÙˆØ§Ø³Ø·Ø© Ø¹Ù…Ø§Ù„Ù‡ ÙˆØ§Ù„ÙŠØ§ØªÙ‡ ÙˆÙ…Ø¹Ù†Ø§ØªÙ‡ ÙˆØ§Ù„ØªØ®Ù„Øµ Ù…Ù†Ù‡Ø§ Ø¨ØªØ±Ø­ÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø±Ù…Ù‰ Ø§Ù„Ø¹Ø§Ù….

ÙŠØ¯ÙØ¹ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ Ø£Ø¬Ø±Ø© Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ø¯Ø§ÙŠØ© ÙƒÙ„ Ø´Ù‡Ø± Ù…Ù‚Ø¯Ù…Ø§ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¶ÙˆØ­ÙŠÙ„ØªØ²Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ Ø¨ØªØ£Ù…ÙŠÙ† Ø­Ø§ÙˆÙŠØ© Ù…Ù‚Ø§Ø³ (Ù…Ø´ØªØ±Ùƒ) ÙˆÙ†Ù‚Ù„ Ù…Ø§ Ø¨Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© ÙÙ‚Ø· .

ÙŠÙ„ØªØ²Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¨ÙˆØ¶Ø¹ Ù…Ø§ ÙŠÙ†ØªØ¬Ù‡ Ù…Ù† Ù†ÙØ§ÙŠØ§Øª ÙÙŠ Ø£ÙƒÙŠØ§Ø³ Ù…Ø­ÙƒÙ…Ø© ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¬ÙŠØ¯Ø§ Ù„Ù…Ù†Ø¹ ØªØ±Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù„Ø© Ø§Ù„Ø¨Ù„Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ : Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯

Ø¹Ù†Ø¯ ÙˆØ¶Ø¹Ù‡Ø§ Ø£Ùˆ Ù†Ù‚Ù„Ù‡Ø§ ÙˆØ°Ù„Ùƒ Ø­ÙØ§Ø¸Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§ÙØ© Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØµØ­Ø© Ø§Ù„Ø¨ÙŠØ¦Ø© .

Ù‚ÙŠÙ…Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø´Ù‡Ø±ÙŠØ§ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¨Ù…Ø¨Ù„Øº (Û±Û°Û°) ÙÙ‚Ø· Ù…Ø§Ø¦Ø© Ø±ÙŠØ§Ù„ ØŒ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (Ù¡Ù¥) Ø¨Ù…Ø¨Ù„Øº (Ù¥))

ÙÙ‚Ø· Ø®Ù…Ø³Ø© Ø¹Ø´Ø±Ø© Ø±ÙŠØ§Ù„ Ø¨Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ù‡Ø±ÙŠ Ù…Ø¹ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (Û±Û±Û¥) ÙÙ‚Ø· Ù…Ø§Ø¦Ø© ÙˆØ®Ù…Ø³Ø© Ø¹Ø´Ø±Ø© Ø±ÙŠØ§Ù„ Ø´Ù‡Ø±ÙŠ

Ø§Ø­Ù…Ø¯

Î˜

Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø«Ø§Ù„Ø« : Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯

Ø¹Ù„Ù…Ø§ Ø¨Ø£Ù† Ø´Ø±ÙƒØ© Ø¨Ù‚Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ (Û³Û±Û²Û±Û¹Û·Ù¥Û´Û²Û·Û°Û°Û°Û°Û³)

Ù‡Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ (Ø³Ù†Ø©) Ù…Ù† ØªØ§Ø±ÙŠØ® Û²Û°Û²Ûµ/Û±Û±/Û°Û±Ù… ÙŠØªØ¬Ø¯Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø§Ù„Ù… ÙŠØ´Ø¹Ø± Ø£ÙŠ Ù…Ù† Ø§Ù„Ø·Ø±ÙÙŠÙ† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø¨Ø¹Ø¯Ù… Ø±ØºØ¨ØªÙ‡ ÙÙŠ Ø§Ù„ØªØ¬Ø¯ Ù‚Ø¨Ù„ Ø´Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ù†Ù‡Ø§ÙŠØ© Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙÙŠ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø·Ø±ÙÙŠÙ†

Ø­Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¨Ù„Ø§Øº Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø§Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù…ÙˆØ¬Ø¨ Ø¥Ø´Ø¹Ø§Ø± ÙƒØªØ§Ø¨ÙŠ ÙŠØ±Ø³Ù„ Ø¹Ù„Ù‰ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© . ÙŠÙƒÙˆÙ† Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø·Ø±ÙÙŠÙ† Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø§Ù„ÙŠ ÙˆØ§Ù„ØªØ­ÙŠØ© Ù„Ù„Ø´Ø±ÙƒØ© ÙˆØ®Ù„Ø§Ù Ø°Ù„Ùƒ ÙØ¥Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ ØºÙŠØ± Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø°Ù„Ùƒ ØªÙ… ØªØ­Ø±ÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ù† Ù†Ø³Ø®ØªÙŠÙ† Ù„ÙƒÙ„ Ù…Ù† Ø§Ù„Ø·Ø±ÙÙŠÙ† Ù†Ø³Ø®Ø©ØŒ ÙˆÙ„ÙƒÙ… Ø¬Ø²ÙŠÙ„ Ø§Ù„Ø´ÙƒØ± .

Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„

Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ

Ø´Ø±ÙƒØ© Ø¨ÙØª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª

Ù…ÙˆØ³Ø³Ù‡ Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø°ÙˆÙ‚ Ù„Ù„ØªØ¬Ø§Ø±Ù‡

Ù…Ù„Ø§Ø­Ø¸Ù‡ / Ø§Ù„Ø¹Ù…Ø± Ù„Ø§ ÙŠØ¹ØªÙ…Ø¯ Ø§Ù„Ø§ Ø¨Ø§Ù„Ø®ØªÙ…`
                },
                { name: 'Ø§Ù„Ø¨Ù†Ø¯: Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ùˆ Ø§Ù„Ø¯ÙØ¹', type: 'text', content: 'Ù‚ÙŠÙ…Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø´Ù‡Ø±ÙŠØ§ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¨Ù…Ø¨Ù„Øº (Û±Û°Û°) ÙÙ‚Ø·...' },
                { name: 'Ø§Ù„Ø¨Ù†Ø¯: Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯', type: 'text', content: 'Ù…Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ (Ø³Ù†Ø©) Ù…Ù† ØªØ§Ø±ÙŠØ® ...' }
            ];

            // localStorage helpers
            function loadLocalTerms() {
                try {
                    const raw = localStorage.getItem(LOCAL_TERMS_KEY);
                    if (!raw) return defaultTerms.slice();
                    return JSON.parse(raw);
                } catch (e) { return defaultTerms.slice(); }
            }
            function saveLocalTerms(arr) {
                try { localStorage.setItem(LOCAL_TERMS_KEY, JSON.stringify(arr)); } catch (e) { console.warn('local save failed', e); }
            }

            // API wrapper with fallback to local storage
            async function getTerms() {
                try {
                    const rows = await apiFetch('/terms', { method: 'GET' });
                    if (Array.isArray(rows)) return rows;
                } catch (err) {
                    // fallback silently
                }
                return loadLocalTerms();
            }
            async function createTerm(term) {
                try {
                    const created = await apiFetch('/terms', { method: 'POST', body: JSON.stringify(term) });
                    if (created) return created;
                } catch (err) {
                    // fallback to local
                }
                const local = loadLocalTerms();
                const id = Date.now().toString(36);
                const item = Object.assign({ id }, term);
                local.push(item);
                saveLocalTerms(local);
                return item;
            }
            async function updateTerm(id, term) {
                try {
                    const updated = await apiFetch('/terms/' + encodeURIComponent(id), { method: 'PUT', body: JSON.stringify(term) });
                    if (updated) return updated;
                } catch (err) {
                    // fallback local
                }
                const local = loadLocalTerms();
                const idx = local.findIndex(t => String(t.id) === String(id) || String(t._id) === String(id));
                if (idx >= 0) { local[idx] = Object.assign({}, local[idx], term); saveLocalTerms(local); return local[idx]; }
                return null;
            }
            async function deleteTermById(id) {
                try {
                    await apiFetch('/terms/' + encodeURIComponent(id), { method: 'DELETE' });
                    return true;
                } catch (err) {
                    // fallback local
                }
                let local = loadLocalTerms();
                local = local.filter(t => !(String(t.id) === String(id) || String(t._id) === String(id)));
                saveLocalTerms(local);
                return true;
            }

            const termsModal = $('termsModal');
            const termsList = $('termsList');
            const termId = $('termId');
            const termName = $('termName');
            const termType = $('termType');
            const termContent = $('termContent');
            const termContentLabel = $('termContentLabel');

            async function openTermsModal() {
                // allow opening modal even if form is hidden (convenience)
                $('termId').value = '';
                $('termName').value = '';
                $('termType').value = 'text';
                $('termContent').value = '';
                showElem(termsModal);
                await loadTerms();
            }

            function closeTermsModal() {
                hideElem(termsModal);
            }

            async function ensureDefaultsOnServer() {
                // try server, if fails populate local storage with defaults
                try {
                    const server = await apiFetch('/terms', { method: 'GET' });
                    if (!Array.isArray(server) || server.length === 0) {
                        try {
                            for (const t of defaultTerms) await apiFetch('/terms', { method: 'POST', body: JSON.stringify(t) });
                            return;
                        } catch (e) {
                            // no-op
                        }
                    } else {
                        return;
                    }
                } catch (err) {
                    // ignore
                }
                const local = loadLocalTerms();
                if (!local || local.length === 0) saveLocalTerms(defaultTerms.slice());
            }

            async function loadTerms() {
                termsList.innerHTML = '<div class="muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
                try {
                    await ensureDefaultsOnServer();
                    const rows = await getTerms();
                    renderTermsList(Array.isArray(rows) ? rows : []);
                } catch (err) {
                    console.warn('terms load failed, showing local defaults:', err);
                    renderTermsList(loadLocalTerms());
                    const note = document.createElement('div');
                    note.className = 'muted';
                    note.style.marginTop = '8px';
                    note.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… â€” Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ø­Ù„ÙŠØ§Ù‹.';
                    termsList.insertBefore(note, termsList.firstChild);
                }
            }

            // UI state persistence for selections so modal "remembers" choices
            const TERMS_UI_KEY = 'terms_ui_state_v1';
            function loadTermsUIState() {
                try { return JSON.parse(localStorage.getItem(TERMS_UI_KEY) || '{}'); } catch (e) { return {}; }
            }
            function saveTermsUIState(state) {
                try { localStorage.setItem(TERMS_UI_KEY, JSON.stringify(state || {})); } catch (e) { console.warn('saveTermsUIState failed', e); }
            }

            // renderTermsList - FIXED VERSION with proper state restoration
            function renderTermsList(rows) {
                if (!rows || rows.length === 0) { termsList.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>'; return; }
                const uiState = loadTermsUIState();
                termsList.innerHTML = '';
                rows.forEach(t => {
                    const wrapper = document.createElement('div');
                    wrapper.style.borderBottom = '1px solid #eef4ff';
                    wrapper.style.padding = '8px 4px';
                    const id = String(t.id || t._id || Math.random().toString(36).slice(2));

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.dataset.id = id;
                    checkbox.className = 'termCheckbox';
                    checkbox.style.marginLeft = '8px';
                    checkbox.dataset.content = t.content || '';

                    // Restore checked state from UI state
                    if (uiState[id] && uiState[id].checked) checkbox.checked = true;

                    const title = document.createElement('span');
                    title.textContent = t.name;
                    title.style.fontWeight = '600';
                    title.style.cursor = 'pointer';
                    title.onclick = () => {
                        loadTermIntoEditor(t);
                        // also mark selected in UI and sync to form
                        const st = loadTermsUIState();
                        st[id] = st[id] || {};
                        st[id].checked = true;
                        saveTermsUIState(st);
                        checkbox.checked = true;
                        updateTermsFromUI();
                    };

                    wrapper.appendChild(checkbox);
                    wrapper.appendChild(title);

                    if (t.type === 'selection' && t.content) {
                        const opts = t.content.split(/\r?\n/).filter(Boolean);
                        const sel = document.createElement('select');
                        sel.style.marginRight = '8px';
                        opts.forEach(o => { const op = document.createElement('option'); op.value = o; op.textContent = o; sel.appendChild(op); });

                        // Restore selected value from UI state
                        if (uiState[id] && uiState[id].selected && opts.includes(uiState[id].selected)) {
                            sel.value = uiState[id].selected;
                        } else if (opts.length) {
                            // Auto-select first option if nothing selected
                            if (uiState[id] && uiState[id].autoSelectFirst) {
                                sel.value = opts[0];
                            }
                        }

                        sel.addEventListener('change', () => {
                            const st = loadTermsUIState();
                            st[id] = st[id] || {};
                            st[id].selected = sel.value;
                            st[id].checked = true;
                            saveTermsUIState(st);
                            checkbox.checked = true;
                            updateTermsFromUI();
                        });

                        wrapper.appendChild(sel);
                    }

                    checkbox.addEventListener('change', () => {
                        const st = loadTermsUIState();
                        st[id] = st[id] || {};
                        st[id].checked = checkbox.checked;
                        saveTermsUIState(st);
                        updateTermsFromUI();
                    });

                    const previewBtn = document.createElement('button');
                    previewBtn.className = 'btn';
                    previewBtn.style.marginRight = '8px';
                    previewBtn.textContent = 'Ø¹Ø±Ø¶';
                    previewBtn.onclick = () => { alert(t.content || '(Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰)'); };
                    wrapper.appendChild(previewBtn);

                    termsList.appendChild(wrapper);
                });
                // refresh form values from current UI immediately after render
                updateTermsFromUI();
            }

            // load term into editor function
            function loadTermIntoEditor(t) {
                if (!t) return;
                const id = String(t.id || t._id || '');
                if (id) $('termId').value = id;
                if (t.name) $('termName').value = t.name;
                if (t.type) $('termType').value = t.type;

                // Set content in Quill editor
                if (t.content) {
                    quill.root.innerHTML = t.content;
                } else {
                    quill.setText('');
                }

                // Update label based on type
                if (t.type === 'selection') {
                    $('termContentLabel').textContent = 'Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¨Ù†Ø¯ (ÙƒÙ„ Ø®ÙŠØ§Ø± ÙÙŠ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)';
                } else {
                    $('termContentLabel').textContent = 'Ù†Øµ Ø§Ù„Ø¨Ù†Ø¯';
                }
            }

            // updateTermsFromUI - FIXED VERSION
            async function updateTermsFromUI() {
                try {
                    const checkedBoxes = Array.from(document.querySelectorAll('#termsList .termCheckbox')).filter(cb => cb.checked);
                    if (checkedBoxes.length === 0) {
                        $('terms').value = '';
                        $('termsSummary').value = '';
                        return;
                    }
                    const all = await getTerms();
                    const uiState = loadTermsUIState();
                    const mergedParts = [];
                    for (const cb of checkedBoxes) {
                        const id = cb.dataset.id;
                        const term = all.find(t => String(t.id) === id || String(t._id) === id) || {
                            name: cb.nextSibling?.textContent || '',
                            content: cb.dataset.content || '',
                            type: 'text'
                        };
                        mergedParts.push(term.name || '');
                        // prefer uiState.selected, then select DOM value, then full content
                        let chosen = null;
                        if (uiState[id] && uiState[id].selected) chosen = uiState[id].selected;
                        else {
                            const row = cb.closest('div');
                            const sel = row ? row.querySelector('select') : null;
                            if (sel) chosen = sel.value;
                        }
                        if (term.type === 'selection') {
                            if (chosen) mergedParts.push(chosen);
                            else mergedParts.push((term.content || '').split(/\r?\n/).filter(Boolean).join('\n'));
                        } else {
                            mergedParts.push(term.content || cb.dataset.content || '');
                        }
                        mergedParts.push('');
                    }
                    const merged = mergedParts.join('\n').trim();
                    $('terms').value = merged;
                    const summary = checkedBoxes.map(cb => cb.nextSibling?.textContent).filter(Boolean).slice(0, 5).join(' Â· ') + (checkedBoxes.length > 5 ? ' Â· ...' : '');
                    $('termsSummary').value = summary;
                    // persist last inserted selection for export when modal closed
                    const st = loadTermsUIState();
                    st._lastInserted = checkedBoxes.map(cb => cb.dataset.id);
                    saveTermsUIState(st);
                } catch (e) {
                    console.warn('updateTermsFromUI failed', e);
                }
            }

            // Terms "Insert" button: finalize current UI selection into the main form and close modal
            const termsInsertEl = $('termsInsertBtn');
            if (termsInsertEl) {
                termsInsertEl.addEventListener('click', async () => {
                    try {
                        // update hidden fields from current UI selections
                        await updateTermsFromUI();
                        const raw = $('terms').value || '';
                        if (!raw.trim()) {
                            alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø¨Ù†Ø¯');
                            return;
                        }
                        // persist last inserted IDs already handled by updateTermsFromUI()
                        alert('ØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ù‚Ø¯. Ù„Ø§ ØªÙ†Ø³ Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯.');
                        closeTermsModal();
                    } catch (err) {
                        alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬: ' + (err && err.message ? err.message : err));
                    }
                });
            }

            // ---------------- Terms Management Logic (Consolidated) ----------------

            // Helper to persist selection state
            async function markTermSelectedById(id, selectedValue) {
                try {
                    if (!id) return;
                    const st = loadTermsUIState();
                    st[String(id)] = st[String(id)] || {};
                    st[String(id)].checked = true;
                    if (selectedValue !== undefined && selectedValue !== null) st[String(id)].selected = selectedValue;
                    saveTermsUIState(st);
                } catch (e) { console.warn('markTermSelectedById failed', e); }
            }

            // Save Term Button
            const saveTermBtn = $('saveTermBtn');
            if (saveTermBtn) {
                saveTermBtn.addEventListener('click', async () => {
                    console.log('Save Term Button Clicked'); // DEBUG
                    const id = $('termId').value.trim();
                    const name = $('termName').value.trim();
                    const type = $('termType').value;
                    // Get content from Quill editor
                    const content = quill.root.innerHTML;

                    console.log('Term Data:', { id, name, type, content }); // DEBUG

                    if (!name || !content) {
                        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯ ÙˆÙ…Ø­ØªÙˆØ§Ù‡');
                        return;
                    }

                    const term = { name, type, content };

                    try {
                        let saved = null;
                        if (id) {
                            console.log('Updating term...');
                            saved = await updateTerm(id, term);
                            alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
                        } else {
                            console.log('Creating term...');
                            saved = await createTerm(term);
                            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
                        }
                        console.log('Save result:', saved);

                        // Persistence logic
                        const savedId = String((saved && (saved.id || saved._id)) || id || (saved && saved.id) || '');
                        let selectedVal = null;
                        if (term.type === 'selection') {
                            const opts = (term.content || '').split(/\r?\n/).map(s => s.trim()).filter(Boolean);
                            if (opts.length) selectedVal = opts[0];
                        }
                        await markTermSelectedById(savedId, selectedVal);

                        // Reload and refresh editor
                        await loadTerms();

                        // If it was an update, keep it in editor? Or clear? 
                        // User might want to add another. Let's clear if new, keep if update? 
                        // The previous robust logic kept it. Let's stick to clearing for "New" feel, or maybe just clear.
                        // Actually, let's clear to avoid confusion, as the "New" button exists.
                        // BUT the robust logic had: if (savedId) loadTermIntoEditor...
                        // Let's keep the robust behavior: focus the item.
                        if (savedId) {
                            const all = await getTerms();
                            const termObj = all.find(t => String(t.id || t._id) === savedId);
                            if (termObj) loadTermIntoEditor(termObj);
                        }

                    } catch (err) {
                        console.error('Save Term Error:', err);
                        alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨Ù†Ø¯: ' + err.message);
                    }
                });
            }

            // Delete Term Button
            const deleteTermBtn = $('deleteTermBtn');
            if (deleteTermBtn) {
                deleteTermBtn.addEventListener('click', async () => {
                    const id = $('termId').value.trim();
                    if (!id) {
                        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¨Ù†Ø¯ Ù„Ù„Ø­Ø°Ù');
                        return;
                    }

                    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ØŸ')) return;

                    try {
                        await deleteTermById(id);

                        // Cleanup UI state
                        try {
                            const st = loadTermsUIState();
                            delete st[String(id)];
                            if (Array.isArray(st._lastInserted)) st._lastInserted = st._lastInserted.filter(x => String(x) !== String(id));
                            saveTermsUIState(st);
                        } catch (e) { console.warn('cleanup UI state failed', e); }

                        alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ù†Ø¬Ø§Ø­');

                        // Clear form
                        $('termId').value = '';
                        $('termName').value = '';
                        quill.setText(''); // Clear Quill editor
                        $('termType').value = 'text';

                        await loadTerms();
                    } catch (err) {
                        console.error(err);
                        alert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯');
                    }
                });
            }

            // New Term Button (Clear Form)
            const newTermBtn = $('newTermBtn');
            if (newTermBtn) {
                newTermBtn.addEventListener('click', () => {
                    $('termId').value = '';
                    $('termName').value = '';
                    quill.setText(''); // Clear Quill editor
                    $('termType').value = 'text';
                    $('termContentLabel').textContent = 'Ù†Øµ Ø§Ù„Ø¨Ù†Ø¯';
                });
            }

            // ---------------- Terms export: docx + HTML fallback ----------------

            async function loadDocx() {
                if (window.docx) return window.docx;
                return new Promise((resolve, reject) => {
                    const s = document.createElement('script');
                    s.src = 'https://cdn.jsdelivr.net/npm/docx@8.4.1/build/index.umd.js';
                    s.async = true;
                    let done = false;
                    const onLoad = () => { if (done) return; done = true; window.docx = window.docx || window.docxModule || window.docx || {}; resolve(window.docx); };
                    const onErr = () => { if (done) return; done = true; reject(new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© docx Ù…Ù† CDN')); };
                    s.onload = onLoad;
                    s.onerror = onErr;
                    document.head.appendChild(s);
                    setTimeout(() => { if (!done) onErr(); }, 10000);
                }).catch(() => ({}));
            }

            function downloadBlob(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 5000);
            }

            function buildWordHtml(title, paragraphs) {
                const style = `
        <meta charset="utf-8" />
        <style>
          body { direction: rtl; font-family: "Cairo","Arial",sans-serif; font-size:14pt; }
          h1 { font-size:18pt; }
          .term-title { font-weight:700; margin-top:12px; margin-bottom:6px; }
          .para { margin:6px 0; white-space:pre-wrap; }
        </style>
      `;
                const body = paragraphs.map(p => `<div class="para">${p}</div>`).join('\n');
                return `<!doctype html><html lang="ar" dir="rtl"><head>${style}<title>${title}</title>
</head><body><h1>${title}</h1>${body}</body></html>`;
            }

            function escapeHtml(str) {
                return String(str || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
            }

            // export selected terms (with UI state preference) -> docx or fallback .doc (HTML)
            async function exportTermsToWordWithUI(selectedTerms, uiState) {
                try {
                    const Docx = await loadDocx();
                    if (Docx && Docx.Document && Docx.Packer) {
                        const { Document, Packer, Paragraph, TextRun } = Docx;
                        const children = [];
                        for (const t of selectedTerms) {
                            const id = String(t.id || t._id || '');
                            children.push(new Paragraph({ children: [new TextRun({ text: t.name || '', bold: true, size: 28 })] }));
                            // determine chosen value
                            let chosen = null;
                            if (uiState && uiState[id] && uiState[id].selected) chosen = uiState[id].selected;
                            else {
                                const cb = document.querySelector(`#termsList .termCheckbox[data-id="${id}"]`);
                                const row = cb ? cb.closest('div') : null;
                                const sel = row ? row.querySelector('select') : null;
                                if (sel) chosen = sel.value;
                            }
                            if (t.type === 'selection') {
                                if (chosen) {
                                    children.push(new Paragraph({ children: [new TextRun({ text: chosen, size: 24 })] }));
                                } else {
                                    ((t.content || '').split(/\r?\n/).filter(Boolean)).forEach(line => {
                                        children.push(new Paragraph({ children: [new TextRun({ text: line, size: 24 })] }));
                                    });
                                }
                            } else {
                                ((t.content || '').split(/\r?\n/).filter(Boolean)).forEach(line => {
                                    children.push(new Paragraph({ children: [new TextRun({ text: line, size: 24 })] }));
                                });
                            }
                            children.push(new Paragraph({ children: [new TextRun({ text: ' ' })] }));
                        }
                        const doc = new Document({ sections: [{ properties: {}, children }] });
                        const blob = await Packer.toBlob(doc);
                        downloadBlob(blob, `terms_${Date.now()}.docx`);
                        return;
                    }
                    throw new Error('docx library ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
                } catch (err) {
                    // fallback to HTML .doc
                    const paragraphs = [];
                    for (const t of selectedTerms) {
                        const id = String(t.id || t._id || '');
                        paragraphs.push(`<div class="term-title">${escapeHtml(t.name || '')}</div>`);
                        let chosen = null;
                        if (uiState && uiState[id] && uiState[id].selected) chosen = uiState[id].selected;
                        else {
                            const cb = document.querySelector(`#termsList .termCheckbox[data-id="${id}"]`);
                            const row = cb ? cb.closest('div') : null;
                            const sel = row ? row.querySelector('select') : null;
                            if (sel) chosen = sel.value;
                        }
                        if (t.type === 'selection') {
                            if (chosen) paragraphs.push(escapeHtml(chosen));
                            else {
                                const opts = (t.content || '').split(/\r?\n/).filter(Boolean);
                                if (opts.length) paragraphs.push('<ul style="direction:rtl;text-align:right;">' + opts.map(o => `<li>${escapeHtml(o)}</li>`).join('') + '</ul>');
                                else paragraphs.push('&nbsp;');
                            }
                        } else {
                            paragraphs.push((t.content || '').replace(/\n/g, '<br/>') || '&nbsp;');
                        }
                    }
                    const html = buildWordHtml('Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¹Ù‚Ø¯', paragraphs);
                    const blob = new Blob([html], { type: 'application/msword;charset=utf-8' });
                    downloadBlob(blob, `terms_${Date.now()}.doc`);
                }
            }

            // export plain text (hidden #terms) -> docx or fallback .doc
            async function exportTextToWord(filename, text) {
                try {
                    const Docx = await loadDocx();
                    if (Docx && Docx.Document && Docx.Packer) {
                        const { Document, Packer, Paragraph, TextRun } = Docx;
                        const children = text.split(/\r?\n/).map(line => new Paragraph({ children: [new TextRun({ text: line || '', size: 24 })] }));
                        const doc = new Document({ sections: [{ children: children.length ? children : [new Paragraph({ children: [new TextRun({ text: text || '', size: 24 })] })] }] });
                        const blob = await Packer.toBlob(doc);
                        downloadBlob(blob, `${filename}_${Date.now()}.docx`);
                        return;
                    }
                    throw new Error('docx library ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
                } catch (err) {
                    const html = buildWordHtml('Ø´Ø±ÙˆØ· Ø§Ù„Ø¹Ù‚Ø¯', text.split(/\r?\n/).map(l => escapeHtml(l) || '&nbsp;'));
                    const blob = new Blob([html], { type: 'application/msword;charset=utf-8' });
                    downloadBlob(blob, `${filename}_${Date.now()}.doc`);
                }
            }

            // bindings for the two export buttons
            const termsExportBtnEl = $('termsExportBtn');
            if (termsExportBtnEl) {
                termsExportBtnEl.addEventListener('click', async () => {
                    try {
                        // determine selected ids (use UI state or last inserted)
                        const uiState = loadTermsUIState();
                        let selectedIds = Array.from(document.querySelectorAll('#termsList .termCheckbox')).filter(cb => cb.checked).map(cb => cb.dataset.id);
                        if (selectedIds.length === 0 && uiState._lastInserted) selectedIds = uiState._lastInserted.slice();
                        if (selectedIds.length === 0) return alert('Ø§Ø®ØªØ± Ø¨Ù†ÙˆØ¯Ø§Ù‹ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§');
                        const all = await getTerms();
                        const selected = [];
                        selectedIds.forEach(id => {
                            const t = all.find(x => String(x.id || x._id) === String(id));
                            if (t) selected.push(t);
                            else {
                                const cb = document.querySelector(`#termsList .termCheckbox[data-id="${id}"]`);
                                if (cb) selected.push({ id, name: cb.nextSibling?.textContent || 'Ø¨Ù†Ø¯', type: 'text', content: cb.dataset.content || '' });
                            }
                        });
                        await exportTermsToWordWithUI(selected, uiState);
                    } catch (err) {
                        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±: ' + (err && err.message ? err.message : err));
                    }
                });
            }

            const smallExportBtn = $('exportTermsBtn');
            if (smallExportBtn) {
                smallExportBtn.addEventListener('click', async () => {
                    try {
                        const raw = $('terms').value || '';
                        if (!raw.trim()) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ù…ÙØ¯Ø±Ø¬Ø© Ù„Ù„ØªØµØ¯ÙŠØ±');
                        await exportTextToWord('contract_terms', raw);
                    } catch (err) {
                        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±: ' + (err && err.message ? err.message : err));
                    }
                });
            }

            // ---------------- end Terms export ----------------

            // Persist UI state when user saves/creates/deletes a term so selections persist across modal open/close

            // (Redundant IIFE removed - logic consolidated above)

            // ============ Sortable Table Headers ============
            let currentSortColumn = null;
            let currentSortDirection = 'asc';
            let contractsData = [];

            window.sortTable = function (column) {
                // Toggle direction if clicking same column
                if (currentSortColumn === column) {
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortColumn = column;
                    currentSortDirection = 'asc';
                }

                // Update header arrows
                document.querySelectorAll('th.sortable').forEach(th => {
                    th.classList.remove('asc', 'desc');
                });
                const activeHeader = document.querySelector(`th[data-sort="${column}"]`);
                if (activeHeader) {
                    activeHeader.classList.add(currentSortDirection);
                }

                // Sort the data
                contractsData.sort((a, b) => {
                    let aVal = a[column];
                    let bVal = b[column];

                    // Handle null/undefined values
                    if (aVal == null) aVal = '';
                    if (bVal == null) bVal = '';

                    // Convert to string for comparison
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();

                    // Numeric comparison for price
                    if (column === 'total_price') {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    }

                    // Compare
                    if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });

                // Re-render the table using the same logic as loadContracts
                const tbody = document.querySelector('#contractsTbody');
                if (!tbody) return;

                tbody.innerHTML = '';
                let active = 0, pending = 0;

                contractsData.forEach(c => {
                    if (c.status === 'active') active++;
                    if (c.status === 'pending') pending++;

                    const tr = document.createElement('tr');
                    const containerMapLink = c.container_location ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.container_location)}" target="_blank" style="font-size:0.8em;">ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©</a>` : '';
                    const pickupMapLink = c.pickup_location ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.pickup_location)}" target="_blank" style="font-size:0.8em;">ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ¬Ù…ÙŠØ¹</a>` : '';

                    tr.innerHTML = `
            <td>${c.id || '-'}</td>
            <td>${c.client_name || ''}</td>
            <td>${c.service_name || ''}</td>
            <td>${c.from_date || '-'} â†’ ${c.to_date || '-'}</td>
            <td>${c.total_price || 0}</td>
            <td>${c.manager || ''}</td>
            <td>${c.collector || ''}</td>
            <td>
                <span class="chip ${c.status === 'active' ? 'active' : (c.status === 'pending' ? 'pending' : 'expired')}">
                ${c.status === 'active' ? 'Ù†Ø´Ø·' : (c.status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹' : 'Ù…Ù†ØªÙ‡ÙŠ')}
                </span>
            </td>
            <td>
              <div style="display:flex; gap:4px; flex-wrap:wrap; align-items:center;">
                  <button class="btn" onclick="openEdit('${c.id}')">Ø¹Ø±Ø¶/ØªØ¹Ø¯ÙŠÙ„</button>
                  <button class="btn small" onclick="updateStatus('${c.id}','active')" title="ØªÙØ¹ÙŠÙ„">âœ…</button>
                  <button class="btn small" onclick="updateStatus('${c.id}','pending')" title="Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹">â³</button>
                  <button class="btn small" onclick="updateStatus('${c.id}','expired')" title="Ø¥Ù†Ù‡Ø§Ø¡">ğŸ›‘</button>
              </div>
              <div style="margin-top:6px; font-size:0.8em;">${containerMapLink} ${pickupMapLink}</div>
            </td>
          `;
                    tbody.appendChild(tr);
                });

                if ($('countActive')) $('countActive').textContent = active;
                if ($('countPending')) $('countPending').textContent = pending;
            };

        }); // DOMContentLoaded
    </script>
</body>

</html>