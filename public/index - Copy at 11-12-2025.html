<!doctype html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù†Ø¸Ø§ÙØ© - ÙˆØ§Ø¬Ù‡Ø© Ù…ØªØµÙ„Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- <link rel="stylesheet" href="styles.css"> -->
  <!-- <link rel="stylesheet" href="styles/theme-modern.css"> -->

  <link rel="stylesheet" href="styles/theme-kucoin.css">

  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <!-- Quill.js Rich Text Editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>








  <!-- <script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script> -->
  <style>
    /* Sortable table headers */
    th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-left: 20px;
    }

    th.sortable:hover {
      background-color: #f0f4f8;
    }

    .sort-arrow {
      position: absolute;
      left: 5px;
      opacity: 0.3;
      font-size: 10px;
    }

    .sort-arrow::before {
      content: 'â–¼';
    }

    th.sortable.asc .sort-arrow {
      opacity: 1;
    }

    th.sortable.asc .sort-arrow::before {
      content: 'â–²';
    }

    th.sortable.desc .sort-arrow {
      opacity: 1;
    }

    th.sortable.desc .sort-arrow::before {
      content: 'â–¼';
    }

    /* Flower Theme Switcher - Improved */
    .theme-flower {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 9999;
      width: 40px;
      height: 40px;
    }

    /* Keep petals visible for 2 seconds after hover ends */
    .theme-flower:hover,
    .theme-flower:focus-within {
      width: 180px;
      height: 180px;
    }

    .flower-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #24ae8f 0%, #14b8a6 100%);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(36, 174, 143, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      transition: all 0.3s ease;
      z-index: 10;
    }

    .flower-center:hover {
      transform: translate(-50%, -50%) scale(1.15) rotate(180deg);
      box-shadow: 0 6px 20px rgba(36, 174, 143, 0.7);
    }

    .flower-petal {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      color: white;
      text-align: center;
      padding: 3px;
      line-height: 1.1;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
      transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      opacity: 0;
      transform: translate(-50%, -50%) scale(0);
      pointer-events: none;
    }

    .theme-flower:hover .flower-petal,
    .theme-flower:focus-within .flower-petal {
      opacity: 1;
      pointer-events: all;
      transition-delay: 0s;
    }

    /* Petal positions - closer circle */
    .theme-flower:hover .petal-1,
    .theme-flower:focus-within .petal-1 {
      transform: translate(calc(-50% + 0px), calc(-50% - 65px)) scale(1);
      transition-delay: 0.05s;
    }

    .theme-flower:hover .petal-2,
    .theme-flower:focus-within .petal-2 {
      transform: translate(calc(-50% + 56px), calc(-50% - 33px)) scale(1);
      transition-delay: 0.1s;
    }

    .theme-flower:hover .petal-3,
    .theme-flower:focus-within .petal-3 {
      transform: translate(calc(-50% + 56px), calc(-50% + 33px)) scale(1);
      transition-delay: 0.15s;
    }

    .theme-flower:hover .petal-4,
    .theme-flower:focus-within .petal-4 {
      transform: translate(calc(-50% + 0px), calc(-50% + 65px)) scale(1);
      transition-delay: 0.2s;
    }

    .theme-flower:hover .petal-5,
    .theme-flower:focus-within .petal-5 {
      transform: translate(calc(-50% - 56px), calc(-50% + 33px)) scale(1);
      transition-delay: 0.25s;
    }

    .theme-flower:hover .petal-6,
    .theme-flower:focus-within .petal-6 {
      transform: translate(calc(-50% - 56px), calc(-50% - 33px)) scale(1);
      transition-delay: 0.3s;
    }

    /* Individual petal colors */
    .petal-1 {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .petal-2 {
      background: linear-gradient(135deg, #f0b90b 0%, #d9a809 100%);
    }

    .petal-3 {
      background: linear-gradient(135deg, #24ae8f 0%, #14b8a6 100%);
    }

    .petal-4 {
      background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);
    }

    .petal-5 {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    }

    .petal-6 {
      background: linear-gradient(135deg, #e5e7eb 0%, #f3f4f6 100%);
      color: #1e293b;
    }

    .flower-petal:hover {
      transform: translate(-50%, -50%) scale(1.2) !important;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
      z-index: 20;
    }

    /* Tooltip on hover */
    .flower-petal::before {
      content: attr(title);
      position: absolute;
      bottom: 110%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .flower-petal:hover::before {
      opacity: 1;
    }

    /* Sidebar Panel Styling */
    main {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 1.5rem;
      align-items: start;
    }

    .panel {
      background: var(--bg-secondary, #f8fafc);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--border-color, #e2e8f0);
      position: sticky;
      top: 20px;
    }

    .panel h3 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--text-primary, #1e293b);
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--primary-color, #2563eb);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel h3::before {
      content: 'ğŸ“Š';
      font-size: 1.5rem;
    }

    /* Stat Cards */
    .stat {
      background: linear-gradient(135deg, var(--primary-color, #3b82f6) 0%, var(--primary-dark, #2563eb) 100%);
      color: white;
      padding: 1.25rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      transition: all 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stat:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .stat:nth-child(3) {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .stat:nth-child(3):hover {
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }

    .stat .muted {
      font-size: 0.75rem;
      opacity: 0.9;
      margin-bottom: 0.375rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat strong {
      font-size: 2.25rem;
      font-weight: 800;
      display: block;
      line-height: 1;
    }

    .stat .chip {
      background: rgba(255, 255, 255, 0.25);
      color: white;
      padding: 0.375rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      border: 1px solid rgba(255, 255, 255, 0.4);
      white-space: nowrap;
    }

    /* Navigation Buttons */
    .nav {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }

    .nav button {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid transparent;
      border-radius: 10px;
      background: var(--bg-tertiary, #f1f5f9);
      color: var(--text-primary, #1e293b);
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: right;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      position: relative;
      overflow: hidden;
    }

    .nav button::before {
      font-size: 1.25rem;
    }

    .nav button::after {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--primary-color, #3b82f6);
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }

    .nav button:hover {
      background: var(--bg-secondary, #e2e8f0);
      border-color: var(--primary-color, #3b82f6);
      transform: translateX(-4px);
    }

    .nav button.active {
      background: linear-gradient(135deg, var(--primary-color, #3b82f6) 0%, var(--primary-dark, #2563eb) 100%);
      color: white;
      border-color: var(--primary-color, #3b82f6);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .nav button.active::after {
      transform: scaleY(1);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      main {
        grid-template-columns: 1fr;
      }

      .panel {
        position: relative;
        top: 0;
      }

      .nav {
        flex-direction: row;
        flex-wrap: wrap;
      }

      .nav button {
        flex: 1;
        min-width: 150px;
      }
    }

    @media (max-width: 768px) {
      .stat {
        flex-direction: column;
        text-align: center;
        gap: 0.75rem;
      }

      .nav button {
        font-size: 0.875rem;
        padding: 0.75rem;
      }

      .nav button::before {
        font-size: 1.125rem;
      }
    }

    /* Quill Toolbar Custom Font Size Labels */
    .ql-snow .ql-picker.ql-size .ql-picker-label::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item::before {
      content: attr(data-value) !important;
    }

    /* Handle default (empty value) case if any */
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value=""]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value=""]::before {
      content: 'Normal';
    }

    .nav button[data-view="contracts"]::before {
      content: 'ğŸ“„';
    }

    .nav button[data-view="clients"]::before {
      content: 'ğŸ‘¥';
    }

    .nav button[data-view="services"]::before {
      content: 'ğŸ› ï¸';
    }

    .nav button[data-view="reports"]::before {
      content: 'ğŸ“Š';
    }

    .nav button::after {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--primary-color, #3b82f6);
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }

    .nav button:hover {
      background: var(--bg-secondary, #e2e8f0);
      border-color: var(--primary-color, #3b82f6);
      transform: translateX(-4px);
    }

    .nav button.active {
      background: linear-gradient(135deg, var(--primary-color, #3b82f6) 0%, var(--primary-dark, #2563eb) 100%);
      color: white;
      border-color: var(--primary-color, #3b82f6);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .nav button.active::after {
      transform: scaleY(1);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      main {
        grid-template-columns: 1fr;
      }

      .panel {
        position: relative;
        top: 0;
      }

      .nav {
        flex-direction: row;
        flex-wrap: wrap;
      }

      .nav button {
        flex: 1;
        min-width: 150px;
      }
    }

    @media (max-width: 768px) {
      .stat {
        flex-direction: column;
        text-align: center;
        gap: 0.75rem;
      }

      .nav button {
        font-size: 0.875rem;
        padding: 0.75rem;
      }

      .nav button::before {
        font-size: 1.125rem;
      }
    }

    /* Fullscreen A4 Document Editor Modal */
    .a4-editor-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      overflow: auto;
      padding: 20px;
    }

    .a4-editor-modal.active {
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    .a4-editor-content {
      background: #e0e0e0;
      border-radius: 12px;
      padding: 30px;
      width: 100%;
      max-width: 240mm;
      min-height: 100vh;
      position: relative;
    }

    .a4-editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .a4-editor-header h3 {
      margin: 0;
      color: #1e293b;
      font-size: 18px;
    }

    .a4-editor-close {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .a4-editor-close:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    /* A4 Paper-Style Editor */
    .a4-paper-container {
      max-width: 210mm;
      margin: 0 auto;
      background: #e0e0e0;
      padding: 20px 0;
    }

    .a4-paper {
      background: white;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(0, 0, 0, 0.1);
      margin: 0 auto;
      width: 210mm;
      min-height: 297mm;
      position: relative;
    }

    /* Quill Editor Styling for A4 */
    .a4-paper .ql-container {
      border: none !important;
      font-family: 'Cairo', 'Arial', sans-serif;
      font-size: 14px;
      line-height: 1.6;
    }

    /* Quill Alignment Classes for View Mode */
    .ql-align-center {
      text-align: center;
    }

    .ql-align-right {
      text-align: right;
    }

    .ql-align-justify {
      text-align: justify;
    }

    /* Quill Font Size Classes for View Mode */
    .ql-size-small {
      font-size: 0.75em;
    }

    .ql-size-large {
      font-size: 1.5em;
    }

    .ql-size-huge {
      font-size: 2.5em;
    }

    /* Custom Pixel Sizes */
    .ql-size-8px {
      font-size: 8px;
    }

    .ql-size-10px {
      font-size: 10px;
    }

    .ql-size-12px {
      font-size: 12px;
    }

    .ql-size-14px {
      font-size: 14px;
    }

    .ql-size-16px {
      font-size: 16px;
    }

    .ql-size-18px {
      font-size: 18px;
    }

    .ql-size-20px {
      font-size: 20px;
    }

    .ql-size-24px {
      font-size: 24px;
    }

    .ql-size-30px {
      font-size: 30px;
    }

    .ql-size-36px {
      font-size: 36px;
    }

    .ql-size-48px {
      font-size: 48px;
    }

    .ql-size-60px {
      font-size: 60px;
    }

    .ql-size-72px {
      font-size: 72px;
    }

    /* Ensure inline font-size styles are respected */
    span[style*="font-size"] {
      display: inline;
    }

    /* Calendar/Date Picker */
    .a4-paper .ql-editor {
      padding: 2.5cm 2cm !important;
      min-height: 297mm;
      direction: rtl;
      text-align: right;
    }

    .a4-paper .ql-toolbar {
      border: none !important;
      border-bottom: 2px solid #e5e7eb !important;
      background: #f9fafb;
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* Quill Toolbar Custom Font Size Labels */
    .ql-snow .ql-picker.ql-size .ql-picker-label::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item::before {
      content: attr(data-value) !important;
    }

    /* Handle default (empty value) case if any */
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value=""]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value=""]::before {
      content: 'Normal';
    }

    /* Drag-and-drop styles for terms */
    .term-item {
      transition: opacity 0.2s, transform 0.2s, background 0.2s;
      cursor: move;
      user-select: none;
      position: relative;
    }

    .term-item.dragging {
      opacity: 0.4;
      transform: scale(0.98);
    }

    .term-item.drag-over {
      border-top: 3px solid var(--primary-color, #3b82f6) !important;
      background: rgba(59, 130, 246, 0.05);
    }

    .term-item:hover {
      background: rgba(59, 130, 246, 0.03);
    }

    .term-item::before {
      content: 'â‹®â‹®';
      position: absolute;
      left: -8px;
      color: #94a3b8;
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .term-item:hover::before {
      opacity: 0.5;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">
          <img src="logo.jpg" alt="Ù†Ø¸Ø§Ù… Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù†Ø¸Ø§ÙØ©" width="56" height="56" id="siteLogo">
        </div>
        <div class="title">
          <h1>Ù†Ø¸Ø§Ù… Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù†Ø¸Ø§ÙØ© </h1>
          <p>Ø¹Ø±Ø¶ØŒ Ø¥Ù†Ø´Ø§Ø¡ØŒ ØªÙˆÙ‚ÙŠØ¹ ÙˆØ£Ø±Ø´ÙØ© Ø§Ù„Ø¹Ù‚ÙˆØ¯ â€” Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
        </div>
      </div>

      <div class="top-actions">
        <div class="size-controls" style="display:flex; gap:2px; margin-left:10px;">
          <button class="btn small" onclick="setPageSize('small')" title="ØªØµØºÙŠØ±">A-</button>
          <button class="btn small" onclick="setPageSize('default')" title="Ø¹Ø§Ø¯ÙŠ">A</button>
          <button class="btn small" onclick="setPageSize('large')" title="ØªÙƒØ¨ÙŠØ±">A+</button>
        </div>
        <!-- <button class="btn" id="exportCsvBtn" title="ØªØµØ¯ÙŠØ± ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚ÙˆØ¯">ØªØµØ¯ÙŠØ± CSV</button> -->
        <!-- <button class="btn" id="uploadPdfBtn" title="Ø±ÙØ¹ PDF">Ø±ÙØ¹ PDF</button> -->
        <button class="btn primary" id="renewContractBtn">ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯</button>
        <button class="btn primary" id="newContractBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</button>
      </div>
    </header>

    <main>
      <aside class="panel" aria-label="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©">
        <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
        <div class="stat">
          <div>
            <div class="muted">Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù†Ø´Ø·Ø©</div><strong id="countActive">0</strong>
          </div>
          <div class="chip">Ù†Ø´Ø·Ø©</div>
        </div>
        <div class="stat">
          <div>
            <div class="muted">Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</div><strong id="countPending">0</strong>
          </div>
          <div class="chip">Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</div>
        </div>
        <div class="nav" role="navigation" aria-label="Ù‚Ø§Ø¦Ù…Ø©">
          <button class="active" data-view="contracts">Ø§Ù„Ø¹Ù‚ÙˆØ¯</button>
          <button data-view="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
        </div>
      </aside>

      <section class="content">
        <div class="auth" id="authBox">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <input id="username" value="admin"></label>
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±: <input id="password" type="password" value="admin123"></label>
          <button class="btn primary" id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          <span id="authMsg" class="muted"></span>
        </div>

        <div id="formWrap" class="form" aria-hidden="true" style="display:none;">
          <h3>Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡/ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù‚Ø¯</h3>

          <div class="row">
            <div class="field small">
              <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
              <select id="clientType">
                <option>ÙØ±Ø¯</option>
                <option>Ù…Ù†Ø´Ø£Ø©</option>
              </select>
            </div>

            <div class="field">
              <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
              <input type="text" id="clientName" />
            </div>

            <div class="field small">
              <label>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
              <select id="serviceType">
                <option>Ù†Ø¸Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ©</option>
                <option>Ù†Ø¸Ø§ÙØ© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</option>
                <option>Ø·ÙˆØ§Ø±Ø¦</option>
                <option>Ù†Ù‚Ù„ Ù†ÙØ§ÙŠØ§Øª</option>
                <option>Ù†Ù‚Ù„ ÙƒÙØ±Ø§Øª</option>
                <option>Ù†Ù‚Ù„ Ø£Ø®Ø´Ø§Ø¨</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field small"><label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label><input id="city" /></div>
            <div class="field small"><label>Ø§Ù„Ø­ÙŠ</label><input id="district" /></div>
            <div class="field small"><label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©</label><select id="containerType">
                <option>Ø¨Ø±Ù…ÙŠÙ„</option>
                <option>2 ÙŠØ§Ø±Ø¯Ø©</option>
                <option>1 ÙŠØ§Ø±Ø¯Ø©</option>
                <option>6 ÙŠØ§Ø±Ø¯Ø©</option>
                <option>240 Liter</option>
                <option>360 Liter</option>
                <option>1100 Liter</option>
                <option>1300 Liter</option>
                <option>Ø¨Ø¯ÙˆÙ†</option>
              </select></div>
            <!-- <div class="field small"><label>Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø¹Ø§Ù…)</label><input id="location" /></div> -->
          </div>

          <div class="row">
            <div class="field small"><label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label><input type="date" id="dateFrom" /></div>
            <div class="field small"><label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label><input type="date" id="dateTo" /></div>
            <div class="field small"><label>Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯</label><select id="duration">
                <option>Ø³Ù†ÙˆÙŠ</option>
                <option>6 Ø£Ø´Ù‡Ø±</option>
                <option>3 Ø£Ø´Ù‡Ø±</option>
                <option>Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©</option>
              </select></div>
            <div class="field small"><label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</label><input id="monthlyFee" /></div>
            <div class="field small"><label>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</label><input id="tax" value="15%" placeholder="Ù…Ø«Ø§Ù„: 15%" /></div>
            <div class="field small"><label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label><input id="totalPrice" /></div>
          </div>

          <div class="row">
            <div class="field">
              <label>Ø´Ø±ÙˆØ· Ùˆ Ø¨Ù†ÙˆØ¯</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <input id="termsSummary" readonly placeholder="Ø§Ø¶ØºØ· 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙˆØ·' Ù„ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø±ÙˆØ·"
                  style="flex:1;padding:8px;border-radius:8px;border:1px solid #e0e6ef" />
                <button class="btn" id="manageTermsBtn">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙˆØ·</button>
                <button class="btn" id="exportTermsBtn" title="ØªØµØ¯ÙŠØ± Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙƒÙ…Ù„Ù Word">ØªØµØ¯ÙŠØ± Word</button>
              </div>
              <input type="hidden" id="terms" />
              <div class="muted" style="font-size:12px">Ø§ÙØªØ­ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙˆØ· Ù„Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ù†ÙˆØ¯. Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ Ø³ØªÙØ­ÙØ¸
                Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù‚Ù„.</div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ© (Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª)</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <input id="containerLocation" placeholder="lat,lng" />
                <button class="btn" id="pickContainerBtn">Ø§Ø®ØªØ± Ù…Ù† Ø®Ø±Ø§Ø¦Ø· Google</button>
                <a id="containerGoogleLink" class="muted" href="#" target="_blank" style="display:none">Ø¹Ø±Ø¶ ÙÙŠ Ø®Ø±Ø§Ø¦Ø·
                  Google</a>
              </div>
              <div class="muted" style="font-size:12px">Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ø®Ø±Ø§Ø¦Ø· Google ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø«Ù… Ø§Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ø¶ØºØ·
                "Ù„ØµÙ‚ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©".</div>
            </div>

            <!-- <div class="field">
              <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ­ØµÙŠÙ„ (Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª)</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <input id="pickupLocation" placeholder="lat,lng" />
                <button class="btn" id="pickPickupBtn">Ø§Ø®ØªØ± Ù…Ù† Ø®Ø±Ø§Ø¦Ø· Google</button>
                <a id="pickupGoogleLink" class="muted" href="#" target="_blank" style="display:none">Ø¹Ø±Ø¶ ÙÙŠ Ø®Ø±Ø§Ø¦Ø·
                  Google</a>
              </div>
              <div class="muted" style="font-size:12px">Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø®Ø±Ø§Ø¦Ø· Google Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø«Ù… Ø§Ø¶ØºØ· "Ù„ØµÙ‚ Ù…Ù†
                Ø§Ù„Ø­Ø§ÙØ¸Ø©".</div>
            </div> -->
          </div>

          <div class="row">
            <div class="field small">
              <label>Ù…Ø³ÙˆÙ‚ Ø§Ù„Ø¹Ù‚Ø¯ <button class="btn small text-only" id="manageManagersBtn"
                  style="padding:0 4px;font-size:0.8em;">(Ø¥Ø¯Ø§Ø±Ø©)</button></label>
              <select id="manager">
                <option value="">-- Ø§Ø®ØªØ± --</option>
              </select>
            </div>
            <div class="field small">
              <label>Ù…Ø­ØµÙ„ Ø§Ù„Ø¹Ù‚Ø¯ <button class="btn small text-only" id="manageCollectorsBtn"
                  style="padding:0 4px;font-size:0.8em;">(Ø¥Ø¯Ø§Ø±Ø©)</button></label>
              <select id="collector">
                <option value="">-- Ø§Ø®ØªØ± --</option>
              </select>
            </div>
            <div class="field small"><label>Ø´Ø±ÙˆØ· Ø§Ù„Ø¯ÙØ¹</label><select id="paymentType">
                <option>Ø³Ù†ÙˆÙŠØ©</option>
                <option>ÙƒÙ„ 6 Ø£Ø´Ù‡Ø±</option>
                <option>ÙƒÙ„ 3 Ø£Ø´Ù‡Ø±</option>
                <option>Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©</option>
                <option>Ø¯ÙØ¹ØªÙŠÙ† 50% Ùˆ 50%</option>
              </select></div>
            <div class="field small"><label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯</label><select id="status">
                <option value="active">Ù†Ø´Ø·</option>
                <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</option>
                <option value="expired">Ù…Ù†ØªÙ‡ÙŠ</option>
              </select></div>
          </div>

          <div class="row">
            <div class="field">
              <label>Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ (Ø«Ø§Ø¨Øª)</label>
              <input type="text" id="firstParty" value="Ø´Ø±ÙƒØ© Ø¨ÙØª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª" readonly
                style="background:#f8f9fc;border-color:#e6ecf8;color:#4a5568;" />
              <div class="muted" style="font-size:12px">Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ Ø«Ø§Ø¨Øª Ø¯Ø§Ø¦Ù…Ø§Ù‹: Ø´Ø±ÙƒØ© Ø¨ÙØª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª</div>
            </div>
            <div class="field">
              <label>Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø§Ù„Ø¹Ù…ÙŠÙ„)</label>
              <input type="text" id="secondParty" readonly
                style="background:#f8f9fc;border-color:#e6ecf8;color:#4a5568;" />
              <div class="muted" style="font-size:12px">Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹)</label>
              <input type="email" id="clientEmail" placeholder="client@example.com" />
              <div class="muted" style="font-size:12px">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¢Ù…Ù† Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯</div>
            </div>
            <div class="field">
              <label>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
              <input type="tel" id="clientPhone" placeholder="05xxxxxxxx" />
              <div class="muted" style="font-size:12px">Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
            </div>
          </div>

          <!-- Contract Attachments Section (Only shown for NEW contracts, not renewals) -->
          <div id="contractAttachmentsSection"
            style="display:none; margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f8fafc 0%, #e3f2fd 100%); border-radius: 12px; border: 2px solid #3b82f6;">
            <h4 style="margin: 0 0 16px 0; color: #1e40af; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 1.5rem;">ğŸ“</span>
              Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯
            </h4>
            <div class="muted" style="font-size:12px; margin-bottom: 16px; color: #475569;">
              Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯. Ø¹Ù†Ø¯ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ù„Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª.
            </div>

            <div class="row">
              <div class="field">
                <label>1- ØµÙˆØ±Ø© Ø§Ù„Ø±Ø®ØµØ© (Ø±ÙØ¹ ØµÙˆØ±Ø©)</label>
                <input type="file" id="licenseImage" accept="image/*"
                  style="padding: 12px; border: 2px dashed #3b82f6; border-radius: 8px; background: white;" />
                <div class="muted" style="font-size:12px">Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„Ø±Ø®ØµØ© (JPG, PNG, GIF)</div>
                <div id="licenseImagePreview" style="margin-top: 8px;"></div>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label>2- Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©</label>
                <input type="text" id="containerLocationAttachment" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©" />
                <div class="muted" style="font-size:12px">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©</div>
              </div>
              <div class="field">
                <label>3- Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</label>
                <input type="text" id="commercialRegistry" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ" />
                <div class="muted" style="font-size:12px">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„</div>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label>4- Ø±Ø®ØµØ© Ø§Ù„Ù†Ø´Ø§Ø·</label>
                <input type="text" id="activityLicense" placeholder="Ø±Ù‚Ù… Ø±Ø®ØµØ© Ø§Ù„Ù†Ø´Ø§Ø·" />
                <div class="muted" style="font-size:12px">Ø±Ù‚Ù… Ø±Ø®ØµØ© Ù…Ø²Ø§ÙˆÙ„Ø© Ø§Ù„Ù†Ø´Ø§Ø·</div>
              </div>
              <div class="field">
                <label>5- Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</label>
                <input type="text" id="taxNumber" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„" />
                <div class="muted" style="font-size:12px">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„</div>
              </div>
            </div>
          </div>

          <!-- Contract Attachments Display -->
          <div id="attachmentsDisplay"
            style="display:none; margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
            <h4 style="margin: 0 0 12px 0; color: #1e293b;">Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯</h4>
            <div id="attachmentsList"></div>
          </div>

          <div class="actions">
            <button class="btn primary" id="saveContractBtn">Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯</button>
            <button class="btn" id="sendForSigningBtn" title="Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù‚Ø¯ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„ØªÙˆÙ‚ÙŠØ¹">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªÙˆÙ‚ÙŠØ¹</button>
            <!-- <button class="btn" id="generateContractFileBtn" title="Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø¹Ù‚Ø¯ (Word/PDF)">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø¹Ù‚Ø¯</button> -->
            <button class="btn" id="cancelFormBtn">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>

        <div class="controls">
          <button class="btn" id="refreshBtn">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
          <button class="btn" id="createUserBtn">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… (admin)</button>
          <input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯..." />
          <select id="filter">
            <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option value="active">Ù†Ø´Ø·</option>
            <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</option>
            <option value="expired">Ù…Ù†ØªÙ‡ÙŠ</option>
          </select>
          <button class="btn" id="exportExcelBtn">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
        </div>

        <div class="table-wrap" id="contractsArea">
          <table>
            <thead>
              <tr>
                <th class="sortable" data-sort="id" onclick="sortTable('id')">Ø±Ù‚Ù… <span class="sort-arrow"></span></th>
                <th class="sortable" data-sort="client_name" onclick="sortTable('client_name')">Ø§Ù„Ø¹Ù…ÙŠÙ„ <span
                    class="sort-arrow"></span></th>
                <th class="sortable" data-sort="service_name" onclick="sortTable('service_name')">Ø§Ù„Ø®Ø¯Ù…Ø© <span
                    class="sort-arrow"></span></th>
                <th class="sortable" data-sort="from_date" onclick="sortTable('from_date')">Ø§Ù„ÙØªØ±Ø© <span
                    class="sort-arrow"></span></th>
                <th class="sortable" data-sort="total_price" onclick="sortTable('total_price')">Ø§Ù„Ø³Ø¹Ø± <span
                    class="sort-arrow"></span></th>
                <th class="sortable" data-sort="manager" onclick="sortTable('manager')">Ù…Ø³ÙˆÙ‚ <span
                    class="sort-arrow"></span></th>
                <th class="sortable" data-sort="collector" onclick="sortTable('collector')">Ù…Ø­ØµÙ„ <span
                    class="sort-arrow"></span></th>
                <th class="sortable" data-sort="status" onclick="sortTable('status')">Ø§Ù„Ø­Ø§Ù„Ø© <span
                    class="sort-arrow"></span></th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="contractsTbody"></tbody>
          </table>
        </div>

        <!-- Reports Section - Enhanced with Manager & Collector Stats -->
        <div class="table-wrap" id="reportsArea" style="display:none;">
          <h3 style="margin-bottom: 1.5rem;">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>

          <!-- Key Metrics -->
          <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div
              style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
              <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚ÙˆØ¯</div>
              <div style="font-size: 2.5rem; font-weight: 700;" id="reportTotalContracts">0</div>
            </div>

            <div
              style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
              <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
              <div style="font-size: 2.5rem; font-weight: 700;" id="reportTotalRevenue">0</div>
              <div style="font-size: 0.75rem; opacity: 0.8;">Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ</div>
            </div>

            <div
              style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
              <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
              <div style="font-size: 2.5rem; font-weight: 700;" id="reportTotalClients">0</div>
            </div>

            <div
              style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
              <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯</div>
              <div style="font-size: 2.5rem; font-weight: 700;" id="reportAvgContract">0</div>
              <div style="font-size: 0.75rem; opacity: 0.8;">Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ</div>
            </div>
          </div>

          <!-- Status Distribution -->
          <div
            style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;">
            <h4 style="margin-bottom: 1rem;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div style="padding: 1rem; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
                <div style="color: #059669; font-size: 0.875rem; margin-bottom: 0.25rem;">Ù†Ø´Ø·Ø©</div>
                <div style="font-size: 1.75rem; font-weight: 700; color: #047857;" id="reportActiveCount">0</div>
              </div>
              <div style="padding: 1rem; background: #fffbeb; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <div style="color: #d97706; font-size: 0.875rem; margin-bottom: 0.25rem;">Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</div>
                <div style="font-size: 1.75rem; font-weight: 700; color: #b45309;" id="reportPendingCount">0</div>
              </div>
              <div style="padding: 1rem; background: #fef2f2; border-radius: 8px; border-left: 4px solid #ef4444;">
                <div style="color: #dc2626; font-size: 0.875rem; margin-bottom: 0.25rem;">Ù…Ù†ØªÙ‡ÙŠØ©</div>
                <div style="font-size: 1.75rem; font-weight: 700; color: #b91c1c;" id="reportExpiredCount">0</div>
              </div>
            </div>
          </div>

          <!-- Manager Performance -->
          <div
            style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;">
            <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-size: 1.5rem;">ğŸ“ˆ</span>
              Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ†
            </h4>
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„Ù…Ø³ÙˆÙ‚</th>
                  <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚ÙˆØ¯</th>
                  <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                  <th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</th>
                </tr>
              </thead>
              <tbody id="managerStatsTbody"></tbody>
            </table>
          </div>

          <!-- Collector Performance -->
          <div
            style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;">
            <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-size: 1.5rem;">ğŸ’°</span>
              Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø­ØµÙ„ÙŠÙ†
            </h4>
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„Ù…Ø­ØµÙ„</th>
                  <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚ÙˆØ¯</th>
                  <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                  <th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</th>
                </tr>
              </thead>
              <tbody id="collectorStatsTbody"></tbody>
            </table>
          </div>

          <!-- Top Clients -->
          <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e5e7eb;">
            <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-size: 1.5rem;">ğŸ†</span>
              Ø£ÙØ¶Ù„ 5 Ø¹Ù…Ù„Ø§Ø¡ (Ø­Ø³Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯)
            </h4>
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                  <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚ÙˆØ¯</th>
                  <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
              </thead>
              <tbody id="topClientsTbody"></tbody>
            </table>
          </div>
        </div>



      </section>
    </main>

    <footer style="text-align:center;margin-top:18px" class="muted">Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© - ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ÙÙŠØ± Ø§Ù„Ø£Ø³Ø±Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ…
    </footer>

    <!-- Theme Flower Switcher -->
    <div class="theme-flower">
      <div class="flower-center" title="Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ…ÙŠÙ…">ğŸŒ¸</div>
      <div class="flower-petal petal-1" onmouseover="switchTheme('theme-modern.css')" title="Modern">Modern</div>
      <div class="flower-petal petal-2" onmouseover="switchTheme('theme-binance.css')" title="Binance">Binance</div>
      <div class="flower-petal petal-3" onmouseover="switchTheme('theme-kucoin.css')" title="KuCoin">KuCoin</div>
      <div class="flower-petal petal-4" onmouseover="switchTheme('theme-ocean.css')" title="Ocean">Ocean</div>
      <div class="flower-petal petal-5" onmouseover="switchTheme('theme-dark-gold.css')" title="Dark Gold">Dark</div>
      <div class="flower-petal petal-6" onmouseover="switchTheme('theme-minimal.css')" title="Minimal">Minimal</div>
    </div>
  </div>

  <!-- Terms manager modal -->
  <div id="termsModal" class="map-modal" role="dialog" aria-hidden="true" style="display:none;">
    <div class="map-modal-content" style="max-width:900px;">
      <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙˆØ· Ùˆ Ø§Ù„Ø¨Ù†ÙˆØ¯</h4>

      <div style="display:flex;gap:12px;margin-bottom:8px;align-items:center;">
        <button class="btn" id="termsRefreshBtn">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        <button class="btn" id="termsSelectAllBtn">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
        <button class="btn" id="termsDeselectAllBtn">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
        <button class="btn primary" id="termsInsertBtn">Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø¹Ù‚Ø¯</button>
        <button class="btn" id="termsExportBtn">ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¥Ù„Ù‰ Word</button>
        <div style="flex:1"></div>
        <button class="btn" id="termsCloseBtn">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div style="display:flex;gap:12px;">
        <div
          style="flex:1;min-width:300px;max-height:480px;overflow:auto;border:1px solid #e6ecf8;padding:8px;border-radius:8px;background:#fff;">
          <div id="termsList"></div>
        </div>

        <aside style="width:380px;min-width:240px;">
          <h5>Ù…Ø¹Ø§ÙŠÙ†Ø© / Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¯</h5>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <input id="termId" type="hidden" />
            <label>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯</label>
            <input id="termName" />
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</label>
            <select id="termType">
              <option value="text">Ù†Øµ</option>
              <option value="selection">Ø§Ø®ØªÙŠØ§Ø± (Ù‚Ø§Ø¦Ù…Ø©)</option>
            </select>
            <label id="termContentLabel">Ù†Øµ Ø§Ù„Ø¨Ù†Ø¯</label>
            <!-- Quill Editor Container with A4 Paper Style -->
            <div style="margin-bottom: 12px;">
              <button class="btn primary" id="openFullscreenEditorBtn" type="button">
                ğŸ“ ÙØªØ­ ÙÙŠ Ù…Ø­Ø±Ø± Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
              </button>
            </div>
            <div class="a4-paper-container" style="max-height: 400px; overflow-y: auto;">
              <div class="a4-paper" style="min-height: 200px;">
                <div id="termContent"></div>
              </div>
            </div>
            <div class="muted" style="font-size:12px">Ù„Ù†ÙˆØ¹ "Ø§Ø®ØªÙŠØ§Ø±" Ø¶Ø¹ ÙƒÙ„ Ø®ÙŠØ§Ø± ÙÙŠ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯. Ø§Ù†Ù‚Ø± "ÙØªØ­ ÙÙŠ Ù…Ø­Ø±Ø± Ù…Ù„Ø¡
              Ø§Ù„Ø´Ø§Ø´Ø©" Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ¬Ø±Ø¨Ø© ØªØ­Ø±ÙŠØ± Ø£ÙØ¶Ù„.</div>

            <div style="display:flex;gap:8px;">
              <button class="btn primary" id="saveTermBtn">Ø­ÙØ¸ Ø§Ù„Ø¨Ù†Ø¯</button>
              <button class="btn" id="newTermBtn">Ø¬Ø¯ÙŠØ¯</button>
              <button class="btn" id="deleteTermBtn"
                style="background:#f8d7da;border-color:#f5c6cb;color:#721c24">Ø­Ø°Ù</button>
            </div>
          </div>
        </aside>
      </div>

    </div>
  </div>

  <!-- Google Maps picker modal (hidden). It does NOT embed Google Maps; it provides "ÙØªØ­ Ø®Ø±Ø§Ø¦Ø· Google" + paste flow. -->
  <div id="mapModal" class="map-modal" role="dialog" aria-hidden="true" style="display:none;">
    <div class="map-modal-content">
      <h4 id="mapModalTitle">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø¨Ø± Ø®Ø±Ø§Ø¦Ø· Google</h4>

      <div id="mapFallback" style="margin-bottom:8px;">
        <p class="muted">Ø³ÙŠØªÙ… ÙØªØ­ Ø®Ø±Ø§Ø¦Ø· Google ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© â€” Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø«Ù… Ø§Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø© (Share Ø£Ùˆ
          Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†).</p>
        <ol style="direction:rtl;text-align:right;">
          <li>ÙÙŠ Ø®Ø±Ø§Ø¦Ø· Google: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… "What's here?" Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª.</li>
          <li>Ø§Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø© (Ctrl+C) Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹.</li>
          <li>Ø§Ø±Ø¬Ø¹ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ§Ø¶ØºØ· "Ù„ØµÙ‚ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©". Ø§Ù„Ù†Ø¸Ø§Ù… Ø³ÙŠØ³ØªØ®Ø±Ø¬ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙˆÙŠØ¶Ø¹Ù‡Ø§ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„.</li>
        </ol>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
        <button class="btn primary" id="openGoogleMapsBtn">Ø§ÙØªØ­ Ø®Ø±Ø§Ø¦Ø· Google</button>
        <button class="btn" id="pasteCoordsBtn">Ù„ØµÙ‚ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©</button>
        <input id="selectedCoords" placeholder="Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ø®Ø±Ø§Ø¦Ø· Google Ø£Ùˆ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù‡Ù†Ø§"
          style="flex:1;padding:8px;border-radius:8px;border:1px solid #e0e6ef" />
        <button class="btn" id="confirmCoordsBtn">ØªØ£ÙƒÙŠØ¯</button>
        <button class="btn" id="cancelCoordsBtn">Ø¥Ù„ØºØ§Ø¡</button>
      </div>

      <div class="muted" style="font-size:12px">ÙŠØ¯Ø¹Ù… Ù„ØµÙ‚: Ø±Ø§Ø¨Ø· Ø®Ø±Ø§Ø¦Ø· Google (ÙŠØ­ØªÙˆÙŠ @lat,lng Ø£Ùˆ !3dLAT!4dLNG) Ø£Ùˆ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
        ÙŠØ¯ÙˆÙŠØ§Ù‹ (lat,lng) Ø£Ùˆ Ø¨ØµÙŠØºØ© N/S/E/W.</div>
    </div>
  </div>

  <!-- Contract Signing Modal -->
  <div id="signingModal" class="map-modal" role="dialog" aria-hidden="true" style="display:none;">
    <div class="map-modal-content" style="max-width:600px;">
      <h4>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù‚Ø¯ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„ØªÙˆÙ‚ÙŠØ¹</h4>

      <div class="row" style="margin-bottom:16px;">
        <div class="field">
          <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label>
          <select id="sendMethod" style="width:100%;">
            <option value="link">Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· ØªÙˆÙ‚ÙŠØ¹ Ø¢Ù…Ù†</option>
            <!-- <option value="email">Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</option> -->
            <option value="whatsapp">Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</option>
            <!-- <option value="file">ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Word/PDF</option> -->
          </select>
        </div>
      </div>

      <div id="linkSection" class="send-section">
        <div class="field">
          <label>Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¢Ù…Ù†</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input id="signingLink" readonly style="flex:1;font-family:monospace;font-size:12px;" />
            <button class="btn" id="copyLinkBtn">Ù†Ø³Ø®</button>
          </div>
          <div class="muted" style="font-size:12px">Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙØ±ÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ¢Ù…Ù† Ù„Ù„ØªÙˆÙ‚ÙŠØ¹</div>
        </div>
      </div>

      <div id="emailSection" class="send-section" style="display:none;">
        <div class="field">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„</label>
          <input type="email" id="signingEmail" placeholder="client@example.com" />
        </div>
        <div class="field">
          <label>Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØµØµØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="emailMessage" style="height:80px;"
            placeholder="ÙŠØ±Ø¬Ù‰ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø±ÙÙ‚ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ..."></textarea>
        </div>
      </div>

      <div id="whatsappSection" class="send-section" style="display:none;">
        <div class="field">
          <label>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
          <input type="tel" id="whatsappNumber" placeholder="05xxxxxxxx" />
        </div>
        <div class="field">
          <label>Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label>
          <textarea id="whatsappMessage" style="height:80px;" readonly></textarea>
        </div>
      </div>

      <!-- <div id="fileSection" class="send-section" style="display:none;"> -->
      <!-- <div class="field">
          <label>ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù</label>
          <select id="fileFormat">
            <option value="word">Ù…Ù„Ù Word (.docx)</option>
            <option value="pdf">Ù…Ù„Ù PDF</option>
          </select>
        </div> -->
      <!-- <div class="field">
          <label>Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©</label>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <label style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" id="includeTerms" checked />
              <span>Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" id="includeSignatures" checked />
              <span>Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" id="includeQrCode" checked />
              <span>Ø¥Ø¯Ø±Ø§Ø¬ ÙƒÙˆØ¯ QR Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯</span>
            </label>
          </div>
        </div> -->
      <!-- </div> -->

      <div class="row">
        <!-- <div class="field">
          <label>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ©</label>
          <select id="authMethod" style="width:100%;">
            <option value="email_only">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙÙ‚Ø·</option>
            <option value="email_code">Ø§Ù„Ø¨Ø±ÙŠØ¯ + Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</option>
            <option value="phone_code">Ø§Ù„Ø¬ÙˆØ§Ù„ + Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</option>
            <option value="id_verification">Ø§Ù„Ø¨Ø±ÙŠØ¯ + ØªØ­Ù‚Ù‚ Ø§Ù„Ù‡ÙˆÙŠØ©</option>
          </select>
          <div class="muted" style="font-size:12px">Ù„Ø²ÙŠØ§Ø¯Ø© Ø£Ù…Ø§Ù† Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆÙ…Ù†Ø¹ Ø§Ù„ØªÙ„Ø§Ø¹Ø¨</div>
        </div> -->
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px;">
        <button class="btn" id="cancelSigningBtn">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn primary" id="confirmSendBtn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>

  <!-- Fullscreen A4 Document Editor Modal -->
  <div id="a4EditorModal" class="a4-editor-modal" role="dialog" aria-hidden="true">
    <div class="a4-editor-content">
      <div class="a4-editor-header">
        <h3 id="a4EditorTitle">ğŸ“ Ù…Ø­Ø±Ø± Ø§Ù„Ù…Ø³ØªÙ†Ø¯ - Ù†Øµ Ø§Ù„Ø¨Ù†Ø¯</h3>
        <div style="display:flex;gap:8px;">
          <button class="btn primary" id="saveTermFullscreenBtn">Ø­ÙØ¸ Ø§Ù„Ø¨Ù†Ø¯</button>
          <button class="btn" id="newTermFullscreenBtn">Ø¬Ø¯ÙŠØ¯</button>
          <button class="a4-editor-close" id="closeA4EditorBtn">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div class="a4-paper-container">
        <div class="a4-paper">
          <div id="termContentFullscreen"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Manager/Collector Management Modal -->
  <div id="listManagementModal" class="map-modal" role="dialog" aria-hidden="true" style="display:none;">
    <div class="map-modal-content" style="max-width:600px;">
      <h4 id="listManagementTitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h4>

      <div style="margin-bottom:20px;">
        <h5 style="margin-bottom:12px;">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h5>
        <div id="currentListItems"
          style="max-height:300px;overflow-y:auto;border:1px solid #e6ecf8;padding:12px;border-radius:8px;background:#fff;">
        </div>
      </div>

      <div style="margin-bottom:20px;">
        <h5 style="margin-bottom:12px;">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</h5>
        <div style="display:flex;gap:8px;">
          <input id="newListItemInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…..."
            style="flex:1;padding:10px;border-radius:8px;border:1px solid #e0e6ef" />
          <button class="btn primary" id="addListItemBtn">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button class="btn" id="closeListManagementBtn">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <script>

    // Global closeModal function
    window.closeModal = function (modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.style.display = 'none';
    };

    // Final integrated index.html: Google Maps paste-based picker (no API key required).
    console.log('âœ… INDEX.HTML LOADED - VERSION: 2025-12-06-02:30 - PRICING TERM FEATURE ACTIVE');
    document.addEventListener('DOMContentLoaded', () => {
      const API_BASE = '/api';
      let token = null;
      let currentPickerTarget = null; // 'container' or 'pickup'

      const $ = id => document.getElementById(id);
      const showElem = el => { if (!el) return; el.style.display = (el.id === 'mapModal') ? 'flex' : 'block'; el.setAttribute('aria-hidden', 'false'); };
      const hideElem = el => { if (!el) return; el.style.display = 'none'; el.setAttribute('aria-hidden', 'true'); };

      // double-guard hide
      hideElem($('formWrap'));
      hideElem($('mapModal'));

      // Click outside to close all modals
      document.addEventListener('click', function (e) {
        // Check if click target has class 'modal' (the backdrop)
        if (e.target.classList && e.target.classList.contains('modal')) {
          hideElem(e.target);
        }
      });

      // Escape key to close all modals
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          const modals = document.querySelectorAll('.modal');
          modals.forEach(modal => hideElem(modal));
        }
      });

      // Theme Switcher Function
      window.switchTheme = function (themeName) {
        const themeLink = document.querySelector('link[href*="theme-"]');
        if (themeLink) {
          themeLink.href = 'styles/' + themeName;
          // Save preference to localStorage
          localStorage.setItem('selectedTheme', themeName);
          console.log('Theme switched to:', themeName);
        }
      };

      // Load saved theme on page load
      const savedTheme = localStorage.getItem('selectedTheme');
      if (savedTheme) {
        const themeLink = document.querySelector('link[href*="theme-"]');
        if (themeLink) {
          themeLink.href = 'styles/' + savedTheme;
        }
      }

      // --- Initialize Quill Editor ---
      // Register custom font sizes
      var Size = Quill.import('attributors/style/size');
      var customSizes = ['8px', '10px', '12px', '14px', '16px', '18px', '20px', '24px', '30px', '36px', '48px', '60px', '72px'];
      Size.whitelist = customSizes;
      Quill.register(Size, true);

      var quill = new Quill('#termContent', {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ 'header': [1, 2, 3, false] }],
            [{ 'size': customSizes }],
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'align': '' }, { 'align': 'center' }, { 'align': 'right' }, { 'align': 'justify' }],
            [{ 'direction': 'rtl' }],
            [{ 'color': [] }, { 'background': [] }],
            ['clean']
          ]
        }
      });

      // Initialize fullscreen Quill editor
      var quillFullscreen = new Quill('#termContentFullscreen', {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ 'header': [1, 2, 3, false] }],
            [{ 'size': customSizes }],
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'align': '' }, { 'align': 'center' }, { 'align': 'right' }, { 'align': 'justify' }],
            [{ 'direction': 'rtl' }],
            [{ 'color': [] }, { 'background': [] }],
            ['clean']
          ]
        }
      });

      // Fullscreen Editor Modal Handlers
      const a4EditorModal = document.getElementById('a4EditorModal');
      const openFullscreenBtn = document.getElementById('openFullscreenEditorBtn');
      const closeFullscreenBtn = document.getElementById('closeA4EditorBtn');

      openFullscreenBtn.addEventListener('click', function () {
        // Sync content from main editor to fullscreen editor
        quillFullscreen.root.innerHTML = quill.root.innerHTML;

        // Show fullscreen modal
        a4EditorModal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
      });

      closeFullscreenBtn.addEventListener('click', function () {
        // Sync content from fullscreen editor back to main editor
        quill.root.innerHTML = quillFullscreen.root.innerHTML;

        // Hide fullscreen modal
        a4EditorModal.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
      });

      // Close on ESC key
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && a4EditorModal.classList.contains('active')) {
          closeFullscreenBtn.click();
        }
      });

      // Close on backdrop click
      a4EditorModal.addEventListener('click', function (e) {
        if (e.target === a4EditorModal) {
          closeFullscreenBtn.click();
        }
      });

      // Fullscreen Save/New Buttons
      const saveFullscreenBtn = document.getElementById('saveTermFullscreenBtn');
      const newFullscreenBtn = document.getElementById('newTermFullscreenBtn');

      saveFullscreenBtn.addEventListener('click', function () {
        // Sync content back to main editor
        quill.root.innerHTML = quillFullscreen.root.innerHTML;
        // Trigger main save button
        document.getElementById('saveTermBtn').click();
      });

      newFullscreenBtn.addEventListener('click', function () {
        // Trigger main new button
        document.getElementById('newTermBtn').click();
        // Sync cleared content to fullscreen editor
        quillFullscreen.root.innerHTML = quill.root.innerHTML;
        // Also clear inputs in fullscreen if we want to reflect that (though inputs are not in fullscreen)
        // The main newTermBtn clears the form, so syncing quill is enough for the editor part.
      });

      // --- LocalStorage Helpers ---
      const STORAGE_KEY_CONTRACTS = 'clean_service_contracts_v1';
      const STORAGE_KEY_CLIENTS = 'clean_service_clients_v1';
      const STORAGE_KEY_USERS = 'clean_service_users_v1';

      function getStoredData(key) {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          console.error('Error reading from localStorage', e);
          return [];
        }
      }

      function setStoredData(key, data) {
        try {
          localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
          console.error('Error writing to localStorage', e);
          alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù…Ù…ØªÙ„Ø¦Ø©ØŸ)');
        }
      }

      // Mock apiFetch for compatibility with existing Terms logic if needed, 
      // but we will try to rely on local storage helpers for main logic.
      // --- API helper ---
      async function apiFetch(path, opts = {}) {
        opts.headers = opts.headers || {};
        if (!opts.headers['Content-Type'] && !(opts.body instanceof FormData)) opts.headers['Content-Type'] = 'application/json';
        if (token) opts.headers['Authorization'] = 'Bearer ' + token;
        const res = await fetch(API_BASE + path, opts);
        if (res.status === 401) { alert('Ù…Ø·Ù„ÙˆØ¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ø±Ù…Ø² Ù…Ù†ØªÙ‡ÙŠ'); throw new Error('unauth'); }
        const data = await res.json().catch(() => null);
        if (!res.ok) throw new Error((data && data.message) || res.statusText);
        return data;
      }

      // --- Number to Arabic Text Converter ---
      function numberToArabicText(num) {
        if (!num || isNaN(num)) return '';

        num = Math.round(num);
        if (num === 0) return 'ØµÙØ±';
        if (num < 0) return 'Ø³Ø§Ù„Ø¨ ' + numberToArabicText(Math.abs(num));

        const ones = ['', 'ÙˆØ§Ø­Ø¯', 'Ø§Ø«Ù†Ø§Ù†', 'Ø«Ù„Ø§Ø«Ø©', 'Ø£Ø±Ø¨Ø¹Ø©', 'Ø®Ù…Ø³Ø©', 'Ø³ØªØ©', 'Ø³Ø¨Ø¹Ø©', 'Ø«Ù…Ø§Ù†ÙŠØ©', 'ØªØ³Ø¹Ø©'];
        const tens = ['', '', 'Ø¹Ø´Ø±ÙˆÙ†', 'Ø«Ù„Ø§Ø«ÙˆÙ†', 'Ø£Ø±Ø¨Ø¹ÙˆÙ†', 'Ø®Ù…Ø³ÙˆÙ†', 'Ø³ØªÙˆÙ†', 'Ø³Ø¨Ø¹ÙˆÙ†', 'Ø«Ù…Ø§Ù†ÙˆÙ†', 'ØªØ³Ø¹ÙˆÙ†'];
        const teens = ['Ø¹Ø´Ø±Ø©', 'Ø£Ø­Ø¯ Ø¹Ø´Ø±', 'Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±', 'Ø«Ù„Ø§Ø«Ø© Ø¹Ø´Ø±', 'Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø±', 'Ø®Ù…Ø³Ø© Ø¹Ø´Ø±', 'Ø³ØªØ© Ø¹Ø´Ø±', 'Ø³Ø¨Ø¹Ø© Ø¹Ø´Ø±', 'Ø«Ù…Ø§Ù†ÙŠØ© Ø¹Ø´Ø±', 'ØªØ³Ø¹Ø© Ø¹Ø´Ø±'];
        const hundreds = ['', 'Ù…Ø§Ø¦Ø©', 'Ù…Ø¦ØªØ§Ù†', 'Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©', 'Ø£Ø±Ø¨Ø¹Ù…Ø§Ø¦Ø©', 'Ø®Ù…Ø³Ù…Ø§Ø¦Ø©', 'Ø³ØªÙ…Ø§Ø¦Ø©', 'Ø³Ø¨Ø¹Ù…Ø§Ø¦Ø©', 'Ø«Ù…Ø§Ù†Ù…Ø§Ø¦Ø©', 'ØªØ³Ø¹Ù…Ø§Ø¦Ø©'];

        function convertLessThanThousand(n) {
          if (n === 0) return '';

          let result = '';

          // Hundreds
          const h = Math.floor(n / 100);
          if (h > 0) {
            result += hundreds[h];
            n %= 100;
            if (n > 0) result += ' Ùˆ';
          }

          // Tens and ones
          if (n >= 10 && n <= 19) {
            result += teens[n - 10];
          } else {
            const t = Math.floor(n / 10);
            const o = n % 10;

            if (t > 0) {
              result += tens[t];
              if (o > 0) result += ' Ùˆ';
            }

            if (o > 0) {
              result += ones[o];
            }
          }

          return result;
        }

        if (num < 1000) {
          return convertLessThanThousand(num);
        }

        // Thousands
        if (num < 1000000) {
          const thousands = Math.floor(num / 1000);
          const remainder = num % 1000;

          let result = '';
          if (thousands === 1) {
            result = 'Ø£Ù„Ù';
          } else if (thousands === 2) {
            result = 'Ø£Ù„ÙØ§Ù†';
          } else if (thousands >= 3 && thousands <= 10) {
            result = convertLessThanThousand(thousands) + ' Ø¢Ù„Ø§Ù';
          } else {
            result = convertLessThanThousand(thousands) + ' Ø£Ù„Ù';
          }

          if (remainder > 0) {
            result += ' Ùˆ' + convertLessThanThousand(remainder);
          }

          return result;
        }

        // Millions
        const millions = Math.floor(num / 1000000);
        const remainder = num % 1000000;

        let result = '';
        if (millions === 1) {
          result = 'Ù…Ù„ÙŠÙˆÙ†';
        } else if (millions === 2) {
          result = 'Ù…Ù„ÙŠÙˆÙ†Ø§Ù†';
        } else {
          result = convertLessThanThousand(millions) + ' Ù…Ù„ÙŠÙˆÙ†';
        }

        if (remainder > 0) {
          result += ' Ùˆ' + numberToArabicText(remainder);
        }

        return result;
      }

      // --- Pricing Term Management ---
      const PRICING_TERM_ID = 'pricing_term_auto';

      async function ensurePricingTerm() {
        try {
          console.log('ğŸ” [DEBUG] ensurePricingTerm: Starting...');

          // Check localStorage first (more reliable)
          const localTerms = loadLocalTerms();
          const existingLocalTerm = localTerms.find(t => (t.id || t._id) === PRICING_TERM_ID);

          if (!existingLocalTerm) {
            console.log('ğŸ” [DEBUG] ensurePricingTerm: Term not in localStorage, creating it');
            // Create the pricing term
            const newTerm = {
              id: PRICING_TERM_ID,
              name: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯',
              type: 'text',
              content: 'Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚ÙŠÙ… Ø§Ù„Ø¹Ù‚Ø¯',
              isDefault: true
            };

            // Save to localStorage first
            localTerms.push(newTerm);
            saveLocalTerms(localTerms);
            console.log('âœ… [DEBUG] ensurePricingTerm: Term saved to localStorage');

            // Try API as well (but don't fail if it doesn't work)
            try {
              await saveTerm(newTerm);
              console.log('âœ… [DEBUG] ensurePricingTerm: Term also saved to API');
            } catch (err) {
              console.log('âš ï¸ [DEBUG] ensurePricingTerm: API save failed (this is OK, using localStorage):', err.message);
            }
          } else {
            console.log('âœ… [DEBUG] ensurePricingTerm: Term already exists in localStorage');
          }
        } catch (err) {
          console.error('âŒ [DEBUG] ensurePricingTerm: Error:', err);
        }
      }

      async function updatePricingTermContent() {
        try {
          console.log('ğŸ” [DEBUG] updatePricingTermContent: Starting...');
          // Get values from form
          const monthlyFeeInput = $('monthlyFee')?.value || '0';
          const taxInput = $('tax')?.value || '15%';
          const totalPriceInput = $('totalPrice')?.value || '0';
          const duration = $('duration')?.value || 'Ø³Ù†ÙˆÙŠ';
          const paymentType = $('paymentType')?.value || 'Ø³Ù†ÙˆÙŠØ©';

          console.log('ğŸ” [DEBUG] updatePricingTermContent: Form values:', { monthlyFeeInput, taxInput, totalPriceInput, duration, paymentType });

          // Parse values
          const monthlyFee = parseFloat(monthlyFeeInput) || 0;
          const taxRate = parseFloat(taxInput.replace('%', '')) || 15;
          const totalPrice = parseFloat(totalPriceInput) || 0;

          // Calculate Monthly Total (Fee + Tax)
          const monthlyTax = (monthlyFee * taxRate) / 100;
          const monthlyTotal = Math.round(monthlyFee + monthlyTax);

          // Calculate Contract Total (already total price from form, which includes duration)
          const contractTotal = Math.round(totalPrice);

          // Convert to Arabic text
          const monthlyTotalText = numberToArabicText(monthlyTotal);
          const contractTotalText = numberToArabicText(contractTotal);

          // 1. Monthly Clause
          // "1- Ù‚ÙŠÙ…Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø´Ù‡Ø±ÙŠØ§ Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡ (MonthlyTotal) ArabicTotal Ø±ÙŠØ§Ù„ ÙÙ‚Ø· Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (15%)"
          const clause1 = `1- Ù‚ÙŠÙ…Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø´Ù‡Ø±ÙŠØ§ Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡ (${monthlyTotal} Ø±ÙŠØ§Ù„) ${monthlyTotalText} Ø±ÙŠØ§Ù„ ÙÙ‚Ø· Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (${taxRate}%)`;

          // 2. Annual/Duration Clause
          // Determine duration text
          let durationText = 'Ø³Ù†ÙˆÙŠØ§';
          if (duration === '6 Ø£Ø´Ù‡Ø±') durationText = 'Ù„Ù…Ø¯Ø© Ø³ØªØ© Ø£Ø´Ù‡Ø±';
          else if (duration === '3 Ø£Ø´Ù‡Ø±') durationText = 'Ù„Ù…Ø¯Ø© Ø«Ù„Ø§Ø«Ø© Ø£Ø´Ù‡Ø±';
          else if (duration === 'Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©') durationText = 'Ø¥Ø¬Ù…Ø§Ù„Ø§Ù‹';

          const clause2 = `2- Ù‚ÙŠÙ…Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ ${durationText} Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡ (${contractTotal} Ø±ÙŠØ§Ù„) ${contractTotalText} Ø±ÙŠØ§Ù„ ÙÙ‚Ø· Ø´Ø§Ù…Ù„ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (${taxRate}%)`;

          // 3. Payment Terms Clause
          // Determine payment text based on selection
          let paymentTermsText = '';
          if (paymentType === 'Ø¯ÙØ¹ØªÙŠÙ† 50% Ùˆ 50%') {
            paymentTermsText = 'Ø¹Ù„Ù‰ Ø¯ÙØ¹ØªÙŠÙ† 50% Ø¹Ù†Ø¯ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø¯ Ùˆ 50% Ø¨Ø¹Ø¯ Ø³ØªØ© Ø£Ø´Ù‡Ø±';
          } else if (paymentType === 'Ø³Ù†ÙˆÙŠØ©') {
            paymentTermsText = 'Ø¹Ù„Ù‰ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© Ø³Ù†ÙˆÙŠØ§Ù‹';
          } else if (paymentType === 'ÙƒÙ„ 6 Ø£Ø´Ù‡Ø±') {
            paymentTermsText = 'Ø¹Ù„Ù‰ Ø¯ÙØ¹Ø§Øª Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©';
          } else if (paymentType === 'ÙƒÙ„ 3 Ø£Ø´Ù‡Ø±') {
            paymentTermsText = 'Ø¹Ù„Ù‰ Ø¯ÙØ¹Ø§Øª Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ©';
          } else if (paymentType === 'Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©') {
            paymentTermsText = 'Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©';
          } else {
            paymentTermsText = paymentType;
          }

          const clause3 = `3- Ø§ØªÙÙ‚ Ø§Ù„Ø·Ø±ÙØ§Ù† Ø¹Ù„Ù‰ Ø£Ù† ÙŠØªÙ… Ø³Ø¯Ø§Ø¯ Ù‚ÙŠÙ…Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ ${paymentTermsText}ØŒ ÙˆÙŠØªÙ… ØªØ­ÙˆÙŠÙ„ Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯ Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ù…Ø¤Ø³Ø³Ø© Ø¨Ù‚Øª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§ØªØŒ Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ Ø±Ù‚Ù… Ø§Ù„Ø§ÙŠØ¨Ø§Ù† (SA8680000193608010458724)`;

          // The new "Calculated Block"
          const newCalcBlock = `${clause1}\n${clause2}\n${clause3}`;

          // Preserve existing Content if it was manually edited
          const existingTerm = loadLocalTerms().find(t => (t.id || t._id) === PRICING_TERM_ID);
          const termName = existingTerm ? existingTerm.name : 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯';

          let finalContent = newCalcBlock;

          if (existingTerm && existingTerm.content) {
            const oldContent = existingTerm.content;

            // Check if content has HTML formatting (starts with < tag)
            const hasFormatting = oldContent.trim().startsWith('<');

            if (hasFormatting) {
              // PRESERVE FORMATTING: Update only the numbers in the HTML
              console.log('âœ… Preserving HTML formatting, updating only numbers.');

              let updatedContent = oldContent;

              // Update Monthly Total (First occurrence of price in parentheses)
              // Pattern: (number Ø±ÙŠØ§Ù„) in clause 1
              updatedContent = updatedContent.replace(
                /(\(\s*)\d+(\s*Ø±ÙŠØ§Ù„\))/,
                `$1${monthlyTotal}$2`
              );

              // Update Monthly Total Arabic Text
              // Pattern: Arabic text before "Ø±ÙŠØ§Ù„ ÙÙ‚Ø· Ø´Ø§Ù…Ù„"
              updatedContent = updatedContent.replace(
                /(ÙˆÙ‚Ø¯Ø±Ù‡ \(\d+ Ø±ÙŠØ§Ù„\)\s+)[\u0600-\u06FF\s]+(\s+Ø±ÙŠØ§Ù„ ÙÙ‚Ø· Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)/,
                `$1${monthlyTotalText}$2`
              );

              // Update Tax Rate in clause 1 (first occurrence)
              updatedContent = updatedContent.replace(
                /(Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© \()\d+(%\))/,
                `$1${taxRate}$2`
              );

              // Update Annual/Contract Total (Second occurrence of price in parentheses)
              // We need to target specifically the second clause
              const clause2Regex = /2-.*?ÙˆÙ‚Ø¯Ø±Ù‡ \(\s*\d+\s*Ø±ÙŠØ§Ù„\)/;
              updatedContent = updatedContent.replace(
                clause2Regex,
                (match) => match.replace(/\d+(?=\s*Ø±ÙŠØ§Ù„\))/, contractTotal)
              );

              // Update Annual Total Arabic Text
              updatedContent = updatedContent.replace(
                /(2-.*?ÙˆÙ‚Ø¯Ø±Ù‡ \(\d+ Ø±ÙŠØ§Ù„\)\s+)[\u0600-\u06FF\s]+(\s+Ø±ÙŠØ§Ù„ ÙÙ‚Ø· Ø´Ø§Ù…Ù„)/,
                `$1${contractTotalText}$2`
              );

              // Update Tax Rate in clause 2
              updatedContent = updatedContent.replace(
                /(Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© \()\d+(%\))/,
                `$1${taxRate}$2`
              );

              finalContent = updatedContent;

            } else {
              // NO FORMATTING: Use old plain text replacement
              const pricingBlockRegex = /1- Ù‚ÙŠÙ…Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø´Ù‡Ø±ÙŠØ§ Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡[\s\S]*?Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ Ø±Ù‚Ù… Ø§Ù„Ø§ÙŠØ¨Ø§Ù† \(SA8680000193608010458724\)/;

              if (pricingBlockRegex.test(oldContent)) {
                console.log('âœ… Found existing pricing block (plain text). Replacing entire block.');
                finalContent = oldContent.replace(pricingBlockRegex, newCalcBlock);
              }
            }
          }
          // Update the term
          const updatedTerm = {
            id: PRICING_TERM_ID,
            name: termName,
            type: 'text',
            content: finalContent,
            isDefault: true
          };

          console.log('ğŸ” [DEBUG] updatePricingTermContent: Content generated:', finalContent.substring(0, 100) + '...');

          // Always update localStorage first (more reliable)
          const localTerms = loadLocalTerms();
          const idx = localTerms.findIndex(t => (t.id || t._id) === PRICING_TERM_ID);
          if (idx >= 0) {
            localTerms[idx] = updatedTerm;
            console.log('âœ… [DEBUG] updatePricingTermContent: Updated term in localStorage at index', idx);
          } else {
            console.log('âš ï¸ [DEBUG] updatePricingTermContent: Term not found in localStorage, adding it');
            localTerms.push(updatedTerm);
          }
          saveLocalTerms(localTerms);
          console.log('âœ… [DEBUG] updatePricingTermContent: Term saved to localStorage');

          // Try API as well (but don't fail if it doesn't work)
          try {
            await updateTerm(PRICING_TERM_ID, updatedTerm);
            console.log('âœ… [DEBUG] updatePricingTermContent: Term also updated via API');
          } catch (err) {
            console.log('âš ï¸ [DEBUG] updatePricingTermContent: API update failed (this is OK, using localStorage):', err.message);
          }

          return content;
        } catch (err) {
          console.error('âŒ [DEBUG] updatePricingTermContent: Error:', err);
          return null;
        }
      }

      // --- Manager/Collector Management ---
      const STORAGE_MANAGERS = 'managers_list';
      const STORAGE_COLLECTORS = 'collectors_list';
      let currentManagementType = null; // 'managers' or 'collectors'

      // Global variables for table sorting
      let contractsData = [];
      let currentSortColumn = '';
      let currentSortDirection = 'asc';

      // Load managers/collectors from localStorage
      function loadList(type) {
        const storageKey = type === 'managers' ? STORAGE_MANAGERS : STORAGE_COLLECTORS;
        const stored = localStorage.getItem(storageKey);
        return stored ? JSON.parse(stored) : [];
      }

      // Save list to localStorage
      function saveList(type, list) {
        const storageKey = type === 'managers' ? STORAGE_MANAGERS : STORAGE_COLLECTORS;
        localStorage.setItem(storageKey, JSON.stringify(list));
      }

      // Initialize lists from DB if empty
      async function initializeDropdownLists() {
        // Check if lists exist
        const managers = loadList('managers');
        const collectors = loadList('collectors');

        if (managers.length === 0 || collectors.length === 0) {
          try {
            // Fetch all contracts to extract unique values
            const contracts = await apiFetch('/contracts');
            if (contracts && Array.isArray(contracts)) {
              if (managers.length === 0) {
                const uniqueManagers = [...new Set(contracts.map(c => c.manager).filter(Boolean))];
                saveList('managers', uniqueManagers);
              }
              if (collectors.length === 0) {
                const uniqueCollectors = [...new Set(contracts.map(c => c.collector).filter(Boolean))];
                saveList('collectors', uniqueCollectors);
              }
            }
          } catch (err) {
            console.warn('Failed to initialize lists from DB:', err);
          }
        }
        populateDropdown('managers');
        populateDropdown('collectors');
      }

      // Populate dropdown
      function populateDropdown(type) {
        const list = loadList(type);
        const selectEl = $(type === 'managers' ? 'manager' : 'collector');
        if (!selectEl) return;

        const currentValue = selectEl.value;
        selectEl.innerHTML = '<option value="">-- Ø§Ø®ØªØ± --</option>';
        list.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item;
          opt.textContent = item;
          selectEl.appendChild(opt);
        });

        // Restore selection if it still exists
        if (currentValue && list.includes(currentValue)) {
          selectEl.value = currentValue;
        }
      }

      // Open management modal
      function openManagementModal(type) {
        currentManagementType = type;
        const title = type === 'managers' ? 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ†' : 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØµÙ„ÙŠÙ†';
        $('listManagementTitle').textContent = title;
        renderListItems();
        const modal = $('listManagementModal');
        if (modal) {
          modal.style.display = 'flex';
          modal.setAttribute('aria-hidden', 'false');
        }
      }

      // Render list items
      function renderListItems() {
        if (!currentManagementType) return;
        const list = loadList(currentManagementType);
        const container = $('currentListItems');
        if (!container) return;

        if (list.length === 0) {
          container.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±</div>';
          return;
        }

        container.innerHTML = '';
        list.forEach((item, index) => {
          const div = document.createElement('div');
          div.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eef4ff;';
          div.innerHTML = `
            <span>${item}</span>
            <button class="btn small" style="background:#f8d7da;border-color:#f5c6cb;color:#721c24;" data-index="${index}">Ø­Ø°Ù</button>
          `;
          container.appendChild(div);
        });

        // Attach delete handlers
        container.querySelectorAll('button[data-index]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.getAttribute('data-index'));
            deleteListItem(index);
          });
        });
      }

      // Add new item
      function addListItem() {
        if (!currentManagementType) return;
        const input = $('newListItemInput');
        if (!input) return;

        const newItem = input.value.trim();
        if (!newItem) {
          alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…');
          return;
        }

        const list = loadList(currentManagementType);
        if (list.includes(newItem)) {
          alert('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
          return;
        }

        list.push(newItem);
        saveList(currentManagementType, list);
        populateDropdown(currentManagementType);
        renderListItems();
        input.value = '';
      }

      // Delete item
      function deleteListItem(index) {
        if (!currentManagementType) return;
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŸ (Ù„Ù† ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)')) return;

        const list = loadList(currentManagementType);
        list.splice(index, 1);
        saveList(currentManagementType, list);
        populateDropdown(currentManagementType);
        renderListItems();
      }

      // Event Listeners for Management
      const manageManagersBtn = $('manageManagersBtn');
      if (manageManagersBtn) {
        manageManagersBtn.addEventListener('click', (e) => {
          e.preventDefault();
          openManagementModal('managers');
        });
      }

      const manageCollectorsBtn = $('manageCollectorsBtn');
      if (manageCollectorsBtn) {
        manageCollectorsBtn.addEventListener('click', (e) => {
          e.preventDefault();
          openManagementModal('collectors');
        });
      }

      const addListItemBtn = $('addListItemBtn');
      if (addListItemBtn) {
        addListItemBtn.addEventListener('click', addListItem);
      }

      const newListItemInput = $('newListItemInput');
      if (newListItemInput) {
        newListItemInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            addListItem();
          }
        });
      }

      const closeListManagementBtn = $('closeListManagementBtn');
      if (closeListManagementBtn) {
        closeListManagementBtn.addEventListener('click', () => {
          const modal = $('listManagementModal');
          if (modal) {
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
          }
          currentManagementType = null;
        });
      }

      $('loginBtn').addEventListener('click', async () => {
        try {
          const username = $('username').value;
          const password = $('password').value;
          const res = await fetch(API_BASE + '/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
          const json = await res.json();
          if (!res.ok) { $('authMsg').textContent = json.message || 'Ø®Ø·Ø£'; return; }
          token = json.token;
          $('authMsg').textContent = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ ' + (json.user.display_name || json.user.username);
          await loadServices();
          await initializeDropdownLists();
          await loadContracts();
        } catch (err) { console.error(err); alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); }
      });

      // Initialize on load
      loadServices();
      initializeDropdownLists();
      loadContracts();

      $('createUserBtn').addEventListener('click', async () => {
        const username = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:', 'sales1');
        if (!username) return;
        const password = prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:', 'password1');
        const role = prompt('Ø§Ù„Ø¯ÙˆØ± (sales, ops_manager, general_manager, client, admin):', 'sales');
        try {
          await apiFetch('/users', { method: 'POST', body: JSON.stringify({ username, password, role, display_name: username }) });
          alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
        } catch (err) { alert('Ø®Ø·Ø£: ' + err.message); }
      });

      async function loadServices() {
        const defaultServices = ['Ù†Ø¸Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ©', 'Ù†Ø¸Ø§ÙØ© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©', 'Ø·ÙˆØ§Ø±Ø¦', 'Ù†Ù‚Ù„ Ù†ÙØ§ÙŠØ§Øª', 'Ù†Ù‚Ù„ ÙƒÙØ±Ø§Øª', 'Ù†Ù‚Ù„ Ø£Ø®Ø´Ø§Ø¨'];
        try {
          const srv = await apiFetch('/services', { method: 'GET' });
          const serverNames = Array.isArray(srv) ? srv.map(s => s.name).filter(Boolean) : [];
          const merged = [...defaultServices];
          serverNames.forEach(n => { if (!merged.includes(n)) merged.push(n); });
          const sel = $('serviceType'); sel.innerHTML = '';
          merged.forEach(name => { const opt = document.createElement('option'); opt.value = name; opt.textContent = name; sel.appendChild(opt); });
        } catch (err) {
          const sel = $('serviceType'); sel.innerHTML = '';
          ['Ù†Ø¸Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ©', 'Ù†Ø¸Ø§ÙØ© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©', 'Ø·ÙˆØ§Ø±Ø¦', 'Ù†Ù‚Ù„ Ù†ÙØ§ÙŠØ§Øª', 'Ù†Ù‚Ù„ ÙƒÙØ±Ø§Øª', 'Ù†Ù‚Ù„ Ø£Ø®Ø´Ø§Ø¨'].forEach(name => {
            const opt = document.createElement('option'); opt.value = name; opt.textContent = name; sel.appendChild(opt);
          });
        }
      }

      // Helper function to check if contract is expired
      function isContractExpired(toDateStr) {
        if (!toDateStr) return false;
        const toDate = new Date(toDateStr);
        const today = new Date();
        // Set time to midnight for accurate date comparison
        today.setHours(0, 0, 0, 0);
        toDate.setHours(0, 0, 0, 0);
        return toDate < today; // Expired if end date is before today
      }

      // Load contracts from server
      async function loadContracts() {
        try {
          const q = $('search').value || '';
          const status = $('filter').value || '';
          const params = new URLSearchParams();
          if (q) params.set('q', q);
          if (status) params.set('status', status);
          const rows = await apiFetch('/contracts?' + params.toString(), { method: 'GET' });

          // Check for expired contracts and update their status automatically
          if (rows && Array.isArray(rows)) {
            for (const contract of rows) {
              // Only update if contract has an end date, is not already expired, and has passed its end date
              if (contract.to_date && contract.status !== 'expired' && isContractExpired(contract.to_date)) {
                try {
                  console.log(`Auto-expiring contract ${contract.id} with end date ${contract.to_date}`);
                  await apiFetch('/contracts/' + encodeURIComponent(contract.id), {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'expired' })
                  });
                  // Update local data to reflect the change
                  contract.status = 'expired';
                } catch (err) {
                  console.error(`Failed to auto-expire contract ${contract.id}:`, err);
                }
              }
            }
          }

          renderContracts(rows || []);
        } catch (err) { console.error(err); }
      }

      // Format date to YYYY-MM-DD only (remove timestamp)
      function formatDate(dateStr) {
        if (!dateStr) return '-';
        // Check for ISO UTC string -> Convert to Local Date
        if (typeof dateStr === 'string' && dateStr.includes('T') && dateStr.endsWith('Z')) {
          const date = new Date(dateStr);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        }
        // If it's a string like YYYY-MM-DD or standard datetime without Z, simple substring
        if (typeof dateStr === 'string' && dateStr.length >= 10) {
          return dateStr.substring(0, 10);
        }
        return dateStr;
      }

      function renderContracts(rows) {
        // Store contracts globally for sorting
        contractsData = rows || [];

        const tbody = $('contractsTbody'); tbody.innerHTML = '';
        let active = 0, pending = 0;
        rows.forEach(c => {
          if (c.status === 'active') active++;
          if (c.status === 'pending') pending++;
          const tr = document.createElement('tr');
          const containerMapLink = c.container_location ? `<a href="https://www.google.com/maps?q=${c.container_location}" target="_blank">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©</a>` : '';
          // const pickupMapLink = c.pickup_location ? `<a href="https://www.google.com/maps?q=${c.pickup_location}" target="_blank">Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ­ØµÙŠÙ„</a>` : '';

          // Format dates to show only YYYY-MM-DD
          const fromDate = formatDate(c.from_date);
          const toDate = formatDate(c.to_date);

          tr.innerHTML = `
            <td>${c.id}</td>
            <td>${c.second_party || ''}</td>
            <td>${c.service_name || ''}</td>
            <td>${fromDate} â†’ ${toDate}</td>
            <td>${c.total_price || 0}</td>
            <td>${c.manager || ''}</td>
            <td>${c.collector || ''}</td>
            <td>
                <span class="chip ${c.status === 'active' ? 'active' : (c.status === 'pending' ? 'pending' : 'expired')}">
                ${c.status === 'active' ? 'Ù†Ø´Ø·' : (c.status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹' : 'Ù…Ù†ØªÙ‡ÙŠ')}
                </span>
            </td>
            <td>
              <div style="display:flex; gap:4px; flex-wrap:wrap; align-items:center;">
                  <button class="btn" onclick="openView('${c.id}')" title="Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ">Ø¹Ø±Ø¶</button>
                  <button class="btn" onclick="openEdit('${c.id}')" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯">ØªØ¹Ø¯ÙŠÙ„</button>
                  <button class="btn small" onclick="updateStatus('${c.id}','active')" title="ØªÙØ¹ÙŠÙ„">âœ…</button>
                  <button class="btn small" onclick="updateStatus('${c.id}','pending')" title="Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹">â³</button>
                  <button class="btn small" onclick="updateStatus('${c.id}','expired')" title="Ø¥Ù†Ù‡Ø§Ø¡">ğŸ›‘</button>
              </div>
              <div style="margin-top:6px; font-size:0.8em;">${containerMapLink}</div>
            </td>
          `;
          tbody.appendChild(tr);
        });
        $('countActive').textContent = active;
        $('countPending').textContent = pending;
      }

      // Open View (Final Contract) - Show in Modal
      window.openView = async function (id) {
        try {
          // Fetch contract data
          const rows = await apiFetch('/contracts?q=' + id, { method: 'GET' });
          const c = Array.isArray(rows) ? rows.find(r => r.id === id) : rows;

          if (!c) {
            alert('Ø§Ù„Ø¹Ù‚Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
          }

          // Fix date off-by-one if weird ISO string (e.g. 2025-05-20T21:00:00.000Z -> 2025-05-21)
          const fixDate = (d) => {
            if (typeof d === 'string' && d.includes('T') && d.endsWith('Z')) {
              const date = new Date(d);
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              return `${year}-${month}-${day}`;
            }
            return d;
          };
          if (c.from_date) c.from_date = fixDate(c.from_date);
          if (c.to_date) c.to_date = fixDate(c.to_date);

          // Fetch attachments to get Tax Number and Registry for replacement in view
          // Fetch attachments to get Tax Number and Registry for replacement in view
          let viewAttachments = [];
          try {
            const res = await apiFetch(`/contracts/${id}/attachments`, { method: 'GET' });
            viewAttachments = (res && res.attachments) ? res.attachments : (Array.isArray(res) ? res : []);
          } catch (e) { console.warn('Failed to fetch view attachments', e); }

          // Use filter().pop() to get the LAST matching item (matches openEdit behavior where last overwrite wins)
          // Also useful if there are duplicates
          const taxAtt = viewAttachments?.filter(a => a.field_name === 'tax_number')?.pop()?.text_value;
          const regAtt = viewAttachments?.filter(a => a.field_name === 'commercial_registration')?.pop()?.text_value;

          const contractData = { ...c, tax_number: taxAtt, commercial_registry: regAtt };

          // Populate modal fields
          const safeSet = (elId, val) => {
            const el = document.getElementById(elId);
            if (el) el.textContent = val || '';
          };

          // safeSet('v-id', c.id || c.contract_number || '---');
          safeSet('v-id-top', c.id || c.contract_number || '---');
          safeSet('v-date-top', new Date().toISOString().split('T')[0]);
          safeSet('v-collector', c.collector || '...................');
          safeSet('v-manager', c.manager || '...................');
          safeSet('v-second-party-name', c.second_party || c.client_name);
          safeSet('v-second-party-email', c.client_email || '');

          // Format and set terms
          // Format and set terms with Hierarchy Support - REFINED
          const formatTerms = (termsText) => {
            if (!termsText) return '';

            // Fix splitting to handle both \r and \n (Quill/HTML usually uses \n)
            const lines = termsText.split(/\r?\n/);
            let html = '';
            let subIndex = 0;

            lines.forEach(line => {
              if (!line.trim()) {
                html += '<br>';
                return;
              }

              // Strip HTML tags to check text content for keywords
              const textContent = line.replace(/<[^>]*>/g, '').trim();

              // Remove manual numbering from the text check (e.g. "1. title")
              const cleanText = textContent.replace(/^\d+[-.]\s*/, '');

              // Check if it's a Main Term/Title
              const isMainTerm = cleanText.match(/^(Ø§Ù„Ø¨Ù†Ø¯|Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯|Ø¹Ù‚Ø¯ Ø¥ØªÙØ§Ù‚|ØªÙ…Ù‡ÙŠØ¯|Ø£ÙˆÙ„Ø§Ù‹|Ø«Ø§Ù†ÙŠØ§Ù‹|Ø«Ø§Ù„Ø«Ø§Ù‹|Ø±Ø§Ø¨Ø¹Ø§Ù‹|Ø®Ø§Ù…Ø³Ø§Ù‹)/);

              // 1. Check for BLOCK-level HTML tags (p, div, headers)
              // These define their own layout, output as-is
              if (line.match(/^<(p|div|h[1-6]|ul|ol|table|blockquote)/i)) {
                subIndex = 0;
                html += line;
              }
              // 2. Check for INLINE HTML tags or formatting (span, strong, em, classes, styles)
              // If the line contains ANY HTML tag, it likely has formatting - preserve it
              else if (line.match(/<[^>]+>/)) {
                subIndex = 0;
                html += line;
              }
              // 3. Check if it's a Main Term/Title (PLAIN TEXT ONLY, no HTML)
              // Only apply auto-styling if it's pure text
              else if (isMainTerm) {
                subIndex = 0;
                html += `<div style="font-weight:700; margin-top:12px; margin-bottom:6px;">${line}</div>`;
              }
              // 4. Check for Level 2 (Indented by 4 spaces in plain text)
              else if (line.startsWith('    ')) {
                subIndex++;
                html += `<div style="margin-right: 20px; font-size: 0.95em; color: #334155;">
                  <span style="display:inline-block; width:20px; font-weight:600;">${subIndex}.</span>${line.trim()}
                </div>`;
              }
              // 5. Standard plain text (no HTML at all)
              else {
                subIndex = 0;
                html += `<div style="margin-bottom: 4px;">${line}</div>`;
              }
            });
            return html;
          };

          const termsEl = document.getElementById('v-terms');
          if (termsEl) {
            let content = c.terms || '';
            // Apply replacements with fetched data
            if (typeof replaceDatePlaceholders === 'function') {
              content = replaceDatePlaceholders(content, contractData);
            }
            termsEl.innerHTML = formatTerms(content);
          }

          // Display attachments
          await displayViewAttachments(id);

          // Store contract ID for print/share
          window.currentViewContractId = id;
          window.currentViewContractClientPhone = c.client_phone || c.phone || '';

          // Show modal
          showElem($('viewContractModal'));
        } catch (err) {
          console.error('Error loading contract:', err);
          alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯');
        }
      };

      // Print View Contract (Robust Iframe Method)
      window.printViewContract = function () {
        const content = document.getElementById('doc-content');
        if (!content) return alert('Ø®Ø·Ø£: Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ù‚Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');

        // Create a hidden iframe
        const iframe = document.createElement('iframe');
        iframe.style.position = 'fixed';
        iframe.style.right = '0';
        iframe.style.bottom = '0';
        iframe.style.width = '0';
        iframe.style.height = '0';
        iframe.style.border = '0';
        document.body.appendChild(iframe);

        // Build the HTML for the iframe
        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(`
          <!DOCTYPE html>
          <html lang="ar" dir="rtl">
          <head>
            <meta charset="utf-8">
            <title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¹Ù‚Ø¯</title>
            <!-- Fonts -->
            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
            <style>
              @page {
                size: A4;
                margin: 0;
              }
              body {
                font-family: 'Cairo', sans-serif;
                margin: 0;
                padding: 0;
                background: white;
                direction: rtl;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
              }
              * { box-sizing: border-box; }
              
              #doc-content {
                width: 210mm;
                min-height: 296.5mm; /* Minimum A4 height */
                padding: 20mm;
                /* Remove box-shadow for print, unnecessary */
                position: relative;
                font-size: 14px;
                line-height: 1.6;
                margin: 0 auto; /* Center in print view if viewer allows */
              }

              /* Alignment Helpers */
              .ql-align-center { text-align: center; }
              .ql-align-right { text-align: right; }
              .ql-align-justify { text-align: justify; }

              /* Font Size Helpers */
              .ql-size-small { font-size: 0.75em; }
              .ql-size-large { font-size: 1.5em; }
              .ql-size-huge { font-size: 2.5em; }

              /* Custom Pixel Sizes */
              .ql-size-8px { font-size: 8px; }
              .ql-size-10px { font-size: 10px; }
              .ql-size-12px { font-size: 12px; }
              .ql-size-14px { font-size: 14px; }
              .ql-size-16px { font-size: 16px; }
              .ql-size-18px { font-size: 18px; }
              .ql-size-20px { font-size: 20px; }
              .ql-size-24px { font-size: 24px; }
              .ql-size-30px { font-size: 30px; }
              .ql-size-36px { font-size: 36px; }
              .ql-size-48px { font-size: 48px; }
              .ql-size-60px { font-size: 60px; }
              .ql-size-72px { font-size: 72px; }

              /* Header Styles */
              .contract-header {
                display: flex;
                flex-direction: column;
                margin-bottom: 20px;
              }
              .top-info-row {
                display: flex;
                justify-content: flex-end;
                width: 100%;
                margin-bottom: 25px;
              }
              .main-title-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
                position: relative;
              }
              
              /* Contract Sections */
              .contract-section {
                margin-bottom: 20px;
              }
              .terms-box {
                white-space: pre-wrap;
              }
              .signature-section {
                display: flex;
                justify-content: space-between;
                margin-top: 40px;
                page-break-inside: avoid; /* Try to keep signatures together */
              }

              /* Ensure table/divs behave well */
              div { page-break-inside: auto; }
              
              /* Bold titles in terms */
              .term-title { font-weight: 700; margin-top: 12px; margin-bottom: 6px; }
            </style>
          </head>
          <body>
            ${content.outerHTML}
            <script>
              // Wait for fonts/resources then print
              window.onload = function() {
                setTimeout(function() {
                  window.print();
                  setTimeout(function() { 
                      try { window.frameElement.remove(); } catch(e){} 
                  }, 500);
                }, 500);
              };
            <\/script>
          </body>
          </html>
        `);
        doc.close();
      };

      // Download View Contract as PDF (same format as print)
      window.downloadViewContractPDF = async function () {
        const content = document.getElementById('doc-content');
        if (!content) return alert('Ø®Ø·Ø£: Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ù‚Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');

        try {
          // Load html2pdf library
          await loadHtml2Pdf();

          const contractId = window.currentViewContractId || 'Contract';

          // Create iframe with same styling as print
          const iframe = document.createElement('iframe');
          iframe.style.position = 'fixed';
          iframe.style.right = '0';
          iframe.style.bottom = '0';
          iframe.style.width = '0';
          iframe.style.height = '0';
          iframe.style.border = '0';
          document.body.appendChild(iframe);

          const doc = iframe.contentWindow.document;
          doc.open();
          doc.write(`
            <!DOCTYPE html>
            <html lang="ar" dir="rtl">
            <head>
              <meta charset="utf-8">
              <title>Contract ${contractId}</title>
              <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
              <style>
                body {
                  font-family: 'Cairo', sans-serif;
                  margin: 0;
                  padding: 20mm;
                  direction: rtl;
                }
                .ql-align-center { text-align: center; }
                .ql-align-right { text-align: right; }
                .ql-align-justify { text-align: justify; }
                ${generateFontSizeCSS()}
              </style>
            </head>
            <body>
              ${content.innerHTML}
            </body>
            </html>
          `);
          doc.close();

          // Wait for content to load
          await new Promise(resolve => setTimeout(resolve, 500));

          const opt = {
            margin: 0,
            filename: `Contract_${contractId}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
          };

          await html2pdf().set(opt).from(iframe.contentWindow.document.body).save();

          iframe.remove();
        } catch (e) {
          console.error(e);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF');
        }
      };

      // Helper function to generate font size CSS
      function generateFontSizeCSS() {
        return `
          .ql-size-small { font-size: 0.75em; }
          .ql-size-large { font-size: 1.5em; }
          .ql-size-huge { font-size: 2.5em; }
          .ql-size-8px { font-size: 8px; }
          .ql-size-10px { font-size: 10px; }
          .ql-size-12px { font-size: 12px; }
          .ql-size-14px { font-size: 14px; }
          .ql-size-16px { font-size: 16px; }
          .ql-size-18px { font-size: 18px; }
          .ql-size-20px { font-size: 20px; }
          .ql-size-24px { font-size: 24px; }
          .ql-size-30px { font-size: 30px; }
          .ql-size-36px { font-size: 36px; }
          .ql-size-48px { font-size: 48px; }
          .ql-size-60px { font-size: 60px; }
          .ql-size-72px { font-size: 72px; }
        `;
      }

      // Helper to load html2pdf
      async function loadHtml2Pdf() {
        if (window.html2pdf) return window.html2pdf;
        return new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
          s.onload = () => resolve(window.html2pdf);
          s.onerror = () => reject(new Error('Failed to load html2pdf'));
          document.head.appendChild(s);
        });
      }

      // Share View Contract via WhatsApp (No PDF download)
      window.shareViewContract = async function () {
        const contractId = window.currentViewContractId || 'Contract';
        const clientPhone = window.currentViewContractClientPhone || '';

        // Prompt for number
        let phone = prompt('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ù…Ø«Ø§Ù„: 9665xxxxxxxx):', clientPhone.replace(/^\+/, '').replace(/^00/, ''));
        if (!phone) return;

        // Basic cleanup
        phone = phone.replace(/[^0-9]/g, '');

        // Open WhatsApp with contract link
        // const url = `${window.location.origin}/pdf-sign.html?id=${contractId}`;
        const text = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø¥Ù„ÙŠÙƒ Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯ Ø±Ù‚Ù… ${contractId}.\n`;
        const shareUrl = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;

        window.open(shareUrl, '_blank');
      };

      // Display contract attachments in view modal
      async function displayViewAttachments(contractId) {
        const container = document.getElementById('v-attachments-display');
        if (!container) return;

        try {
          const res = await apiFetch(`/contracts/${contractId}/attachments`, { method: 'GET' });
          const attachments = res && res.attachments ? res.attachments : [];

          if (attachments.length === 0) {
            container.innerHTML = '<p class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª</p>';
            return;
          }

          const labels = {
            license_photo: 'ØµÙˆØ±Ø© Ø§Ù„Ø±Ø®ØµØ©',
            container_location_doc: 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©',
            commercial_registration: 'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ',
            activity_license: 'Ø±Ø®ØµØ© Ø§Ù„Ù†Ø´Ø§Ø·',
            tax_number: 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ'
          };

          let html = '';
          attachments.forEach(att => {
            const label = labels[att.field_name] || att.field_name;
            html += `<div style="margin-bottom: 10px;"><strong>${label}:</strong> `;

            if (att.field_type === 'text') {
              html += att.text_value || '-';
            } else if (att.field_type === 'image' && att.file_path) {
              html += `<br><img src="${att.file_path}" style="max-width: 300px; margin-top: 5px; border: 1px solid #e2e8f0; border-radius: 4px;">`;
            }
            html += '</div>';
          });

          container.innerHTML = html;
        } catch (err) {
          console.error('Error fetching attachments:', err);
          container.innerHTML = '<p class="muted">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</p>';
        }
      }

      // status update
      async function updateStatus(id, status) {
        if (!confirm('ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ' + (status === 'active' ? 'Ù†Ø´Ø·' : (status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹' : 'Ù…Ù†ØªÙ‡ÙŠ')) + 'ØŸ')) return;
        try {
          await apiFetch('/contracts/' + encodeURIComponent(id), {
            method: 'PUT',
            body: JSON.stringify({ status: status })
          });
          await loadContracts();
        } catch (err) { alert('Ø®Ø·Ø£: ' + err.message); }
      }
      window.updateStatus = updateStatus;

      // open edit
      async function openEdit(id) {
        try {
          // Fetch contract from API
          const rows = await apiFetch('/contracts?q=' + id, { method: 'GET' });
          const c = Array.isArray(rows) ? rows.find(r => r.id === id) : rows;

          if (!c) return alert('Ø§Ù„Ø¹Ù‚Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');

          // Safely set values with null checks
          if ($('clientName')) $('clientName').value = c.second_party || '';
          if ($('clientType')) $('clientType').value = c.client_type || 'ÙØ±Ø¯';

          // If client details are missing in contract response, try to fetch client
          if (c.client_id && (!c.city || !c.district)) {
            try {
              const client = await apiFetch('/clients/' + c.client_id);
              if (client) {
                if ($('city') && !c.city) $('city').value = client.city || '';
                if ($('district') && !c.district) $('district').value = client.district || '';
                // Update other client fields if needed
              }
            } catch (e) { console.warn('Could not fetch client details', e); }
          } else {
            if ($('city')) $('city').value = c.city || '';
            if ($('district')) $('district').value = c.district || '';
          }

          if (c.service_name && $('serviceType')) {
            const sel = $('serviceType');
            if (![...sel.options].some(o => o.value === c.service_name)) {
              const opt = document.createElement('option');
              opt.value = c.service_name;
              opt.textContent = c.service_name;
              sel.appendChild(opt);
            }
            $('serviceType').value = c.service_name;
          }

          // Handle dates - ensure we format YYYY-MM-DD
          const fmtDate = (d) => {
            if (!d) return '';
            if (typeof d === 'string' && d.includes('T') && d.endsWith('Z')) {
              const date = new Date(d);
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              return `${year}-${month}-${day}`;
            }
            if (typeof d === 'string' && d.length >= 10) return d.substring(0, 10);
            return d;
          };

          if ($('dateFrom')) $('dateFrom').value = fmtDate(c.from_date);
          if ($('dateTo')) $('dateTo').value = fmtDate(c.to_date);

          if ($('monthlyFee')) $('monthlyFee').value = c.monthly_fee || '';
          if ($('tax')) $('tax').value = c.tax || '15%';
          if ($('totalPrice')) $('totalPrice').value = c.total_price || '';
          if ($('manager')) {
            const val = c.manager || '';
            const sel = $('manager');
            if (val && ![...sel.options].some(o => o.value === val)) {
              const opt = document.createElement('option');
              opt.value = val;
              opt.textContent = val;
              sel.appendChild(opt);
            }
            sel.value = val;
          }
          if ($('collector')) {
            const val = c.collector || '';
            const sel = $('collector');
            if (val && ![...sel.options].some(o => o.value === val)) {
              const opt = document.createElement('option');
              opt.value = val;
              opt.textContent = val;
              sel.appendChild(opt);
            }
            sel.value = val;
          }
          if ($('status')) $('status').value = c.status || 'pending';
          if ($('containerType')) $('containerType').value = c.container_type || 'Ø¨Ø±Ù…ÙŠÙ„';

          // Location fields
          if ($('containerLocation')) $('containerLocation').value = c.container_location || '';
          // if ($('pickupLocation')) $('pickupLocation').value = c.pickup_location || '';
          if ($('location')) $('location').value = c.location || '';

          if ($('duration')) $('duration').value = c.duration || 'Ø³Ù†ÙˆÙŠ';
          if ($('paymentType')) $('paymentType').value = c.payment_type || 'Ø³Ù†ÙˆÙŠØ©';
          if ($('signMethod')) $('signMethod').value = c.sign_method || 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';

          // Terms handling
          if ($('terms')) $('terms').value = c.terms || '';
          if ($('termsSummary')) {
            if (c.terms && c.terms.trim().length > 0) {
              const firstLine = c.terms.split('\n')[0];
              $('termsSummary').value = 'ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø´Ø±ÙˆØ·: ' + (firstLine.substring(0, 30) + '...');
            } else {
              $('termsSummary').value = '';
            }
          }

          // Handle signing fields
          if ($('firstParty')) $('firstParty').value = c.first_party || 'Ø´Ø±ÙƒØ© Ø¨ÙØª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª';
          if ($('secondParty')) $('secondParty').value = c.second_party || c.client_name || '';
          if ($('clientEmail')) $('clientEmail').value = c.client_email || '';
          if ($('clientPhone')) $('clientPhone').value = c.client_phone || '';
          if ($('clientPhone')) $('clientPhone').value = c.client_phone || '';

          updateGoogleLink('container', c.container_location);
          // updateGoogleLink('pickup', c.pickup_location);
          $('formWrap').dataset.editing = c.id;

          // Fetch and display attachments
          try {
            const attachments = await apiFetch(`/contracts/${id}/attachments`, { method: 'GET' });
            displayAttachments(attachments || []);

            // Also populate the attachment INPUT fields with existing data
            if (attachments && Array.isArray(attachments)) {
              attachments.forEach(att => {
                if (att.field_type === 'text' && att.text_value) {
                  // Populate text fields
                  if (att.field_name === 'container_location_doc' && $('containerLocationAttachment')) {
                    $('containerLocationAttachment').value = att.text_value;
                  } else if (att.field_name === 'commercial_registration' && $('commercialRegistry')) {
                    $('commercialRegistry').value = att.text_value;
                  } else if (att.field_name === 'activity_license' && $('activityLicense')) {
                    $('activityLicense').value = att.text_value;
                  } else if (att.field_name === 'tax_number' && $('taxNumber')) {
                    $('taxNumber').value = att.text_value;
                  }
                }
                // Note: Image files are displayed in the attachmentsDisplay section, not in input field
              });
              console.log('âœ… Loaded attachment values into input fields');
            }
          } catch (err) {
            console.warn('Could not load attachments:', err);
            displayAttachments([]);
          }

          // Hide attachments input section when editing (attachments can only be added when creating new contract)
          setContractAttachmentsVisible(true);
          delete $('formWrap').dataset.renewing; // Clear renewal flag when editing

          showElem($('formWrap'));
          window.scrollTo({ top: 0, behavior: 'smooth' });
        } catch (err) {
          console.error('Open edit error:', err);
          alert('Ø®Ø·Ø£: ' + (err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      }
      window.openEdit = openEdit;

      // Display contract attachments
      function displayAttachments(attachments) {
        const container = $('attachmentsDisplay');
        const list = $('attachmentsList');

        if (!container || !list) return;

        if (attachments.length === 0) {
          container.style.display = 'none';
          return;
        }

        container.style.display = 'block';
        list.innerHTML = '';

        const fieldLabels = {
          license_photo: 'ØµÙˆØ±Ø© Ø§Ù„Ø±Ø®ØµØ©',
          container_location_doc: 'ÙˆØ«ÙŠÙ‚Ø© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„',
          commercial_registration: 'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ',
          activity_license: 'Ø±Ø®ØµØ© Ø§Ù„Ù†Ø´Ø§Ø·',
          tax_number: 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ'
        };

        // Deduplicate attachments by field_name - keep only the most recent one for each field
        const uniqueAttachments = {};
        attachments.forEach(att => {
          const fieldName = att.field_name;
          // If we haven't seen this field yet OR this one has a later ID (more recent), use it
          if (!uniqueAttachments[fieldName] || (att.id > uniqueAttachments[fieldName].id)) {
            uniqueAttachments[fieldName] = att;
          }
        });

        // Convert back to array and display
        Object.values(uniqueAttachments).forEach(att => {
          const fieldLabel = fieldLabels[att.field_name] || att.field_name;
          const div = document.createElement('div');
          div.style.cssText = 'margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;';

          if (att.field_type === 'text') {
            div.innerHTML = `
              <div style="font-weight: 600; color: #475569; margin-bottom: 4px;">${fieldLabel}</div>
              <div style="color: #64748b; font-size: 14px;">${att.text_value || ''}</div>
            `;
          } else if (att.field_type === 'image' && att.image_filename) {
            const contractId = $('formWrap').dataset.editing;
            const fileUrl = `/api/contracts/${contractId}/attachments/file/${att.image_filename}`;
            const isImage = att.image_filename.match(/\.(jpg|jpeg|png|gif)$/i);

            div.innerHTML = `
              <div style="font-weight: 600; color: #475569; margin-bottom: 8px;">${fieldLabel}</div>
              ${isImage ? `
                <a href="${fileUrl}" target="_blank">
                  <img src="${fileUrl}" alt="${fieldLabel}" style="max-width: 200px; max-height: 200px; border-radius: 4px; border: 1px solid #e2e8f0; cursor: pointer;" />
                </a>
              ` : `
                <a href="${fileUrl}" target="_blank" style="color: #3b82f6; text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
                  <span>ğŸ“„</span>
                  <span>${att.image_filename}</span>
                </a>
              `}
            `;
          }

          list.appendChild(div);
        });
      }

      // save contract (create or update)
      // NOTE: When $('formWrap').dataset.renewing is 'true', this is a renewal contract
      // that doesn't require attachments (Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯). Attachments are handled separately
      // via the pdf-sign.html page and are optional for all contracts.
      $('saveContractBtn').addEventListener('click', async () => {
        try {
          if (!token) return alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');

          // Validate required fields
          const clientName = $('clientName').value;
          if (!clientName || clientName.trim() === '') {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„');
            return;
          }

          const clientPhone = $('clientPhone').value;
          if (!clientPhone || clientPhone.trim() === '') {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„');
            return;
          }


          let contractId = $('formWrap').dataset.editing;
          const isNew = !contractId;

          let clientId;

          // Only create a new client if this is a NEW contract
          // For existing contracts, we'll get the client_id from the contract data
          if (isNew) {
            // Generate a client_id for new contracts (no database record needed)
            clientId = 'client-' + Date.now();
            // Let server generate contract ID
            contractId = null;
          } else {
            // For editing, fetch the existing contract to get client_id
            const existingContract = await apiFetch('/contracts?q=' + contractId, { method: 'GET' });
            const contract = Array.isArray(existingContract) ? existingContract.find(c => c.id === contractId) : existingContract;
            clientId = contract?.client_id;

            if (!clientId) {
              alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„');
              return;
            }

            // Update client information when editing
            // Only update if client_id is a valid integer (new data format)
            // Skip if it's a string ID (legacy data)
            if (clientId && !isNaN(parseInt(clientId))) {
              try {
                await apiFetch('/clients/' + clientId, {
                  method: 'PUT',
                  body: JSON.stringify({
                    name: clientName.trim(),
                    type: $('clientType').value || 'ÙØ±Ø¯',
                    city: $('city')?.value || '',
                    district: $('district')?.value || ''
                  })
                });
              } catch (updateErr) {
                console.warn('Failed to update client info:', updateErr);
                // Continue anyway - contract update is more important
              }
            } else {
              console.log('Skipping client update - legacy string ID:', clientId);
            }
          }


          // Helper to handle date fields: send null if empty, otherwise value
          const getDateVal = (id) => {
            const val = $(id)?.value;
            return val ? val : null;
          };

          // Build contract payload
          const payload = {
            id: contractId,
            client_id: clientId, // Backend expects client_id
            client_type: $('clientType')?.value || 'ÙØ±Ø¯',
            service_name: $('serviceType')?.value || 'Ù†Ø¸Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ©',

            from_date: getDateVal('dateFrom'),
            to_date: getDateVal('dateTo'),

            container_type: $('containerType')?.value || 'Ø¨Ø±Ù…ÙŠÙ„',
            location: $('location')?.value || null, // Backend expects location

            monthly_fee: parseFloat($('monthlyFee')?.value || 0),
            tax: $('tax')?.value || '15%',
            total_price: parseFloat($('totalPrice')?.value || 0),
            manager: $('manager')?.value || '',
            status: $('status')?.value || 'pending',
            sign_method: $('signMethod')?.value || 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
            terms: $('terms')?.value || '',

            // Backend fields from error log:
            // file_url: COALESCE(?, file_url) -> handled by backend usually, we send null or undefined if not changing
            client_email: $('clientEmail')?.value || '',

            // Extra fields that might not be in backend but we send anyway just in case:
            city: $('city')?.value || '',
            district: $('district')?.value || '',
            container_location: $('containerLocation')?.value || null,
            // pickup_location: $('pickupLocation')?.value || null,
            duration: $('duration')?.value || 'Ø³Ù†ÙˆÙŠ',
            payment_type: $('paymentType')?.value || 'Ø³Ù†ÙˆÙŠØ©',
            first_party: $('firstParty')?.value || 'Ø´Ø±ÙƒØ© Ø¨ÙØª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª',
            second_party: $('clientName')?.value || '',
            client_phone: $('clientPhone')?.value || '',
            collector: $('collector')?.value || '' // Sending it even if backend might ignore it
          };

          console.log('Saving contract payload:', payload);

          if (!isNew) {
            // Update existing contract
            await apiFetch('/contracts/' + encodeURIComponent(contractId), { method: 'PUT', body: JSON.stringify(payload) });

            // Also update attachments if the section is visible and has data
            const attachmentsVisible = $('contractAttachmentsSection') &&
              $('contractAttachmentsSection').style.display !== 'none';

            if (attachmentsVisible) {
              try {
                console.log('Updating attachments for contract:', contractId);
                await uploadContractAttachments(contractId);
                console.log('âœ… Attachments updated successfully');
              } catch (attachErr) {
                console.warn('âš ï¸ Failed to update attachments:', attachErr);
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­ ÙˆÙ„ÙƒÙ† Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª: ' + attachErr.message);
              }
            }

            alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
            delete $('formWrap').dataset.editing;
          } else {
            // For new contracts, let server generate ID or handle it. 
            // We send payload without ID (or with null ID) if we want server to gen, 
            // but our payload construction used contractId. 
            // We will send payload with null ID and let server assign it.
            if (payload.id === undefined || payload.id === null) delete payload.id;

            const res = await apiFetch('/contracts', { method: 'POST', body: JSON.stringify(payload) });
            const newContractId = res.id || contractId;

            // Upload attachments for NEW contracts (not renewals)
            const isRenewal = $('formWrap').dataset.renewing === 'true';
            const attachmentsVisible = $('contractAttachmentsSection') &&
              $('contractAttachmentsSection').style.display !== 'none';

            if (!isRenewal && attachmentsVisible) {
              try {
                console.log('Uploading attachments for new contract:', newContractId);
                await uploadContractAttachments(newContractId);
                console.log('âœ… Attachments uploaded successfully');
              } catch (attachErr) {
                console.warn('âš ï¸ Failed to upload some attachments:', attachErr);
                alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­ ÙˆÙ„ÙƒÙ† Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª: ' + attachErr.message);
              }
            }

            alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­: ' + newContractId);
          }

          // Clear renewal flag if it was set
          delete $('formWrap').dataset.renewing;

          hideElem($('formWrap'));
          await loadContracts();
        } catch (err) {
          console.error('Contract save error:', err);
          const errorMessage = err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
          alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + errorMessage);
        }
      });

      $('cancelFormBtn').addEventListener('click', () => {
        delete $('formWrap').dataset.renewing; // Clear renewal flag
        hideElem($('formWrap'));
      });

      // ============ CONTRACT ATTACHMENTS FUNCTIONALITY ============

      // License Image Preview
      const licenseImageInput = $('licenseImage');
      if (licenseImageInput) {
        licenseImageInput.addEventListener('change', function (e) {
          const file = e.target.files[0];
          const preview = $('licenseImagePreview');

          if (file && preview) {
            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
              alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø¨ØµÙŠØºØ© JPG, PNG, Ø£Ùˆ GIF');
              e.target.value = '';
              preview.innerHTML = '';
              return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
              alert('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² 5 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª');
              e.target.value = '';
              preview.innerHTML = '';
              return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function (event) {
              preview.innerHTML = `
                <div style="margin-top: 8px; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                  <div style="font-weight: 600; color: #475569; margin-bottom: 6px; font-size: 13px;">Ù…Ø¹Ø§ÙŠÙ†Ø©:</div>
                  <img src="${event.target.result}" alt="License Preview" 
                    style="max-width: 200px; max-height: 200px; border-radius: 4px; border: 1px solid #cbd5e1;" />
                  <div style="margin-top: 6px; font-size: 12px; color: #64748b;">
                    ${file.name} (${(file.size / 1024).toFixed(2)} KB)
                  </div>
                </div>
              `;
            };
            reader.readAsDataURL(file);
          } else if (preview) {
            preview.innerHTML = '';
          }
        });
      }

      // Function to show/hide attachments section based on contract type
      window.setContractAttachmentsVisible = function (isVisible) {
        const section = $('contractAttachmentsSection');
        if (section) {
          section.style.display = isVisible ? 'block' : 'none';
        }
      };

      // Function to clear attachment fields
      window.clearAttachmentFields = function () {
        if ($('licenseImage')) $('licenseImage').value = '';
        if ($('licenseImagePreview')) $('licenseImagePreview').innerHTML = '';
        if ($('containerLocationAttachment')) $('containerLocationAttachment').value = '';
        if ($('commercialRegistry')) $('commercialRegistry').value = '';
        if ($('activityLicense')) $('activityLicense').value = '';
        if ($('taxNumber')) $('taxNumber').value = '';
      };

      // Function to upload attachments to server
      async function uploadContractAttachments(contractId) {
        try {
          const attachments = [];

          // 1. License Image (file upload)
          const licenseImageInput = $('licenseImage');
          if (licenseImageInput && licenseImageInput.files && licenseImageInput.files[0]) {
            const file = licenseImageInput.files[0];
            const reader = new FileReader();

            await new Promise((resolve, reject) => {
              reader.onload = function (e) {
                attachments.push({
                  fieldName: 'license_photo',
                  fieldType: 'image',
                  fileData: e.target.result
                });
                resolve();
              };
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
          }

          // 2. Container Location Attachment (text)
          const containerLocationAtt = $('containerLocationAttachment');
          if (containerLocationAtt && containerLocationAtt.value.trim()) {
            attachments.push({
              fieldName: 'container_location_doc',
              fieldType: 'text',
              textValue: containerLocationAtt.value.trim()
            });
          }

          // 3. Commercial Registry (text)
          const commercialRegistry = $('commercialRegistry');
          if (commercialRegistry && commercialRegistry.value.trim()) {
            attachments.push({
              fieldName: 'commercial_registration',
              fieldType: 'text',
              textValue: commercialRegistry.value.trim()
            });
          }

          // 4. Activity License (text)
          const activityLicense = $('activityLicense');
          if (activityLicense && activityLicense.value.trim()) {
            attachments.push({
              fieldName: 'activity_license',
              fieldType: 'text',
              textValue: activityLicense.value.trim()
            });
          }

          // 5. Tax Number (text)
          const taxNumber = $('taxNumber');
          if (taxNumber && taxNumber.value.trim()) {
            attachments.push({
              fieldName: 'tax_number',
              fieldType: 'text',
              textValue: taxNumber.value.trim()
            });
          }

          // Only send if there are attachments
          if (attachments.length === 0) {
            console.log('No attachments to upload');
            return { success: true, message: 'No attachments to upload' };
          }

          console.log(`Uploading ${attachments.length} attachments for contract ${contractId}`);

          // Send to server
          const response = await apiFetch(`/contracts/${contractId}/attachments`, {
            method: 'POST',
            body: JSON.stringify({ attachmentsData: attachments })
          });

          console.log('âœ… Attachments uploaded successfully:', response);
          return { success: true, data: response };

        } catch (error) {
          console.error('âŒ Error uploading attachments:', error);
          throw error;
        }
      }

      // Expose function globally for use in save contract function
      window.uploadContractAttachments = uploadContractAttachments;

      // ============ NEW CONTRACT & RENEW CONTRACT BUTTON HANDLERS ============

      // New Contract Button - Show form with attachments section
      const newContractBtn = $('newContractBtn');
      if (newContractBtn) {
        newContractBtn.addEventListener('click', () => {
          if (!token) {
            alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
            return;
          }

          // Clear all form fields
          const inputs = $('formWrap').querySelectorAll('input:not([readonly]), select, textarea');
          inputs.forEach(input => {
            if (input.type === 'checkbox') {
              input.checked = false;
            } else if (input.type !== 'hidden' && input.id !== 'firstParty') {
              input.value = '';
            }
          });

          // Set defaults
          if ($('clientType')) $('clientType').value = 'ÙØ±Ø¯';
          if ($('serviceType')) $('serviceType').value = 'Ù†Ø¸Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ©';
          if ($('containerType')) $('containerType').value = 'Ø¨Ø±Ù…ÙŠÙ„';
          if ($('duration')) $('duration').value = 'Ø³Ù†ÙˆÙŠ';
          if ($('paymentType')) $('paymentType').value = 'Ø³Ù†ÙˆÙŠØ©';
          if ($('status')) $('status').value = 'pending';
          if ($('tax')) $('tax').value = '15%';
          if ($('firstParty')) $('firstParty').value = 'Ø´Ø±ÙƒØ© Ø¨ÙØª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª';
          if ($('clientName')) $('secondParty').value = '';
          if ($('terms')) $('terms').value = '';
          if ($('termsSummary')) $('termsSummary').value = '';

          // Automatically generate and insert First Party text with today's dates
          if (typeof generateFirstPartyText === 'function') {
            const firstPartyText = generateFirstPartyText('Ø´Ø±ÙƒØ© Ø¨ÙØª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª');
            if ($('terms')) {
              $('terms').value = firstPartyText;
              console.log('âœ… Auto-inserted First Party text with today\'s dates');
            }
          }

          // Clear editing flag and renewal flag
          delete $('formWrap').dataset.editing;
          delete $('formWrap').dataset.renewing;

          // Clear and show attachments section for NEW contracts
          clearAttachmentFields();
          setContractAttachmentsVisible(true);

          // Show the form
          showElem($('formWrap'));
          window.scrollTo({ top: 0, behavior: 'smooth' });

          console.log('âœ… New contract form opened with attachments visible');
        });
      }

      // Renew Contract Button - Show form WITHOUT attachments section
      const renewContractBtn = $('renewContractBtn');
      if (renewContractBtn) {
        renewContractBtn.addEventListener('click', () => {
          if (!token) {
            alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
            return;
          }

          // Ask user to select a contract to renew
          const contractId = prompt('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ¬Ø¯ÙŠØ¯Ù‡:');
          if (!contractId) return;

          // Load the existing contract data
          (async () => {
            try {
              const rows = await apiFetch('/contracts?q=' + contractId, { method: 'GET' });
              const contract = Array.isArray(rows) ? rows.find(r => r.id === contractId) : rows;

              if (!contract) {
                alert('Ø§Ù„Ø¹Ù‚Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
              }

              // Load existing contract data into form (similar to openEdit)
              if ($('clientName')) $('clientName').value = contract.second_party || '';
              if ($('clientType')) $('clientType').value = contract.client_type || 'ÙØ±Ø¯';
              if ($('serviceType')) $('serviceType').value = contract.service_name || 'Ù†Ø¸Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ©';
              if ($('city')) $('city').value = contract.city || '';
              if ($('district')) $('district').value = contract.district || '';
              if ($('containerType')) $('containerType').value = contract.container_type || 'Ø¨Ø±Ù…ÙŠÙ„';
              if ($('monthlyFee')) $('monthlyFee').value = contract.monthly_fee || '';
              if ($('tax')) $('tax').value = contract.tax || '15%';
              if ($('totalPrice')) $('totalPrice').value = contract.total_price || '';
              if ($('manager')) $('manager').value = contract.manager || '';
              if ($('collector')) $('collector').value = contract.collector || '';
              if ($('paymentType')) $('paymentType').value = contract.payment_type || 'Ø³Ù†ÙˆÙŠØ©';
              if ($('duration')) $('duration').value = contract.duration || 'Ø³Ù†ÙˆÙŠ';
              if ($('status')) $('status').value = 'pending'; // New renewal starts as pending
              if ($('firstParty')) $('firstParty').value = contract.first_party || 'Ø´Ø±ÙƒØ© Ø¨ÙØª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª';
              if ($('secondParty')) $('secondParty').value = contract.second_party || '';
              if ($('clientEmail')) $('clientEmail').value = contract.client_email || '';
              if ($('clientPhone')) $('clientPhone').value = contract.client_phone || '';
              if ($('terms')) $('terms').value = contract.terms || '';
              if ($('container Location')) $('containerLocation').value = contract.container_location || '';

              // Set new dates for renewal (e.g., start from today, end 1 year from now)
              const today = new Date();
              const oneYearLater = new Date(today);
              oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);

              if ($('dateFrom')) $('dateFrom').value = today.toISOString().split('T')[0];
              if ($('dateTo')) $('dateTo').value = oneYearLater.toISOString().split('T')[0];

              // Mark as renewal and clear editing ID (so it creates a new contract)
              delete $('formWrap').dataset.editing;
              $('formWrap').dataset.renewing = 'true';

              // Hide attachments section for RENEWAL contracts
              clearAttachmentFields();
              setContractAttachmentsVisible(false);

              // Show the form
              showElem($('formWrap'));
              window.scrollTo({ top: 0, behavior: 'smooth' });

              console.log('âœ… Renewal form opened for contract:', contractId);
              alert(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯ ${contractId} Ù„Ù„ØªØ¬Ø¯ÙŠØ¯. Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸.`);
            } catch (err) {
              console.error('Error loading contract for renewal:', err);
              alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯: ' + (err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
            }
          })();
        });
      }

      // ---------------- Google Maps paste-based picker ----------------

      function openMapModalFor(target) {
        // only allow when form visible
        if ($('formWrap').style.display === 'none') {
          alert('Ø§ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø®Ø±Ø§Ø¦Ø· Google.');
          return;
        }
        currentPickerTarget = target;
        $('selectedCoords').value = '';
        showElem($('mapModal'));
      }

      function openGoogleMapsWindow() {
        const url = 'https://www.google.com/maps';
        const w = window.open(url, '_blank', 'noopener');
        if (!w) alert('ØªØ¹Ø°Ø± ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®Ø±Ø§Ø¦Ø·. ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø¸Ø± Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©.');
      }

      async function pasteCoordsFromClipboard() {
        try {
          const text = await navigator.clipboard.readText();
          if (!text) { alert('Ø§Ù„Ø­Ø§ÙØ¸Ø© ÙØ§Ø±ØºØ© Ø£Ùˆ Ù„Ù… ØªØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙˆØµÙˆÙ„'); return; }
          $('selectedCoords').value = text.trim();
        } catch (err) {
          alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø°Ù† Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø§ÙØ¸Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„.');
        }
      }

      // parse coordinates from Google Maps URL or from manual coordinate input
      function parseCoordsFromGoogleLinkOrText(input) {
        if (!input) return null;
        input = input.trim();

        // If input looks like direct lat,lng
        const simpleCoord = input.match(/(-?\d+(?:\.\d+)?)[,\s]+(-?\d+(?:\.\d+)?)/);
        if (simpleCoord) {
          const lat = parseFloat(simpleCoord[1]), lng = parseFloat(simpleCoord[2]);
          if (!isNaN(lat) && !isNaN(lng)) return lat.toFixed(6) + ',' + lng.toFixed(6);
        }

        // Try Google Maps @lat,lng,zoom (e.g. https://www.google.com/maps/@24.7136,46.6753,15z)
        let m = input.match(/@(-?\d+\.\d+),(-?\d+\.\d+),/);
        if (m) return parseFloat(m[1]).toFixed(6) + ',' + parseFloat(m[2]).toFixed(6);

        // Try q=lat,lng or /place/.../data=!3m1!4b1!4m5!...!3dLAT!4dLNG
        m = input.match(/[?&]q=([-.\d]+),\s*([-.\d]+)/);
        if (m) return parseFloat(m[1]).toFixed(6) + ',' + parseFloat(m[2]).toFixed(6);

        m = input.match(/!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/);
        if (m) return parseFloat(m[1]).toFixed(6) + ',' + parseFloat(m[2]).toFixed(6);

        // Try to find any lat,lng pair inside the URL
        m = input.match(/(-?\d+\.\d+),\s*(-?\d+\.\d+)/);
        if (m) return parseFloat(m[1]).toFixed(6) + ',' + parseFloat(m[2]).toFixed(6);

        // If not found, attempt to normalize formats with N/E/S/W (like 24.7136N,46.6753E)
        const normalized = normalizeCoordinates(input);
        if (normalized) return normalized;

        return null;
      }

      // reuse normalization function from prior logic (supports N/S/E/W and DMS)
      function normalizeCoordinates(input) {
        if (!input) return null;
        input = input.trim();
        input = input.replace(/[Â°â€²'â€³"]/g, ' ').replace(/\s+/g, ' ').trim();
        let parts = [];
        if (input.includes(',')) parts = input.split(',').map(s => s.trim());
        else {
          const tokens = input.split(' ');
          if (tokens.length >= 2) {
            const mid = Math.ceil(tokens.length / 2);
            parts = [tokens.slice(0, mid).join(' '), tokens.slice(mid).join(' ')];
          } else return null;
        }
        function parseCoordStr(s, isLat) {
          s = s.trim();
          const dirMatch = s.match(/([NnSsEeWw])/);
          const dir = dirMatch ? dirMatch[1].toUpperCase() : null;
          s = s.replace(/[NnSsEeWw]/g, '').trim();
          const nums = s.split(/[\s:]+/).map(x => parseFloat(x)).filter(x => !isNaN(x));
          if (nums.length === 0) return null;
          let val = null;
          if (nums.length === 1) val = nums[0];
          else val = Math.abs(nums[0]) + (nums[1] || 0) / 60 + (nums[2] || 0) / 3600;
          if (dir) {
            if (dir === 'S' || dir === 'W') val = -Math.abs(val);
            else val = Math.abs(val);
          }
          if (isLat && Math.abs(val) > 90) return null;
          if (!isLat && Math.abs(val) > 180) return null;
          return val;
        }
        const lat = parseCoordStr(parts[0], true);
        const lng = parseCoordStr(parts[1], false);
        if (lat === null || lng === null) return null;
        return lat.toFixed(6) + ',' + lng.toFixed(6);
      }

      function confirmCoordsFromModal() {
        const raw = $('selectedCoords').value.trim();
        const coords = parseCoordsFromGoogleLinkOrText(raw);
        if (!coords) return alert('ØªØ¹Ø°Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ø®Ø±Ø§Ø¦Ø· Google Ø£Ùˆ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¨ØµÙŠØºØ© lat,lng Ø£Ùˆ Ø¨ØµÙŠØºØ© ØªØ­ØªÙˆÙŠ N/S/E/W.');
        if (currentPickerTarget === 'container') {
          $('containerLocation').value = coords;
          updateGoogleLink('container', coords);
        } else if (currentPickerTarget === 'pickup') {
          $('pickupLocation').value = coords;
          updateGoogleLink('pickup', coords);
        }
        closeMapModal();
      }

      function closeMapModal() {
        currentPickerTarget = null;
        hideElem($('mapModal'));
      }

      function updateGoogleLink(type, coordStr) {
        const link = (type === 'container') ? $('containerGoogleLink') : $('pickupGoogleLink');
        if (coordStr && coordStr.includes(',')) {
          link.href = 'https://www.google.com/maps?q=' + encodeURIComponent(coordStr);
          link.style.display = 'inline';
        } else {
          link.href = '#';
          link.style.display = 'none';
        }
      }

      // attach events
      $('pickContainerBtn').addEventListener('click', () => openMapModalFor('container'));
      // $('pickPickupBtn').addEventListener('click', () => openMapModalFor('pickup'));
      $('openGoogleMapsBtn').addEventListener('click', openGoogleMapsWindow);
      $('pasteCoordsBtn').addEventListener('click', pasteCoordsFromClipboard);
      $('confirmCoordsBtn').addEventListener('click', confirmCoordsFromModal);
      $('cancelCoordsBtn').addEventListener('click', closeMapModal);

      // Terms modal bindings
      const safe = (id, fn) => { const el = $(id); if (el) el.addEventListener('click', fn); };
      safe('manageTermsBtn', openTermsModal);
      // allow keyboard open
      if ($('manageTermsBtn')) $('manageTermsBtn').addEventListener('keydown', (e) => { if (e.key === 'Enter') openTermsModal(); });
      safe('termsCloseBtn', closeTermsModal);
      safe('termsRefreshBtn', loadTerms);
      // select/deselect helpers (UI elements exist in modal)
      const selAll = () => document.querySelectorAll('#termsList .termCheckbox').forEach(cb => cb.checked = true);
      const deselectAll = () => document.querySelectorAll('#termsList .termCheckbox').forEach(cb => cb.checked = false);
      if ($('termsSelectAllBtn')) $('termsSelectAllBtn').addEventListener('click', selAll);
      if ($('termsDeselectAllBtn')) $('termsDeselectAllBtn').addEventListener('click', deselectAll);

      // other UI wiring
      $('refreshBtn').addEventListener('click', loadContracts);
      // Ensure search is instant
      $('search').addEventListener('input', () => {
        console.log('Search input detected');
        loadContracts();
      });
      $('filter').addEventListener('change', loadContracts);

      // Export to Excel
      $('exportExcelBtn').addEventListener('click', () => {
        if (!contractsData || contractsData.length === 0) {
          alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
          return;
        }

        // Format data for Excel
        const data = contractsData.map(c => ({
          'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯': c.id,
          'Ø§Ù„Ø¹Ù…ÙŠÙ„': c.second_party || c.client_name,
          'Ø§Ù„Ø®Ø¯Ù…Ø©': c.service_name,
          'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ': c.total_price,
          'Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©': c.monthly_fee,
          'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': c.from_date ? String(c.from_date).substring(0, 10) : '',
          'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': c.to_date ? String(c.to_date).substring(0, 10) : '',
          'Ø§Ù„Ù…Ø³ÙˆÙ‚': c.manager || '',
          'Ø§Ù„Ù…Ø­ØµÙ„': c.collector || '',
          'Ø§Ù„Ø­Ø§Ù„Ø©': c.status === 'active' ? 'Ù†Ø´Ø·' : (c.status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹' : 'Ù…Ù†ØªÙ‡ÙŠ'),
          'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„': c.container_location,
          // 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ­ØµÙŠÙ„': c.pickup_location,
          'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': c.city,
          'Ø§Ù„Ø­ÙŠ': c.district,
          'Ø§Ù„Ø¬ÙˆØ§Ù„': c.client_phone,
          'Ø§Ù„Ø¨Ø±ÙŠØ¯': c.client_email,




        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø¹Ù‚ÙˆØ¯");
        XLSX.writeFile(wb, "contracts_export.xlsx");
      });

      $('newContractBtn').addEventListener('click', () => {
        delete $('formWrap').dataset.editing;

        // Clear all form fields safely
        const fieldsToClear = [
          'clientName', 'city', 'district', 'location', 'dateFrom', 'dateTo',
          'monthlyFee', 'tax', 'totalPrice', 'manager', 'collector', 'terms', 'termsSummary',
          'containerLocation', 'pickupLocation', 'clientType', 'serviceType',
          'containerType', 'duration', 'paymentType', 'signMethod',
          'clientEmail', 'clientPhone'
        ];

        fieldsToClear.forEach(id => {
          const el = $(id);
          if (el) {
            if (el.tagName === 'SELECT') {
              // Set select to first option instead of empty
              el.selectedIndex = 0;
            } else {
              el.value = '';
            }
          }
        });

        // Set default values
        if ($('status')) $('status').value = 'pending';
        if ($('tax')) $('tax').value = '15%';
        if ($('clientType')) $('clientType').value = 'ÙØ±Ø¯';
        if ($('serviceType')) $('serviceType').value = 'Ù†Ø¸Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ©';
        if ($('containerType')) $('containerType').value = 'Ø¨Ø±Ù…ÙŠÙ„';
        if ($('duration')) $('duration').value = 'Ø³Ù†ÙˆÙŠ';
        if ($('paymentType')) $('paymentType').value = 'Ø³Ù†ÙˆÙŠØ©';
        if ($('signMethod')) $('signMethod').value = 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';

        updateGoogleLink('container', '');
        // updateGoogleLink('pickup', '');

        // Hide attachments display for new contracts
        const attachmentsDisplay = $('attachmentsDisplay');
        if (attachmentsDisplay) attachmentsDisplay.style.display = 'none';

        showElem($('formWrap'));
        hideElem($('mapModal'));
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      // Renew Contract Button - Same as New Contract but without attachments requirement
      $('renewContractBtn').addEventListener('click', () => {
        delete $('formWrap').dataset.editing;

        // Clear all form fields safely (same as new contract)
        const fieldsToClear = [
          'clientName', 'city', 'district', 'location', 'dateFrom', 'dateTo',
          'monthlyFee', 'tax', 'totalPrice', 'manager', 'collector', 'terms', 'termsSummary',
          'containerLocation', 'pickupLocation', 'clientType', 'serviceType',
          'containerType', 'duration', 'paymentType', 'signMethod',
          'clientEmail', 'clientPhone'
        ];

        fieldsToClear.forEach(id => {
          const el = $(id);
          if (el) {
            if (el.tagName === 'SELECT') {
              // Set select to first option instead of empty
              el.selectedIndex = 0;
            } else {
              el.value = '';
            }
          }
        });

        // Set default values (same as new contract)
        if ($('status')) $('status').value = 'pending';
        if ($('tax')) $('tax').value = '15%';
        if ($('clientType')) $('clientType').value = 'ÙØ±Ø¯';
        if ($('serviceType')) $('serviceType').value = 'Ù†Ø¸Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ©';
        if ($('containerType')) $('containerType').value = 'Ø¨Ø±Ù…ÙŠÙ„';
        if ($('duration')) $('duration').value = 'Ø³Ù†ÙˆÙŠ';
        if ($('paymentType')) $('paymentType').value = 'Ø³Ù†ÙˆÙŠØ©';
        if ($('signMethod')) $('signMethod').value = 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';

        updateGoogleLink('container', '');
        // updateGoogleLink('pickup', '');

        // Hide attachments display for renewal contracts
        const attachmentsDisplay = $('attachmentsDisplay');
        if (attachmentsDisplay) attachmentsDisplay.style.display = 'none';

        // Set flag to indicate this is a renewal contract (no attachments required)
        $('formWrap').dataset.renewing = 'true';

        showElem($('formWrap'));
        hideElem($('mapModal'));
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });


      // Navigation System
      document.querySelectorAll('.nav button[data-view]').forEach(btn => {
        btn.addEventListener('click', () => {
          const view = btn.dataset.view;
          switchView(view);

          // Update active button
          document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });

      function switchView(view) {
        // Hide all views
        ['contractsArea', 'reportsArea'].forEach(id => {
          const el = $(id);
          if (el) el.style.display = 'none';
        });

        // Show selected view
        const viewEl = $(view + 'Area');
        if (viewEl) viewEl.style.display = 'block';

        // Load data for the view
        switch (view) {
          case 'contracts':
            loadContracts();
            break;
          case 'reports':
            loadReports();
            break;
        }
      }

      // Reports and Statistics - Enhanced with Manager & Collector Performance
      async function loadReports() {
        try {
          const contracts = await apiFetch('/contracts', { method: 'GET' });
          const clients = await apiFetch('/clients', { method: 'GET' });

          generateReports(contracts || [], clients || []);
        } catch (err) {
          console.error('Error loading reports:', err);
          generateReports([], []);
        }
      }

      function generateReports(contracts, clients) {
        // Total contracts
        $('reportTotalContracts').textContent = contracts.length;

        // Total revenue
        const totalRevenue = contracts.reduce((sum, c) => sum + (parseFloat(c.total_price) || 0), 0);
        $('reportTotalRevenue').textContent = totalRevenue.toLocaleString('ar-SA');

        // Total clients (unique)
        const uniqueClients = new Set(contracts.map(c => c.second_party).filter(Boolean));
        $('reportTotalClients').textContent = uniqueClients.size;

        // Average contract value
        const avgContract = contracts.length > 0 ? totalRevenue / contracts.length : 0;
        $('reportAvgContract').textContent = avgContract.toLocaleString('ar-SA', { maximumFractionDigits: 0 });

        // Status distribution
        const activeCount = contracts.filter(c => c.status === 'active').length;
        const pendingCount = contracts.filter(c => c.status === 'pending').length;
        const expiredCount = contracts.filter(c => c.status === 'expired').length;

        $('reportActiveCount').textContent = activeCount;
        $('reportPendingCount').textContent = pendingCount;
        $('reportExpiredCount').textContent = expiredCount;

        // Manager Performance Statistics
        const managerStats = {};
        contracts.forEach(c => {
          const manager = c.manager || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          if (!managerStats[manager]) {
            managerStats[manager] = { count: 0, total: 0, monthlyFees: 0 };
          }
          managerStats[manager].count++;
          managerStats[manager].total += parseFloat(c.total_price) || 0;
          managerStats[manager].monthlyFees += parseFloat(c.monthly_fee) || 0;
        });

        const managerStatsTbody = $('managerStatsTbody');
        if (managerStatsTbody) {
          managerStatsTbody.innerHTML = '';
          const sortedManagers = Object.entries(managerStats)
            .sort((a, b) => b[1].total - a[1].total);

          sortedManagers.forEach(([name, stats]) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><strong>${name}</strong></td>
              <td>${stats.count}</td>
              <td>${stats.total.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</td>
              <td>${stats.monthlyFees.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„/Ø´Ù‡Ø±</td>
            `;
            managerStatsTbody.appendChild(tr);
          });
        }

        // Collector Performance Statistics
        const collectorStats = {};
        contracts.forEach(c => {
          const collector = c.collector || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          if (!collectorStats[collector]) {
            collectorStats[collector] = { count: 0, total: 0, monthlyFees: 0 };
          }
          collectorStats[collector].count++;
          collectorStats[collector].total += parseFloat(c.total_price) || 0;
          collectorStats[collector].monthlyFees += parseFloat(c.monthly_fee) || 0;
        });

        const collectorStatsTbody = $('collectorStatsTbody');
        if (collectorStatsTbody) {
          collectorStatsTbody.innerHTML = '';
          const sortedCollectors = Object.entries(collectorStats)
            .sort((a, b) => b[1].total - a[1].total);

          sortedCollectors.forEach(([name, stats]) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><strong>${name}</strong></td>
              <td>${stats.count}</td>
              <td>${stats.total.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</td>
              <td>${stats.monthlyFees.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„/Ø´Ù‡Ø±</td>
            `;
            collectorStatsTbody.appendChild(tr);
          });
        }

        // Top 5 clients by contract value
        const clientStats = {};
        contracts.forEach(c => {
          const clientName = c.second_party || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          if (!clientStats[clientName]) {
            clientStats[clientName] = { count: 0, total: 0 };
          }
          clientStats[clientName].count++;
          clientStats[clientName].total += parseFloat(c.total_price) || 0;
        });

        const topClients = Object.entries(clientStats)
          .sort((a, b) => b[1].total - a[1].total)
          .slice(0, 5);

        const topClientsTbody = $('topClientsTbody');
        if (topClientsTbody) {
          topClientsTbody.innerHTML = '';
          topClients.forEach(([name, stats]) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${name}</td>
              <td>${stats.count}</td>
              <td>${stats.total.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</td>
            `;
            topClientsTbody.appendChild(tr);
          });
        }
      }

      // $('exportCsvBtn').addEventListener('click', () => {
      //   alert('ØªØµØ¯ÙŠØ± CSV ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Client-side only)');
      // });

      // helper to generate contract id: CN-YYYY-N
      function generateContractId() {
        const now = new Date();
        const yr = now.getFullYear();

        // Find max ID for this year
        const contracts = getStoredData(STORAGE_KEY_CONTRACTS);
        const prefix = `CN-${yr}-`;
        let maxSeq = 0;

        contracts.forEach(c => {
          if (c.id && c.id.startsWith(prefix)) {
            const seq = parseInt(c.id.replace(prefix, ''));
            if (!isNaN(seq) && seq > maxSeq) maxSeq = seq;
          }
        });

        return `${prefix}${maxSeq + 1}`;
      }

      // helper to generate secure signing token
      function generateSigningToken(contractId, clientEmail) {
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(2);
        const data = `${contractId}:${clientEmail}:${timestamp}:${random}`;
        // Return full Base64 without truncation
        return btoa(data);
      }

      // helper to create secure signing link
      function createSigningLink(contractId, clientEmail, token) {
        const baseUrl = window.location.origin;
        // Encode token to be URL-safe
        return `${baseUrl}/sign/${contractId}/${encodeURIComponent(token)}`;
      }

      // Test server connection
      async function testServerConnection() {
        try {
          const response = await fetch('/health');
          const data = await response.json();
          console.log('âœ… Server connected:', data);
          return true;
        } catch (error) {
          console.error('âŒ Server connection failed:', error);
          return false;
        }
      }

      // Test server connection on page load
      // Test server connection on page load - Disabled for client-side version
      // testServerConnection();

      // update second party field when client name changes
      $('clientName').addEventListener('input', () => {
        if ($('secondParty')) {
          $('secondParty').value = $('clientName').value || '';
        }
      });

      // Auto-calculate Total Price
      function calculateTotal() {
        const monthly = parseFloat($('monthlyFee').value) || 0;
        const taxStr = $('tax').value || '0';
        const taxRate = parseFloat(taxStr.replace('%', '')) / 100;

        // Determine multiplier based on duration
        const duration = $('duration').value;
        let multiplier = 12; // Default to Annual
        if (duration === '6 Ø£Ø´Ù‡Ø±') multiplier = 6;
        else if (duration === '3 Ø£Ø´Ù‡Ø±') multiplier = 3;
        else if (duration === 'Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©') multiplier = 1;

        const subtotal = monthly * multiplier;
        const total = subtotal + (subtotal * taxRate);
        $('totalPrice').value = Math.round(total);
      }

      if ($('monthlyFee')) $('monthlyFee').addEventListener('input', calculateTotal);
      if ($('tax')) $('tax').addEventListener('input', calculateTotal);
      if ($('duration')) $('duration').addEventListener('change', calculateTotal);

      // Auto-calculate End Date (1 year later)
      if ($('dateFrom')) {
        $('dateFrom').addEventListener('change', function () {
          const val = this.value;
          if (val) {
            const date = new Date(val);
            date.setFullYear(date.getFullYear() + 1);
            $('dateTo').value = date.toISOString().split('T')[0];
          }
        });
      }

      // Contract signing modal functions
      function openSigningModal(contractId = null, clientEmail = null) {
        const modal = $('signingModal');
        if (!modal) return;

        // Reset modal state
        $('sendMethod').value = 'link';
        hideAllSendSections();
        $('linkSection').style.display = 'block';

        // Auto-generate link if we have contract data
        if (contractId && clientEmail) {
          const token = generateSigningToken(contractId, clientEmail);
          const link = createSigningLink(contractId, clientEmail, token);
          $('signingLink').value = link;
        }

        showElem(modal);
      }

      function closeSigningModal() {
        hideElem($('signingModal'));
      }

      function hideAllSendSections() {
        ['linkSection', 'emailSection', 'whatsappSection', 'fileSection'].forEach(id => {
          const el = $(id);
          if (el) el.style.display = 'none';
        });
      }

      // Send method change handler
      $('sendMethod').addEventListener('change', (e) => {
        hideAllSendSections();
        const method = e.target.value;
        const section = $(method + 'Section');
        if (section) {
          section.style.display = 'block';

          // Auto-fill email from form if available
          if (method === 'email' && $('clientEmail')?.value) {
            $('signingEmail').value = $('clientEmail').value;
          }

          // Auto-fill phone from form if available
          if (method === 'whatsapp' && $('clientPhone')?.value) {
            $('whatsappNumber').value = $('clientPhone').value;
            updateWhatsappMessage();
          }
        }
      });

      // Copy link handler
      $('copyLinkBtn').addEventListener('click', () => {
        const linkInput = $('signingLink');
        if (!linkInput?.value) {
          alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù„Ù„Ù†Ø³Ø®');
          return;
        }

        navigator.clipboard.writeText(linkInput.value).then(() => {
          alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­');
        }).catch(() => {
          // Fallback for older browsers
          linkInput.select();
          document.execCommand('copy');
          alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­');
        });
      });

      // Update whatsapp message
      function updateWhatsappMessage() {
        const clientName = $('clientName')?.value || 'Ø§Ù„Ø¹Ù…ÙŠÙ„';
        const companyName = $('firstParty')?.value || 'Ø´Ø±ÙƒØ© Ø¨ÙØª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª';
        const link = $('signingLink')?.value || '';

        const message = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${clientName}ØŒ\n\nØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ù‚Ø¯ÙƒÙ… Ù…Ø¹ ${companyName} Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙˆÙ‚ÙŠØ¹.\n\nÙŠÙ…ÙƒÙ†ÙƒÙ… ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† ÙˆÙ…Ø¨Ø§Ø´Ø± Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ:\n${link}\n\nØ§Ù„Ø±Ø§Ø¨Ø· ÙØ±ÙŠØ¯ ÙˆÙ…Ø®ØµØµ Ù„ÙƒÙ… ÙÙ‚Ø· Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹.\n\nÙ…Ø¹ ØªØ­ÙŠØ§ØªØŒ\n${companyName}`;

        if ($('whatsappMessage')) {
          $('whatsappMessage').value = message;
        }
      }

      $('whatsappNumber').addEventListener('input', updateWhatsappMessage);

      // Send for signing button
      $('sendForSigningBtn').addEventListener('click', () => {
        const clientName = $('clientName')?.value;
        const clientEmail = $('clientEmail')?.value;
        const editingId = $('formWrap').dataset.editing;

        if (!clientName || !clientEmail) {
          alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹');
          return;
        }

        if (!editingId) {
          alert('ÙŠØ±Ø¬Ù‰ Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªÙˆÙ‚ÙŠØ¹');
          return;
        }

        const contractId = editingId;
        openSigningModal(contractId, clientEmail);
      });

      // Generate contract file button
      // $('generateContractFileBtn').addEventListener('click', async () => {
      //   const clientName = $('clientName')?.value;
      //   if (!clientName) {
      //     alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹');
      //     return;
      //   }

      //   // Open modal with file section
      //   openSigningModal();
      //   $('sendMethod').value = 'file';
      //   hideAllSendSections();
      //   $('fileSection').style.display = 'block';
      // });

      // Confirm send button
      $('confirmSendBtn').addEventListener('click', async () => {
        const method = $('sendMethod').value;
        const clientName = $('clientName')?.value;
        const clientEmail = $('clientEmail')?.value;
        // const authMethod = $('authMethod').value;

        try {
          switch (method) {
            case 'link':
              await handleLinkGeneration();
              break;
            case 'email':
              await handleEmailSending();
              break;
            case 'whatsapp':
              await handleWhatsappSending();
              break;
            case 'file':
              await handleFileGeneration();
              break;
          }

          alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­');
          closeSigningModal();

        } catch (error) {
          console.error('Sending error:', error);
          alert('Ø®Ø·Ø£: ' + (error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'));
        }
      });

      async function handleLinkGeneration() {
        const link = $('signingLink').value;
        if (!link) {
          throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù…ØªØ§Ø­');
        }

        // Here you would save the signing request to your backend
        console.log('Generated signing link:', link);
      }

      async function handleEmailSending() {
        const email = $('signingEmail').value;
        const message = $('emailMessage').value;

        if (!email) {
          throw new Error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
        }

        // Here you would call your email service
        console.log('Sending email to:', email, 'Message:', message);
      }

      async function handleWhatsappSending() {
        const phone = $('whatsappNumber').value;
        const message = $('whatsappMessage').value;

        if (!phone) {
          throw new Error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„');
        }

        // Create WhatsApp link
        const whatsappLink = `https://wa.me/${phone.replace(/[^\d]/g, '')}?text=${encodeURIComponent(message)}`;
        window.open(whatsappLink, '_blank');

        console.log('WhatsApp link:', whatsappLink);
      }

      async function handleFileGeneration() {
        const format = $('fileFormat').value;
        const includeTerms = $('includeTerms').checked;
        const includeSignatures = $('includeSignatures').checked;
        const includeQrCode = $('includeQrCode').checked;

        // Here you would generate the actual file
        console.log('Generating file:', {
          format,
          includeTerms,
          includeSignatures,
          includeQrCode
        });

        // Placeholder for file generation
        alert('Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù ÙˆØªØ­Ù…ÙŠÙ„Ù‡...');
      }

      // Cancel signing button
      $('cancelSigningBtn').addEventListener('click', closeSigningModal);

      // expose some helpers for console if needed
      window.openEdit = openEdit;
      window.updateStatus = updateStatus;

      // ---------------- Terms manager ----------------

      const LOCAL_TERMS_KEY = 'local_terms_v1';

      const defaultTerms = [
        {
          name: 'Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø£ÙˆÙ„ :',
          type: 'text',
          content: 'ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ Ø¨Ù†Ù‚Ù„ ÙˆØªØ±Ø­ÙŠÙ„ Ù…Ø§ ÙŠÙ†ØªØ¬Ù‡ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…Ù† Ù†ÙØ§ÙŠØ§Øª Ø¨ÙˆØ§Ø³Ø·Ø© Ø¹Ù…Ø§Ù„Ù‡ ÙˆØ¢Ù„ÙŠØ§ØªÙ‡ ÙˆÙ…Ø¹Ø¯Ø§ØªÙ‡ ÙˆØ§Ù„ØªØ®Ù„Øµ Ù…Ù†Ù‡Ø§ Ø¨ØªØ±Ø­ÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø±Ù…Ù‰ Ø§Ù„Ø¹Ø§Ù….'
        },
        {
          name: 'Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ :',
          type: 'text',
          content: 'Ù…Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆÙŠÙ…ÙƒÙ† ØªØ¬Ø¯ÙŠØ¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø§ Ù„Ù… ÙŠØ´Ø¹Ø± Ø£Ø­Ø¯ Ø§Ù„Ø·Ø±ÙÙŠÙ† Ø§Ù„Ø¢Ø®Ø± Ø¨Ø¹Ø¯Ù… Ø±ØºØ¨ØªÙ‡ ÙÙŠ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯.'
        }
      ];

      // localStorage helpers
      const BLACKLISTED_TERMS = [
        'Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù‚Ø¯ ÙƒØ§Ù…Ù„ (Ù…Ø«Ø§Ù„)',
        'Ø§Ù„Ø¨Ù†Ø¯: Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ùˆ Ø§Ù„Ø¯ÙØ¹',
        'Ø§Ù„Ø¨Ù†Ø¯: Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯'
      ];

      function loadLocalTerms() {
        try {
          const raw = localStorage.getItem(LOCAL_TERMS_KEY);
          let terms = [];

          if (!raw) {
            terms = defaultTerms.slice();
          } else {
            terms = JSON.parse(raw);
          }

          // Filter out blacklisted terms
          const filtered = terms.filter(t => !BLACKLISTED_TERMS.includes(t.name));

          // If we removed any blacklisted terms, save the cleaned list back
          if (filtered.length !== terms.length) {
            console.log('ğŸ§¹ Removed', terms.length - filtered.length, 'blacklisted terms');
            saveLocalTerms(filtered);
          }

          return filtered;
        } catch (e) {
          return defaultTerms.slice().filter(t => !BLACKLISTED_TERMS.includes(t.name));
        }
      }
      function saveLocalTerms(arr) {
        try { localStorage.setItem(LOCAL_TERMS_KEY, JSON.stringify(arr)); } catch (e) { console.warn('local save failed', e); }
      }

      // API wrapper with fallback to local storage
      async function getTerms() {
        try {
          const rows = await apiFetch('/terms', { method: 'GET' });
          if (Array.isArray(rows)) return rows;
        } catch (err) {
          // fallback silently
        }
        return loadLocalTerms();
      }
      async function createTerm(term) {
        try {
          const created = await apiFetch('/terms', { method: 'POST', body: JSON.stringify(term) });
          if (created) return created;
        } catch (err) {
          // fallback to local
        }
        const local = loadLocalTerms();
        const id = Date.now().toString(36);
        const item = Object.assign({ id }, term);
        local.push(item);
        saveLocalTerms(local);
        return item;
      }
      async function updateTerm(id, term) {
        try {
          const updated = await apiFetch('/terms/' + encodeURIComponent(id), { method: 'PUT', body: JSON.stringify(term) });
          if (updated) return updated;
        } catch (err) {
          // fallback local
        }
        const local = loadLocalTerms();
        const idx = local.findIndex(t => String(t.id) === String(id) || String(t._id) === String(id));
        if (idx >= 0) { local[idx] = Object.assign({}, local[idx], term); saveLocalTerms(local); return local[idx]; }
        return null;
      }
      async function deleteTermById(id) {
        try {
          await apiFetch('/terms/' + encodeURIComponent(id), { method: 'DELETE' });
          return true;
        } catch (err) {
          // fallback local
        }
        let local = loadLocalTerms();
        local = local.filter(t => !(String(t.id) === String(id) || String(t._id) === String(id)));
        saveLocalTerms(local);
        return true;
      }

      const termsModal = $('termsModal');
      const termsList = $('termsList');
      const termId = $('termId');
      const termName = $('termName');
      const termType = $('termType');
      const termContent = $('termContent');
      const termContentLabel = $('termContentLabel');

      async function openTermsModal() {
        // allow opening modal even if form is hidden (convenience)
        $('termId').value = '';
        $('termName').value = '';
        $('termType').value = 'text';
        $('termContent').value = '';
        showElem(termsModal);
        await loadTerms();

        // Auto-check the pricing term after loading
        try {
          console.log('ğŸ” [DEBUG] openTermsModal: Auto-checking pricing term...');
          const uiState = loadTermsUIState();
          uiState[PRICING_TERM_ID] = uiState[PRICING_TERM_ID] || {};
          uiState[PRICING_TERM_ID].checked = true;
          saveTermsUIState(uiState);
          console.log('âœ… [DEBUG] openTermsModal: UI state updated');

          // Also check the checkbox in the DOM
          setTimeout(() => {
            console.log('ğŸ” [DEBUG] openTermsModal: Looking for pricing checkbox...');
            const pricingCheckbox = document.querySelector(`#termsList .termCheckbox[data-id="${PRICING_TERM_ID}"]`);
            if (pricingCheckbox) {
              console.log('âœ… [DEBUG] openTermsModal: Found checkbox, checking it');
              pricingCheckbox.checked = true;
              // Trigger the update to sync with the form
              updateTermsFromUI();
            } else {
              console.error('âŒ [DEBUG] openTermsModal: Pricing checkbox NOT FOUND in DOM!');
              console.log('ğŸ” [DEBUG] openTermsModal: Available checkboxes:', document.querySelectorAll('#termsList .termCheckbox').length);
            }
          }, 100);
        } catch (err) {
          console.error('âŒ [DEBUG] openTermsModal: Auto-check error:', err);
        }
      }

      function closeTermsModal() {
        hideElem(termsModal);
      }

      async function ensureDefaultsOnServer() {
        // try server, if fails populate local storage with defaults
        try {
          const server = await apiFetch('/terms', { method: 'GET' });
          if (!Array.isArray(server) || server.length === 0) {
            try {
              for (const t of defaultTerms) await apiFetch('/terms', { method: 'POST', body: JSON.stringify(t) });
              return;
            } catch (e) {
              // no-op
            }
          } else {
            return;
          }
        } catch (err) {
          // ignore
        }
        const local = loadLocalTerms();
        if (!local || local.length === 0) saveLocalTerms(defaultTerms.slice());
      }

      async function loadTerms() {
        console.log('ğŸ” [DEBUG] loadTerms: Starting... VERSION: 2025-12-06-02:35');
        termsList.innerHTML = '<div class="muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
        try {
          await ensureDefaultsOnServer();
          console.log('ğŸ” [DEBUG] loadTerms: About to call ensurePricingTerm()');
          // Ensure pricing term exists in localStorage
          await ensurePricingTerm();
          console.log('ğŸ” [DEBUG] loadTerms: About to call updatePricingTermContent()');
          // Update pricing term with current form values
          await updatePricingTermContent();
          console.log('ğŸ” [DEBUG] loadTerms: About to get terms from localStorage');

          // Use localStorage directly since that's where our pricing term is stored
          // (API might not have it due to database permission issues)
          const rows = loadLocalTerms();
          console.log('ğŸ” [DEBUG] loadTerms: Got', rows.length, 'terms from localStorage');

          // Also try to sync with API terms (but don't fail if it doesn't work)
          try {
            const apiTerms = await apiFetch('/terms', { method: 'GET' });
            if (Array.isArray(apiTerms) && apiTerms.length > 0) {
              console.log('ğŸ” [DEBUG] loadTerms: Got', apiTerms.length, 'terms from API, merging...');
              // Merge API terms with localStorage, keeping pricing term from localStorage
              const mergedTerms = [...rows];
              apiTerms.forEach(apiTerm => {
                const id = apiTerm.id || apiTerm._id;
                // Don't replace pricing term from localStorage
                if (id !== PRICING_TERM_ID) {
                  const existingIndex = mergedTerms.findIndex(t => (t.id || t._id) === id);
                  if (existingIndex >= 0) {
                    mergedTerms[existingIndex] = apiTerm;
                  } else {
                    mergedTerms.push(apiTerm);
                  }
                }
              });
              console.log('ğŸ” [DEBUG] loadTerms: Merged to', mergedTerms.length, 'total terms');
              renderTermsList(mergedTerms);
            } else {
              renderTermsList(rows);
            }
          } catch (err) {
            console.log('âš ï¸ [DEBUG] loadTerms: API fetch failed, using localStorage only:', err.message);
            renderTermsList(rows);
          }
        } catch (err) {
          console.error('âŒ [DEBUG] loadTerms: Error:', err);
          renderTermsList(loadLocalTerms());
          const note = document.createElement('div');
          note.className = 'muted';
          note.style.marginTop = '8px';
          note.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… â€” Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ø­Ù„ÙŠØ§Ù‹.';
          termsList.insertBefore(note, termsList.firstChild);
        }
      }

      // UI state persistence for selections so modal "remembers" choices
      const TERMS_UI_KEY = 'terms_ui_state_v1';
      function loadTermsUIState() {
        try { return JSON.parse(localStorage.getItem(TERMS_UI_KEY) || '{}'); } catch (e) { return {}; }
      }
      function saveTermsUIState(state) {
        try { localStorage.setItem(TERMS_UI_KEY, JSON.stringify(state || {})); } catch (e) { console.warn('saveTermsUIState failed', e); }
      }

      // renderTermsList - FIXED VERSION with proper state restoration + DRAG-AND-DROP


      // renderTermsList - New Collapsible Version
      // renderTermsList - New Collapsible Version (Updated UI)
      function renderTermsList(rows) {
        if (!rows || rows.length === 0) { termsList.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>'; return; }
        const uiState = loadTermsUIState();

        // Apply saved custom order if exists
        if (uiState._termsOrder && Array.isArray(uiState._termsOrder)) {
          const orderedRows = [];
          const usedIds = new Set();
          uiState._termsOrder.forEach(savedId => {
            const term = rows.find(t => String(t.id || t._id) === String(savedId));
            if (term) { orderedRows.push(term); usedIds.add(String(savedId)); }
          });
          rows.forEach(t => {
            const id = String(t.id || t._id);
            if (!usedIds.has(id)) orderedRows.push(t);
          });
          rows = orderedRows;
        }

        termsList.innerHTML = '';
        let draggedElement = null;

        rows.forEach((t, index) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'term-item';
          wrapper.style.cssText = 'border-bottom: 1px solid #eef4ff; padding: 8px 4px; margin-bottom: 4px; background: white; border-radius: 6px;';
          wrapper.draggable = true;
          const id = String(t.id || t._id || Math.random().toString(36).slice(2));
          wrapper.dataset.termId = id;

          // --- Drag & Drop for Terms ---
          wrapper.addEventListener('dragstart', (e) => {
            if (e.target.closest('.sub-items-container') || e.target.closest('.rule-actions')) { return; }
            draggedElement = wrapper;
            wrapper.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', wrapper.innerHTML);
          });
          wrapper.addEventListener('dragend', () => {
            wrapper.classList.remove('dragging');
            document.querySelectorAll('.term-item').forEach(item => item.classList.remove('drag-over'));
            draggedElement = null;
            saveTermsOrder();
          });
          wrapper.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (draggedElement && draggedElement !== wrapper && draggedElement.classList.contains('term-item')) {
              wrapper.classList.add('drag-over');
            }
          });
          wrapper.addEventListener('dragleave', () => wrapper.classList.remove('drag-over'));
          wrapper.addEventListener('drop', (e) => {
            e.preventDefault();
            wrapper.classList.remove('drag-over');
            if (draggedElement && draggedElement !== wrapper && draggedElement.classList.contains('term-item')) {
              const allItems = Array.from(termsList.children);
              const draggedIndex = allItems.indexOf(draggedElement);
              const targetIndex = allItems.indexOf(wrapper);
              if (draggedIndex < targetIndex) wrapper.parentNode.insertBefore(draggedElement, wrapper.nextSibling);
              else wrapper.parentNode.insertBefore(draggedElement, wrapper);
              saveTermsOrder(); // Ensure order is saved after drop
            }
          });

          // --- Term Header (Title + Toggle) ---
          const headerDiv = document.createElement('div');
          headerDiv.style.cssText = 'display: flex; align-items: center; padding: 6px; background: #fff; border-radius: 6px;';

          // Toggle Expand/Collapse - Distinct Large Button
          const isExpanded = uiState[id] ? !!uiState[id].expanded : false;

          const expandBtn = document.createElement('div');
          expandBtn.className = 'expand-btn';
          expandBtn.style.cssText = 'cursor: pointer; padding: 8px 12px; font-size: 16px; color: #64748b; user-select: none; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.2s; min-width: 30px;';
          expandBtn.innerHTML = isExpanded ? 'â–¼' : 'â—€';
          expandBtn.title = 'Ø§Ù†Ù‚Ø± Ù„ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©';
          expandBtn.onmouseover = () => expandBtn.style.background = '#f1f5f9';
          expandBtn.onmouseout = () => expandBtn.style.background = 'transparent';

          expandBtn.onclick = (e) => {
            e.stopPropagation();
            const newState = !isExpanded;
            const subContainer = wrapper.querySelector('.sub-items-container');
            if (subContainer) {
              subContainer.style.display = newState ? 'block' : 'none';
              expandBtn.innerHTML = newState ? 'â–¼' : 'â—€';

              // Save state
              const st = loadTermsUIState();
              st[id] = st[id] || {};
              st[id].expanded = newState;
              saveTermsUIState(st);
            }
          };

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.dataset.id = id;
          checkbox.className = 'termCheckbox';
          checkbox.style.marginLeft = '8px';
          checkbox.style.transform = 'scale(1.2)';
          checkbox.dataset.content = t.content || '';
          if (uiState[id] && uiState[id].checked) checkbox.checked = true;

          const title = document.createElement('span');
          // NUMBERING REMOVED FROM TERM NAME per user request
          title.innerHTML = `${t.name}`;
          title.style.cssText = 'font-weight: 600; flex: 1; user-select: none; cursor: pointer; padding: 4px; font-size: 1.05em;';

          // Ensure title click matches "Customize/Edit" button behavior (loads into editor)
          title.onclick = (e) => {
            e.stopPropagation();
            loadTermIntoEditor(t);
            // Also imply selection
            checkbox.checked = true;
            const st = loadTermsUIState();
            st[id] = st[id] || {};
            st[id].checked = true;
            saveTermsUIState(st);
            updateTermsFromUI();
          };

          // Edit Term Button (Pen icon)
          const editTermBtn = document.createElement('button');
          editTermBtn.className = 'btn small icon-only flat';
          editTermBtn.innerHTML = 'âš™ï¸';
          editTermBtn.title = 'ØªØ®ØµÙŠØµ Ø§Ù„Ø¨Ù†Ø¯';
          editTermBtn.style.fontSize = '1.2em';
          editTermBtn.onclick = (e) => {
            e.stopPropagation();
            loadTermIntoEditor(t);
          };

          // Delete Term Button (Trash icon)
          const delTermBtn = document.createElement('button');
          delTermBtn.className = 'btn small icon-only flat';
          delTermBtn.innerHTML = 'ğŸ—‘ï¸';
          delTermBtn.title = 'Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„';
          delTermBtn.style.color = '#ef4444';
          delTermBtn.onclick = async (e) => {
            e.stopPropagation();
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ')) {
              await deleteTermById(id);
              await loadTerms();
            }
          };

          // Only show expand button for selection terms or terms with content
          if (t.type !== 'selection') {
            expandBtn.style.visibility = 'hidden';
          }

          headerDiv.appendChild(expandBtn);
          headerDiv.appendChild(checkbox);
          headerDiv.appendChild(title);
          headerDiv.appendChild(editTermBtn);
          headerDiv.appendChild(delTermBtn);
          wrapper.appendChild(headerDiv);

          // Handle Selection Type (Multi-select list)
          if (t.type === 'selection' && t.content) {
            const subItemsContainer = document.createElement('div');
            subItemsContainer.className = 'sub-items-container';
            subItemsContainer.style.cssText = 'padding-right: 28px; margin-top: 8px; border-right: 2px solid #e2e8f0;';
            subItemsContainer.style.display = isExpanded ? 'block' : 'none';

            // --- HIERARCHY PARSING LOGIC ---
            // We need to parse lines and group them: Rule -> [Inside Rules]
            // Indented lines (start with whitespace) are "Inside Rules"
            let rawLines = t.content.split(/\r?\n/).filter(line => line.trim().length > 0);

            // Build Tree
            const tree = [];
            let currentParent = null;

            rawLines.forEach(line => {
              const isIndented = line.match(/^\s+/);
              const text = line.trim();

              if (isIndented && currentParent) {
                // It is a child of the current parent
                currentParent.children.push({ text: text, original: line });
              } else {
                // It is a new top-level rule
                currentParent = { text: text, original: line, children: [] };
                tree.push(currentParent);
              }
            });

            // --- Render Tree ---
            tree.forEach((node, nodeIndex) => {
              // --- Render Parent Rule ---
              const ruleDiv = document.createElement('div');
              ruleDiv.className = 'sub-term-item rule-parent'; // Distinct class
              ruleDiv.style.cssText = 'display: flex; align-items: flex-start; margin-bottom: 6px; padding: 6px; background: #f8fafc; border-radius: 4px; border: 1px solid transparent; transition: all 0.2s;';

              // Parent Hover
              ruleDiv.onmouseover = () => ruleDiv.style.borderColor = '#cbd5e1';
              ruleDiv.onmouseout = () => ruleDiv.style.borderColor = 'transparent';

              // Checkbox for Logic (selects all children if checked?)
              const ruleCheckbox = document.createElement('input');
              ruleCheckbox.type = 'checkbox';
              ruleCheckbox.className = 'sub-term-checkbox';
              ruleCheckbox.dataset.parent = id;
              ruleCheckbox.dataset.val = node.original;
              ruleCheckbox.style.marginTop = '4px';
              ruleCheckbox.style.marginLeft = '8px';

              if (uiState[id] && uiState[id].subSelections && uiState[id].subSelections.includes(node.original)) {
                ruleCheckbox.checked = true;
              }

              const ruleLabel = document.createElement('div');
              // Keep Rule Numbering: 1., 2., ...
              ruleLabel.innerHTML = `<strong>${nodeIndex + 1}.</strong> ${node.text}`;
              ruleLabel.className = 'sub-term-text';
              ruleLabel.style.cssText = 'font-size: 1em; font-weight: 600; color: #334155; flex: 1; line-height: 1.5; outline: none; padding: 2px;';

              // Actions
              const actionsDiv = document.createElement('div');
              actionsDiv.className = 'rule-actions';
              actionsDiv.style.cssText = 'display: flex; gap: 4px; opacity: 0.8; margin-right: 8px;';

              // Add Inside Rule Button ( + )
              const addInsideBtn = document.createElement('button');
              addInsideBtn.innerHTML = 'â• Ø®ÙŠØ§Ø± ÙØ±Ø¹ÙŠ';
              addInsideBtn.className = 'btn small dashed';
              addInsideBtn.style.fontSize = '0.7em';
              addInsideBtn.style.padding = '2px 6px';
              addInsideBtn.title = 'Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ ÙØ±Ø¹ÙŠ (Inside Rule)';
              addInsideBtn.onclick = (e) => {
                e.stopPropagation();
                const newText = prompt(`Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± ÙØ±Ø¹ÙŠ ØªØ­Øª "${node.text}":`);
                if (newText && newText.trim()) {
                  // Logic: Find 'node.original' in content, insert '    ' + newText after it (or after its last child)
                  addInsideRule(t, node.original, newText.trim());
                }
              };

              // Edit
              const editBtn = document.createElement('button');
              editBtn.innerHTML = 'âœï¸';
              editBtn.className = 'btn icon-only small flat';
              editBtn.onclick = (e) => {
                e.stopPropagation();
                const newText = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ:', node.text);
                if (newText !== null && newText !== node.text) {
                  updateRuleText(t, node.original, newText);
                }
              };

              // Delete
              const delBtn = document.createElement('button');
              delBtn.innerHTML = 'âŒ';
              delBtn.className = 'btn icon-only small flat';
              delBtn.style.color = '#ef4444';
              delBtn.onclick = (e) => {
                e.stopPropagation();
                const confirmMsg = node.children.length > 0
                  ? `Ø­Ø°Ù "${node.text}" Ùˆ ${node.children.length} Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©ØŸ`
                  : `Ø­Ø°Ù "${node.text}"ØŸ`;
                if (confirm(confirmMsg)) {
                  deleteRuleBlock(t, node);
                }
              };

              actionsDiv.appendChild(addInsideBtn);
              actionsDiv.appendChild(editBtn);
              actionsDiv.appendChild(delBtn);

              ruleCheckbox.addEventListener('change', () => {
                if (ruleCheckbox.checked) {
                  checkbox.checked = true;
                }
                saveSubSelections(id, subItemsContainer);
                updateTermsFromUI();
              });

              ruleDiv.appendChild(ruleCheckbox);
              ruleDiv.appendChild(ruleLabel);
              ruleDiv.appendChild(actionsDiv);
              subItemsContainer.appendChild(ruleDiv);

              // --- Render Children (Inside Rules) ---
              if (node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.style.marginRight = '24px'; // Indent
                childrenContainer.style.borderRight = '2px dashed #e2e8f0';
                childrenContainer.style.paddingRight = '8px';

                node.children.forEach((child, childIndex) => {
                  const childDiv = document.createElement('div');
                  childDiv.className = 'sub-term-item inside-rule';
                  childDiv.style.cssText = 'display: flex; align-items: flex-start; margin-bottom: 4px; padding: 4px; border-radius: 4px;';

                  const childCheckbox = document.createElement('input');
                  childCheckbox.type = 'checkbox';
                  childCheckbox.className = 'sub-term-checkbox';
                  childCheckbox.dataset.parent = id;
                  childCheckbox.dataset.val = child.original;
                  childCheckbox.style.marginTop = '4px';
                  childCheckbox.style.marginLeft = '8px';
                  if (uiState[id] && uiState[id].subSelections && uiState[id].subSelections.includes(child.original)) {
                    childCheckbox.checked = true;
                  }

                  const childLabel = document.createElement('div');
                  // LOCAL NUMBERING: 1., 2., ... instead of 1.1., 1.2.
                  childLabel.innerHTML = `<strong>${childIndex + 1}.</strong> ${child.text}`;
                  childLabel.className = 'sub-term-text';
                  childLabel.style.cssText = 'font-size: 0.9em; color: #64748b; flex: 1; line-height: 1.5;';

                  // Actions for Child
                  const childActions = document.createElement('div');
                  childActions.className = 'rule-actions';
                  childActions.style.cssText = 'display: flex; gap: 4px; opacity: 0.6; margin-right: 8px;';
                  childDiv.onmouseenter = () => childActions.style.opacity = '1';
                  childDiv.onmouseleave = () => childActions.style.opacity = '0.6';

                  // Child Edit
                  const cEdit = document.createElement('button');
                  cEdit.innerHTML = 'âœï¸';
                  cEdit.className = 'btn icon-only small flat';
                  cEdit.onclick = (e) => {
                    e.stopPropagation();
                    const newT = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ±Ø¹ÙŠ:', child.text);
                    if (newT && newT !== child.text) {
                      // Ensure we keep indentation
                      updateRuleText(t, child.original, '    ' + newT.trim());
                    }
                  };

                  // Child Delete
                  const cDel = document.createElement('button');
                  cDel.innerHTML = 'âŒ';
                  cDel.className = 'btn icon-only small flat';
                  cDel.style.color = '#ef4444';
                  cDel.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹ÙŠØŸ')) deleteRule(t, child.original);
                  };

                  childActions.appendChild(cEdit);
                  childActions.appendChild(cDel);

                  childCheckbox.addEventListener('change', () => {
                    saveSubSelections(id, subItemsContainer);
                    updateTermsFromUI();
                  });

                  childDiv.appendChild(childCheckbox);
                  childDiv.appendChild(childLabel);
                  childDiv.appendChild(childActions);
                  childrenContainer.appendChild(childDiv);
                });
                subItemsContainer.appendChild(childrenContainer);
              }
            });

            // "Add New Rule" Button (Top Level)
            const addRuleDiv = document.createElement('div');
            addRuleDiv.style.marginTop = '8px';
            const addBtn = document.createElement('button');
            addBtn.className = 'btn small dashed';
            addBtn.innerHTML = '+ Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ø±Ø¦ÙŠØ³ÙŠ Ø¬Ø¯ÙŠØ¯';
            addBtn.style.width = '100%';
            addBtn.onclick = (e) => {
              e.stopPropagation();
              const newRule = prompt('Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:');
              if (newRule && newRule.trim()) {
                addRule(t, newRule.trim());
              }
            };
            addRuleDiv.appendChild(addBtn);
            subItemsContainer.appendChild(addRuleDiv);

            wrapper.appendChild(subItemsContainer);
          }

          checkbox.addEventListener('change', () => {
            const st = loadTermsUIState();
            st[id] = st[id] || {};
            st[id].checked = checkbox.checked;
            saveTermsUIState(st);
            updateTermsFromUI();
          });

          termsList.appendChild(wrapper);
        });

        updateTermsFromUI();
      }

      // --- New Helper Functions for Hierarchy ---

      async function addInsideRule(term, parentOriginalLine, newChildText) {
        let lines = (term.content || '').split(/\r?\n/);
        // Find index of parent
        // Note: if there are duplicate lines, this might pick the first one. 
        // Ideally we use unique IDs, but text-based is the constraint.
        const parentIdx = lines.indexOf(parentOriginalLine);
        if (parentIdx === -1) return;

        // Find where to insert: after parent AND all its current children
        let insertIdx = parentIdx + 1;
        while (insertIdx < lines.length && lines[insertIdx].match(/^\s+/)) {
          insertIdx++;
        }

        // Insert with 4 spaces indentation
        lines.splice(insertIdx, 0, '    ' + newChildText);

        term.content = lines.join('\n');
        await updateTerm(term.id || term._id, term);
        await loadTerms();
      }

      async function deleteRuleBlock(term, node) {
        let lines = (term.content || '').split(/\r?\n/);

        // We need to remove the parent line AND any immediately following indented lines
        // First, find the exact block indices.
        const idx = lines.indexOf(node.original);
        if (idx === -1) return;

        let count = 1; // Removing parent
        // Look ahead for children
        while (idx + count < lines.length && lines[idx + count].match(/^\s+/)) {
          count++;
        }

        // Remove block
        const removed = lines.splice(idx, count);

        // Cleanup UI selections for all removed lines
        const st = loadTermsUIState();
        const tid = String(term.id || term._id);
        if (st[tid]) {
          if (st[tid].subSelections) {
            removed.forEach(remLine => {
              st[tid].subSelections = st[tid].subSelections.filter(x => x !== remLine);
            });
          }
          saveTermsUIState(st);
        }

        term.content = lines.join('\n');
        await updateTerm(term.id || term._id, term);
        await loadTerms();
      }

      // Old renderTermsList implementation (Deprecated)
      function renderTermsListDeprecated(rows) {
        if (!rows || rows.length === 0) { termsList.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>'; return; }
        const uiState = loadTermsUIState();

        // Apply saved custom order if exists
        if (uiState._termsOrder && Array.isArray(uiState._termsOrder)) {
          const orderedRows = [];
          const usedIds = new Set();
          uiState._termsOrder.forEach(savedId => {
            const term = rows.find(t => String(t.id || t._id) === String(savedId));
            if (term) { orderedRows.push(term); usedIds.add(String(savedId)); }
          });
          rows.forEach(t => {
            const id = String(t.id || t._id);
            if (!usedIds.has(id)) orderedRows.push(t);
          });
          rows = orderedRows;
        }

        termsList.innerHTML = '';
        let draggedElement = null;

        rows.forEach((t, index) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'term-item';
          wrapper.style.cssText = 'border-bottom: 1px solid #eef4ff; padding: 8px 4px; margin-bottom: 4px; background: white; border-radius: 6px;';
          wrapper.draggable = true;
          const id = String(t.id || t._id || Math.random().toString(36).slice(2));
          wrapper.dataset.termId = id;

          // --- Drag & Drop for Terms ---
          wrapper.addEventListener('dragstart', (e) => {
            if (e.target.closest('.sub-items-container') || e.target.closest('.rule-actions')) { return; }
            draggedElement = wrapper;
            wrapper.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', wrapper.innerHTML);
          });
          wrapper.addEventListener('dragend', () => {
            wrapper.classList.remove('dragging');
            document.querySelectorAll('.term-item').forEach(item => item.classList.remove('drag-over'));
            draggedElement = null;
            saveTermsOrder();
          });
          wrapper.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (draggedElement && draggedElement !== wrapper && draggedElement.classList.contains('term-item')) {
              wrapper.classList.add('drag-over');
            }
          });
          wrapper.addEventListener('dragleave', () => wrapper.classList.remove('drag-over'));
          wrapper.addEventListener('drop', (e) => {
            e.preventDefault();
            wrapper.classList.remove('drag-over');
            if (draggedElement && draggedElement !== wrapper && draggedElement.classList.contains('term-item')) {
              const allItems = Array.from(termsList.children);
              const draggedIndex = allItems.indexOf(draggedElement);
              const targetIndex = allItems.indexOf(wrapper);
              if (draggedIndex < targetIndex) wrapper.parentNode.insertBefore(draggedElement, wrapper.nextSibling);
              else wrapper.parentNode.insertBefore(draggedElement, wrapper);
            }
          });

          // --- Term Header (Title + Toggle) ---
          const headerDiv = document.createElement('div');
          headerDiv.style.cssText = 'display: flex; align-items: center; cursor: pointer; padding: 4px;';
          headerDiv.title = 'Ø§Ù†Ù‚Ø± Ù„ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©';

          // Toggle Expand/Collapse
          const isExpanded = uiState[id] ? !!uiState[id].expanded : false;

          headerDiv.onclick = (e) => {
            if (e.target.closest('button') || e.target.closest('.termCheckbox')) return;
            const newState = !isExpanded;
            const subContainer = wrapper.querySelector('.sub-items-container');
            if (subContainer) {
              subContainer.style.display = newState ? 'block' : 'none';
              // Update Arrow
              const arrow = headerDiv.querySelector('.expand-arrow');
              if (arrow) arrow.textContent = newState ? 'â–¼' : 'â—€';

              // Save state
              const st = loadTermsUIState();
              st[id] = st[id] || {};
              st[id].expanded = newState;
              saveTermsUIState(st);
            }
          };

          const expandArrow = document.createElement('span');
          expandArrow.className = 'expand-arrow';
          expandArrow.textContent = isExpanded ? 'â–¼' : 'â—€';
          expandArrow.style.cssText = 'color: #94a3b8; font-size: 10px; margin-left: 8px; width: 14px; text-align: center;';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.dataset.id = id;
          checkbox.className = 'termCheckbox';
          checkbox.style.marginLeft = '8px';
          checkbox.dataset.content = t.content || '';
          if (uiState[id] && uiState[id].checked) checkbox.checked = true;

          const title = document.createElement('span');
          title.innerHTML = t.name;
          title.style.cssText = 'font-weight: 600; flex: 1; user-select: none;';

          // Edit Term Button (Pen icon)
          const editTermBtn = document.createElement('button');
          editTermBtn.className = 'btn small icon-only flat';
          editTermBtn.innerHTML = 'âš™ï¸';
          editTermBtn.title = 'ØªØ®ØµÙŠØµ Ø§Ù„Ø¨Ù†Ø¯';
          editTermBtn.onclick = (e) => {
            e.stopPropagation();
            loadTermIntoEditor(t);
          };

          // Delete Term Button (Trash icon)
          const delTermBtn = document.createElement('button');
          delTermBtn.className = 'btn small icon-only flat';
          delTermBtn.innerHTML = 'ğŸ—‘ï¸';
          delTermBtn.title = 'Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„';
          delTermBtn.style.color = '#ef4444';
          delTermBtn.onclick = async (e) => {
            e.stopPropagation();
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ')) {
              await deleteTermById(id);
              await loadTerms();
            }
          };

          headerDiv.appendChild(expandArrow);
          headerDiv.appendChild(checkbox);
          headerDiv.appendChild(title);
          headerDiv.appendChild(editTermBtn);
          headerDiv.appendChild(delTermBtn);
          wrapper.appendChild(headerDiv);

          // Handle Selection Type (Multi-select list)
          if (t.type === 'selection' && t.content) {
            const subItemsContainer = document.createElement('div');
            subItemsContainer.className = 'sub-items-container';
            subItemsContainer.style.cssText = 'padding-right: 28px; margin-top: 8px; border-right: 2px solid #e2e8f0;';
            subItemsContainer.style.display = isExpanded ? 'block' : 'none';

            let lines = t.content.split(/\r?\n/).filter(line => line.trim().length > 0);

            // Reorder lines based on saved subOrder
            if (uiState[id] && uiState[id].subOrder) {
              const orderMap = new Map(uiState[id].subOrder.map((val, idx) => [val, idx]));
              lines.sort((a, b) => {
                const idxA = orderMap.has(a) ? orderMap.get(a) : 9999;
                const idxB = orderMap.has(b) ? orderMap.get(b) : 9999;
                return idxA - idxB;
              });
            }

            let draggedSubItem = null;

            // --- Render each Rule/Line ---
            lines.forEach((line) => {
              const subItemDiv = document.createElement('div');
              subItemDiv.className = 'sub-term-item';
              subItemDiv.draggable = true;
              subItemDiv.style.cssText = 'display: flex; align-items: flex-start; margin-bottom: 6px; padding: 6px; background: #f8fafc; border-radius: 4px; border: 1px solid transparent; transition: all 0.2s;';

              // Hover effect
              subItemDiv.onmouseover = () => subItemDiv.style.borderColor = '#cbd5e1';
              subItemDiv.onmouseout = () => subItemDiv.style.borderColor = 'transparent';

              // Sub-item Drag Logic
              subItemDiv.addEventListener('dragstart', (e) => {
                e.stopPropagation();
                draggedSubItem = subItemDiv;
                subItemDiv.style.opacity = '0.5';
                e.dataTransfer.effectAllowed = 'move';
              });
              subItemDiv.addEventListener('dragend', (e) => {
                e.stopPropagation();
                subItemDiv.style.opacity = '1';
                draggedSubItem = null;
                // Save Order & UI State
                saveSubItemsOrder(id, subItemsContainer);
                updateTermsFromUI();
              });
              subItemDiv.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); });
              subItemDiv.addEventListener('drop', (e) => {
                e.preventDefault(); e.stopPropagation();
                if (draggedSubItem && draggedSubItem !== subItemDiv && draggedSubItem.parentNode === subItemsContainer) {
                  const items = Array.from(subItemsContainer.querySelectorAll('.sub-term-item'));
                  const srcPos = items.indexOf(draggedSubItem);
                  const tgtPos = items.indexOf(subItemDiv);
                  if (srcPos < tgtPos) subItemsContainer.insertBefore(draggedSubItem, subItemDiv.nextSibling);
                  else subItemsContainer.insertBefore(draggedSubItem, subItemDiv);
                  // dragend handles save state
                }
              });

              const subCheckbox = document.createElement('input');
              subCheckbox.type = 'checkbox';
              subCheckbox.className = 'sub-term-checkbox';
              subCheckbox.dataset.parent = id;
              subCheckbox.dataset.val = line;
              subCheckbox.style.marginTop = '4px';
              subCheckbox.style.marginLeft = '8px';

              if (uiState[id] && uiState[id].subSelections && uiState[id].subSelections.includes(line)) {
                subCheckbox.checked = true;
              }

              const subLabel = document.createElement('div');
              subLabel.innerHTML = line;
              subLabel.className = 'sub-term-text';
              subLabel.style.cssText = 'font-size: 0.9em; color: #475569; flex: 1; line-height: 1.5; outline: none; padding: 2px; border-radius: 4px; border: 1px dashed transparent;';

              // Actions Container (Edit/Delete)
              const actionsDiv = document.createElement('div');
              actionsDiv.className = 'rule-actions';
              actionsDiv.style.cssText = 'display: flex; gap: 4px; opacity: 0.6; margin-right: 8px;';
              subItemDiv.onmouseenter = () => actionsDiv.style.opacity = '1';
              subItemDiv.onmouseleave = () => actionsDiv.style.opacity = '0.6';

              // Edit Button
              const editBtn = document.createElement('button');
              editBtn.innerHTML = 'âœï¸';
              editBtn.title = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ';
              editBtn.className = 'btn icon-only small flat';
              editBtn.onclick = (e) => {
                e.stopPropagation();
                const newText = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ:', line.replace(/<[^>]*>/g, ''));
                if (newText !== null && newText !== line) {
                  updateRuleText(t, line, newText);
                }
              };

              // Delete Button
              const delBtn = document.createElement('button');
              delBtn.innerHTML = 'âŒ';
              delBtn.title = 'Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø±';
              delBtn.className = 'btn icon-only small flat';
              delBtn.style.color = '#ef4444';
              delBtn.onclick = (e) => {
                e.stopPropagation();
                if (confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø±ØŸ')) {
                  deleteRule(t, line);
                }
              };

              actionsDiv.appendChild(editBtn);
              actionsDiv.appendChild(delBtn);

              subCheckbox.addEventListener('change', () => {
                if (subCheckbox.checked) {
                  checkbox.checked = true;
                  const st = loadTermsUIState();
                  st[id] = st[id] || {};
                  st[id].checked = true;
                  saveTermsUIState(st);
                }
                saveSubSelections(id, subItemsContainer);
                updateTermsFromUI();
              });

              subItemDiv.appendChild(subCheckbox);
              subItemDiv.appendChild(subLabel);
              subItemDiv.appendChild(actionsDiv);
              subItemsContainer.appendChild(subItemDiv);
            });

            // "Add New Rule" Button
            const addRuleDiv = document.createElement('div');
            addRuleDiv.style.marginTop = '8px';
            const addBtn = document.createElement('button');
            addBtn.className = 'btn small dashed';
            addBtn.innerHTML = '+ Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯';
            addBtn.style.width = '100%';
            addBtn.onclick = (e) => {
              e.stopPropagation();
              const newRule = prompt('Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯:');
              if (newRule && newRule.trim()) {
                addRule(t, newRule.trim());
              }
            };
            addRuleDiv.appendChild(addBtn);
            subItemsContainer.appendChild(addRuleDiv);

            wrapper.appendChild(subItemsContainer);
          }

          checkbox.addEventListener('change', () => {
            const st = loadTermsUIState();
            st[id] = st[id] || {};
            st[id].checked = checkbox.checked;
            saveTermsUIState(st);
            updateTermsFromUI();
          });

          termsList.appendChild(wrapper);
        });

        updateTermsFromUI();
      }

      // --- Helper Functions for Rule Management ---

      function saveSubItemsOrder(termId, container) {
        const currentOrder = Array.from(container.querySelectorAll('.sub-term-checkbox')).map(cb => cb.dataset.val);
        const st = loadTermsUIState();
        st[termId] = st[termId] || {};
        st[termId].subOrder = currentOrder;
        saveTermsUIState(st);
      }

      function saveSubSelections(termId, container) {
        const checked = Array.from(container.querySelectorAll('.sub-term-checkbox:checked'));
        const st = loadTermsUIState();
        st[termId] = st[termId] || {};
        st[termId].subSelections = checked.map(cb => cb.dataset.val);
        saveTermsUIState(st);
      }

      async function addRule(term, newText) {
        let lines = (term.content || '').split(/\r?\n/);
        lines.push(newText);
        /* Remove empty lines if any? maybe keep */
        const newContent = lines.join('\n');
        term.content = newContent;
        await updateTerm(term.id || term._id, term);
        await loadTerms(); // Refresh UI
      }

      async function updateRuleText(term, oldText, newText) {
        let lines = (term.content || '').split(/\r?\n/);
        const idx = lines.indexOf(oldText);
        if (idx !== -1) {
          lines[idx] = newText;
          term.content = lines.join('\n');

          // Also update local UI state if this was selected/ordered
          const st = loadTermsUIState();
          const tid = String(term.id || term._id);
          if (st[tid]) {
            if (st[tid].subSelections) {
              const selIdx = st[tid].subSelections.indexOf(oldText);
              if (selIdx !== -1) st[tid].subSelections[selIdx] = newText;
            }
            if (st[tid].subOrder) {
              const ordIdx = st[tid].subOrder.indexOf(oldText);
              if (ordIdx !== -1) st[tid].subOrder[ordIdx] = newText;
            }
            saveTermsUIState(st);
          }

          await updateTerm(term.id || term._id, term);
          await loadTerms();
        }
      }

      async function deleteRule(term, textToDelete) {
        let lines = (term.content || '').split(/\r?\n/);
        const idx = lines.indexOf(textToDelete);
        if (idx !== -1) {
          lines.splice(idx, 1);
          term.content = lines.join('\n');

          // cleanup UI state
          const st = loadTermsUIState();
          const tid = String(term.id || term._id);
          if (st[tid]) {
            if (st[tid].subSelections) {
              st[tid].subSelections = st[tid].subSelections.filter(x => x !== textToDelete);
            }
            if (st[tid].subOrder) {
              st[tid].subOrder = st[tid].subOrder.filter(x => x !== textToDelete);
            }
            saveTermsUIState(st);
          }

          await updateTerm(term.id || term._id, term);
          await loadTerms();
        }
      }

      // Save current terms order to UI state
      function saveTermsOrder() {
        const items = Array.from(termsList.querySelectorAll('.term-item'));
        const order = items.map(item => item.dataset.termId);
        const st = loadTermsUIState();
        st._termsOrder = order;
        saveTermsUIState(st);
        console.log('âœ… Terms order saved:', order);

        // Update the terms in the contract to reflect new order
        updateTermsFromUI();
      }

      // load term into editor function
      function loadTermIntoEditor(t) {
        if (!t) return;
        const id = String(t.id || t._id || '');
        if (id) $('termId').value = id;
        if (t.name) $('termName').value = t.name;
        if (t.type) $('termType').value = t.type;

        // Set content in Quill editor
        if (t.content) {
          // Replace old date patterns with today's dates before loading
          let contentToLoad = t.content;

          // Apply date replacement if the function exists
          if (typeof replaceDatePlaceholders === 'function') {
            // Gather current context data for replacement
            const contractData = {
              from_date: $('dateFrom')?.value || null,
              second_party: $('clientName')?.value || '',
              container_type: $('containerType')?.value || '', // Add container type
              // Add other potential fields if needed
            };

            contentToLoad = replaceDatePlaceholders(t.content, contractData);
            console.log('ğŸ“ Applied date replacement to term content in editor', contractData);
          }

          quill.root.innerHTML = contentToLoad;
        } else {
          quill.setText('');
        }

        // Update label based on type
        if (t.type === 'selection') {
          $('termContentLabel').textContent = 'Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¨Ù†Ø¯ (ÙƒÙ„ Ø®ÙŠØ§Ø± ÙÙŠ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)';
        } else {
          $('termContentLabel').textContent = 'Ù†Øµ Ø§Ù„Ø¨Ù†Ø¯';
        }
      }

      // ============ HIJRI DATE CONVERSION & DYNAMIC DATE REPLACEMENT ============

      // Convert Gregorian date to Hijri (Islamic calendar)
      // Using browser's built-in Intl API for 100% accuracy
      function gregorianToHijri(date) {
        const gDate = new Date(date);

        // Subtract 1 day to match accurate Hijri calendar
        // The Intl API sometimes is 1 day ahead
        gDate.setDate(gDate.getDate() - 1);

        // Use Intl.DateTimeFormat with Islamic calendar (umalqura)
        const formatter = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {
          day: 'numeric',
          month: 'numeric',
          year: 'numeric',
          numberingSystem: 'latn' // Use Latin numbers (1,2,3) instead of Arabic (Ù¡,Ù¢,Ù£)
        });

        // Format and parse the date
        const parts = formatter.formatToParts(gDate);

        const day = parseInt(parts.find(p => p.type === 'day').value);
        const month = parseInt(parts.find(p => p.type === 'month').value);
        const year = parseInt(parts.find(p => p.type === 'year').value);

        console.log(`ğŸŒ™ Hijri conversion (Built-in API): ${day}/${month}/${year}Ù‡Ù€`);

        return { day, month, year };
      }

      // Get Arabic day name
      function getArabicDayName(date) {
        const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
        return days[date.getDay()];
      }

      // Format date as "DD/MM/YYYY"Ø¡   
      function formatGregorianDate(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${year}/${month}/${day}`;
      }

      // Format Hijri date as "DD/MM/YYYYÙ‡Ù€"
      function formatHijriDate(hijri) {
        return `${hijri.day}/${String(hijri.month).padStart(2, '0')}/${hijri.year}Ù‡Ù€`;
      }

      // Replace date placeholders in term content
      function replaceDatePlaceholders(content, contractData = null) {
        if (!content) return content;

        const today = new Date();
        const hijri = gregorianToHijri(today);
        const dayName = getArabicDayName(today);
        const gregorianDate = formatGregorianDate(today);
        const hijriDate = formatHijriDate(hijri);

        // Replace placeholders
        let result = content;

        // ===== AUTOMATIC PATTERN DETECTION (NO PLACEHOLDERS NEEDED) =====
        // Automatically detects and replaces existing Arabic date patterns

        console.log('ğŸ“… Checking content for date patterns...');
        console.log('Content length:', content.length);
        console.log('First 200 chars:', content.substring(0, 200));

        // Pattern 1: "Ø§Ù†Ù‡ ÙÙŠ ÙŠÙˆÙ… [day] ØªØ§Ø±ÙŠØ® [hijri]Ù‡Ù€ Ø§Ù„Ù…ÙˆØ§ÙÙ‚ [gregorian]"
        // Made more flexible: handles single/double digit days, various spacing
        const arabicDatePattern = /Ø§Ù†Ù‡ ÙÙŠ ÙŠÙˆÙ…\s*(Ø§Ù„Ø£Ø­Ø¯|Ø§Ù„Ø§Ø«Ù†ÙŠÙ†|Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡|Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡|Ø§Ù„Ø®Ù…ÙŠØ³|Ø§Ù„Ø¬Ù…Ø¹Ø©|Ø§Ù„Ø³Ø¨Øª)\s+ØªØ§Ø±ÙŠØ®\s+\d+\/\d+\/\d+Ù‡Ù€\s*[ØŒ,]?\s*Ø§Ù„Ù…ÙˆØ§ÙÙ‚\s+\d{4}\/\d{1,2}\/\d{1,2}/gi;

        if (arabicDatePattern.test(content)) {
          console.log('âœ… Found date pattern! Replacing...');
          arabicDatePattern.lastIndex = 0; // Reset regex
          result = result.replace(arabicDatePattern, `Ø§Ù†Ù‡ ÙÙŠ ÙŠÙˆÙ… ${dayName} ØªØ§Ø±ÙŠØ® ${hijriDate} Ø§Ù„Ù…ÙˆØ§ÙÙ‚ ${gregorianDate}`);
          console.log('âœ… Replaced with:', `${dayName} ØªØ§Ø±ÙŠØ® ${hijriDate} Ø§Ù„Ù…ÙˆØ§ÙÙ‚ ${gregorianDate}`);
        } else {
          console.log('âš ï¸ No date pattern found in Pattern 1');
        }

        // Pattern 2: Without "ØªØ§Ø±ÙŠØ®" keyword  
        const arabicDatePattern2 = /Ø§Ù†Ù‡ ÙÙŠ ÙŠÙˆÙ…\s*(Ø§Ù„Ø£Ø­Ø¯|Ø§Ù„Ø§Ø«Ù†ÙŠÙ†|Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡|Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡|Ø§Ù„Ø®Ù…ÙŠØ³|Ø§Ù„Ø¬Ù…Ø¹Ø©|Ø§Ù„Ø³Ø¨Øª)\s+\d+\/\d+\/\d+Ù‡Ù€[ØŒ,]?\s*Ø§Ù„Ù…ÙˆØ§ÙÙ‚\s+\d{4}\/\d{1,2}\/\d{1,2}/gi;

        if (arabicDatePattern2.test(content)) {
          console.log('âœ… Found date pattern 2! Replacing...');
          arabicDatePattern2.lastIndex = 0; // Reset regex
          result = result.replace(arabicDatePattern2, `Ø§Ù†Ù‡ ÙÙŠ ÙŠÙˆÙ… ${dayName} ${hijriDate}ØŒ Ø§Ù„Ù…ÙˆØ§ÙÙ‚ ${gregorianDate}`);
        }

        // ===== MANUAL PLACEHOLDERS (Still supported for backward compatibility) =====

        // Pattern 1: "(here will be today date in arabic hejry as above in the example format )"
        result = result.replace(/\(here will be today date in arabic hejry[^)]*\)/gi, hijriDate);

        // Pattern 2: "(today date in english format as in example above )"
        result = result.replace(/\(today date in english format[^)]*\)/gi, gregorianDate);

        // Pattern 3: Generic patterns for flexibility
        result = result.replace(/\{HIJRI_DATE\}/g, hijriDate);
        result = result.replace(/\{GREGORIAN_DATE\}/g, gregorianDate);
        result = result.replace(/\{DAY_NAME\}/g, dayName);
        result = result.replace(/\{TODAY_HIJRI\}/g, hijriDate);
        result = result.replace(/\{TODAY_GREGORIAN\}/g, gregorianDate);

        console.log(`ğŸ“… Date replacement: Hijri=${hijriDate}, Gregorian=${gregorianDate}, Day=${dayName}`);

        // ===== DYNAMIC START DATE FROM INPUT =====
        if (contractData && contractData.from_date) {
          let startDate = contractData.from_date;
          // Format to YYYY/MM/DD if it comes as YYYY-MM-DD
          if (typeof startDate === 'string') {
            startDate = startDate.split('T')[0].replace(/-/g, '/');
          }

          console.log('âœ… Replacing start date placeholders with:', startDate);

          // Replace hardcoded "2024/01/01" or "2024-01-01"
          result = result.replace(/2024\/01\/01/g, startDate);
          result = result.replace(/2024-01-01/g, startDate);

          // Standard Placeholders
          result = result.replace(/\{START_DATE\}/g, startDate);
          result = result.replace(/\{FROM_DATE\}/g, startDate);
        }

        // ===== DYNAMIC CONTAINER TYPE FROM INPUT =====
        // Always attempt to find the type, using data or DOM
        const cType = (contractData && contractData.container_type) ? contractData.container_type : ($('containerType')?.value || '');

        if (cType) {
          console.log('âœ… Replacing container type placeholders with:', cType);

          // 1. Existing override for "4 Yard"
          result = result.replace(/\(\s*4\s*ÙŠØ§Ø±Ø¯Ø©\s*\)/g, `( ${cType} )`);

          // 2. New override for "Liter" formats (e.g. 1300 Liter)
          // Updated to allow optional HTML tags inside the parentheses/text
          // Matches: ( [tags] digits [tags] Liter [tags] )
          // We replace the WHOLE match with ( cType ), unfortunately removing internal tags if they were inside parens.
          // But usually bold is applied to the whole parenthesized group.
          result = result.replace(/\(\s*(?:<[^>]+>\s*)*\d+\s*(?:<[^>]+>\s*)*Liter\s*(?:<[^>]+>\s*)*\)/gi, `( ${cType} )`);

          // Also replace generic placeholders if any
          result = result.replace(/\{CONTAINER_TYPE\}/g, cType);
        }

        // ===== ALSO APPLY SECOND PARTY FIELD REPLACEMENT =====
        // This ensures client data is replaced everywhere dates are replaced
        if (typeof replaceSecondPartyPlaceholders === 'function') {
          result = replaceSecondPartyPlaceholders(result, contractData);
        }

        // ===== APPLY FIRST PARTY TEXT REPLACEMENT =====
        // Ensures static/hardcoded First Party text is always used
        if (typeof replaceFirstPartyText === 'function') {
          result = replaceFirstPartyText(result);
        }

        return result;
      }

      // ============ AUTO-GENERATE FIRST PARTY TEXT ============
      // Automatically generates "Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„" text using contract data and today's dates
      // No need for a separate database term!

      function generateFirstPartyText(firstPartyName = 'Ø´Ø±ÙƒØ© Ø¨ÙØª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª') {
        const today = new Date();
        const hijri = gregorianToHijri(today);
        const dayName = getArabicDayName(today);
        const gregorianDate = formatGregorianDate(today);
        const hijriDate = formatHijriDate(hijri);

        // Company details
        const companyDetails = {
          name: firstPartyName || 'Ø´Ø±ÙƒØ© Ø¨ÙØª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª',
          commercialRegistry: '5850026989',
          registryIssuePlace: 'Ø£Ø¨Ù‡Ø§Ø¡',
          registryIssueDate: '1427/05/16Ù‡Ù€',
          taxNumber: '300637265300003',
          city: 'Ø®Ù…ÙŠØ³ Ù…Ø´ÙŠØ·',
          district: 'Ø­Ø¬Ù„Ø©',
          address: 'Ø¥Ø´Ø§Ø±Ø© Ø¨Ø§Ø­Øµ Ø®Ù„Ù Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¬Ø±Ø¨ÙˆØ¹',
          poBox: '6454',
          postalCode: '62561',
          email: 'BAFT-EST@HOTMAIL.COM',
          phone: '2278666-017',
          extension: '105',
          mobile: '0552200931',
          representative: 'Ø¸Ø§ÙØ± Ø¨Ù† Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ',
          representativeTitle: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…'
        };

        // Generate the full text with today's dates
        const text = `Ø§Ù†Ù‡ ÙÙŠ ÙŠÙˆÙ… ${dayName} ØªØ§Ø±ÙŠØ® ${hijriDate} Ø§Ù„Ù…ÙˆØ§ÙÙ‚ ${gregorianDate}ØŒ ØªÙ… ØªÙˆÙ‚Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ ÙÙŠ Ù…Ø¯ÙŠÙ†Ø© Ø®Ù…ÙŠØ³ Ù…Ø´ÙŠØ· Ø¨ÙŠÙ† ÙƒÙ„Ø§ Ù…Ù† : -

Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ Ù…Ø¤Ø³Ø³Ø© ${companyDetails.name} ÙˆØ¬Ù†Ø³ÙŠØªÙ‡Ø§ Ø³Ø¹ÙˆØ¯ÙŠØ©ØŒ Ø¨Ù…ÙˆØ¬Ø¨ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø±Ù‚Ù… (${companyDetails.commercialRegistry}) ØµØ§Ø¯Ø± Ù…Ù† ${companyDetails.registryIssuePlace} Ø¨ØªØ§Ø±ÙŠØ® ${companyDetails.registryIssueDate}. Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ (${companyDetails.taxNumber})ØŒ ÙˆØ¹Ù†ÙˆØ§Ù†Ù‡Ø§ ÙÙŠ Ù…Ø¯ÙŠÙ†Ø© ${companyDetails.city} (${companyDetails.district}) ${companyDetails.address}ØŒ Øµ Ø¨ ${companyDetails.poBox} Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ ${companyDetails.postalCode}ØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (${companyDetails.email})ØŒ Ù‡Ø§ØªÙ Ø±Ù‚Ù… ${companyDetails.phone} ØªØ­ÙˆÙŠÙ„Ø© (${companyDetails.extension})ØŒ Ø¬ÙˆØ§Ù„ ( ${companyDetails.mobile}) ÙˆÙŠÙ…Ø«Ù„Ù‡ ÙÙŠ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø£Ø³ØªØ§Ø°/ ${companyDetails.representative} Ø¨ØµÙØªÙ‡ (${companyDetails.representativeTitle}) ÙˆÙŠØ´Ø§Ø± Ø§Ù„ÙŠÙ‡ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù€ (Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„)`;

        console.log(`ğŸ“ Generated First Party text with dates: ${dayName} ${hijriDate} ${gregorianDate}`);

        return text;
      }

      // Make it globally available
      window.generateFirstPartyText = generateFirstPartyText;

      // ============ AUTO-GENERATE SECOND PARTY TEXT ============
      // Automatically generates "Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ" text using contract form data
      // Pulls data from: client name, commercial registry, tax number, phone

      function generateSecondPartyText() {
        // Get data from form fields - REMOVED HARDCODED DEFAULTS
        const clientName = $('clientName')?.value || '';
        const commercialRegistry = $('commercialRegistry')?.value || '';
        const taxNumber = $('taxNumber')?.value || ''; // No more static default
        const clientPhone = $('clientPhone')?.value || '';

        // Only use defaults if they look like real placeholders, otherwise empty
        // Actually, let's keep the structure but allow replacing empty values with a visible placeholder for editing if needed
        // But for production, empty is safer than wrong data.

        // Default values that can be edited (kept as placeholders)
        const defaultValues = {
          nationality: 'Ø³Ø¹ÙˆØ¯ÙŠØ©',
          registryIssuePlace: 'Ø£Ø¨Ù‡Ø§Ø¡',
          registryIssueDate: '1444/06/19 Ù‡Ù€',
          city: 'Ø§Ù„Ø±ÙŠØ§Ø¶',
          poBox: '58310',
          postalCode: '11594',
          email: 'a.althaqib@umc.com.sa',
          representative: 'Ø­Ø³Ù† Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø§Ù„Ø´Ù…Ø±Ø§Ù†ÙŠ',
          representativeTitle: 'Ø§Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ'
        };

        // Generate the full text
        const text = `Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ (${clientName}) ÙˆØ¬Ù†Ø³ÙŠØªÙ‡Ø§ ${defaultValues.nationality}ØŒ Ø¨Ù…ÙˆØ¬Ø¨ Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠ Ø±Ù‚Ù… (${commercialRegistry}) Ø§Ù„ØµØ§Ø¯Ø± Ù…Ù† ${defaultValues.registryIssuePlace} Ø¨ØªØ§Ø±ÙŠØ® ${defaultValues.registryIssueDate} Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ (${taxNumber})ØŒ ÙˆØ¹Ù†ÙˆØ§Ù†Ù‡Ø§ ÙÙŠ Ù…Ø¯ÙŠÙ†Ø© ${defaultValues.city} Øµ Ø¨ ${defaultValues.poBox} Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ ${defaultValues.postalCode}ØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (${defaultValues.email}) : Ø¬ÙˆØ§Ù„ ( ${clientPhone}) ÙˆÙŠÙ…Ø«Ù„Ù‡ ÙÙŠ Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø§Ø³ØªØ§Ø° / ${defaultValues.representative} - Ø¨ØµÙØªÙ‡ ${defaultValues.representativeTitle} ÙˆÙ†Ø´Ø§Ø± Ø§Ù„ÙŠÙ‡ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨(Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ)`;

        return text;
      }
      // Make it globally available
      window.generateSecondPartyText = generateSecondPartyText;

      // ============ REPLACE SECOND PARTY PLACEHOLDERS ============
      // Automatically replaces placeholders in second party term with actual form data
      // Similar to date replacement, but for client fields

      function replaceSecondPartyPlaceholders(content, contractData = null) {
        if (!content) return content;

        // Get values from provided data OR form fields
        // Used for View Mode (where form is empty) or Edit Mode (from inputs)
        const clientName = (contractData?.client_name || contractData?.second_party) || ($('clientName')?.value || '');
        const clientPhone = (contractData?.client_phone) || ($('clientPhone')?.value || '');

        // Attachment fields: MUST prioritize contractData (attachments) if available
        const commercialRegistry = (contractData?.commercial_registry) || ($('commercialRegistry')?.value || '');
        const taxNumber = (contractData?.tax_number) || ($('taxNumber')?.value || '');

        let result = content;

        // Pattern 1: Client name
        if (clientName) {
          // 1. Explicit placeholders
          result = result.replace(/\{SECOND_PARTY\}/g, clientName);
          result = result.replace(/\{CLIENT_NAME\}/g, clientName);

          // 2. "Second Party (....)" pattern
          result = result.replace(/Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ\s*\([^)]+\)/g, `Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ (${clientName})`);

          // 3. "Second Party : ...." pattern (dotted lines)
          result = result.replace(/Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ\s*[:]\s*[.\-_]{3,}/g, `Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ : ${clientName}`);
        }

        // Pattern 1.5: Client Email
        const clientEmail = (contractData?.client_email) || ($('clientEmail')?.value || '');
        if (clientEmail) {
          result = result.replace(/\{CLIENT_EMAIL\}/g, clientEmail);
          result = result.replace(/Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø§Ù„Ùƒ?ØªØ±ÙˆÙ†ÙŠ\s*\([^)]+\)/gi, `Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (${clientEmail})`);
        }

        // Pattern 2: Commercial registry number
        if (commercialRegistry) {
          result = result.replace(/Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠ Ø±Ù‚Ù…\s*\(([^)]+)\)/g, `Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠ Ø±Ù‚Ù… (${commercialRegistry})`);
        }

        // Pattern 3: Tax Number
        // Matches: Ø§Ù„Ø±Ù‚Ù… <spaces> Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ/Ø§Ù„Ø¶Ø±Ø¨ÙŠ/Ø§Ù„Ø¶Ø±ÙŠÙŠÙŠØ¨ÙŠ (tolerant to spelling) <spaces> ( <content/empty> )
        const firstPartyTax = '300637265300003';
        if (taxNumber) {
          // Regex: /Ø§Ù„Ø±Ù‚Ù…\s*Ø§Ù„Ø¶Ø±[ÙŠ]*Ø¨ÙŠ\s*\(([^)]*)\)/g
          //   Ø§Ù„Ø±Ù‚Ù… matches "Ø§Ù„Ø±Ù‚Ù…"
          //   \s* matches optional spaces (was \s+ before, but \s* is safer if typos like Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ)
          //   Ø§Ù„Ø¶Ø± matches "Ø§Ù„Ø¶Ø±"
          //   [ÙŠ]* matches zero or more 'ÙŠ' (so 'Ø§Ù„Ø¶Ø±Ø¨ÙŠ', 'Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ', 'Ø§Ù„Ø¶Ø±ÙŠÙŠØ¨ÙŠ')
          //   Ø¨ÙŠ matches "Ø¨ÙŠ"
          //   \s* matches optional spaces
          //   \(([^)]*)\) matches anything inside parentheses, including empty

          result = result.replace(/Ø§Ù„Ø±Ù‚Ù…\s*Ø§Ù„Ø¶Ø±[ÙŠ]*Ø¨ÙŠ\s*\(([^)]*)\)/g, (match, captured) => {
            // Check capture content for First Party Tax
            if (captured) {
              const cleanCaptured = captured.replace(/\s/g, '');
              if (cleanCaptured.includes(firstPartyTax)) return match;
            }
            // Clean replacement
            return `Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ (${taxNumber})`;
          });
        }

        // Pattern 4: Mobile phone
        if (clientPhone) {
          result = result.replace(/Ø¬ÙˆØ§Ù„\s*\(\s*[^)]+\s*\)/g, `Ø¬ÙˆØ§Ù„ ( ${clientPhone})`);
        }

        return result;
      }

      // Make it globally available
      window.replaceSecondPartyPlaceholders = replaceSecondPartyPlaceholders;

      // ============ REPLACE FIRST PARTY TEXT (STATIC) ============
      function replaceFirstPartyText(content) {
        if (!content) return content;

        // DISABLED: We do NOT want to overwrite the user's custom formatting for the first party text.
        // The dates will be updated by 'replaceDatePlaceholders' which runs separately and targets specific patterns.
        // This allows the user to change fonts/styles in the editor without them being reset.

        /*
        // Generate the correct static text
        const correctText = generateFirstPartyText();
      
        const broadPattern = /Ø§Ù†Ù‡ ÙÙŠ ÙŠÙˆÙ…[\s\S]*?ÙˆÙŠØ´Ø§Ø± Ø§Ù„ÙŠÙ‡ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù€ \(Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„\)/g;
      
        if (broadPattern.test(content)) {
          return content.replace(broadPattern, correctText);
        }
        */

        return content;
      }
      window.replaceFirstPartyText = replaceFirstPartyText;

      // ============ LIVE REPLACEMENT OF OLD DATE PATTERNS ============
      function replaceDatePatternsInTerms() {
        const termsField = $('terms');
        if (!termsField || !termsField.value) return;

        let content = termsField.value;

        // 1. First Party Replacement (Static)
        content = replaceFirstPartyText(content);

        // 2. Second Party Replacement (Dynamic from Form/Attachments)
        // Note: For input field edit, we use data currently in the DOM inputs.
        content = replaceSecondPartyPlaceholders(content);

        if (termsField.value !== content) {
          termsField.value = content;
        }
      }

      // Auto-replace dates/terms when field changes, focuses, or is loaded
      if ($('terms')) {
        const t = $('terms');
        t.addEventListener('blur', replaceDatePatternsInTerms);
        t.addEventListener('focus', replaceDatePatternsInTerms); // Trigger on focus/click
        t.addEventListener('click', replaceDatePatternsInTerms); // Double safety

        // Also check when form becomes visible
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.target.id === 'formWrap' && mutation.target.style.display !== 'none') {
              setTimeout(replaceDatePatternsInTerms, 100);
            }
          });
        });

        if ($('formWrap')) {
          observer.observe($('formWrap'), { attributes: true, attributeFilter: ['style'] });
        }
      }

      // updateTermsFromUI - FIXED VERSION with custom order support
      // updateTermsFromUI - FIXED VERSION with custom order support + Sub-Items
      async function updateTermsFromUI() {
        try {
          // Order checked boxes according to DOM order (which reflects saved order)
          const orderedCheckboxes = [];
          document.querySelectorAll('#termsList .term-item').forEach(termItem => {
            const checkbox = termItem.querySelector('.termCheckbox');
            if (checkbox && checkbox.checked) {
              orderedCheckboxes.push(checkbox);
            }
          });

          if (orderedCheckboxes.length === 0) {
            $('terms').value = '';
            $('termsSummary').value = '';
            return;
          }

          const all = await getTerms();
          const uiState = loadTermsUIState();
          const mergedParts = [];

          for (const cb of orderedCheckboxes) {
            const id = cb.dataset.id;
            const term = all.find(t => String(t.id) === id || String(t._id) === id) || {
              name: cb.nextSibling?.textContent || '',
              content: cb.dataset.content || '',
              type: 'text'
            };

            // Add two line breaks before the term name for better spacing
            // Clean up name from any HTML tags if desired in text output, but usually valid HTML is ok if using Rich Text
            // We'll strip tags for the text-only output if usage is text-only, but 'terms' might be used in text editor
            // Let's assume using innerText of the title span is safer for the name:
            // const nameText = cb.nextSibling ? cb.nextSibling.innerText : term.name.replace(/<[^>]*>/g, '');
            // mergedParts.push('\n' + nameText); // REMOVED: User requested to hide Term Name in final contract

            if (term.type === 'selection') {
              // Logic:
              // 1. If Rich Text (HTML) exists, use it.
              // 2. Check for active sub-items (checkboxes).
              // 3. If a sub-item is checked BUT its text is NOT in the Rich Text, append it.
              //    (This assumes the user wants the auto-list unless they manually typed it).

              let addedContent = '';
              let isRich = false;

              if (term.content && term.content.trim().startsWith('<')) {
                isRich = true;
                const contentWithDates = replaceDatePlaceholders(term.content);
                addedContent += '\n' + contentWithDates;
              }

              // Look for sub-items
              const termItem = cb.closest('.term-item');
              const subContainer = termItem.querySelector('.sub-items-container');

              if (subContainer) {
                const checkedSubs = Array.from(subContainer.querySelectorAll('.sub-term-checkbox:checked'));
                if (checkedSubs.length > 0) {
                  // If we didn't use rich text, or if we need to append missing items
                  checkedSubs.forEach((sub, subIndex) => {
                    const val = sub.dataset.val.trim();

                    // If Rich Text was used, check if this value is already inside it (to avoid duplication)
                    // We strip HTML tags from content to check text presence accurately
                    if (isRich) {
                      const rawContent = term.content.replace(/<[^>]*>/g, '');
                      if (rawContent.includes(val)) {
                        return; // Already manually added by user
                      }
                    }

                    // Append the item
                    // Auto-numbering: 1. Option...
                    addedContent += '\n' + (subIndex + 1) + '. ' + val;
                  });
                }
              } else if (!isRich) {
                // Fallback if no sub-container but legacy state exists (and not rich)
                if (uiState[id] && uiState[id].selected) {
                  addedContent += '\n' + uiState[id].selected;
                }
              }

              mergedParts.push(addedContent);

            } else {
              // Replace date placeholders in content before adding
              const contentWithDates = replaceDatePlaceholders(term.content || cb.dataset.content || '');
              mergedParts.push(contentWithDates);
            }
          }

          // Join with single line break
          // This ensures terms are on separate lines for the splitter, 
          // but avoids adding extra visual gaps if the terms themselves are HTML blocks.
          let merged = mergedParts.join('\n').trim();

          // Apply date replacement to the entire merged content as well
          merged = replaceDatePlaceholders(merged);

          // Apply second party field replacement (client name, registry, tax, phone)
          if (typeof replaceSecondPartyPlaceholders === 'function') {
            merged = replaceSecondPartyPlaceholders(merged);
          }

          $('terms').value = merged;

          const summary = orderedCheckboxes.map(cb => cb.nextSibling?.innerText).filter(Boolean).slice(0, 5).join(' Â· ') + (orderedCheckboxes.length > 5 ? ' Â· ...' : '');
          $('termsSummary').value = summary;

          // persist last inserted selection for export when modal closed
          const st = loadTermsUIState();
          st._lastInserted = orderedCheckboxes.map(cb => cb.dataset.id);
          saveTermsUIState(st);
        } catch (e) {
          console.warn('updateTermsFromUI failed', e);
        }
      }

      // Terms "Insert" button: finalize current UI selection into the main form and close modal
      const termsInsertEl = $('termsInsertBtn');
      if (termsInsertEl) {
        termsInsertEl.addEventListener('click', async () => {
          try {
            // update hidden fields from current UI selections
            await updateTermsFromUI();
            const raw = $('terms').value || '';
            if (!raw.trim()) {
              alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø¨Ù†Ø¯');
              return;
            }
            // persist last inserted IDs already handled by updateTermsFromUI()
            alert('ØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ù‚Ø¯. Ù„Ø§ ØªÙ†Ø³ Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯.');
            closeTermsModal();
          } catch (err) {
            alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬: ' + (err && err.message ? err.message : err));
          }
        });
      }

      // ---------------- Terms Management Logic (Consolidated) ----------------

      // Helper to persist selection state
      async function markTermSelectedById(id, selectedValue) {
        try {
          if (!id) return;
          const st = loadTermsUIState();
          st[String(id)] = st[String(id)] || {};
          st[String(id)].checked = true;
          if (selectedValue !== undefined && selectedValue !== null) st[String(id)].selected = selectedValue;
          saveTermsUIState(st);
        } catch (e) { console.warn('markTermSelectedById failed', e); }
      }

      // Save Term Button
      const saveTermBtn = $('saveTermBtn');
      if (saveTermBtn) {
        saveTermBtn.addEventListener('click', async () => {
          console.log('Save Term Button Clicked'); // DEBUG
          const id = $('termId').value.trim();
          const name = $('termName').value.trim();
          const type = $('termType').value;
          // Get content from Quill editor
          const content = quill.root.innerHTML;

          console.log('Term Data:', { id, name, type, content }); // DEBUG

          if (!name || !content) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯ ÙˆÙ…Ø­ØªÙˆØ§Ù‡');
            return;
          }

          const term = { name, type, content };

          try {
            let saved = null;
            if (id) {
              console.log('Updating term...');
              saved = await updateTerm(id, term);
              alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
              console.log('Creating term...');
              saved = await createTerm(term);
              alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
            }
            console.log('Save result:', saved);

            // Persistence logic
            const savedId = String((saved && (saved.id || saved._id)) || id || (saved && saved.id) || '');
            let selectedVal = null;
            if (term.type === 'selection') {
              const opts = (term.content || '').split(/\r?\n/).map(s => s.trim()).filter(Boolean);
              if (opts.length) selectedVal = opts[0];
            }
            await markTermSelectedById(savedId, selectedVal);

            // Reload and refresh editor
            await loadTerms();

            // If it was an update, keep it in editor? Or clear? 
            // User might want to add another. Let's clear if new, keep if update? 
            // The previous robust logic kept it. Let's stick to clearing for "New" feel, or maybe just clear.
            // Actually, let's clear to avoid confusion, as the "New" button exists.
            // BUT the robust logic had: if (savedId) loadTermIntoEditor...
            // Let's keep the robust behavior: focus the item.
            if (savedId) {
              const all = await getTerms();
              const termObj = all.find(t => String(t.id || t._id) === savedId);
              if (termObj) loadTermIntoEditor(termObj);
            }

          } catch (err) {
            console.error('Save Term Error:', err);
            alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨Ù†Ø¯: ' + err.message);
          }
        });
      }

      // Delete Term Button
      const deleteTermBtn = $('deleteTermBtn');
      if (deleteTermBtn) {
        deleteTermBtn.addEventListener('click', async () => {
          const id = $('termId').value.trim();
          if (!id) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¨Ù†Ø¯ Ù„Ù„Ø­Ø°Ù');
            return;
          }

          if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ØŸ')) return;

          try {
            await deleteTermById(id);

            // Cleanup UI state
            try {
              const st = loadTermsUIState();
              delete st[String(id)];
              if (Array.isArray(st._lastInserted)) st._lastInserted = st._lastInserted.filter(x => String(x) !== String(id));
              saveTermsUIState(st);
            } catch (e) { console.warn('cleanup UI state failed', e); }

            alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ù†Ø¬Ø§Ø­');

            // Clear form
            $('termId').value = '';
            $('termName').value = '';
            quill.setText(''); // Clear Quill editor
            $('termType').value = 'text';

            await loadTerms();
          } catch (err) {
            console.error(err);
            alert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯');
          }
        });
      }

      // New Term Button (Clear Form)
      const newTermBtn = $('newTermBtn');
      if (newTermBtn) {
        newTermBtn.addEventListener('click', () => {
          $('termId').value = '';
          $('termName').value = '';
          quill.setText(''); // Clear Quill editor
          $('termType').value = 'text';
          $('termContentLabel').textContent = 'Ù†Øµ Ø§Ù„Ø¨Ù†Ø¯';
        });
      }

      // ---------------- Terms export: docx + HTML fallback ----------------

      async function loadDocx() {
        if (window.docx) return window.docx;
        return new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/docx@8.4.1/build/index.umd.js';
          s.async = true;
          let done = false;
          const onLoad = () => { if (done) return; done = true; window.docx = window.docx || window.docxModule || window.docx || {}; resolve(window.docx); };
          const onErr = () => { if (done) return; done = true; reject(new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© docx Ù…Ù† CDN')); };
          s.onload = onLoad;
          s.onerror = onErr;
          document.head.appendChild(s);
          setTimeout(() => { if (!done) onErr(); }, 10000);
        }).catch(() => ({}));
      }

      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 5000);
      }

      function buildWordHtml(title, paragraphs) {
        const style = `
        <meta charset="utf-8" />
        <style>
          body { direction: rtl; font-family: "Cairo","Arial",sans-serif; font-size:14pt; }
          h1 { font-size:18pt; }
          .term-title { font-weight:700; margin-top:12px; margin-bottom:6px; }
          .para { margin:6px 0; white-space:pre-wrap; }
        </style>
      `;
        const body = paragraphs.map(p => `<div class="para">${p}</div>`).join('\n');
        return `<!doctype html><html lang="ar" dir="rtl"><head>${style}<title>${title}</title>
</head><body><h1>${title}</h1>${body}</body></html>`;
      }

      function escapeHtml(str) {
        return String(str || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
      }

      // export selected terms (with UI state preference) -> docx or fallback .doc (HTML)
      async function exportTermsToWordWithUI(selectedTerms, uiState) {
        try {
          const Docx = await loadDocx();
          if (Docx && Docx.Document && Docx.Packer) {
            const { Document, Packer, Paragraph, TextRun } = Docx;
            const children = [];
            for (const t of selectedTerms) {
              const id = String(t.id || t._id || '');
              children.push(new Paragraph({ children: [new TextRun({ text: t.name || '', bold: true, size: 28 })] }));
              // determine chosen value
              let chosen = null;
              if (uiState && uiState[id] && uiState[id].selected) chosen = uiState[id].selected;
              else {
                const cb = document.querySelector(`#termsList .termCheckbox[data-id="${id}"]`);
                const row = cb ? cb.closest('div') : null;
                const sel = row ? row.querySelector('select') : null;
                if (sel) chosen = sel.value;
              }
              if (t.type === 'selection') {
                if (chosen) {
                  children.push(new Paragraph({ children: [new TextRun({ text: chosen, size: 24 })] }));
                } else {
                  ((t.content || '').split(/\r?\n/).filter(Boolean)).forEach(line => {
                    children.push(new Paragraph({ children: [new TextRun({ text: line, size: 24 })] }));
                  });
                }
              } else {
                ((t.content || '').split(/\r?\n/).filter(Boolean)).forEach(line => {
                  children.push(new Paragraph({ children: [new TextRun({ text: line, size: 24 })] }));
                });
              }
              children.push(new Paragraph({ children: [new TextRun({ text: ' ' })] }));
            }
            const doc = new Document({ sections: [{ properties: {}, children }] });
            const blob = await Packer.toBlob(doc);
            downloadBlob(blob, `terms_${Date.now()}.docx`);
            return;
          }
          throw new Error('docx library ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
        } catch (err) {
          // fallback to HTML .doc
          const paragraphs = [];
          for (const t of selectedTerms) {
            const id = String(t.id || t._id || '');
            paragraphs.push(`<div class="term-title">${escapeHtml(t.name || '')}</div>`);
            let chosen = null;
            if (uiState && uiState[id] && uiState[id].selected) chosen = uiState[id].selected;
            else {
              const cb = document.querySelector(`#termsList .termCheckbox[data-id="${id}"]`);
              const row = cb ? cb.closest('div') : null;
              const sel = row ? row.querySelector('select') : null;
              if (sel) chosen = sel.value;
            }
            if (t.type === 'selection') {
              if (chosen) paragraphs.push(escapeHtml(chosen));
              else {
                const opts = (t.content || '').split(/\r?\n/).filter(Boolean);
                if (opts.length) paragraphs.push('<ul style="direction:rtl;text-align:right;">' + opts.map(o => `<li>${escapeHtml(o)}</li>`).join('') + '</ul>');
                else paragraphs.push('&nbsp;');
              }
            } else {
              paragraphs.push((t.content || '').replace(/\n/g, '<br/>') || '&nbsp;');
            }
          }
          const html = buildWordHtml('Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¹Ù‚Ø¯', paragraphs);
          const blob = new Blob([html], { type: 'application/msword;charset=utf-8' });
          downloadBlob(blob, `terms_${Date.now()}.doc`);
        }
      }

      // export plain text (hidden #terms) -> docx or fallback .doc
      async function exportTextToWord(filename, text) {
        try {
          const Docx = await loadDocx();
          if (Docx && Docx.Document && Docx.Packer) {
            const { Document, Packer, Paragraph, TextRun } = Docx;
            const children = text.split(/\r?\n/).map(line => new Paragraph({ children: [new TextRun({ text: line || '', size: 24 })] }));
            const doc = new Document({ sections: [{ children: children.length ? children : [new Paragraph({ children: [new TextRun({ text: text || '', size: 24 })] })] }] });
            const blob = await Packer.toBlob(doc);
            downloadBlob(blob, `${filename}_${Date.now()}.docx`);
            return;
          }
          throw new Error('docx library ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
        } catch (err) {
          const html = buildWordHtml('Ø´Ø±ÙˆØ· Ø§Ù„Ø¹Ù‚Ø¯', text.split(/\r?\n/).map(l => escapeHtml(l) || '&nbsp;'));
          const blob = new Blob([html], { type: 'application/msword;charset=utf-8' });
          downloadBlob(blob, `${filename}_${Date.now()}.doc`);
        }
      }

      // bindings for the two export buttons
      const termsExportBtnEl = $('termsExportBtn');
      if (termsExportBtnEl) {
        termsExportBtnEl.addEventListener('click', async () => {
          try {
            // determine selected ids (use UI state or last inserted)
            const uiState = loadTermsUIState();
            let selectedIds = Array.from(document.querySelectorAll('#termsList .termCheckbox')).filter(cb => cb.checked).map(cb => cb.dataset.id);
            if (selectedIds.length === 0 && uiState._lastInserted) selectedIds = uiState._lastInserted.slice();
            if (selectedIds.length === 0) return alert('Ø§Ø®ØªØ± Ø¨Ù†ÙˆØ¯Ø§Ù‹ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§');
            const all = await getTerms();
            const selected = [];
            selectedIds.forEach(id => {
              const t = all.find(x => String(x.id || x._id) === String(id));
              if (t) selected.push(t);
              else {
                const cb = document.querySelector(`#termsList .termCheckbox[data-id="${id}"]`);
                if (cb) selected.push({ id, name: cb.nextSibling?.textContent || 'Ø¨Ù†Ø¯', type: 'text', content: cb.dataset.content || '' });
              }
            });
            await exportTermsToWordWithUI(selected, uiState);
          } catch (err) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±: ' + (err && err.message ? err.message : err));
          }
        });
      }

      const smallExportBtn = $('exportTermsBtn');
      if (smallExportBtn) {
        smallExportBtn.addEventListener('click', async () => {
          try {
            const raw = $('terms').value || '';
            if (!raw.trim()) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ù…ÙØ¯Ø±Ø¬Ø© Ù„Ù„ØªØµØ¯ÙŠØ±');
            await exportTextToWord('contract_terms', raw);
          } catch (err) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±: ' + (err && err.message ? err.message : err));
          }
        });
      }

      // ---------------- end Terms export ----------------

      // Persist UI state when user saves/creates/deletes a term so selections persist across modal open/close

      // (Redundant IIFE removed - logic consolidated above)

      // ============ Sortable Table Headers ============

      // Sorting functionality
      window.sortTable = function (column) {
        // Toggle direction if clicking same column
        if (currentSortColumn === column) {
          currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          currentSortColumn = column;
          currentSortDirection = 'asc';
        }

        // Update header arrows
        document.querySelectorAll('th.sortable').forEach(th => {
          th.classList.remove('asc', 'desc');
        });
        const activeHeader = document.querySelector(`th[data-sort="${column}"]`);
        if (activeHeader) {
          activeHeader.classList.add(currentSortDirection);
        }

        // Sort the data
        contractsData.sort((a, b) => {
          let aVal = a[column];
          let bVal = b[column];

          // Handle null/undefined values
          if (aVal == null) aVal = '';
          if (bVal == null) bVal = '';

          // Convert to string for comparison
          aVal = String(aVal).toLowerCase();
          bVal = String(bVal).toLowerCase();

          // Numeric comparison for price
          if (column === 'total_price') {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
          }

          // Compare
          if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
          if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
          return 0;
        });

        // Re-render the table using the same logic as loadContracts
        const tbody = document.querySelector('#contractsTbody');
        if (!tbody) return;

        tbody.innerHTML = '';
        let active = 0, pending = 0;

        contractsData.forEach(c => {
          if (c.status === 'active') active++;
          if (c.status === 'pending') pending++;

          const tr = document.createElement('tr');
          const containerMapLink = c.container_location ? `<a href="https://www.google.com/maps?q=${c.container_location}" target="_blank">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©</a>` : '';
          // const pickupMapLink = c.pickup_location ? `<a href="https://www.google.com/maps?q=${c.pickup_location}" target="_blank">Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ­ØµÙŠÙ„</a>` : '';

          // Format dates to show only YYYY-MM-DD
          const fromDate = formatDate(c.from_date);
          const toDate = formatDate(c.to_date);

          tr.innerHTML = `
        <td>${c.id || '-'}</td>
        <td>${c.second_party || ''}</td>
        <td>${c.service_name || ''}</td>
        <td>${fromDate} â†’ ${toDate}</td>
        <td>${c.total_price || 0}</td>
        <td>${c.manager || ''}</td>
        <td>${c.collector || ''}</td>
        <td>
            <span class="chip ${c.status === 'active' ? 'active' : (c.status === 'pending' ? 'pending' : 'expired')}">
            ${c.status === 'active' ? 'Ù†Ø´Ø·' : (c.status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹' : 'Ù…Ù†ØªÙ‡ÙŠ')}
            </span>
        </td>
        <td>
          <div style="display:flex; gap:4px; flex-wrap:wrap; align-items:center;">
              <button class="btn" onclick="openView('${c.id}')" title="Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ">Ø¹Ø±Ø¶</button>
              <button class="btn" onclick="openEdit('${c.id}')" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn small" onclick="updateStatus('${c.id}','active')" title="ØªÙØ¹ÙŠÙ„">âœ…</button>
              <button class="btn small" onclick="updateStatus('${c.id}','pending')" title="Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹">â³</button>
              <button class="btn small" onclick="updateStatus('${c.id}','expired')" title="Ø¥Ù†Ù‡Ø§Ø¡">ğŸ›‘</button>
          </div>
          <div style="margin-top:6px; font-size:0.8em;">${containerMapLink}</div>
        </td>
      `;
          tbody.appendChild(tr);
        });

        if ($('countActive')) $('countActive').textContent = active;
        if ($('countPending')) $('countPending').textContent = pending;
      };

      // Page Sizing Logic
      window.setPageSize = function (size) {
        document.body.classList.remove('size-small', 'size-large');
        if (size === 'small') document.body.classList.add('size-small');
        if (size === 'large') document.body.classList.add('size-large');
        localStorage.setItem('pageSize', size);
      };

      // Initialize size from localStorage
      const savedSize = localStorage.getItem('pageSize');
      if (savedSize) window.setPageSize(savedSize);

    }); // DOMContentLoaded
  </script>

  <!-- View Contract Modal -->
  <div id="viewContractModal" class="modal" style="display:none;">
    <div
      style="max-width: 100vw; height: 100vh; display: flex; flex-direction: column; background: #f8f9fc; margin: 0; padding: 0;">

      <!-- Header with action buttons -->
      <div
        style="padding: 12px 24px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
        <div></div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" onclick="printViewContract()"
            style="background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">ğŸ–¨ï¸
            Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn" onclick="printViewContract()"
            style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">ğŸ“„
            Ø­ÙØ¸ PDF</button>
          <button class="btn" onclick="shareViewContract()"
            style="background: #25D366; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
            <svg style="width: 18px; height: 18px; vertical-align: middle; margin-left: 4px; fill: white;"
              viewBox="0 0 24 24">
              <path
                d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" />
            </svg>
            ÙˆØ§ØªØ³Ø§Ø¨
          </button>
          <span onclick="closeModal('viewContractModal')"
            style="font-size: 32px; cursor: pointer; color: #64748b; line-height: 1;">&times;</span>
        </div>
      </div>

      <!-- Doc wrapper - exact match with pdf-sign.html -->
      <div id="doc-wrapper"
        style="flex: 1; background: #ffffff; overflow: auto; display: flex; justify-content: center; padding: 20px; position: relative;">

        <!-- Doc content - exact copy from pdf-sign.html -->
        <div id="doc-content"
          style="background: #fff; width: 210mm; min-height: 296.5mm; padding: 20mm; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: relative; box-sizing: border-box; font-size: 14px; line-height: 1.6; display: block; background-image: linear-gradient(to bottom, transparent 0mm, transparent 297mm, rgba(0, 0, 0, 0.05) 297mm, rgba(0, 0, 0, 0.05) 297.5mm, transparent 297.5mm); background-size: 100% 297mm; background-repeat: repeat-y;">

          <div class="contract-header" style="flex-direction: column; align-items: stretch; margin-bottom:20px;">
            <!-- Top Row: Manager Info on Left -->
            <div class="top-info-row" style="display:flex; justify-content: flex-end; width:100%; margin-bottom: 25px;">
              <div style="text-align: left; font-size: 0.95em; color: #444; line-height: 1.6;">
                <!-- <div style="direction:ltr; text-align:left;"> <span id="v-date-top"></span></div> -->
                <div>Ù…Ø­ØµÙ„ / <span id="v-collector"></span></div>
                <div>Ù…Ø³ÙˆÙ‚ / <span id="v-manager"></span></div>
              </div>
            </div>

            <!-- Main Title Row: Contract Num (Left) - Title (Center) -->
            <div class="main-title-row"
              style="display: flex; justify-content: space-between; align-items: center; width: 100%; position: relative;">

              <!-- Right Side: Spacer -->
              <div style="width: 200px;"></div>

              <!-- Center: Title -->
              <div style="text-align: center; flex: 1;">
                <div style="margin: 0; font-weight: bold; font-size: 1em;">Ø¹Ù‚Ø¯ Ø¥ØªÙØ§Ù‚ Ù„Ù†Ù‚Ù„ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</div>
              </div>

              <!-- Left Side: Contract Number -->
              <div style="width: 200px; text-align: left;">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯: <span id="v-id-top"></span></div>
            </div>
          </div>

          <div class="contract-section">
            <div class="terms-box" id="v-terms"></div>
          </div>


          <div class="contract-section signature-section" style="display: flex; justify-content: space-between;">
            <div style="text-align: center; width: 200px;">
              <p><strong>Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„</strong></p>
              <p>Ø´Ø±ÙƒØ© Ø¨ÙØª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª</p>
              <div style="text-align: right; width: 200px;">
                <p><strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:</strong></p>
                <p><strong>Ø§Ù„Ø®ØªÙ…:</strong></p>
                <br><br>
              </div>
            </div>
            <div style="text-align: center; width: 200px;">
              <p><strong>Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ</strong></p>
              <p id="v-second-party-name"></p>
              <div style="text-align: right; width: 200px;">
                <p><strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:</strong></p>
                <p><strong>Ø§Ù„Ø®ØªÙ…:</strong></p>
              </div>

              <!-- <p id="v-second-party-email" style="direction: ltr; font-size: 0.9em; margin-top: 4px; color: #555;"></p> -->
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

</body>

</html>